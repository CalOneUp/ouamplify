<!--
  templateType: "none"
  isAvailableForNewContent: false
  label: "AmpUp Platform - Social Thunderclap Gamification System"
  description: "Comprehensive gamification platform for social media campaigns with user authentication, campaign management, leaderboards, achievements, prize wheel, battle pass, admin dashboard, and real-time analytics"
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="AmpUp - Social Thunderclap Platform. Join the crew, amplify the message, and see your impact. Gamified social media campaign platform.">
    <title>AmpUp // Social Thunderclap Platform</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, addDoc, query, where, getDocs, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCp6YhQPYSQXzAtQQJ8vtzZFghrYU4g2WQ",
            authDomain: "ampup-f3c11.firebaseapp.com",
            projectId: "ampup-f3c11",
            storageBucket: "ampup-f3c11.firebasestorage.app",
            messagingSenderId: "966376787228",
            appId: "1:966376787228:web:c0cb0fe19a0a3ca2f87ed9"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Make Firebase instances globally available
        window.firebaseApp = app;
        window.firebaseDb = db;
        window.firebaseAuth = auth;
        window.firestore = { collection, doc, getDoc, setDoc, updateDoc, addDoc, query, where, getDocs, onSnapshot, serverTimestamp };
        window.firebaseAuthMethods = { signInAnonymously, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged };

        // Log Firebase initialization
        if (typeof console !== 'undefined') {
            console.log('✅ Firebase initialized successfully');
        }
    </script>
    <script>
        // Verify Chart.js loaded
        (function() {
            function checkChartJS() {
                if (typeof Chart !== 'undefined') {
                    if (typeof logger !== 'undefined') logger.log('✅ Chart.js loaded successfully');
                } else {
                    if (typeof logger !== 'undefined') logger.warn('⚠️ Chart.js not yet loaded, will retry...');
                    setTimeout(checkChartJS, 100);
                }
            }
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', checkChartJS);
            } else {
                checkChartJS();
            }
        })();
    </script>
    <script>
        (function() {
            'use strict';
            
            // Initialize theme based on user preference or stored value
            var prefersLight = (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches);
            var stored = null;
            try { stored = localStorage.getItem('ampup-theme'); } catch (_) {}
            var theme = stored || (prefersLight ? 'light' : 'dark');
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>
    <style>
        :root {
            --bg-color: #0A0A0A;
            --surface-color: #151515;
            --surface-elevated: #1F1F1F;
            --text-primary: #FFFFFF;
            --text-secondary: #B0B0B0;
            --accent-primary: #BE38F3;
            --accent-secondary: #F43F5E;
            --accent-glow: rgba(190, 56, 243, 0.4);
            --border-color: #2A2A2A;
            --border-hover: #3A3A3A;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);
            --shadow-glow: 0 0 24px rgba(190, 56, 243, 0.3);
            
            /* Semantic Colors */
            --color-success: #10B981;
            --color-success-bg: rgba(16, 185, 129, 0.1);
            --color-warning: #F59E0B;
            --color-warning-bg: rgba(245, 158, 11, 0.1);
            --color-error: #EF4444;
            --color-error-bg: rgba(239, 68, 68, 0.1);
            --color-info: #3B82F6;
            --color-info-bg: rgba(59, 130, 246, 0.1);
            
            /* Spacing Scale (4px base) */
            --spacing-xs: 0.25rem;   /* 4px */
            --spacing-sm: 0.5rem;   /* 8px */
            --spacing-md: 1rem;     /* 16px */
            --spacing-lg: 1.5rem;   /* 24px */
            --spacing-xl: 2rem;     /* 32px */
            --spacing-2xl: 3rem;    /* 48px */
            --spacing-3xl: 4rem;    /* 64px */
            
            /* Typography Scale */
            --font-size-xs: 0.75rem;    /* 12px */
            --font-size-sm: 0.875rem;  /* 14px */
            --font-size-base: 1rem;    /* 16px */
            --font-size-lg: 1.125rem;  /* 18px */
            --font-size-xl: 1.25rem;   /* 20px */
            --font-size-2xl: 1.5rem;   /* 24px */
            --font-size-3xl: 2rem;     /* 32px */
            --font-size-4xl: 2.5rem;   /* 40px */
            
            /* Line Heights */
            --line-height-tight: 1.2;
            --line-height-normal: 1.5;
            --line-height-relaxed: 1.6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Sora', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--bg-color) 0%, #0F0F0F 50%, var(--bg-color) 100%);
            background-attachment: fixed;
            color: var(--text-primary);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-size: var(--font-size-base);
            line-height: var(--line-height-relaxed);
        }

        /* Typography Hierarchy */
        h1, .h1 {
            font-size: var(--font-size-4xl);
            font-weight: 800;
            line-height: var(--line-height-tight);
            letter-spacing: -0.02em;
            margin-bottom: var(--spacing-lg);
        }

        h2, .h2 {
            font-size: var(--font-size-3xl);
            font-weight: 800;
            line-height: var(--line-height-tight);
            letter-spacing: -0.02em;
            margin-bottom: var(--spacing-md);
        }

        h3, .h3 {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            line-height: var(--line-height-tight);
            letter-spacing: -0.02em;
            margin-bottom: var(--spacing-md);
        }

        h4, .h4 {
            font-size: var(--font-size-xl);
            font-weight: 600;
            line-height: var(--line-height-normal);
            margin-bottom: var(--spacing-sm);
        }

        p {
            font-size: var(--font-size-base);
            line-height: var(--line-height-relaxed);
            margin-bottom: var(--spacing-md);
        }

        .font-extrabold-heading { 
            font-weight: 800; 
            letter-spacing: -0.02em; 
        }

        .gradient-text {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            background-size: 200% 200%;
            animation: gradient-shift 3s ease infinite;
        }

        @keyframes gradient-shift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .gradient-bg {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            position: relative;
            overflow: hidden;
        }

        .gradient-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .gradient-bg:hover:not(:disabled)::before {
            left: 100%;
        }

        .gradient-bg:hover:not(:disabled) {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 24px var(--accent-glow), var(--shadow-lg);
        }
        
        .gradient-bg:active:not(:disabled) {
            transform: translateY(0) scale(0.98);
            transition: transform 0.1s ease;
        }
        
        /* Ripple effect for buttons */
        .btn-primary,
        .btn-secondary,
        .gradient-bg {
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary::after,
        .btn-secondary::after,
        .gradient-bg::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn-primary:active::after,
        .btn-secondary:active::after,
        .gradient-bg:active::after {
            width: 300px;
            height: 300px;
        }

        .accent-text { 
            color: var(--accent-primary); 
        }

        .surface-card { 
            background: linear-gradient(135deg, var(--surface-color) 0%, var(--surface-elevated) 100%);
            border: 1px solid var(--border-color); 
            border-radius: 12px;
            padding: 1rem;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .surface-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.05), transparent);
            transition: left 0.5s ease;
        }

        .surface-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md), 0 0 20px rgba(190, 56, 243, 0.1);
            border-color: var(--border-hover);
        }

        .surface-card:hover::before {
            left: 100%;
        }

        .surface-card:active {
            transform: translateY(-2px);
        }
        
        @media (min-width: 768px) {
            .surface-card {
                border-radius: 16px;
                padding: 1.25rem;
            }
        }

        /* Improved spacing and layout */
        section {
            margin-bottom: 2rem;
        }

        /* Cleaner section headers */
        section h3 {
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        @keyframes fadeIn { 
            from { 
                opacity: 0; 
                transform: translateY(10px); 
            } 
            to { 
                opacity: 1; 
                transform: translateY(0); 
            } 
        }

        .fade-in { 
            animation: fadeIn 0.5s ease-out forwards; 
        }

        /* Enhanced Animation System */
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideLeft {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideRight {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes scaleOut {
            from {
                opacity: 1;
                transform: scale(1);
            }
            to {
                opacity: 0;
                transform: scale(0.9);
            }
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        @keyframes glow {
            0%, 100% {
                box-shadow: 0 0 10px var(--accent-glow);
            }
            50% {
                box-shadow: 0 0 20px var(--accent-glow), 0 0 30px var(--accent-glow);
            }
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-8px);
            }
        }

        @keyframes rotateIn {
            from {
                opacity: 0;
                transform: rotate(-180deg) scale(0.8);
            }
            to {
                opacity: 1;
                transform: rotate(0deg) scale(1);
            }
        }

        /* Spring Physics Animations */
        @keyframes spring {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }
            50% {
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.95);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Stagger Animation Classes */
        .animate-slide-up {
            animation: slideUp 0.5s ease-out forwards;
        }

        .animate-slide-down {
            animation: slideDown 0.5s ease-out forwards;
        }

        .animate-slide-left {
            animation: slideLeft 0.5s ease-out forwards;
        }

        .animate-slide-right {
            animation: slideRight 0.5s ease-out forwards;
        }

        .animate-scale-in {
            animation: scaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        .animate-scale-out {
            animation: scaleOut 0.3s ease-in forwards;
        }

        .animate-bounce {
            animation: bounce 0.6s ease-in-out;
        }

        .animate-shake {
            animation: shake 0.5s ease-in-out;
        }

        .animate-glow {
            animation: glow 2s ease-in-out infinite;
        }

        .animate-float {
            animation: float 3s ease-in-out infinite;
        }

        .animate-spring {
            animation: spring 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        /* Smooth Scroll Behavior */
        html {
            scroll-behavior: smooth;
        }

        /* Page Transition */
        .page-transition {
            animation: fadeIn 0.4s ease-out forwards;
        }

        /* Stagger Delay Utilities */
        .stagger-1 { animation-delay: 0.1s; }
        .stagger-2 { animation-delay: 0.2s; }
        .stagger-3 { animation-delay: 0.3s; }
        .stagger-4 { animation-delay: 0.4s; }
        .stagger-5 { animation-delay: 0.5s; }

        /* Reduced motion support for animations */
        @media (prefers-reduced-motion: reduce) {
            .animate-slide-up,
            .animate-slide-down,
            .animate-slide-left,
            .animate-slide-right,
            .animate-scale-in,
            .animate-scale-out,
            .animate-bounce,
            .animate-shake,
            .animate-glow,
            .animate-float,
            .animate-spring {
                animation: none;
                opacity: 1;
                transform: none;
            }
            
            html {
                scroll-behavior: auto;
            }
        }

        .hidden { 
            display: none; 
        }
        
        /* --- PLAYER PERSONA STYLES --- */
        /* Persona-specific color schemes and emphasis */
        
        /* Achiever Persona - Gold/Yellow emphasis */
        .persona-achiever {
            --persona-accent: #F59E0B;
            --persona-accent-glow: rgba(245, 158, 11, 0.3);
        }
        
        .persona-achiever .achievement-card {
            border-color: var(--persona-accent);
        }
        
        .persona-achiever .progress-bar-fill {
            background: linear-gradient(90deg, var(--persona-accent) 0%, #FCD34D 100%);
        }
        
        /* Explorer Persona - Blue/Cyan emphasis */
        .persona-explorer {
            --persona-accent: #3B82F6;
            --persona-accent-glow: rgba(59, 130, 246, 0.3);
        }
        
        .persona-explorer .content-creation-card {
            border-color: var(--persona-accent);
            box-shadow: 0 0 20px var(--persona-accent-glow);
        }
        
        /* Socializer Persona - Green/Teal emphasis */
        .persona-socializer {
            --persona-accent: #10B981;
            --persona-accent-glow: rgba(16, 185, 129, 0.3);
        }
        
        .persona-socializer .team-card,
        .persona-socializer .social-feed-card {
            border-color: var(--persona-accent);
        }
        
        /* Killer Persona - Red/Orange emphasis */
        .persona-killer {
            --persona-accent: #EF4444;
            --persona-accent-glow: rgba(239, 68, 68, 0.3);
        }
        
        .persona-killer .leaderboard-card,
        .persona-killer .competitive-metric {
            border-color: var(--persona-accent);
            box-shadow: 0 0 20px var(--persona-accent-glow);
        }
        
        /* Persona-specific button emphasis */
        .persona-achiever .btn-primary {
            background: linear-gradient(135deg, #F59E0B 0%, #FCD34D 100%);
        }
        
        .persona-explorer .btn-primary {
            background: linear-gradient(135deg, #3B82F6 0%, #60A5FA 100%);
        }
        
        .persona-socializer .btn-primary {
            background: linear-gradient(135deg, #10B981 0%, #34D399 100%);
        }
        
        .persona-killer .btn-primary {
            background: linear-gradient(135deg, #EF4444 0%, #F87171 100%);
        }
        
        /* Persona-specific card emphasis */
        .persona-achiever .achievement-card.unlocked {
            border-color: #F59E0B;
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.2);
        }
        
        .persona-explorer .content-creation-card {
            border-color: #3B82F6;
        }
        
        .persona-socializer .team-card {
            border-color: #10B981;
        }
        
        .persona-killer .competitive-metric {
            border-color: #EF4444;
        }
        
        /* Persona indicator badge */
        .persona-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
        }
        
        .persona-badge.achiever {
            border-color: #F59E0B;
            color: #F59E0B;
        }
        
        .persona-badge.explorer {
            border-color: #3B82F6;
            color: #3B82F6;
        }
        
        .persona-badge.socializer {
            border-color: #10B981;
            color: #10B981;
        }
        .persona-badge.killer {
            border-color: #EF4444;
            color: #EF4444;
        }
        
        /* --- WHEEL SPIN STYLES --- */
        .wheel-container {
            position: relative;
            width: 500px;
            height: 500px;
            margin: 2rem auto;
            padding: 20px;
        }
        
        .wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            border: 12px solid rgba(255, 255, 255, 0.1);
            box-shadow: 
                0 0 50px rgba(0, 0, 0, 0.8),
                inset 0 0 60px rgba(0, 0, 0, 0.4),
                0 0 100px rgba(190, 56, 243, 0.3);
            background: radial-gradient(circle at center, rgba(30, 30, 40, 0.9) 0%, rgba(20, 20, 30, 1) 100%);
            transition: transform 5s cubic-bezier(0.17, 0.67, 0.12, 0.99);
        }
        
        .wheel-spinning {
            animation: wheelSpin 5s cubic-bezier(0.17, 0.67, 0.12, 0.99);
        }
        
        @keyframes wheelSpin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(1800deg);
            }
        }
        
        .wheel-segment {
            position: absolute;
            width: 50%;
            height: 50%;
            transform-origin: 100% 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px;
            box-sizing: border-box;
            border-right: 2px solid rgba(255, 255, 255, 0.15);
            transition: all 0.2s ease;
        }
        
        .wheel-segment::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }
        
        .wheel-segment-common {
            background: linear-gradient(135deg, #6B7280 0%, #4B5563 100%);
        }
        
        .wheel-segment-rare {
            background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
            box-shadow: inset 0 0 20px rgba(59, 130, 246, 0.3);
        }
        
        .wheel-segment-epic {
            background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
            box-shadow: inset 0 0 25px rgba(139, 92, 246, 0.4);
        }
        
        .wheel-segment-legendary {
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
            box-shadow: 
                inset 0 0 30px rgba(245, 158, 11, 0.5),
                0 0 20px rgba(245, 158, 11, 0.3);
            animation: legendaryGlow 2s ease-in-out infinite;
        }
        
        @keyframes legendaryGlow {
            0%, 100% {
                box-shadow: 
                    inset 0 0 30px rgba(245, 158, 11, 0.5),
                    0 0 20px rgba(245, 158, 11, 0.3);
            }
            50% {
                box-shadow: 
                    inset 0 0 40px rgba(245, 158, 11, 0.7),
                    0 0 30px rgba(245, 158, 11, 0.5);
            }
        }
        
        @keyframes winningPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 rgba(255, 255, 255, 0);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 30px rgba(255, 255, 255, 0.6);
            }
        }
        
        .wheel-segment-content {
            transform: rotate(0deg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            text-align: center;
            z-index: 1;
        }
        
        .wheel-segment-icon {
            font-size: 2.5rem;
            line-height: 1;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
            margin-bottom: 2px;
        }
        
        .wheel-segment-name {
            font-size: 0.7rem;
            font-weight: 700;
            color: white;
            text-shadow: 
                1px 1px 2px rgba(0, 0, 0, 0.8),
                0 0 8px rgba(0, 0, 0, 0.5);
            line-height: 1.1;
            max-width: 90%;
            word-wrap: break-word;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .wheel-segment-value {
            font-size: 0.65rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
            margin-top: 2px;
        }
        
        .wheel-pointer {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 25px solid transparent;
            border-right: 25px solid transparent;
            border-top: 50px solid #BE38F3;
            z-index: 15;
            filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.6));
        }
        .wheel-pointer::before {
            content: '';
            position: absolute;
            top: -45px;
            left: -20px;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #BE38F3 0%, #9D28D9 100%);
            border-radius: 50%;
            box-shadow: 0 4px 15px rgba(190, 56, 243, 0.6);
        }
        
        .wheel-pointer::after {
            content: '';
            position: absolute;
            top: -40px;
            left: -15px;
            width: 30px;
            height: 30px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
        }
        
        .spin-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #BE38F3 0%, #9D28D9 50%, #7C3AED 100%);
            border: 5px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1.1rem;
            font-weight: 900;
            cursor: pointer;
            z-index: 25;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            box-shadow: 
                0 8px 30px rgba(190, 56, 243, 0.5),
                inset 0 2px 10px rgba(255, 255, 255, 0.2),
                inset 0 -2px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .spin-button::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(190, 56, 243, 0.5), rgba(156, 39, 176, 0.5));
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .spin-button:hover:not(:disabled)::before {
            opacity: 1;
            animation: pulseGlow 1.5s ease-in-out infinite;
        }
        
        @keyframes pulseGlow {
            0%, 100% {
                transform: scale(1);
                opacity: 0.5;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
        }
        
        .spin-button:hover:not(:disabled) {
            transform: translate(-50%, -50%) scale(1.08);
            box-shadow: 
                0 12px 40px rgba(190, 56, 243, 0.7),
                inset 0 2px 10px rgba(255, 255, 255, 0.3),
                inset 0 -2px 10px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .spin-button:active:not(:disabled) {
            transform: translate(-50%, -50%) scale(1.02);
        }
        
        .spin-button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background: linear-gradient(135deg, #4B5563 0%, #374151 100%);
        }
        
        .spin-button-text {
            font-size: 1.1rem;
            font-weight: 900;
            line-height: 1;
        }
        
        .spin-button-subtext {
            font-size: 0.65rem;
            font-weight: 600;
            opacity: 0.9;
            line-height: 1;
        }
        
        /* Responsive wheel design */
        @media (max-width: 640px) {
            .wheel-container {
                width: 350px;
                height: 350px;
                padding: 15px;
            }
            
            .wheel-segment-icon {
                font-size: 2rem;
            }
            
            .wheel-segment-name {
                font-size: 0.6rem;
            }
            
            .wheel-segment-value {
                font-size: 0.55rem;
            }
            
            .spin-button {
                width: 100px;
                height: 100px;
                font-size: 0.95rem;
            }
            
            .spin-button-text {
                font-size: 0.95rem;
            }
            
            .spin-button-subtext {
                font-size: 0.6rem;
            }
            
            .wheel-pointer {
                border-left-width: 20px;
                border-right-width: 20px;
                border-top-width: 40px;
                top: -12px;
            }
            
            .wheel-pointer::before {
                width: 35px;
                height: 35px;
                top: -40px;
                left: -17.5px;
            }
            
            .wheel-pointer::after {
                width: 25px;
                height: 25px;
                top: -35px;
                left: -12.5px;
            }
        }
        
        /* --- SHOP STYLES --- */
        .shop-item-card {
            background: linear-gradient(135deg, var(--surface-color) 0%, var(--surface-elevated) 100%);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .shop-item-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(190, 56, 243, 0.3);
        }
        
        .shop-item-card.affordable {
            border-color: var(--color-success);
        }
        
        .shop-item-card.unaffordable {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* --- BATTLE PASS STYLES --- */
        .battle-pass-track {
            background: var(--surface-color);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        
        .battle-pass-milestone {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 12px;
            background: var(--bg-color);
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .battle-pass-milestone.unlocked {
            border-color: var(--color-success);
            background: rgba(16, 185, 129, 0.1);
        }
        
        .battle-pass-milestone.claimed {
            opacity: 0.5;
        }
        
        .battle-pass-milestone.claimable {
            border-color: var(--accent-primary);
            background: rgba(190, 56, 243, 0.1);
            cursor: pointer;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(190, 56, 243, 0.4);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(190, 56, 243, 0);
            }
        }

        input[type="text"], input[type="email"], textarea {
            background: var(--surface-color); 
            border: 2px solid var(--border-color); 
            color: var(--text-primary); 
            border-radius: 12px; 
            padding: 0.875rem 1rem;
            width: 100%;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.9375rem;
        }

        input:hover, textarea:hover {
            border-color: var(--border-hover);
        }

        input:focus, textarea:focus {
            outline: none; 
            border-color: var(--accent-primary); 
            box-shadow: 0 0 0 2px var(--accent-primary), 0 0 0 4px var(--accent-glow), var(--shadow-md);
            background: var(--surface-elevated);
        }

        /* Improved Focus States for Accessibility */
        /* Enhanced Button Micro-interactions */
        .btn-primary,
        .btn-secondary,
        button:not(.no-interaction) {
            position: relative;
            overflow: hidden;
            transform: translateZ(0);
            backface-visibility: hidden;
        }

        .btn-primary::before,
        .btn-secondary::before,
        button:not(.no-interaction)::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn-primary:hover:not(:disabled)::before,
        .btn-secondary:hover:not(:disabled)::before,
        button:not(.no-interaction):hover:not(:disabled)::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary:active:not(:disabled),
        .btn-secondary:active:not(:disabled),
        button:not(.no-interaction):active:not(:disabled) {
            transform: scale(0.98);
            transition: transform 0.1s ease;
        }

        /* Card Lift Effect */
        .card-lift {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), 
                        box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card-lift:hover {
            transform: translateY(-6px) scale(1.02);
            box-shadow: var(--shadow-lg), 0 0 30px rgba(190, 56, 243, 0.15);
        }

        .card-lift:active {
            transform: translateY(-3px) scale(1.01);
        }

        /* Icon Animations */
        .icon-bounce:hover {
            animation: bounce 0.6s ease-in-out;
        }

        .icon-pulse {
            animation: pulse 2s ease-in-out infinite;
        }

        .icon-rotate:hover {
            animation: rotateIn 0.5s ease-out;
        }

        /* Badge Animations */
        .badge-pulse {
            animation: pulse 2s ease-in-out infinite;
        }

        .badge-glow {
            animation: glow 2s ease-in-out infinite;
        }

        /* Enhanced Focus States */
        button:focus-visible,
        a:focus-visible,
        .nav-item:focus-visible,
        input:focus-visible,
        textarea:focus-visible,
        select:focus-visible {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
            outline-style: solid;
        }

        /* Keyboard Navigation Indicator */
        .keyboard-navigation *:focus {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }

        /* Screen Reader Only Content */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Skip Link */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--accent-primary);
            color: white;
            padding: 8px 16px;
            text-decoration: none;
            z-index: 10000;
            border-radius: 0 0 4px 0;
        }

        .skip-link:focus {
            top: 0;
        }

        /* Semantic Color Utilities */
        .text-success { color: var(--color-success); }
        .text-warning { color: var(--color-warning); }
        .text-error { color: var(--color-error); }
        .text-info { color: var(--color-info); }

        .bg-success { background-color: var(--color-success-bg); }
        .bg-warning { background-color: var(--color-warning-bg); }
        .bg-error { background-color: var(--color-error-bg); }
        .bg-info { background-color: var(--color-info-bg); }

        .border-success { border-color: var(--color-success); }
        .border-warning { border-color: var(--color-warning); }
        .border-error { border-color: var(--color-error); }
        .border-info { border-color: var(--color-info); }

        /* Button Base Styles */
        button {
            border-radius: 12px; 
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            padding: 0.875rem 1.75rem;
            font-weight: 600;
            font-size: var(--font-size-base);
            position: relative;
            overflow: hidden;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
        }

        button:active {
            transform: scale(0.98);
        }

        button:disabled { 
            background: var(--surface-color); 
            color: #6B7280; 
            cursor: not-allowed; 
            border: 1px solid var(--border-color);
            opacity: 0.6;
        }

        /* Button Variants */
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px var(--accent-glow), var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--surface-color);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--surface-elevated);
            border-color: var(--border-hover);
        }

        .btn-tertiary {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid transparent;
        }

        .btn-tertiary:hover:not(:disabled) {
            color: var(--text-primary);
            background: var(--surface-color);
        }

        .btn-danger {
            background: var(--color-error);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #DC2626;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }
        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, var(--surface-color) 25%, var(--surface-elevated) 50%, var(--surface-color) 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s ease-in-out infinite;
            border-radius: 8px;
        }

        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-text {
            height: 1em;
            margin-bottom: var(--spacing-sm);
        }

        .skeleton-title {
            height: 1.5em;
            width: 60%;
            margin-bottom: var(--spacing-md);
        }

        .skeleton-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
        }

        .skeleton-card {
            padding: var(--spacing-lg);
            border-radius: 12px;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
        }

        /* Enhanced Empty States */
        .empty-state {
            text-align: center;
            padding: var(--spacing-3xl) var(--spacing-xl);
            color: var(--text-secondary);
            animation: fadeIn 0.5s ease-out;
        }

        .empty-state-icon {
            font-size: 5rem;
            margin-bottom: var(--spacing-lg);
            opacity: 0.6;
            animation: float 3s ease-in-out infinite;
            filter: drop-shadow(0 4px 12px rgba(190, 56, 243, 0.2));
            display: block;
        }

        .empty-state-title {
            font-size: var(--font-size-xl);
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--spacing-sm);
            animation: slideUp 0.5s ease-out 0.1s both;
        }

        .empty-state-description {
            font-size: var(--font-size-base);
            color: var(--text-secondary);
            margin-bottom: var(--spacing-lg);
            line-height: var(--line-height-relaxed);
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
            animation: slideUp 0.5s ease-out 0.2s both;
        }

        .empty-state-action {
            margin-top: var(--spacing-xl);
            animation: slideUp 0.5s ease-out 0.3s both;
        }

        /* Empty State Variants */
        .empty-state.success .empty-state-icon {
            color: var(--color-success);
        }

        .empty-state.info .empty-state-icon {
            color: var(--color-info);
        }

        .empty-state.warning .empty-state-icon {
            color: var(--color-warning);
        }

        /* Form Improvements */
        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-label {
            display: block;
            font-size: var(--font-size-sm);
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-sm);
        }

        .form-label .required {
            color: var(--color-error);
            margin-left: 4px;
        }

        .form-help {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
            margin-top: var(--spacing-xs);
        }

        .form-error {
            font-size: var(--font-size-xs);
            color: var(--color-error);
            margin-top: var(--spacing-xs);
            display: flex;
            align-items: center;
            gap: 4px;
            animation: slideDown 0.3s ease-out;
        }

        .form-success {
            font-size: var(--font-size-xs);
            color: var(--color-success);
            margin-top: var(--spacing-xs);
            display: flex;
            align-items: center;
            gap: 4px;
            animation: slideDown 0.3s ease-out;
        }

        .form-field-error input,
        .form-field-error textarea,
        .form-field-error select {
            border-color: var(--color-error);
            animation: shake 0.5s ease-in-out;
        }

        .form-field-success input,
        .form-field-success textarea,
        .form-field-success select {
            border-color: var(--color-success);
        }

        .form-field-validating input,
        .form-field-validating textarea,
        .form-field-validating select {
            border-color: var(--color-info);
        }

        /* Real-time validation indicator */
        .field-validation-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1rem;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .field-validation-icon.valid {
            color: var(--color-success);
        }

        .field-validation-icon.invalid {
            color: var(--color-error);
        }

        .field-validation-icon.validating {
            color: var(--color-info);
            animation: spin 1s linear infinite;
        }

        /* Form field wrapper for validation */
        .form-field-wrapper {
            position: relative;
        }

        .character-count {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
            text-align: right;
            margin-top: var(--spacing-xs);
        }

        .character-count.warning {
            color: var(--color-warning);
        }

        .character-count.error {
            color: var(--color-error);
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
        }

        .badge.gold { background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); color: #000; }
        .badge.silver { background: linear-gradient(135deg, #c0c0c0 0%, #808080 100%); color: #000; }
        .badge.bronze { background: linear-gradient(135deg, #cd7f32 0%, #8b4513 100%); color: #fff; }
        .badge.gray {
            background: var(--bg-color);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        /* Admin Styles */
        .admin-tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .admin-tab:hover {
            color: var(--text-primary);
            background: var(--bg-color);
        }

        .admin-tab.active {
            color: var(--accent-primary);
            border-bottom-color: var(--accent-primary);
        }
        .badge.purple { background: var(--accent-primary); color: #fff; }

        .points-breakdown {
            background: var(--bg-color);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .points-breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .points-breakdown-item:last-child {
            border-bottom: none;
            font-weight: 600;
            margin-top: 0.5rem;
            padding-top: 0.75rem;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            min-width: 300px;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3), 0 0 20px rgba(190, 56, 243, 0.1);
            animation: slideInRight 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex;
            align-items: flex-start;
            gap: 12px;
            position: relative;
            backdrop-filter: blur(10px);
        }

        .toast::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            border-radius: 12px 0 0 12px;
        }
        .toast-icon {
            font-size: 1.25rem;
            line-height: 1;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .toast.success .toast-icon {
            color: var(--color-success);
        }

        .toast.error .toast-icon {
            color: var(--color-error);
        }

        .toast.warning .toast-icon {
            color: var(--color-warning);
        }

        .toast.info .toast-icon {
            color: var(--color-info);
        }
        .toast-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast-message {
            font-size: var(--font-size-sm);
            line-height: var(--line-height-normal);
        }

        .toast-actions {
            display: flex;
            gap: 8px;
            margin-top: 4px;
        }

        .toast-action {
            background: transparent;
            border: none;
            color: var(--accent-primary);
            font-size: var(--font-size-xs);
            font-weight: 600;
            padding: 4px 8px;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .toast-action:hover {
            background: var(--surface-elevated);
        }

        .toast-close {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .toast-close:hover {
            color: var(--text-primary);
            background: var(--surface-elevated);
        }

        .toast.success {
            border-left: 4px solid var(--color-success);
        }

        .toast.success::before {
            background: var(--color-success);
        }

        .toast.error {
            border-left: 4px solid var(--color-error);
        }

        .toast.error::before {
            background: var(--color-error);
        }

        .toast.info {
            border-left: 4px solid var(--color-info);
        }

        .toast.info::before {
            background: var(--color-info);
        }

        .toast.warning {
            border-left: 4px solid var(--color-warning);
        }

        .toast.warning::before {
            background: var(--color-warning);
        }

        .toast:hover {
            transform: translateX(-4px);
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.4), 0 0 30px rgba(190, 56, 243, 0.15);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .toast.fade-out {
            animation: slideOutRight 0.3s ease-out forwards;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--accent-primary);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Skeleton Screen Styles */
        .skeleton {
            background: linear-gradient(
                90deg,
                var(--surface-color) 0%,
                var(--surface-elevated) 50%,
                var(--surface-color) 100%
            );
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s ease-in-out infinite;
            border-radius: 8px;
        }

        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-card {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            overflow: hidden;
        }

        .skeleton-card .skeleton {
            height: 1rem;
            margin-bottom: 0.75rem;
        }

        .skeleton-card .skeleton:last-child {
            margin-bottom: 0;
            width: 60%;
        }

        .skeleton-title {
            height: 1.5rem;
            width: 70%;
            margin-bottom: 1rem;
        }

        .skeleton-text {
            height: 0.875rem;
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .skeleton-text.short {
            width: 80%;
        }

        .skeleton-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
        }

        .skeleton-button {
            height: 2.5rem;
            width: 120px;
            border-radius: 8px;
        }

        .skeleton-chart {
            height: 250px;
            width: 100%;
            border-radius: 12px;
        }

        .skeleton-list-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .skeleton-list-item:last-child {
            border-bottom: none;
        }

        /* Loading States */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 10, 10, 0.8);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            border-radius: 12px;
        }

        .loading-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            color: var(--text-primary);
        }

        .loading-spinner-large {
            width: 48px;
            height: 48px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .loading-text {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-align: center;
        }

        /* Contextual Loading Indicators */
        .loading-inline {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .loading-inline .spinner {
            width: 16px;
            height: 16px;
            border-width: 2px;
        }

        /* Progress Indicator */
        .progress-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: var(--surface-color);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .progress-indicator .spinner {
            width: 20px;
            height: 20px;
            border-width: 2px;
        }

        /* Fade in animation for loaded content */
        @keyframes contentFadeIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .content-loaded {
            animation: contentFadeIn 0.4s ease-out forwards;
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            .skeleton,
            .skeleton-loading,
            .spinner,
            .loading-spinner-large {
                animation: none;
            }
            
            .skeleton {
                background: var(--surface-elevated);
            }
            
            .content-loaded {
                animation: none;
            }
        }
        /* Copy Editor */
        .copy-editor {
            background: var(--bg-color);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            min-height: 150px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.2s;
        }
        .copy-editor:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .copy-preview {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            white-space: pre-wrap;
            line-height: 1.6;
        }

        .character-count {
            text-align: right;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        .character-count.warning {
            color: #f59e0b;
        }

        .character-count.error {
            color: #ef4444;
        }

        /* Enhanced Stats Cards */
        .stat-card {
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }


        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(to right, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Progress Bars */
        .progress-bar-container {
            background: var(--border-color);
            border-radius: 8px;
            height: 12px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(to right, var(--accent-primary), var(--accent-secondary));
            border-radius: 8px;
            transition: width 1s ease-out;
            position: relative;
        }

        .progress-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            background-color: var(--surface-color);
            color: var(--text-primary);
            text-align: center;
            border-radius: 6px;
            padding: 8px 12px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
            white-space: nowrap;
            border: 1px solid var(--border-color);
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Pulse Animation */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Enhanced Smooth Transitions */
        * {
            transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
        }

        /* Specific transition optimizations */
        button, a, .surface-card, .stat-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        input, textarea, select {
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
        }

        /* Stagger Animation Utilities */
        .stagger-container {
            opacity: 0;
        }

        .stagger-item {
            opacity: 0;
            animation: slideUp 0.5s ease-out forwards;
        }

        .stagger-item:nth-child(1) { animation-delay: 0.05s; }
        .stagger-item:nth-child(2) { animation-delay: 0.1s; }
        .stagger-item:nth-child(3) { animation-delay: 0.15s; }
        .stagger-item:nth-child(4) { animation-delay: 0.2s; }
        .stagger-item:nth-child(5) { animation-delay: 0.25s; }
        .stagger-item:nth-child(6) { animation-delay: 0.3s; }
        .stagger-item:nth-child(7) { animation-delay: 0.35s; }
        .stagger-item:nth-child(8) { animation-delay: 0.4s; }
        .stagger-item:nth-child(9) { animation-delay: 0.45s; }
        .stagger-item:nth-child(10) { animation-delay: 0.5s; }
        .stagger-item:nth-child(n+11) { animation-delay: 0.55s; }

        /* Mobile Optimizations & Touch Enhancements */
        @media (max-width: 768px) {
            #amplifier-app {
                padding: 1rem;
            }

            .stat-value {
                font-size: 2rem;
            }

            .toast {
                min-width: calc(100vw - 40px);
                right: 20px;
                left: 20px;
            }

            /* Touch-optimized tap targets */
            button, a, .surface-card, .card-lift {
                min-height: 44px;
                min-width: 44px;
            }

            /* Bottom sheet modal for mobile */
            .modal-content {
                max-height: 90vh;
                overflow-y: auto;
                border-radius: 20px 20px 0 0;
            }

            @media (max-width: 640px) {
                .modal-content {
                    max-width: 100vw;
                    margin: 0;
                    border-radius: 20px 20px 0 0;
                    position: fixed;
                    bottom: 0;
                    left: 0;
                    right: 0;
                    max-height: 85vh;
                    animation: slideUp 0.3s ease-out;
                }

                .modal.active .modal-content {
                    animation: slideUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
                }
            }

            /* Improved mobile form inputs */
            input, textarea, select {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 0.875rem;
            }

            /* Swipe gestures hint */
            .swipe-hint {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                color: var(--text-secondary);
                font-size: 0.75rem;
                margin-top: 0.5rem;
            }

            /* Mobile-specific loading states */
            .loading-overlay {
                border-radius: 0;
            }

            /* Chart mobile optimizations */
            canvas {
                max-width: 100%;
                height: auto !important;
            }
        }

        /* Touch device optimizations */
        @media (hover: none) and (pointer: coarse) {
            .surface-card:hover,
            .card-lift:hover {
                transform: none;
            }

            button:active,
            .btn-primary:active,
            .btn-secondary:active {
                transform: scale(0.95);
                transition: transform 0.1s ease;
            }

            /* Larger touch targets */
            .toast-close {
                width: 32px;
                height: 32px;
            }
        }

        /* Selection Styling */
        ::selection {
            background: var(--accent-primary);
            color: white;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-color);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--surface-color);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--border-color);
        }

        /* Table Styling */
        table {
            border-collapse: collapse;
            width: 100%;
        }

        table th {
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.75rem;
        }

        table td, table th {
            padding: 0.75rem 1rem;
        }


        /* Improved spacing */
        .space-y-8 > * + * {
            margin-top: 2rem;
        }

        .space-y-6 > * + * {
            margin-top: 1.5rem;
        }

        .space-y-4 > * + * {
            margin-top: 1rem;
        }

        .space-y-3 > * + * {
            margin-top: 0.75rem;
        }

        /* Better card padding consistency */
        .surface-card {
            padding: 1.5rem;
        }

        @media (min-width: 768px) {
            .surface-card {
                padding: 2rem;
            }
        }

        /* Collapsible Sections */
        .collapsible-section {
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.2s ease-out, margin 0.3s ease-out, padding 0.3s ease-out;
            max-height: 5000px;
            opacity: 1;
        }

        .collapsible-section.collapsed {
            max-height: 0 !important;
            opacity: 0;
            margin-top: 0 !important;
            margin-bottom: 0 !important;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
        }

        .toggle-button {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .toggle-button:hover {
            background: var(--surface-color);
            border-color: var(--accent-primary);
        }

        .toggle-button .icon {
            transition: transform 0.3s;
        }

        .toggle-button.expanded .icon {
            transform: rotate(180deg);
        }

        /* Hero Image */
        .drop-hero-image {
            width: 100%;
            height: 350px;
            object-fit: cover;
            margin: 0;
            display: block;
            border-radius: 16px;
        }

        @media (min-width: 768px) {
            .drop-hero-image {
                height: 450px;
            }
        }

        /* Asset Images */
        .asset-image {
            border-radius: 12px;
            overflow: hidden;
        }

        /* Step Indicator */
        .step-indicator {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            position: relative;
            padding: 0 1rem;
        }

        .step-indicator::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--border-color);
            z-index: 0;
            border-radius: 2px;
            transform: translateY(-50%);
        }

        .step-indicator::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            z-index: 1;
            border-radius: 2px;
            transform: translateY(-50%);
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            width: 0%;
        }
        .step-indicator[data-progress="25"]::after { width: 25%; }
        .step-indicator[data-progress="50"]::after { width: 50%; }
        .step-indicator[data-progress="75"]::after { width: 75%; }
        .step-indicator[data-progress="100"]::after { width: 100%; }

        .step {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            cursor: pointer;
        }

        .step-circle {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--bg-color);
            border: 3px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.875rem;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            margin-bottom: 0.5rem;
            position: relative;
            color: var(--text-secondary);
        }
        .step-circle::before {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            border: 2px solid var(--accent-primary);
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.3s ease;
        }

        .step.active .step-circle {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(190, 56, 243, 0.4);
        }

        .step.active .step-circle::before {
            opacity: 1;
            transform: scale(1.2);
        }

        .step.completed .step-circle {
            background: #10b981;
            border-color: #10b981;
            color: white;
            animation: scaleIn 0.3s ease-out;
        }

        .step.completed .step-circle::after {
            content: '✓';
            font-size: 1.1rem;
            animation: rotateIn 0.4s ease-out;
        }

        .step.completed .step-circle:hover {
            transform: scale(1.05);
        }

        .step-label {
            font-size: 0.75rem;
            text-align: center;
            color: var(--text-secondary);
            max-width: 80px;
            transition: all 0.3s ease;
        }

        .step.active .step-label {
            color: var(--accent-primary);
            font-weight: 600;
            transform: translateY(-2px);
        }

        .step.completed .step-label {
            color: #10b981;
        }

        .step-content {
            display: none;
            opacity: 0;
            transform: translateX(20px);
        }

        .step-content.active {
            display: block;
            animation: slideLeft 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .step-navigation {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px solid var(--border-color);
        }

        /* Campaign Wizard Styles */
        .campaign-wizard-progress {
            margin-bottom: 2rem;
        }

        .wizard-steps {
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }

        .wizard-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            position: relative;
            z-index: 1;
        }

        .wizard-step-line {
            flex: 1;
            height: 2px;
            background: var(--border-color);
            margin: 0 0.5rem;
            position: relative;
            z-index: 0;
        }

        .wizard-step.active .wizard-step-line,
        .wizard-step.completed ~ .wizard-step-line {
            background: var(--accent-primary);
        }

        .wizard-step-circle {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--bg-color);
            border: 3px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.95rem;
            transition: all 0.3s;
            margin-bottom: 0.5rem;
        }

        .wizard-step.active .wizard-step-circle {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
            transform: scale(1.05);
        }

        .wizard-step.completed .wizard-step-circle {
            background: #10b981;
            border-color: #10b981;
            color: white;
        }

        .wizard-step.completed .wizard-step-circle::after {
            content: '✓';
            font-size: 1.2rem;
        }

        .wizard-step-label {
            font-size: 0.75rem;
            text-align: center;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .wizard-step.active .wizard-step-label {
            color: var(--accent-primary);
            font-weight: 600;
        }

        .campaign-wizard-step {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }

        .campaign-wizard-step.active {
            display: block;
        }
        .required {
            color: #ef4444;
        }

        .step-button {
            padding: 0.75rem 2rem;
            font-weight: 600;
            border-radius: 12px;
            transition: all 0.2s;
        }
        .step-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Campaign Card Refinements */
        .campaign-hero-card {
            border-radius: 24px;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
        }

        .reward-card {
            background: linear-gradient(135deg, rgba(190, 56, 243, 0.12) 0%, rgba(244, 63, 94, 0.12) 100%);
            border: 2px solid var(--accent-primary);
            border-radius: 24px;
            box-shadow: 0 0 40px rgba(190, 56, 243, 0.25), var(--shadow-lg);
        }

        .success-card {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(16, 185, 129, 0.15) 100%);
            border: 2px solid #22c55e;
            border-radius: 16px;
        }

        /* Badge Improvements */
        .badge {
            padding: 0.375rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            backdrop-filter: blur(10px);
        }

        .badge.purple { 
            background: rgba(190, 56, 243, 0.2);
            border: 1px solid var(--accent-primary);
            color: var(--accent-primary);
        }

        /* Button Refinements */
        .campaign-join-button {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            box-shadow: 0 4px 20px rgba(190, 56, 243, 0.4), var(--shadow-md);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .campaign-join-button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
        }

        .campaign-join-button:hover:not(:disabled)::after {
            width: 300px;
            height: 300px;
        }

        .campaign-join-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(190, 56, 243, 0.6), var(--shadow-lg);
        }

        .campaign-join-button:active {
            transform: translateY(-1px);
        }

        /* Stat Cards */
        .stat-mini {
            text-align: center;
            padding: 1.25rem;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.03) 0%, rgba(190, 56, 243, 0.03) 100%);
            border-radius: 16px;
            border: 1px solid var(--border-color);
        }

        /* Image Overlay Badges */
        .image-badge {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0);
            backdrop-filter: blur(0px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1), backdrop-filter 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
        }

        .modal {
            background: var(--surface-color);
            border: 2px solid var(--border-color);
            border-radius: 24px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9) translateY(30px);
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            padding: 2rem;
            opacity: 0;
            position: relative;
        }
        
        /* Staggered animation for modal content */
        .modal-overlay.active .modal > * {
            animation: fadeInUp 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            opacity: 0;
        }
        
        .modal-overlay.active .modal > *:nth-child(1) { animation-delay: 0.1s; }
        .modal-overlay.active .modal > *:nth-child(2) { animation-delay: 0.15s; }
        .modal-overlay.active .modal > *:nth-child(3) { animation-delay: 0.2s; }
        .modal-overlay.active .modal > *:nth-child(4) { animation-delay: 0.25s; }
        .modal-overlay.active .modal > *:nth-child(5) { animation-delay: 0.3s; }

        .modal-overlay.active .modal {
            transform: scale(1) translateY(0);
            opacity: 1;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Prevent body scroll when modal is open */
        body.modal-open {
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        /* Prize Filter Buttons */
        .prize-filter-btn {
            background: var(--surface-color);
            border: 2px solid var(--border-color);
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }

        .prize-filter-btn:hover {
            border-color: var(--accent-primary);
            color: var(--text-primary);
            transform: translateY(-2px);
        }

        .prize-filter-btn.active {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            border-color: var(--accent-primary);
            color: white;
            box-shadow: 0 4px 12px rgba(190, 56, 243, 0.4);
        }

        /* Mobile Responsive Enhancements */
        @media (max-width: 768px) {
            .prize-card {
                padding: 1rem;
                border-radius: 16px;
            }

            .prize-card:hover {
                transform: translateY(-4px);
            }

            .achievement-card {
                padding: 1rem;
                border-radius: 16px;
            }

            .achievement-card:hover {
                transform: translateY(-4px);
            }

            .achievement-unlock-animation {
                padding: 2rem 1.5rem;
                max-width: 90%;
            }

            .achievement-unlock-icon {
                font-size: 4rem;
            }

            .modal {
                padding: 1.5rem;
                border-radius: 20px;
                max-height: 95vh;
            }

            .prize-filter-btn {
                padding: 0.5rem 0.75rem;
                font-size: 0.75rem;
            }

            .prize-showcase-content {
                max-height: 50vh;
            }

            /* Swipe gestures for modals */
            .modal {
                touch-action: pan-y;
            }

            /* Optimize touch targets */
            .prize-card,
            .achievement-card {
                min-height: 120px;
            }

            button {
                min-height: 44px;
                min-width: 44px;
            }
        }

        @media (max-width: 480px) {
            .prize-card,
            .achievement-card {
                padding: 0.875rem;
            }

            .prize-icon {
                font-size: 2rem;
            }

            .achievement-unlock-animation {
                padding: 1.5rem 1rem;
            }

            .achievement-unlock-icon {
                font-size: 3rem;
            }
        }

        .modal-header {
            padding: 2rem 2rem 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 2rem;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            line-height: 1;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .feature-item {
            text-align: center;
            padding: 1.5rem;
            background: var(--bg-color);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .feature-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        /* Enhanced Prize Card Design with 3D Effects */
        .prize-card {
            background: var(--surface-color);
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 2px solid var(--border-color);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            transform-style: preserve-3d;
            perspective: 1000px;
        }

        .prize-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: var(--border-color);
            transition: all 0.4s ease;
            z-index: 1;
        }

        .prize-card::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.4s ease;
            pointer-events: none;
        }

        .prize-card:hover {
            transform: translateY(-8px) rotateX(2deg);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }

        .prize-card:hover::after {
            opacity: 1;
        }

        /* Common Rarity */
        .prize-card.prize-common {
            border-color: #6B7280;
            background: linear-gradient(135deg, var(--surface-color) 0%, rgba(107, 114, 128, 0.05) 100%);
        }

        .prize-card.prize-common::before {
            background: linear-gradient(90deg, #6B7280 0%, #9CA3AF 100%);
        }

        .prize-card.prize-common:hover {
            box-shadow: 0 12px 40px rgba(107, 114, 128, 0.3);
        }

        /* Rare Rarity */
        .prize-card.prize-rare {
            border-color: #3B82F6;
            background: linear-gradient(135deg, var(--surface-color) 0%, rgba(59, 130, 246, 0.08) 100%);
            box-shadow: 0 0 25px rgba(59, 130, 246, 0.25);
        }

        .prize-card.prize-rare::before {
            background: linear-gradient(90deg, #3B82F6 0%, #60A5FA 50%, #93C5FD 100%);
            animation: shimmer-blue 3s infinite;
        }

        @keyframes shimmer-blue {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .prize-card.prize-rare:hover {
            box-shadow: 0 12px 40px rgba(59, 130, 246, 0.4), 0 0 30px rgba(59, 130, 246, 0.3);
        }

        /* Epic Rarity */
        .prize-card.prize-epic {
            border-color: #BE38F3;
            background: linear-gradient(135deg, var(--surface-color) 0%, rgba(190, 56, 243, 0.1) 100%);
            box-shadow: 0 0 30px rgba(190, 56, 243, 0.35);
            border-width: 3px;
        }

        .prize-card.prize-epic::before {
            background: linear-gradient(90deg, #BE38F3 0%, #F43F5E 50%, #BE38F3 100%);
            animation: shimmer-purple 2.5s infinite;
            height: 6px;
        }

        @keyframes shimmer-purple {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .prize-card.prize-epic:hover {
            box-shadow: 0 12px 40px rgba(190, 56, 243, 0.5), 0 0 40px rgba(190, 56, 243, 0.4);
            transform: translateY(-10px) rotateX(3deg) scale(1.02);
        }

        /* Legendary Rarity - Holographic Effect */
        .prize-card.prize-legendary {
            border-color: #FFD700;
            background: linear-gradient(135deg, 
                rgba(255, 215, 0, 0.1) 0%, 
                rgba(255, 165, 0, 0.08) 25%,
                rgba(255, 215, 0, 0.1) 50%,
                rgba(255, 140, 0, 0.08) 75%,
                rgba(255, 215, 0, 0.1) 100%);
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.5);
            border-width: 3px;
            position: relative;
        }

        .prize-card.prize-legendary::before {
            background: linear-gradient(90deg, 
                #FFD700 0%, 
                #FFA500 25%, 
                #FFD700 50%, 
                #FFA500 75%, 
                #FFD700 100%);
            background-size: 200% 100%;
            animation: holographic-shimmer 3s infinite;
            height: 6px;
        }

        @keyframes holographic-shimmer {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .prize-card.prize-legendary::after {
            background: linear-gradient(45deg, 
                transparent 30%, 
                rgba(255, 255, 255, 0.3) 50%, 
                transparent 70%);
            animation: holographic-sweep 4s infinite;
        }

        @keyframes holographic-sweep {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(200%) translateY(200%) rotate(45deg); }
        }

        .prize-card.prize-legendary:hover {
            box-shadow: 0 15px 50px rgba(255, 215, 0, 0.6), 
                        0 0 60px rgba(255, 215, 0, 0.5),
                        inset 0 0 30px rgba(255, 215, 0, 0.1);
            transform: translateY(-12px) rotateX(4deg) scale(1.03);
        }

        .prize-card.prize-locked {
            opacity: 0.5;
            filter: grayscale(0.3);
        }

        .prize-card.prize-locked:hover {
            transform: translateY(-4px);
        }

        .prize-card.prize-unlocked {
            border-color: #10B981;
            box-shadow: 0 0 25px rgba(16, 185, 129, 0.4);
            background: linear-gradient(135deg, var(--surface-color) 0%, rgba(16, 185, 129, 0.08) 100%);
        }

        .prize-card.prize-unlocked::before {
            background: linear-gradient(90deg, #10B981 0%, #34D399 100%);
            animation: pulse-green 2s infinite;
        }

        @keyframes pulse-green {
            0%, 100% { opacity: 1; box-shadow: 0 0 10px rgba(16, 185, 129, 0.5); }
            50% { opacity: 0.8; box-shadow: 0 0 20px rgba(16, 185, 129, 0.8); }
        }

        .prize-card.prize-unlocked:hover {
            box-shadow: 0 12px 40px rgba(16, 185, 129, 0.5), 0 0 30px rgba(16, 185, 129, 0.4);
        }

        .prize-tier {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .prize-icon {
            font-size: 2.5rem;
            flex-shrink: 0;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        .prize-details {
            flex: 1;
            min-width: 0;
        }

        .prize-details h4 {
            font-size: 1.125rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .prize-rarity-badge {
            font-size: 0.75rem;
            font-weight: 700;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .prize-requirement {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .prize-reward {
            font-size: 0.875rem;
            color: var(--text-primary);
            font-weight: 600;
            margin-top: 0.5rem;
        }

        .prize-progress {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-color);
        }

        .prize-progress-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
            display: flex;
            justify-content: space-between;
        }

        /* Enhanced Progress Bars with Gradients and Milestones */
        .prize-progress-bar {
            height: 10px;
            background: var(--bg-color);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        .prize-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, 
                var(--accent-primary) 0%, 
                var(--accent-secondary) 50%,
                var(--accent-primary) 100%);
            background-size: 200% 100%;
            border-radius: 8px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            animation: progress-shimmer 2s infinite;
            box-shadow: 0 0 10px rgba(190, 56, 243, 0.4);
        }

        @keyframes progress-shimmer {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .prize-progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255, 255, 255, 0.3) 50%, 
                transparent 100%);
            animation: progress-glow 1.5s infinite;
        }
        @keyframes progress-glow {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(200%); }
        }

        /* Progress Milestone Markers */
        .progress-milestone {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 16px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            z-index: 2;
        }

        .progress-milestone.reached {
            background: var(--accent-primary);
            box-shadow: 0 0 8px rgba(190, 56, 243, 0.6);
        }
        .prize-unlocked-badge {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: #10B981;
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            text-transform: uppercase;
        }
        /* Milestone Styles */
        .milestone-unlocked {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.2);
        }

        .milestone-locked {
            opacity: 0.8;
        }

        .badge.green {
            background: #10B981;
            color: white;
        }

        /* Enhanced Achievement Card Design - 3D Trophy Style */
        .achievement-card {
            background: linear-gradient(135deg, var(--surface-color) 0%, var(--surface-elevated) 100%);
            border-radius: 20px;
            padding: 1.5rem;
            border: 2px solid var(--border-color);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            transform-style: preserve-3d;
            perspective: 1000px;
        }

        .achievement-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 50% 0%, rgba(190, 56, 243, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .achievement-card:hover {
            transform: translateY(-6px) rotateX(2deg);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
            border-color: var(--accent-primary);
        }

        .achievement-card:hover::before {
            opacity: 1;
        }

        .achievement-card.unlocked {
            border-color: var(--accent-primary);
            box-shadow: 0 0 20px rgba(190, 56, 243, 0.3);
        }

        .achievement-card.unlocked::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, 
                transparent 30%, 
                rgba(190, 56, 243, 0.2) 50%, 
                transparent 70%);
            animation: achievement-shine 3s infinite;
        }

        @keyframes achievement-shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(200%) translateY(200%) rotate(45deg); }
        }

        .achievement-card.locked {
            opacity: 0.5;
            filter: grayscale(0.4);
        }

        /* Achievement Category Colors */
        .achievement-card.category-participation {
            border-left: 4px solid #10B981;
            background: linear-gradient(135deg, var(--surface-color) 0%, rgba(16, 185, 129, 0.05) 100%);
        }

        .achievement-card.category-performance {
            border-left: 4px solid #3B82F6;
            background: linear-gradient(135deg, var(--surface-color) 0%, rgba(59, 130, 246, 0.05) 100%);
        }

        .achievement-card.category-social {
            border-left: 4px solid #F59E0B;
            background: linear-gradient(135deg, var(--surface-color) 0%, rgba(245, 158, 11, 0.05) 100%);
        }

        .achievement-card.category-milestone {
            border-left: 4px solid #BE38F3;
            background: linear-gradient(135deg, var(--surface-color) 0%, rgba(190, 56, 243, 0.05) 100%);
        }

        .achievement-card.category-special {
            border-left: 4px solid #FFD700;
            background: linear-gradient(135deg, var(--surface-color) 0%, rgba(255, 215, 0, 0.05) 100%);
        }

        /* Achievement Rarity Badges */
        .achievement-rarity-badge {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 8px;
            font-size: 0.625rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .achievement-rarity-common {
            background: rgba(107, 114, 128, 0.2);
            color: #9CA3AF;
            border: 1px solid #6B7280;
        }

        .achievement-rarity-rare {
            background: rgba(59, 130, 246, 0.2);
            color: #60A5FA;
            border: 1px solid #3B82F6;
        }

        .achievement-rarity-epic {
            background: rgba(190, 56, 243, 0.2);
            color: #C084FC;
            border: 1px solid #BE38F3;
        }

        .achievement-rarity-legendary {
            background: rgba(255, 215, 0, 0.2);
            color: #FFD700;
            border: 1px solid #FFD700;
            animation: legendary-pulse 2s infinite;
        }

        @keyframes legendary-pulse {
            0%, 100% { box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
            50% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.8); }
        }

        /* Enhanced Achievement Unlock Animation - Full Screen with Confetti */
        .achievement-unlock-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: overlayFadeIn 0.3s ease forwards;
        }

        @keyframes overlayFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .achievement-unlock-animation {
            position: relative;
            z-index: 2001;
            background: linear-gradient(135deg, var(--surface-color) 0%, var(--surface-elevated) 100%);
            border: 4px solid var(--accent-primary);
            border-radius: 32px;
            padding: 4rem 3rem;
            text-align: center;
            box-shadow: 0 30px 80px rgba(190, 56, 243, 0.6),
                        0 0 100px rgba(190, 56, 243, 0.4),
                        inset 0 0 50px rgba(190, 56, 243, 0.1);
            max-width: 500px;
            width: 90%;
            animation: achievementUnlockPop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            transform-style: preserve-3d;
        }

        @keyframes achievementUnlockPop {
            0% {
                transform: scale(0.3) rotateY(-180deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.1) rotateY(10deg);
            }
            70% {
                transform: scale(0.95) rotateY(-5deg);
            }
            100% {
                transform: scale(1) rotateY(0deg);
                opacity: 1;
            }
        }

        .achievement-unlock-content {
            color: var(--text-primary);
            position: relative;
            z-index: 2;
        }

        .achievement-unlock-icon {
            font-size: 5rem;
            margin-bottom: 1.5rem;
            display: inline-block;
            animation: iconBounce 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) 0.3s both;
            filter: drop-shadow(0 10px 20px rgba(190, 56, 243, 0.5));
        }

        @keyframes iconBounce {
            0% {
                transform: scale(0) rotate(-180deg);
                opacity: 0;
            }
            60% {
                transform: scale(1.2) rotate(10deg);
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        .achievement-unlock-animation.fade-out {
            animation: achievementFadeOut 0.5s ease forwards;
        }

        @keyframes achievementFadeOut {
            0% {
                transform: scale(1) rotateY(0deg);
                opacity: 1;
            }
            100% {
                transform: scale(0.8) rotateY(180deg);
                opacity: 0;
            }
        }

        /* Confetti Particles */
        .confetti-particle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: var(--accent-primary);
            animation: confettiFall linear forwards;
        }

        @keyframes confettiFall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        /* Avatar Styles */
        .avatar {
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .avatar-container {
            position: relative;
            display: inline-block;
        }

        /* Level Badge Styles */
        .level-badge {
            position: absolute;
            bottom: -4px;
            right: -4px;
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            color: white;
            font-weight: 800;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid var(--bg-color);
            box-shadow: 0 2px 8px rgba(190, 56, 243, 0.4);
            z-index: 10;
        }

        .level-badge-xs {
            width: 18px;
            height: 18px;
            font-size: 9px;
            border-width: 2px;
        }

        .level-badge-sm {
            width: 24px;
            height: 24px;
            font-size: 11px;
        }

        .level-badge-md {
            width: 32px;
            height: 32px;
            font-size: 14px;
        }

        .level-badge-lg {
            width: 40px;
            height: 40px;
            font-size: 16px;
        }

        /* Reputation Meter Styles */
        .reputation-meter {
            width: 100%;
            height: 8px;
            background: var(--surface-color);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .reputation-meter-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .xp-progress-bar {
            width: 100%;
            height: 12px;
            background: var(--surface-color);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
            border: 1px solid var(--border-color);
        }

        .xp-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10B981 0%, #3B82F6 50%, #BE38F3 100%);
            border-radius: 6px;
            transition: width 0.5s ease;
            position: relative;
        }

        .xp-progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .avatar-sm {
            width: 40px;
            height: 40px;
        }

        .avatar-md {
            width: 56px;
            height: 56px;
        }

        .avatar-lg {
            width: 80px;
            height: 80px;
        }

        .avatar-xl {
            width: 120px;
            height: 120px;
            border-width: 4px;
        }

        .avatar-2xl {
            width: 160px;
            height: 160px;
            border-width: 5px;
        }

        .avatar-gradient {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            border: 3px solid var(--border-color);
        }

        .avatar-gradient.avatar-sm {
            font-size: 16px;
        }

        .avatar-gradient.avatar-md {
            font-size: 24px;
        }

        .avatar-gradient.avatar-lg {
            font-size: 32px;
        }

        .avatar-gradient.avatar-xl {
            font-size: 48px;
            border-width: 4px;
        }

        .avatar-gradient.avatar-2xl {
            font-size: 64px;
            border-width: 5px;
        }

        .avatar-container {
            position: relative;
            display: inline-block;
        }

        .avatar-badge {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid var(--surface-color);
            background: var(--accent-primary);
        }

        .avatar-badge.rank-1 {
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
        }

        .avatar-badge.rank-2 {
            background: linear-gradient(135deg, #c0c0c0 0%, #808080 100%);
        }

        .avatar-badge.rank-3 {
            background: linear-gradient(135deg, #cd7f32 0%, #8b4513 100%);
        }

        /* Navigation Styles */
        .main-nav {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .nav-item {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-secondary);
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            min-height: 44px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-item:hover {
            color: var(--text-primary);
            background: var(--surface-color);
        }

        .nav-item.active {
            color: var(--accent-primary);
            background: var(--surface-color);
        }

        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent-primary);
            border-radius: 2px 2px 0 0;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .breadcrumb-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .breadcrumb-item a {
            color: var(--text-secondary);
            text-decoration: none;
            transition: color 0.2s;
        }

        .breadcrumb-item a:hover {
            color: var(--accent-primary);
        }

        .breadcrumb-separator {
            color: var(--border-color);
        }

        .breadcrumb-item.active {
            color: var(--text-primary);
        }

        /* Mobile Navigation */
        .mobile-nav-toggle {
            display: none;
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            min-width: 44px;
            min-height: 44px;
        }

        .mobile-nav-drawer {
            position: fixed;
            top: 0;
            left: -100%;
            width: 280px;
            height: 100vh;
            background: var(--surface-color);
            border-right: 1px solid var(--border-color);
            z-index: 1000;
            transition: left 0.3s ease;
            padding: 1rem;
            overflow-y: auto;
        }

        .mobile-nav-drawer.open {
            left: 0;
        }

        .mobile-nav-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .mobile-nav-overlay.open {
            opacity: 1;
            pointer-events: all;
        }

        /* View Transitions */
        .view-container {
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .view-container.active {
            opacity: 1;
            transform: translateY(0);
        }

        .view-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            color: var(--text-secondary);
        }

        /* Keyboard Shortcut Hint */
        .keyboard-hint {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-left: 0.5rem;
        }

        .keyboard-hint kbd {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 0.125rem 0.375rem;
            font-family: monospace;
            font-size: 0.7rem;
        }
        @media (max-width: 768px) {
            .main-nav {
                display: none;
            }

            .mobile-nav-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .breadcrumb {
                font-size: 0.75rem;
            }
        }
    </style>
    
    <!-- Login function - must be defined before body content -->
    <script>
    // Define login function immediately in head to avoid HubSpot script conflicts
    window.ampupLogin = function() {
        logger.log('ampupLogin called');
        var emailInput = document.getElementById('advocate-email-input');
        if (!emailInput) {
            alert('Email input not found. Please refresh the page.');
            return;
        }
        var email = emailInput.value.trim();
        if (!email || !email.includes('@')) {
            alert('Please enter a valid email address.');
            emailInput.focus();
            return;
        }
        
        // Create user
        var emailLower = email.toLowerCase();
        var nameParts = email.split('@')[0].replace(/[._]/g, ' ').split(' ');
        var firstName = nameParts[0] ? nameParts[0].charAt(0).toUpperCase() + nameParts[0].slice(1) : 'User';
        var lastName = nameParts[1] ? nameParts[1].charAt(0).toUpperCase() + nameParts[1].slice(1) : '';
        var fullName = lastName ? firstName + ' ' + lastName : firstName;
        
        // Store in sessionStorage
        try {
            sessionStorage.setItem('ampup_user', JSON.stringify({
                name: fullName,
                email: emailLower,
                department: 'Unassigned',
                participatedDrops: [],
                totalHype: 0,
                badges: [],
                followers: 0
            }));
        } catch(e) {
            // Error saving to sessionStorage - non-critical, continue
        }
        
        // Hide login, show main
        var loginScreen = document.getElementById('login-screen');
        var mainApp = document.getElementById('main-app');
        if (loginScreen) loginScreen.classList.add('hidden');
        if (mainApp) mainApp.classList.remove('hidden');
        
        // Reload page to initialize app
        window.location.reload();
    };
    // ampupLogin function defined in head
    
    // For prototype: Show dashboard by default, skip login
    (function() {
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                var loginScreen = document.getElementById('login-screen');
                var mainApp = document.getElementById('main-app');
                if (loginScreen) loginScreen.classList.add('hidden');
                if (mainApp) mainApp.classList.remove('hidden');
            });
        } else {
            var loginScreen = document.getElementById('login-screen');
            var mainApp = document.getElementById('main-app');
            if (loginScreen) loginScreen.classList.add('hidden');
            if (mainApp) mainApp.classList.remove('hidden');
        }
    })();
    </script>
</head>
<body>
    <!-- Toast Notification Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Onboarding Modal -->
    <div id="onboarding-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="text-2xl md:text-3xl font-extrabold-heading gradient-text">Welcome to AmpUp! 🚀</h2>
                <button class="modal-close" onclick="closeOnboardingModal()">×</button>
            </div>
            <div class="modal-body">
                <p class="text-lg text-secondary mb-6">
                    Turn your social reach into real impact. Join campaigns, share content, and compete for amazing prizes!
                </p>
                
                <div class="feature-grid">
                    <div class="feature-item">
                        <div class="feature-icon">💎</div>
                        <h3 class="font-bold mb-1">Earn Points</h3>
                        <p class="text-sm text-secondary">Get rewarded for quality engagement</p>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">🏆</div>
                        <h3 class="font-bold mb-1">Win Prizes</h3>
                        <p class="text-sm text-secondary">Compete for exclusive rewards</p>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">📊</div>
                        <h3 class="font-bold mb-1">Track Impact</h3>
                        <p class="text-sm text-secondary">See your real-time results</p>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">🎯</div>
                        <h3 class="font-bold mb-1">Make Waves</h3>
                        <p class="text-sm text-secondary">Amplify what matters</p>
                    </div>
                </div>

                <div class="mt-6 p-4 bg-gradient-to-r from-purple-900/20 to-pink-900/20 rounded-xl border border-accent-primary/30">
                    <h3 class="font-bold text-lg mb-3 flex items-center gap-2">
                        <span>🎁</span>
                        <span>How It Works</span>
                    </h3>
                    <ol class="space-y-2 text-sm text-secondary">
                        <li class="flex items-start gap-2">
                            <span class="font-bold accent-text">1.</span>
                            <span>Join an active campaign</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="font-bold accent-text">2.</span>
                            <span>Get your unique tracking link</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="font-bold accent-text">3.</span>
                            <span>Share on LinkedIn, Twitter, or both</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="font-bold accent-text">4.</span>
                            <span>Earn points for every click and compete for prizes!</span>
                        </li>
                    </ol>
                </div>

                <div class="mt-6 flex gap-3">
                    <button onclick="closeOnboardingModal(); document.getElementById('login-button')?.focus();" class="flex-1 bg-gray-600 text-white py-3 px-6 rounded-xl font-semibold hover:opacity-90 transition-all">
                        Learn More
                    </button>
                    <button onclick="closeOnboardingModal(); document.getElementById('login-button')?.click();" class="flex-1 gradient-bg text-white py-2.5 px-5 rounded-xl text-sm font-bold hover:opacity-90 transition-all">
                        Get Started Now
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="amplifier-app" class="container mx-auto p-4 md:p-8 max-w-7xl">
        <!-- Mobile Navigation Overlay -->
        <div id="mobile-nav-overlay" class="mobile-nav-overlay"></div>
        
        <!-- Mobile Navigation Drawer -->
        <div id="mobile-nav-drawer" class="mobile-nav-drawer">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-extrabold-heading">📣 AmpUp</h2>
                <button id="mobile-nav-close" class="mobile-nav-toggle" aria-label="Close menu">✕</button>
            </div>
            <nav id="mobile-nav-content" class="flex flex-col gap-2">
                <!-- Mobile nav items rendered here -->
            </nav>
        </div>

        <!-- Header -->
        <header class="flex justify-between items-center mb-4 md:mb-6" style="padding: 1rem 0; border-bottom: 1px solid var(--border-color); position: sticky; top: 0; background: rgba(10, 10, 10, 0.85); backdrop-filter: blur(20px); z-index: 100; margin: -1rem -1rem 1.5rem -1rem; padding-left: 1rem; padding-right: 1rem;">
            <div class="flex items-center gap-3">
                <button id="mobile-nav-toggle" class="mobile-nav-toggle" aria-label="Open menu">☰</button>
                <h1 class="text-2xl md:text-3xl font-extrabold-heading">📣 AmpUp</h1>
                <span class="badge purple text-xs hidden md:inline">Beta</span>
            </div>
            <nav id="main-navigation" class="main-nav">
                <!-- Navigation items rendered here -->
            </nav>
            <div id="auth-section">
                <!-- Auth content rendered here -->
            </div>
        </header>

        <!-- Breadcrumb Navigation -->
        <nav id="breadcrumb-nav" class="breadcrumb" aria-label="Breadcrumb">
            <!-- Breadcrumb items rendered here -->
        </nav>

        <!-- Login Screen -->
        <div id="login-screen" class="max-w-lg mx-auto text-center mt-16 fade-in">
            <div class="mb-6">
                <h2 class="text-4xl md:text-5xl font-extrabold-heading mb-3 gradient-text">Make Waves.</h2>
                <p class="mb-2 text-lg md:text-xl text-secondary">Join the crew.</p>
                <p class="mb-2 text-lg md:text-xl text-secondary">Amplify the message.</p>
                <p class="text-lg md:text-xl text-secondary">See the impact.</p>
            </div>
            
            <div class="surface-card p-4 md:p-6 mb-4">
                <div class="flex flex-col gap-4">
                    <div>
                        <label for="advocate-email-input" class="block text-sm font-semibold mb-2 text-left">Work Email</label>
                        <input 
                            type="email" 
                            id="advocate-email-input" 
                            placeholder="you@company.com" 
                            class="p-4 text-lg w-full"
                            autocomplete="email"
                            aria-required="true"
                            aria-describedby="email-help"
                        >
                        <p id="email-help" class="text-xs text-secondary mt-2 text-left">We'll verify your domain to ensure secure access.</p>
                    </div>
                    <button type="button" id="login-button" class="gradient-bg text-white font-bold py-3 px-6 text-base w-full mt-4" onclick="if(window.ampupLogin) { window.ampupLogin(); } else { alert('Login function not loaded. Please refresh the page.'); } return false;" aria-label="Login to AmpUp Platform">
                        Join the Crew
                    </button>
                </div>
            </div>
            
            <div class="surface-card p-6 mt-6">
                <h3 class="font-bold text-lg mb-4 text-center">Why Join AmpUp?</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="text-center p-4 bg-bg-color rounded-lg">
                        <div class="text-3xl mb-2">💎</div>
                        <div class="font-semibold mb-1">Earn Points</div>
                        <div class="text-xs text-secondary">Get rewarded for quality engagement, not just reach</div>
                    </div>
                    <div class="text-center p-4 bg-bg-color rounded-lg">
                        <div class="text-3xl mb-2">🏆</div>
                        <div class="font-semibold mb-1">Win Prizes</div>
                        <div class="text-xs text-secondary">Compete for gift cards and exclusive recognition</div>
                    </div>
                    <div class="text-center p-4 bg-bg-color rounded-lg">
                        <div class="text-3xl mb-2">📊</div>
                        <div class="font-semibold mb-1">Track Impact</div>
                        <div class="text-xs text-secondary">See your real-time results and leaderboard position</div>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-border-color text-center">
                    <p class="text-xs text-secondary">⏱️ Takes less than 2 minutes to get started</p>
                </div>
            </div>
        </div>

        <!-- Main App View -->
        <main id="main-app" class="hidden view-container" data-persona="" role="main" aria-label="Main application content">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 md:gap-6">
                <!-- Main Content -->
                <div class="lg:col-span-8">
                    <!-- Active Campaign -->
                    <section id="active-drop" class="mb-6">
                        <!-- Campaign content rendered here -->
                    </section>

                    <!-- Past Campaigns -->
                    <section id="drop-archive" class="mb-6">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl md:text-2xl font-extrabold-heading">Past Campaigns</h3>
                            <button class="toggle-button text-sm rounded-xl" data-target="archive-section">
                                <span class="text-sm">View All</span>
                                <span class="icon text-xs">▼</span>
                            </button>
                        </div>
                        <div class="collapsible-section collapsed" id="archive-section">
                            <div id="archive-log" class="space-y-4">
                                <!-- History content rendered here -->
                            </div>
                        </div>
                    </section>
                </div>

                <!-- Sidebar: Quick Stats -->
                <div class="lg:col-span-4 space-y-6" id="sidebar-content">
                    <!-- Sidebar content rendered here -->
                </div>
            </div>
        </main>

        <!-- Drop Recap View -->
        <div id="recap-screen" class="hidden view-container">
            <!-- Recap content rendered here -->
        </div>

        <!-- Player Profile View -->
        <div id="player-screen" class="hidden view-container">
            <!-- Player profile content rendered here -->
        </div>

        <!-- Admin Dashboard View -->
        <div id="admin-screen" class="hidden view-container">
            <!-- Admin content rendered here -->
        </div>

        <!-- Admin Modals -->
        <!-- Create/Edit Campaign Modal -->
        <div id="campaign-modal" class="modal-overlay">
            <div class="modal" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <h2 class="text-2xl font-extrabold-heading gradient-text" id="campaign-modal-title">Create New Campaign</h2>
                    <button class="modal-close" onclick="closeCampaignModal()">×</button>
                </div>
                <div class="modal-body">
                    <form id="campaign-form" onsubmit="handleSaveCampaign(event)">
                        <!-- Campaign Wizard Progress Indicator -->
                        <div class="campaign-wizard-progress mb-4 md:mb-6">
                            <div class="wizard-steps">
                                <div class="wizard-step active" data-wizard-step="1">
                                    <div class="wizard-step-circle">1</div>
                                    <div class="wizard-step-label">Import Content</div>
                                </div>
                                <div class="wizard-step-line"></div>
                                <div class="wizard-step" data-wizard-step="2">
                                    <div class="wizard-step-circle">2</div>
                                    <div class="wizard-step-label">Review & Edit</div>
                                </div>
                                <div class="wizard-step-line"></div>
                                <div class="wizard-step" data-wizard-step="3">
                                    <div class="wizard-step-circle">3</div>
                                    <div class="wizard-step-label">Configure</div>
                                </div>
                                <div class="wizard-step-line"></div>
                                <div class="wizard-step" data-wizard-step="4">
                                    <div class="wizard-step-circle">4</div>
                                    <div class="wizard-step-label">Preview & Launch</div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 1: Import from URL -->
                        <div class="campaign-wizard-step active" id="campaign-step-1">
                            <div class="mb-6">
                                <h3 class="text-xl font-extrabold-heading mb-2">Step 1: Import from Webpage</h3>
                                <p class="text-sm text-secondary">Quickly create a campaign by importing content from a webpage URL</p>
                            </div>
                            
                            <div class="surface-card p-4 mb-4 border-2 border-dashed border-border-color">
                                <label class="block text-sm font-semibold mb-2">Webpage URL</label>
                                <div class="flex gap-2">
                                    <input type="url" id="campaign-source-url" class="p-3 flex-1" placeholder="https://example.com/blog/post" onkeypress="if(event.key === 'Enter') { event.preventDefault(); window.fetchWebpageMetadata(); }">
                                    <button type="button" id="fetch-url-btn" onclick="window.fetchWebpageMetadata()" class="btn-secondary px-4 py-3 whitespace-nowrap">
                                        <span id="fetch-url-btn-text">🔍 Fetch</span>
                                    </button>
                                </div>
                                <p class="text-xs text-secondary mt-2">Enter a webpage URL to automatically extract title, description, and images. Press Enter or click Fetch.</p>
                                <div id="fetch-url-status" class="mt-2 text-sm hidden"></div>
                            </div>

                            <div class="bg-info/10 border border-info/30 rounded-lg p-4 mb-6">
                                <div class="flex items-start gap-3">
                                    <span class="text-lg">💡</span>
                                    <div>
                                        <div class="font-semibold text-sm mb-1">Quick Tip</div>
                                        <div class="text-xs text-secondary">You can also fill the form manually by clicking "Skip Import" below</div>
                                    </div>
                                </div>
                            </div>

                            <div class="flex gap-4">
                                <button type="button" onclick="closeCampaignModal()" class="flex-1 btn-secondary">
                                    Cancel
                                </button>
                                <button type="button" onclick="goToCampaignStep(2)" class="flex-1 btn-primary">
                                    Skip Import →
                                </button>
                            </div>
                        </div>

                        <!-- Step 2: Review & Edit -->
                        <div class="campaign-wizard-step" id="campaign-step-2">
                            <div class="mb-6">
                                <h3 class="text-xl font-extrabold-heading mb-2">Step 2: Review & Edit Content</h3>
                                <p class="text-sm text-secondary">Review the imported content and make any necessary edits</p>
                            </div>
                            
                            <div class="space-y-6">
                                <div class="form-group">
                                    <label class="form-label">Campaign Name <span class="required">*</span></label>
                                    <input type="text" id="campaign-name" required class="p-3 w-full" placeholder="e.g., October Product Drop">
                                    <div class="form-help">This will be displayed to participants</div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Objective <span class="required">*</span></label>
                                    <textarea id="campaign-objective" required class="p-3 w-full" rows="3" placeholder="What is the goal of this campaign?"></textarea>
                                    <div class="form-help">Describe what you want to achieve with this campaign</div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Post Link <span class="required">*</span></label>
                                    <input type="url" id="campaign-post-link" required class="p-3 w-full" placeholder="https://example.com/blog/post">
                                    <div class="form-help">The URL participants will share</div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Hero Image URL</label>
                                    <input type="url" id="campaign-hero-image" class="p-3 w-full" placeholder="https://example.com/image.png">
                                    <div class="form-help">Main image displayed on the campaign card (optional)</div>
                                    <div id="campaign-image-preview" class="mt-3 hidden">
                                        <img id="preview-hero-image" src="" alt="Preview" class="max-w-full h-auto rounded-lg border border-border-color" style="max-height: 200px;">
                                    </div>
                                </div>
                            </div>

                            <div class="flex gap-4 mt-8">
                                <button type="button" onclick="goToCampaignStep(1)" class="flex-1 btn-secondary">
                                    ← Back
                                </button>
                                <button type="button" onclick="goToCampaignStep(3)" class="flex-1 btn-primary">
                                    Next: Configure →
                                </button>
                            </div>
                        </div>

                        <!-- Step 3: Configure Settings -->
                        <div class="campaign-wizard-step" id="campaign-step-3">
                            <div class="mb-6">
                                <h3 class="text-xl font-extrabold-heading mb-2">Step 3: Configure Engagement Settings</h3>
                                <p class="text-sm text-secondary">Set up points, instructions, and content options</p>
                            </div>
                            
                            <div class="space-y-6">
                                <div class="form-group">
                                    <label class="form-label">Base Points</label>
                                    <input type="number" id="campaign-points" value="100" min="0" class="p-3 w-full">
                                    <div class="form-help">Base points awarded for participating (additional points for customization)</div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Instructions (one per line)</label>
                                    <textarea id="campaign-instructions" class="p-3 w-full" rows="5" placeholder="1. Step one&#10;2. Step two"></textarea>
                                    <div class="form-help">Step-by-step instructions for participants</div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Content Options (one per line)</label>
                                    <textarea id="campaign-content-options" class="p-3 w-full" rows="4" placeholder="Option 1 text&#10;Option 2 text"></textarea>
                                    <div class="form-help">Pre-written copy options for participants. Each line becomes a separate option.</div>
                                </div>
                            </div>

                            <div class="flex gap-4 mt-8">
                                <button type="button" onclick="goToCampaignStep(2)" class="flex-1 btn-secondary">
                                    ← Back
                                </button>
                                <button type="button" onclick="goToCampaignStep(4)" class="flex-1 btn-primary">
                                    Next: Preview →
                                </button>
                            </div>
                        </div>

                        <!-- Step 4: Preview & Launch -->
                        <div class="campaign-wizard-step" id="campaign-step-4">
                            <div class="mb-6">
                                <h3 class="text-xl font-extrabold-heading mb-2">Step 4: Preview & Launch</h3>
                                <p class="text-sm text-secondary">Review your campaign before launching</p>
                            </div>
                            
                            <div id="campaign-preview" class="surface-card p-6 mb-6">
                                <!-- Preview content will be rendered here -->
                            </div>

                            <div class="flex gap-4">
                                <button type="button" onclick="goToCampaignStep(3)" class="flex-1 btn-secondary">
                                    ← Back
                                </button>
                                <button type="button" onclick="closeCampaignModal()" class="flex-1 btn-secondary">
                                    Save as Draft
                                </button>
                                <button type="submit" class="flex-1 btn-primary">
                                    🚀 Launch Campaign
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Add/Edit User Modal -->
        <div id="user-modal" class="modal-overlay">
            <div class="modal" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="text-2xl font-extrabold-heading gradient-text" id="user-modal-title">Add New User</h2>
                    <button class="modal-close" onclick="closeUserModal()">×</button>
                </div>
                <div class="modal-body">
                    <form id="user-form" onsubmit="handleSaveUser(event)">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">Name *</label>
                                <input type="text" id="user-name" required class="p-3 w-full" placeholder="John Doe">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Email *</label>
                                <input type="email" id="user-email" required class="p-3 w-full" placeholder="john@company.com">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Department</label>
                                <input type="text" id="user-department" class="p-3 w-full" placeholder="Marketing">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Followers (for engagement calculation)</label>
                                <input type="number" id="user-followers" value="0" min="0" class="p-3 w-full">
                            </div>
                            <div>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" id="user-is-admin" class="rounded">
                                    <span class="text-sm font-semibold">Admin Access</span>
                                </label>
                            </div>
                        </div>
                        <div class="flex gap-4 mt-8">
                            <button type="button" onclick="closeUserModal()" class="flex-1 bg-gray-600 text-white py-3 px-6 rounded-xl font-semibold hover:opacity-90">
                                Cancel
                            </button>
                            <button type="submit" class="flex-1 gradient-bg text-white py-2.5 px-5 rounded-xl text-sm font-bold hover:opacity-90">
                                Save User
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
    // Development mode flag - set to false in production
    const DEV_MODE = true;
    
    // Logging utility - defined at top level to be accessible everywhere
    const logger = {
        log: function(...args) {
            if (DEV_MODE) console.log('[AmpUp]', ...args);
        },
        error: function(...args) {
            console.error('[AmpUp ERROR]', ...args);
        },
        warn: function(...args) {
            if (DEV_MODE) console.warn('[AmpUp WARN]', ...args);
        },
        info: function(...args) {
            if (DEV_MODE) console.info('[AmpUp INFO]', ...args);
        }
    };
    
    // Wrap everything in try-catch to prevent HubSpot errors from breaking our code
    try {
    logger.log('AmpUp script loading...');
    
    // Define login function immediately, before DOMContentLoaded
    (function() {
        'use strict';
        logger.log('AmpUp IIFE executing...');
        
        window.ampupLogin = function() {
            logger.log('ampupLogin called directly');
        const emailInput = document.getElementById('advocate-email-input');
        if (!emailInput) {
            logger.error('Email input not found');
            alert('Email input not found. Please refresh the page.');
            return;
        }
        const email = emailInput.value.trim();
        if (!email || !email.includes('@')) {
            alert('Please enter a valid email address.');
            emailInput.focus();
            return;
        }
        
        // Create user
        const emailLower = email.toLowerCase();
        const nameParts = email.split('@')[0].replace(/[._]/g, ' ').split(' ');
        const firstName = nameParts[0] ? nameParts[0].charAt(0).toUpperCase() + nameParts[0].slice(1) : 'User';
        const lastName = nameParts[1] ? nameParts[1].charAt(0).toUpperCase() + nameParts[1].slice(1) : '';
        const fullName = lastName ? `${firstName} ${lastName}` : firstName;
        
        // Store in sessionStorage for now
        sessionStorage.setItem('ampup_user', JSON.stringify({
            name: fullName,
            email: emailLower,
            department: 'Unassigned',
            participatedDrops: [],
            totalHype: 0,
            badges: [],
            followers: 0
        }));
        
        // Hide login, show main
        const loginScreen = document.getElementById('login-screen');
        const mainApp = document.getElementById('main-app');
        if (loginScreen) loginScreen.classList.add('hidden');
        if (mainApp) mainApp.classList.remove('hidden');
        
        // Reload page to initialize app
        window.location.reload();
        };
        
        logger.log('ampupLogin function defined:', typeof window.ampupLogin);
        
        // Try to attach event listener immediately
        function attachLoginHandler() {
            var btn = document.getElementById('login-button');
            logger.log('Looking for login button:', btn);
            if (btn) {
                logger.log('Found button, attaching listener');
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    logger.log('Button clicked via addEventListener');
                    window.ampupLogin();
                });
                // Also try onclick as backup
                btn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    logger.log('Button clicked via onclick property');
                    window.ampupLogin();
                    return false;
                };
            } else {
                logger.log('Button not found yet, will retry');
                setTimeout(attachLoginHandler, 100);
            }
        }
        
        // Try immediately
        attachLoginHandler();
        
        // Also try on DOMContentLoaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', attachLoginHandler);
        }
    })();
    // Initialize immediately - don't wait for DOMContentLoaded
    (function initApp() {
        logger.log('Initializing app immediately...');
        
        function initializeApp() {
            try {
                logger.log('initializeApp called');
                
            // Validation function to check all required constants and functions exist
            // Note: Must be called AFTER all constants are defined to avoid temporal dead zone errors
            function validateInitialization() {
                const errors = [];
                const warnings = [];
                
                // Check required constants (using try-catch to safely check for temporal dead zone)
                try {
                    if (typeof IMPACT_SCORE_WEIGHTS === 'undefined') {
                        errors.push('IMPACT_SCORE_WEIGHTS is not defined');
                    }
                } catch (e) {
                    errors.push('IMPACT_SCORE_WEIGHTS is not accessible');
                }
                
                try {
                    if (typeof POINTS === 'undefined') {
                        errors.push('POINTS is not defined');
                    }
                } catch (e) {
                    errors.push('POINTS is not accessible');
                }
                
                try {
                    if (typeof CLICK_POINTS === 'undefined') {
                        warnings.push('CLICK_POINTS is not defined');
                    }
                } catch (e) {
                    warnings.push('CLICK_POINTS is not accessible');
                }
                
                // Check required functions
                try {
                    if (typeof calculateImpactScore !== 'function') {
                        errors.push('calculateImpactScore function is not defined');
                    }
                } catch (e) {
                    errors.push('calculateImpactScore function is not accessible');
                }
                
                try {
                    if (typeof getUserImpactScore !== 'function') {
                        errors.push('getUserImpactScore function is not defined');
                    }
                } catch (e) {
                    errors.push('getUserImpactScore function is not accessible');
                }
                
                try {
                    if (typeof initializeUserReputation !== 'function') {
                        errors.push('initializeUserReputation function is not defined');
                    }
                } catch (e) {
                    errors.push('initializeUserReputation function is not accessible');
                }
                
                try {
                    if (typeof calculateReputationScore !== 'function') {
                        errors.push('calculateReputationScore function is not defined');
                    }
                } catch (e) {
                    errors.push('calculateReputationScore function is not accessible');
                }
                
                // Check DOM elements
                try {
                    const loginScreen = document.getElementById('login-screen');
                    const mainApp = document.getElementById('main-app');
                    if (!loginScreen) {
                        warnings.push('login-screen element not found');
                    }
                    if (!mainApp) {
                        warnings.push('main-app element not found');
                    }
                } catch (e) {
                    warnings.push('Error checking DOM elements: ' + e.message);
                }
                
                // Log results
                if (errors.length > 0) {
                    logger.error('Initialization validation FAILED:', errors);
                    return false;
                }
                if (warnings.length > 0) {
                    logger.warn('Initialization validation warnings:', warnings);
                } else {
                    logger.log('Initialization validation passed');
                }
                return true;
            }
            
            // Note: Reputation initialization happens after appState is defined (see line ~1959)
            // --- UTILITY FUNCTIONS --- //
        
        // Toast Notification System
        function showToast(message, type = 'info', duration = 3000, actions = null) {
            const toastContainer = document.getElementById('toast-container');
            if (!toastContainer) return;
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '✓',
                error: '✕',
                info: 'ℹ',
                warning: '⚠'
            };
            
            const toastContent = document.createElement('div');
            toastContent.className = 'toast-content';
            
            const messageEl = document.createElement('div');
            messageEl.className = 'toast-message';
            messageEl.textContent = message;
            toastContent.appendChild(messageEl);
            
            if (actions && actions.length > 0) {
                const actionsEl = document.createElement('div');
                actionsEl.className = 'toast-actions';
                actions.forEach(function(action) {
                    const actionBtn = document.createElement('button');
                    actionBtn.className = 'toast-action';
                    actionBtn.textContent = action.label;
                    actionBtn.onclick = function() {
                        if (action.handler) action.handler();
                        removeToast(toast);
                    };
                    actionsEl.appendChild(actionBtn);
                });
                toastContent.appendChild(actionsEl);
            }
            
            const closeBtn = document.createElement('button');
            closeBtn.className = 'toast-close';
            closeBtn.innerHTML = '×';
            closeBtn.setAttribute('aria-label', 'Close');
            closeBtn.onclick = function() {
                removeToast(toast);
            };
            
            // Append elements in correct order
            toast.appendChild(toastContent);
            toast.appendChild(closeBtn);
            
            toastContainer.appendChild(toast);
            
            if (duration > 0) {
                setTimeout(function() {
                    removeToast(toast);
                }, duration);
            }
        }
        
        function removeToast(toast) {
            if (!toast) return;
            toast.classList.add('fade-out');
            setTimeout(function() {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }

        // Loading State Helper
        function setLoading(element, isLoading, loadingText = 'Loading...') {
            if (!element) return;
            
            if (isLoading) {
                element.dataset.originalText = element.textContent;
                element.disabled = true;
                element.innerHTML = `<span class="spinner" style="display: inline-block; margin-right: 8px;"></span>${loadingText}`;
            } else {
                element.disabled = false;
                element.textContent = element.dataset.originalText || element.textContent;
            }
        }

        // --- GAMIFICATION CONSTANTS --- //
        const POINTS = {
            PARTICIPATE: 100,
            PROVIDED_COPY: 0,
            CUSTOMIZE_COPY: 50,
            ORIGINAL_COPY: 100,
            ADD_STORY: 75,
            ADD_CTA: 25,
            FIRST_PARTICIPANT: 50,
            CROSS_PLATFORM: 50,
            TAG_COLLEAGUE: 25
        };

        const CLICK_POINTS = {
            TIER_1: { range: [1, 10], points: 15 },
            TIER_2: { range: [11, 50], points: 10 },
            TIER_3: { range: [51, Infinity], points: 8 }
        };

        // --- PLAYER PERSONA DETECTION SYSTEM --- //
        // Detects player type based on behavior patterns (Bartle's Taxonomy)
        // Used to customize UI/UX for optimal engagement
        
        function detectPlayerPersona(user, allUsers = []) {
            if (!user) return 'Achiever'; // Default fallback
            
            // Calculate behavior scores
            const achievementScore = (user.badges || []).length * 2 + 
                                   (user.level || 0) * 3 +
                                   (user.impactScore || 0) / 100;
            
            const explorationScore = (user.originalPosts || 0) * 5 +
                                   (user.customizedPosts || 0) * 2 +
                                   (user.explorationMissions || 0) * 3;
            
            const socialScore = (user.peerBadgesReceived || 0) * 4 +
                              (user.commentsGenerated || 0) * 2 +
                              (user.teamParticipation || 0) * 3;
            
            // Calculate competitive ranking
            const allScores = allUsers.map(u => u.impactScore || 0).sort((a, b) => b - a);
            const userRank = allScores.indexOf(user.impactScore || 0) + 1;
            const totalUsers = allUsers.length || 1;
            const competitiveScore = (totalUsers - userRank + 1) / totalUsers * 10 +
                                   (user.leaderboardPosition || 0) * 2;
            
            // Find dominant persona (highest score)
            const scores = {
                'Achiever': achievementScore,
                'Explorer': explorationScore,
                'Socializer': socialScore,
                'Killer': competitiveScore
            };
            
            // Get persona with highest score
            const detectedPersona = Object.keys(scores).reduce((a, b) => 
                scores[a] > scores[b] ? a : b
            );
            
            // If scores are very close, use secondary indicators
            const maxScore = Math.max(...Object.values(scores));
            const minScore = Math.min(...Object.values(scores));
            const scoreRange = maxScore - minScore;
            
            // If range is small (< 20% difference), use tie-breakers
            if (scoreRange < maxScore * 0.2) {
                // Tie-breaker: Check recent activity patterns
                if (user.originalPosts > 0) return 'Explorer';
                if (user.peerBadgesReceived > 0) return 'Socializer';
                if (userRank <= 3 && totalUsers > 5) return 'Killer';
                return 'Achiever'; // Default
            }
            
            return detectedPersona;
        }
        
        // --- PSYCHOLOGICAL GAMIFICATION: IMPACT SCORE SYSTEM --- //
        // Based on Self-Determination Theory and Octalysis Framework
        // Rewards authentic effort and real business impact, not vanity metrics
        // MUST be defined before appState initialization to prevent undefined errors
        var IMPACT_SCORE_WEIGHTS = {
            // Low-value actions (minimize overjustification effect)
            SHARE_SUGGESTED: 1,        // Base value - simple brand awareness
            LIKE_REACTION: 2,          // Measures network reach (unfair to small networks)
            
            // Medium-value actions (competence indicators)
            CLICK_ON_LINK: 5,          // Measures content relevance
            COMMENT_ON_POST: 10,       // Drives meaningful engagement (Competence, Relatedness)
            
            // High-value actions (autonomy and creativity)
            ORIGINAL_POST: 20,         // Authentic effort, autonomy (Drive 3: Empowerment of Creativity)
            PEER_BADGE_RECEIVED: 25,   // Social recognition (Relatedness, Social Influence)
            
            // Highest-value actions (epic meaning and business impact)
            CONVERSION_LEAD: 50,       // Direct business value (Competence, Epic Meaning)
            CONVERSION_HIRE: 50,       // Direct business value
            CONVERSION_SALE: 100       // Ultimate business impact
        };

        // --- STATE MANAGEMENT --- //
        window.appState = {
            currentView: 'main',
            // For prototype: Create a demo user automatically
            currentUser: {
                name: 'Demo User',
                email: 'demo@company.com',
                department: 'Marketing',
                participatedDrops: ['d002'],
                totalHype: 1890,
                badges: ['creative'],
                followers: 1200,
                isAdmin: true,
                wheelSpins: 0
            },
            adminTab: 'campaigns',
            drops: [
                {
                    id: 'd001',
                    name: 'October Product Drop',
                    objective: 'Share our latest Product Drop and help recruiters discover smarter charts, collaborative dashboards & deeper insights.',
                    status: 'ACTIVE',
                instructions: [
                    "1. Choose your copy style - customize or write original for bonus points!",
                    "2. Download your preferred visual asset (banner or square format).",
                    "3. Get your unique short tracking link (amp.yourdomain.com/xxxxx).",
                    "4. Post to LinkedIn (or Twitter) with your link and chosen copy.",
                    "5. Watch your points grow in real-time as clicks come in!",
                    "6. Compete on the leaderboard and earn badges."
                ],
                    visualAssets: [
                        { type: 'image', url: 'https://oneupsales.com/hubfs/Monthly%20Drop%20Multi-design.png', filename: 'october-product-drop.png' }
                    ],
                    contentOptions: [
                        { type: 'Statement', text: "Our latest Product Drop is here! 🚀 Smarter charts, collaborative dashboards, and deeper insights - all designed to help recruiters see clearer and work faster. Check it out!" },
                        { type: 'Question', text: "Want to see how OneUp got better this month? Our October Product Drop includes collaborative dashboards, multi-period charts, and reporting drill-downs. What feature are you most excited about?" },
                        { type: 'Personal', text: "I've been using the new collaborative dashboards and they're a game-changer for our team. Being able to build and share insights together has made our workflows so much smoother. Check out the latest Product Drop!" },
                        { type: 'Question', text: "What if you could go from metric to mentor in two clicks? Our new Product Drop makes it possible. Explore smarter charts and deeper insights that help you find the 'who' behind every number." }
                    ],
                    postLink: 'https://oneupsales.com/blog/product-drop-october',
                    points: 1000,
                    createdAt: new Date('2024-10-31')
                },
                {
                    id: 'd002',
                    name: 'Culture Report \'25',
                    objective: 'Showcase our company culture and attract new talent.',
                    status: 'COMPLETE',
                    instructions: ["Post the report link with a comment about your favorite part of our culture."],
                    visualAssets: [
                        { type: 'image', url: 'https://placehold.co/1200x500/F43F5E/FFFFFF?text=CULTURE+REPORT', filename: 'culture_hero.png' }
                    ],
                    contentOptions: [
                        { type: 'Statement', text: "Proud to share our 2025 Culture Report. The best part of working here is easily the people. Great things happen when you have an amazing team." }
                    ],
                    postLink: 'https://www.yourcompany.com/culture-report-2025',
                    points: 500
                }
            ],
            crew: [
                { name: 'Alice Chen', email: 'alice@company.com', department: 'Engineering', participatedDrops: ['d002'], totalHype: 2850, badges: ['creative', 'growth-hacker'], followers: 1200, wheelSpins: 0 },
                { name: 'Bob Martinez', email: 'bob@company.com', department: 'Marketing', participatedDrops: ['d002'], totalHype: 3420, badges: ['storyteller', 'team-player'], followers: 3500, wheelSpins: 0 },
                { name: 'Charlie Kim', email: 'charlie@company.com', department: 'Engineering', participatedDrops: [], totalHype: 0, badges: [], followers: 800, wheelSpins: 0 },
                { name: 'Diana Patel', email: 'diana@company.com', department: 'Sales', participatedDrops: ['d002'], totalHype: 4150, badges: ['king-of-clicks', 'first-responder'], followers: 2800, wheelSpins: 0 },
                { name: 'Emma Wilson', email: 'emma@company.com', department: 'Marketing', participatedDrops: ['d002'], totalHype: 1890, badges: ['creative'], followers: 950, wheelSpins: 0 },
                { name: 'Frank Thompson', email: 'frank@company.com', department: 'Sales', participatedDrops: ['d002'], totalHype: 2250, badges: ['team-player'], followers: 1500, wheelSpins: 0 }
            ],
            performanceData: {
                'd002': { 
                    'alice@company.com': 121, 
                    'bob@company.com': 95, 
                    'diana@company.com': 210,
                    'emma@company.com': 67,
                    'frank@company.com': 89
                }
            },
            participationData: {}
        };
        
        // Initialize reputation for all users (after appState is defined)
        if (appState.currentUser) {
            try {
            initializeUserReputation(appState.currentUser);
            // Calculate reputation score
            const allUsers = [...appState.crew, appState.currentUser];
            appState.currentUser.reputationScore = calculateReputationScore(appState.currentUser, allUsers);
                
                // Detect and set player persona
                if (!appState.currentUser.playerPersona) {
                    appState.currentUser.playerPersona = detectPlayerPersona(appState.currentUser, allUsers);
                    logger.log('Detected player persona:', appState.currentUser.playerPersona);
                }
            } catch (error) {
                logger.error('Error initializing current user reputation:', error);
                logger.error('Stack:', error.stack);
                // Set default values to prevent undefined errors
                if (!appState.currentUser.impactScore) appState.currentUser.impactScore = 0;
                if (!appState.currentUser.reputationScore) appState.currentUser.reputationScore = 0;
                if (!appState.currentUser.playerPersona) appState.currentUser.playerPersona = 'Achiever';
                if (!appState.currentUser.wheelSpins) appState.currentUser.wheelSpins = 0;
            }
        }
        
        // Initialize reputation for all crew members
        appState.crew.forEach(function(user) {
            try {
            initializeUserReputation(user);
            const allUsers = [...appState.crew, appState.currentUser].filter(u => u);
            user.reputationScore = calculateReputationScore(user, allUsers);
            } catch (error) {
                logger.error('Error initializing crew member reputation for', user.email || 'unknown', ':', error);
                // Set default values to prevent undefined errors
                if (!user.impactScore) user.impactScore = 0;
                if (!user.reputationScore) user.reputationScore = 0;
            }
        });
        
        // Note: Achievement checks will happen after initializeApp() runs and ACHIEVEMENT_DEFINITIONS is defined
        // They will be checked when users participate in campaigns

        // Validate initialization AFTER all constants and functions are defined
        const isValid = validateInitialization();
        if (!isValid) {
            logger.error('Critical initialization errors detected. Attempting to continue with fallbacks...');
        }

        // --- DOM ELEMENTS --- //
        const loginScreen = document.getElementById('login-screen');
        const mainApp = document.getElementById('main-app');
        const recapScreen = document.getElementById('recap-screen');
        const playerScreen = document.getElementById('player-screen');
        const authSection = document.getElementById('auth-section');
        const loginButton = document.getElementById('login-button');
        const advocateEmailInput = document.getElementById('advocate-email-input');

        // --- VIEW MANAGEMENT --- //
        // View history for breadcrumbs
        const viewHistory = [];
        
        function renderNavigation() {
            const mainNav = document.getElementById('main-navigation');
            const mobileNav = document.getElementById('mobile-nav-content');
            if (!mainNav || !mobileNav) return;
            
            const navItems = [
                { id: 'main', label: 'Dashboard', icon: '📊', shortcut: 'D' },
                { id: 'roster', label: 'Leaderboard', icon: '🏆', shortcut: 'L' },
                { id: 'rewards', label: 'Rewards', icon: '🎁', shortcut: 'R', action: 'showRewardsMenu' }
            ];
            
            // Add admin if user is admin
            if (appState.currentUser && appState.currentUser.isAdmin) {
                navItems.push({ id: 'admin', label: 'Admin', icon: '⚙️', shortcut: 'A' });
            }
            
            // Render main navigation
            mainNav.innerHTML = navItems.map(function(item) {
                const isActive = appState.currentView === item.id || 
                    (item.id === 'roster' && appState.currentView === 'main');
                
                let onClickHandler = '';
                if (item.action) {
                    // Custom action (rewards menu) - use direct function call
                    if (item.action === 'showRewardsMenu') {
                        onClickHandler = "if (window.showRewardsMenu) { window.showRewardsMenu(); } else { alert('Rewards menu not available. Please refresh the page.'); }";
                    } else {
                        onClickHandler = "if (typeof window." + item.action + " === 'function') { window." + item.action + "(); } else { alert('Function not available. Please refresh the page.'); }";
                    }
                } else if (item.id === 'roster') {
                    onClickHandler = "window.switchView('main', { scrollToSection: 'roster' }); setTimeout(() => { const roster = document.getElementById('roster-section') || document.getElementById('roster'); if (roster) { roster.scrollIntoView({ behavior: 'smooth', block: 'start' }); } }, 300);";
                } else {
                    onClickHandler = "window.switchView('" + item.id + "');";
                }
                
                return `
                    <button 
                        class="nav-item ${isActive ? 'active' : ''}" 
                        onclick="${onClickHandler}"
                        aria-label="${item.label}"
                    >
                        <span>${item.icon}</span>
                        <span>${item.label}</span>
                        <span class="keyboard-hint"><kbd>${item.shortcut}</kbd></span>
                    </button>
                `;
            }).join('');
            
            // Render mobile navigation
            mobileNav.innerHTML = navItems.map(function(item) {
                const isActive = appState.currentView === item.id || 
                    (item.id === 'roster' && appState.currentView === 'main');
                
                let onClickHandler = '';
                if (item.action) {
                    // Custom action (rewards menu) - use direct function call
                    if (item.action === 'showRewardsMenu') {
                        onClickHandler = "closeMobileNav(); if (window.showRewardsMenu) { window.showRewardsMenu(); } else { alert('Rewards menu not available. Please refresh the page.'); }";
                    } else {
                        onClickHandler = "closeMobileNav(); if (typeof window." + item.action + " === 'function') { window." + item.action + "(); } else { alert('Function not available. Please refresh the page.'); }";
                    }
                } else if (item.id === 'roster') {
                    onClickHandler = "window.switchView('main', { scrollToSection: 'roster' }); closeMobileNav(); setTimeout(() => { const roster = document.getElementById('roster-section') || document.getElementById('roster'); if (roster) { roster.scrollIntoView({ behavior: 'smooth', block: 'start' }); } }, 300);";
                } else {
                    onClickHandler = "window.switchView('" + item.id + "'); closeMobileNav();";
                }
                
                return `
                    <button 
                        class="nav-item ${isActive ? 'active' : ''}" 
                        onclick="${onClickHandler}"
                        style="width: 100%; justify-content: flex-start;"
                        aria-label="${item.label}"
                    >
                        <span>${item.icon}</span>
                        <span>${item.label}</span>
                    </button>
                `;
            }).join('');
        }
        
        function renderBreadcrumb(view, context) {
            const breadcrumbNav = document.getElementById('breadcrumb-nav');
            if (!breadcrumbNav) return;
            
            const breadcrumbs = [{ label: 'AmpUp', view: 'main' }];
            
            if (view === 'main') {
                breadcrumbs.push({ label: 'Dashboard', view: 'main', active: true });
            } else if (view === 'recap') {
                breadcrumbs.push({ label: 'Dashboard', view: 'main' });
                breadcrumbs.push({ label: 'Campaign Recap', view: 'recap', active: true });
            } else if (view === 'player') {
                breadcrumbs.push({ label: 'Dashboard', view: 'main' });
                breadcrumbs.push({ label: context?.playerName || 'Player Profile', view: 'player', active: true });
            } else if (view === 'admin') {
                breadcrumbs.push({ label: 'Admin Center', view: 'admin', active: true });
            }
            
            breadcrumbNav.innerHTML = breadcrumbs.map(function(item, index) {
                const isLast = index === breadcrumbs.length - 1;
                return `
                    <div class="breadcrumb-item ${item.active ? 'active' : ''}">
                        ${!isLast ? `<a href="#" onclick="event.preventDefault(); window.switchView('${item.view}'); return false;">${item.label}</a>` : `<span>${item.label}</span>`}
                        ${!isLast ? '<span class="breadcrumb-separator">›</span>' : ''}
                    </div>
                `;
            }).join('');
            
            // Show/hide breadcrumb based on view
            if (view === 'login' || view === 'main') {
                breadcrumbNav.style.display = 'none';
            } else {
                breadcrumbNav.style.display = 'flex';
            }
        }
        
        function closeMobileNav() {
            const drawer = document.getElementById('mobile-nav-drawer');
            const overlay = document.getElementById('mobile-nav-overlay');
            if (drawer) drawer.classList.remove('open');
            if (overlay) overlay.classList.remove('open');
        }
        
        function openMobileNav() {
            const drawer = document.getElementById('mobile-nav-drawer');
            const overlay = document.getElementById('mobile-nav-overlay');
            if (drawer) drawer.classList.add('open');
            if (overlay) overlay.classList.add('open');
        }
        
        // Mobile nav event handlers
        const mobileNavToggle = document.getElementById('mobile-nav-toggle');
        const mobileNavClose = document.getElementById('mobile-nav-close');
        const mobileNavOverlay = document.getElementById('mobile-nav-overlay');
        
        if (mobileNavToggle) {
            mobileNavToggle.addEventListener('click', openMobileNav);
        }
        if (mobileNavClose) {
            mobileNavClose.addEventListener('click', closeMobileNav);
        }
        if (mobileNavOverlay) {
            mobileNavOverlay.addEventListener('click', closeMobileNav);
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Don't trigger shortcuts when typing in inputs
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
                return;
            }
            
            // Check for modifier keys (Ctrl/Cmd)
            if (e.ctrlKey || e.metaKey) {
                return; // Let browser handle Ctrl/Cmd shortcuts
            }
            
            switch(e.key.toLowerCase()) {
                case 'r':
                    if (window.showRewardsMenu) {
                        e.preventDefault();
                        window.showRewardsMenu();
                    }
                    break;
                case 'd':
                    e.preventDefault();
                    window.switchView('main');
                    break;
                case 'l':
                    e.preventDefault();
                    window.switchView('main', { scrollToSection: 'roster' });
                    setTimeout(function() {
                        const roster = document.getElementById('roster-section') || document.getElementById('roster');
                        if (roster) roster.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 300);
                    break;
                case 'p':
                    e.preventDefault();
                    if (window.appState && window.appState.currentUser && typeof window.handleViewPlayer === 'function') {
                        window.handleViewPlayer(window.appState.currentUser.email);
                    }
                    break;
                case 'a':
                    e.preventDefault();
                    if (appState.currentUser && appState.currentUser.isAdmin) {
                        window.switchView('admin');
                    }
                    break;
                case 'escape':
                case 'Escape':
                    // Close any open modals
                    e.preventDefault();
                    if (window.closePrizeModal) {
                        window.closePrizeModal();
                        }
                    // Also close mobile nav if open
                    closeMobileNav();
                    break;
            }
        });
        window.switchView = function(view, context) {
            // Add to history
            if (appState.currentView && appState.currentView !== view) {
                viewHistory.push({ view: appState.currentView, context: appState.currentContext });
            }
            
            appState.currentView = view;
            appState.currentContext = context || {};
            
            // Scroll to top immediately when switching views (unless it's a scroll-to-section case)
            // This ensures users start at the top of new views
            if (view !== 'main' || !context || !context.scrollToSection) {
                window.scrollTo({ top: 0, behavior: 'instant' });
            }
            
            // Hide all views with transition
            const views = [loginScreen, mainApp, recapScreen, playerScreen];
            const adminScreen = document.getElementById('admin-screen');
            if (adminScreen) views.push(adminScreen);
            
            views.forEach(function(viewEl) {
                if (viewEl) {
                    viewEl.classList.remove('active');
                    setTimeout(function() {
                        viewEl.classList.add('hidden');
                    }, 150);
                }
            });
            
            // Show target view with transition
            setTimeout(function() {
                let targetView = null;
                if (view === 'login') targetView = loginScreen;
                else if (view === 'main') targetView = mainApp;
                else if (view === 'recap') targetView = recapScreen;
                else if (view === 'player' && playerScreen) targetView = playerScreen;
                else if (view === 'admin' && adminScreen) targetView = adminScreen;
                
                if (targetView) {
                    targetView.classList.remove('hidden');
                    setTimeout(function() {
                        targetView.classList.add('active');
                        // Ensure we're at the top after view transition completes
                        if (view !== 'main' || !context || !context.scrollToSection) {
                            window.scrollTo({ top: 0, behavior: 'smooth' });
                        }
                    }, 10);
                }
                
                // Render navigation and breadcrumb
                renderNavigation();
                renderBreadcrumb(view, context);
                
                // Special handling for admin view
                if (view === 'admin' && adminScreen) {
                    renderAdminDashboard();
                }
            }, 150);
        }
        
        // Calculate Impact Score (replaces simple point counting)
        function calculateImpactScore(user, allUsers = [], performanceData = {}, participationData = {}) {
            // Safeguard: Check if IMPACT_SCORE_WEIGHTS is defined
            if (typeof IMPACT_SCORE_WEIGHTS === 'undefined') {
                logger.error('IMPACT_SCORE_WEIGHTS not defined, using fallback values');
                // Return 0 or use fallback calculation
                return 0;
            }
            
            // Safeguard: Check if user is valid
            if (!user || !user.email) {
                logger.error('Invalid user object passed to calculateImpactScore');
                return 0;
            }
            
            let impactScore = 0;
            const userEmail = user.email.toLowerCase();
            
            // Count shares (low weight - avoid overjustification)
            const shares = (user.participatedDrops || []).length;
            impactScore += shares * IMPACT_SCORE_WEIGHTS.SHARE_SUGGESTED;
            
            // Count clicks (medium weight - competence indicator)
            let totalClicks = 0;
            Object.values(performanceData).forEach(function(dropPerf) {
                totalClicks += dropPerf[userEmail] || 0;
            });
            impactScore += totalClicks * IMPACT_SCORE_WEIGHTS.CLICK_ON_LINK;
            
            // Count comments generated (high weight - meaningful engagement)
            const comments = user.commentsGenerated || 0;
            impactScore += comments * IMPACT_SCORE_WEIGHTS.COMMENT_ON_POST;
            
            // Count original posts (very high weight - autonomy and creativity)
            const originalPosts = user.originalPosts || 0;
            impactScore += originalPosts * IMPACT_SCORE_WEIGHTS.ORIGINAL_POST;
            
            // Count peer badges received (high weight - social recognition)
            const peerBadges = user.peerBadgesReceived || 0;
            impactScore += peerBadges * IMPACT_SCORE_WEIGHTS.PEER_BADGE_RECEIVED;
            
            // Count conversions (highest weight - business impact)
            const conversions = (user.conversions || []).length;
            impactScore += conversions * IMPACT_SCORE_WEIGHTS.CONVERSION_LEAD;
            
            // Participation quality bonus (autonomy indicators)
            try {
                if (participationData && typeof participationData === 'object') {
            Object.values(participationData).forEach(function(participation) {
                        if (participation && participation.email === userEmail) {
                    if (participation.copyType === 'original') {
                        impactScore += IMPACT_SCORE_WEIGHTS.ORIGINAL_POST * 0.5; // Bonus for original copy
                    }
                    if (participation.hasStory) {
                        impactScore += 5; // Personal story adds authenticity
                    }
                }
            });
                }
            } catch (error) {
                logger.error('Error processing participation data:', error);
                // Continue with calculation even if participation data processing fails
            }
            
            return Math.round(impactScore);
        }
        
        // Legacy function for backward compatibility (maps to Impact Score)
        function calculateClickPoints(clicks) {
            // Map clicks to impact score equivalent
            return clicks * IMPACT_SCORE_WEIGHTS.CLICK_ON_LINK;
        }

        function calculateParticipationPoints(participation) {
            let points = IMPACT_SCORE_WEIGHTS.SHARE_SUGGESTED; // Base share value
            
            // Quality bonuses (autonomy and creativity)
            if (participation.copyType === 'customized') points += 3; // Small bonus for customization
            if (participation.copyType === 'original') points += IMPACT_SCORE_WEIGHTS.ORIGINAL_POST * 0.3; // Significant bonus
            if (participation.hasStory) points += 5; // Authenticity bonus
            if (participation.hasCTA) points += 2; // Engagement bonus
            if (participation.isFirstParticipant) points += 3; // First responder bonus
            if (participation.sharedOn && participation.sharedOn.length > 1) points += 3; // Cross-platform bonus
            if (participation.colleaguesTagged) points += participation.colleaguesTagged * 2; // Social connection bonus
            
            return Math.round(points);
        }

        function calculateEstimatedPoints(participation) {
            const basePoints = calculateParticipationPoints(participation);
            return {
                participation: basePoints,
                estimatedClicks: '10-15 per click',
                total: basePoints
            };
        }
        // --- LEVEL & REPUTATION SYSTEM --- //
        
        // XP required per level (exponential growth)
        function getXPForLevel(level) {
            if (level <= 1) return 0;
            // Exponential formula: base * (multiplier ^ (level - 1))
            // Level 1: 0 XP, Level 2: 100 XP, Level 3: 250 XP, etc.
            const base = 100;
            const multiplier = 1.15;
            let totalXP = 0;
            for (let i = 2; i <= level; i++) {
                totalXP += Math.floor(base * Math.pow(multiplier, i - 2));
            }
            return totalXP;
        }
        // Calculate level from Impact Score (1 Impact Point = 1 XP)
        // Impact Score is now the primary metric (replaces totalHype)
        function calculateLevel(impactScore) {
            if (impactScore < 0) return 1;
            let level = 1;
            while (level < 50 && getXPForLevel(level + 1) <= impactScore) {
                level++;
            }
            return Math.min(level, 50);
        }

        // Calculate XP progress for current level (using Impact Score)
        function calculateXPProgress(impactScore) {
            const level = calculateLevel(impactScore);
            const xpForCurrentLevel = getXPForLevel(level);
            const xpForNextLevel = getXPForLevel(level + 1);
            const currentXP = impactScore - xpForCurrentLevel;
            const xpNeeded = xpForNextLevel - xpForCurrentLevel;
            const progress = level >= 50 ? 100 : (currentXP / xpNeeded) * 100;
            
            return {
                level: level,
                currentXP: currentXP,
                xpNeeded: xpNeeded,
                progress: Math.min(progress, 100),
                totalXP: impactScore
            };
        }
        
        // --- MISSION/QUEST FRAMEWORK --- //
        // Based on Octalysis Drive 1: Epic Meaning & Calling
        // Transforms tasks into narrative-driven missions
        
        const MISSION_TYPES = {
            ONBOARDING: 'onboarding',
            SKILL: 'skill',
            CAMPAIGN: 'campaign',
            CREATIVE: 'creative',
            TEAM: 'team',
            SPECIAL: 'special'
        };
        
        // Mission definitions with narrative framing
        function getMissionDefinitions() {
            return {
                'new-ambassador-quest': {
                    id: 'new-ambassador-quest',
                    type: MISSION_TYPES.ONBOARDING,
                    name: 'Your Ambassador Journey Begins',
                    narrative: 'Welcome to the team! Your journey as a brand ambassador starts here. Complete these challenges to unlock your potential and join the community of experts.',
                    emoji: '🌱',
                    category: 'Onboarding',
                    targetPlayerTypes: ['Achievers', 'Explorers', 'Socializers'],
                    tasks: [
                        {
                            id: 'skill-builder',
                            name: 'Skill-Builder Challenge',
                            description: 'Complete a 2-minute quiz on our social media policy',
                            type: 'quiz',
                            reward: { impactScore: 10, badge: 'policy-expert' },
                            sdtsatisfies: ['Competence']
                        },
                        {
                            id: 'scavenger-hunt',
                            name: 'The Great Scavenger Hunt',
                            description: 'Find 3 colleagues from your department and follow them',
                            type: 'social',
                            reward: { impactScore: 15, badge: 'network-builder' },
                            sdtsatisfies: ['Relatedness']
                        },
                        {
                            id: 'meet-greet',
                            name: 'Meet and Greet',
                            description: 'Post one "hello" message in your team\'s discussion channel',
                            type: 'social',
                            reward: { impactScore: 10, badge: 'team-player' },
                            sdtsatisfies: ['Relatedness']
                        },
                        {
                            id: 'first-share',
                            name: 'First Share Achievement',
                            description: 'Make your first suggested share from the content library',
                            type: 'action',
                            reward: { impactScore: 5, badge: 'first-steps' },
                            sdtsatisfies: ['Competence']
                        }
                    ],
                    completionReward: { impactScore: 50, badge: 'ambassador-initiate' }
                },
                'topic-specialist': {
                    id: 'topic-specialist',
                    type: MISSION_TYPES.SKILL,
                    name: 'Topic Specialist',
                    narrative: 'Become the go-to expert in your field. Share knowledge and insights to establish yourself as a thought leader.',
                    emoji: '🎯',
                    category: 'Skill Development',
                    targetPlayerTypes: ['Achievers', 'Explorers'],
                    tasks: [
                        {
                            id: 'share-articles',
                            name: 'Share 3 Articles',
                            description: 'Share 3 articles about this month\'s featured topic',
                            type: 'action',
                            count: 3,
                            reward: { impactScore: 30, badge: 'specialist' },
                            sdtsatisfies: ['Competence']
                        }
                    ],
                    completionReward: { impactScore: 50, badge: 'topic-master' }
                },
                'content-creator': {
                    id: 'content-creator',
                    type: MISSION_TYPES.CREATIVE,
                    name: 'Content Creator',
                    narrative: 'Unleash your creativity! Write original content that showcases your expertise and unique perspective.',
                    emoji: '✍️',
                    category: 'Creativity',
                    targetPlayerTypes: ['Explorers', 'Achievers'],
                    tasks: [
                        {
                            id: 'write-post',
                            name: 'Write Original Post',
                            description: 'Write one original, 500-word post about your work and submit it to the community blog',
                            type: 'creative',
                            reward: { impactScore: IMPACT_SCORE_WEIGHTS.ORIGINAL_POST, badge: 'innovator' },
                            sdtsatisfies: ['Autonomy', 'Competence']
                        }
                    ],
                    completionReward: { impactScore: 100, badge: 'content-master' }
                },
                'team-campaign': {
                    id: 'team-campaign',
                    type: MISSION_TYPES.TEAM,
                    name: 'Team vs. Team Challenge',
                    narrative: 'Unite with your team to achieve greatness! Compete collaboratively to drive real impact.',
                    emoji: '🤝',
                    category: 'Team Collaboration',
                    targetPlayerTypes: ['Socializers', 'Killers'],
                    tasks: [
                        {
                            id: 'team-engagement',
                            name: 'Team Engagement Goal',
                            description: 'Your team must generate the most engagement on the new product launch this week',
                            type: 'team',
                            reward: { impactScore: 50, badge: 'team-mvp' },
                            sdtsatisfies: ['Relatedness', 'Competence']
                        }
                    ],
                    completionReward: { impactScore: 100, badge: 'champion-team' }
                }
            };
        }
        
        // Check mission progress
        function checkMissionProgress(missionId, user, appState) {
            const missions = getMissionDefinitions();
            const mission = missions[missionId];
            if (!mission) return null;
            
            const progress = {
                missionId: missionId,
                mission: mission,
                completedTasks: [],
                totalTasks: mission.tasks.length,
                isComplete: false,
                progress: 0
            };
            
            mission.tasks.forEach(function(task) {
                let taskComplete = false;
                
                if (task.type === 'action' && task.count) {
                    // Count actions
                    const actionCount = (user.participatedDrops || []).length;
                    taskComplete = actionCount >= task.count;
                } else if (task.type === 'social') {
                    // Check social connections
                    taskComplete = (user.following || []).length >= 3;
                } else if (task.type === 'creative') {
                    // Check original posts
                    taskComplete = (user.originalPosts || 0) > 0;
                } else if (task.type === 'quiz') {
                    // Check if quiz completed
                    taskComplete = user.quizCompleted || false;
                }
                
                if (taskComplete) {
                    progress.completedTasks.push(task.id);
                }
            });
            
            progress.progress = (progress.completedTasks.length / progress.totalTasks) * 100;
            progress.isComplete = progress.completedTasks.length === progress.totalTasks;
            
            return progress;
        }

        // Reputation titles based on level (using Impact Score)
        function calculateReputationTitle(level, impactScore, badges = []) {
            if (level >= 45) return { title: 'Legend', emoji: '👑', color: '#FFD700' };
            if (level >= 35) return { title: 'Master', emoji: '⭐', color: '#BE38F3' };
            if (level >= 25) return { title: 'Expert', emoji: '🎯', color: '#F43F5E' };
            if (level >= 15) return { title: 'Veteran', emoji: '🏆', color: '#3B82F6' };
            if (level >= 8) return { title: 'Novice', emoji: '🌟', color: '#10B981' };
            return { title: 'Rookie', emoji: '🌱', color: '#6B7280' };
        }

        // --- MULTI-FACETED LEADERBOARD SYSTEM --- //
        // Based on Social Comparison Theory - avoids "Ladder Anxiety"
        // Provides multiple competitive contexts to serve all player types
        
        function generatePersonalMicroLeague(user, allUsers, impactScores) {
            // "5-Up / 5-Down" - Shows achievable next steps (Urgent Optimism)
            const sortedUsers = allUsers
                .map(u => ({ ...u, impactScore: impactScores[u.email] || 0 }))
                .sort((a, b) => b.impactScore - a.impactScore);
            
            const userIndex = sortedUsers.findIndex(u => u.email === user.email);
            if (userIndex === -1) return null;
            
            const startIndex = Math.max(0, userIndex - 5);
            const endIndex = Math.min(sortedUsers.length, userIndex + 6);
            
            return {
                type: 'personal-micro',
                users: sortedUsers.slice(startIndex, endIndex),
                userPosition: userIndex + 1,
                totalUsers: sortedUsers.length,
                percentile: Math.round(((sortedUsers.length - userIndex) / sortedUsers.length) * 100)
            };
        }
        
        function generateTeamLeaderboard(user, allUsers, impactScores) {
            // Team-based competition (fosters Relatedness and collaboration)
            const teams = {};
            
            allUsers.forEach(u => {
                const dept = u.department || 'Unassigned';
                if (!teams[dept]) {
                    teams[dept] = {
                        name: dept,
                        members: [],
                        totalImpact: 0,
                        avgImpact: 0
                    };
                }
                const impact = impactScores[u.email] || 0;
                teams[dept].members.push({ ...u, impactScore: impact });
                teams[dept].totalImpact += impact;
            });
            
            Object.keys(teams).forEach(dept => {
                teams[dept].avgImpact = teams[dept].totalImpact / teams[dept].members.length;
            });
            
            const sortedTeams = Object.values(teams).sort((a, b) => b.totalImpact - a.totalImpact);
            
            return {
                type: 'team',
                teams: sortedTeams,
                userTeam: teams[user.department || 'Unassigned'],
                userTeamRank: sortedTeams.findIndex(t => t.name === (user.department || 'Unassigned')) + 1
            };
        }
        
        function generateRotatingMetricLeaderboard(allUsers, metric, impactScores) {
            // Rotating metrics prevent "gaming" and give all types a chance to win
            let sortedUsers = [];
            
            switch(metric) {
                case 'most-creative':
                    sortedUsers = allUsers
                        .map(u => ({ ...u, score: (u.originalPosts || 0) * IMPACT_SCORE_WEIGHTS.ORIGINAL_POST }))
                        .sort((a, b) => b.score - a.score);
                    break;
                case 'most-engaged':
                    sortedUsers = allUsers
                        .map(u => ({ ...u, score: (u.commentsGenerated || 0) * IMPACT_SCORE_WEIGHTS.COMMENT_ON_POST }))
                        .sort((a, b) => b.score - a.score);
                    break;
                case 'most-conversions':
                    sortedUsers = allUsers
                        .map(u => ({ ...u, score: ((u.conversions || []).length) * IMPACT_SCORE_WEIGHTS.CONVERSION_LEAD }))
                        .sort((a, b) => b.score - a.score);
                    break;
                default:
                    sortedUsers = allUsers
                        .map(u => ({ ...u, score: impactScores[u.email] || 0 }))
                        .sort((a, b) => b.score - a.score);
            }
            
            return {
                type: 'rotating-metric',
                metric: metric,
                users: sortedUsers.slice(0, 10), // Top 10
                period: 'weekly'
            };
        }
        
        // --- PRESTIGE SYSTEM --- //
        // Inspired by Call of Duty - transforms veterans into co-creators
        // Satisfies highest levels of Autonomy and Epic Meaning
        
        const PRESTIGE_PATHS = {
            MENTOR: {
                id: 'mentor',
                name: 'Mentor',
                emoji: '🎓',
                description: 'Guide new ambassadors through their journey. Help others grow and unlock their potential.',
                unlocks: [
                    'Ability to "adopt" new hires',
                    'Access to mentorship dashboard',
                    'Mentor badge and recognition',
                    'Ability to create onboarding quests'
                ],
                sdtsatisfies: ['Relatedness', 'Social Influence'],
                targetPlayerTypes: ['Socializers']
            },
            CONTENT_CREATOR: {
                id: 'content-creator',
                name: 'Content Creator',
                emoji: '✍️',
                description: 'Unlock advanced content creation tools. Shape the narrative and create original content for company-wide campaigns.',
                unlocks: [
                    'Access to editorial calendar',
                    'Content submission portal',
                    'Creator badge and recognition',
                    'Ability to suggest campaign themes'
                ],
                sdtsatisfies: ['Autonomy', 'Creativity'],
                targetPlayerTypes: ['Explorers', 'Achievers']
            },
            COMMUNITY_HERO: {
                id: 'community-hero',
                name: 'Community Hero',
                emoji: '🦸',
                description: 'Become a community moderator. Help manage discussions and foster a positive, engaging environment.',
                unlocks: [
                    'Moderator privileges',
                    'Community management tools',
                    'Hero badge and recognition',
                    'Ability to create team missions'
                ],
                sdtsatisfies: ['Epic Meaning', 'Ownership'],
                targetPlayerTypes: ['Socializers', 'Achievers']
            }
        };
        
        function checkPrestigeEligibility(user, impactScore) {
            const level = calculateLevel(impactScore);
            const isEligible = level >= 50; // Max level reached
            
            if (!isEligible) {
                return {
                    eligible: false,
                    currentLevel: level,
                    requiredLevel: 50,
                    progress: (level / 50) * 100
                };
            }
            
            return {
                eligible: true,
                currentLevel: level,
                paths: PRESTIGE_PATHS,
                hasChosenPath: !!user.prestigePath
            };
        }
        
        function unlockPrestigePath(user, pathId) {
            const path = PRESTIGE_PATHS[pathId.toUpperCase()];
            if (!path) return false;
            
            user.prestigePath = pathId;
            user.prestigeUnlocked = true;
            user.prestigeUnlockedAt = new Date().toISOString();
            
            // Grant path-specific badges
            if (!user.badges) user.badges = [];
            if (!user.badges.includes(pathId + '-prestige')) {
                user.badges.push(pathId + '-prestige');
            }
            
            return true;
        }

        // Helper: Get Impact Score for a user (calculates if not cached)
        function getUserImpactScore(user, allUsers = [], performanceData = {}, participationData = {}) {
            try {
                // Safeguard: Check if user is valid
                if (!user || !user.email) {
                    logger.error('Invalid user object passed to getUserImpactScore');
                    return 0;
                }
                
            // Use cached value if available and recent
            if (user.impactScore !== undefined && user.impactScoreLastCalculated) {
                const cacheAge = Date.now() - new Date(user.impactScoreLastCalculated).getTime();
                if (cacheAge < 60000) { // Cache for 1 minute
                    return user.impactScore;
                }
            }
            
            // Calculate fresh Impact Score
                if (typeof calculateImpactScore !== 'function') {
                    logger.error('calculateImpactScore function is not defined');
                    return 0;
                }
                
            const impactScore = calculateImpactScore(user, allUsers, performanceData, participationData);
            user.impactScore = impactScore;
            user.impactScoreLastCalculated = new Date().toISOString();
            
            // Maintain backward compatibility with totalHype
            if (!user.totalHype) {
                user.totalHype = impactScore;
            }
            
            return impactScore;
            } catch (error) {
                logger.error('Error in getUserImpactScore:', error);
                logger.error('Stack:', error.stack);
                // Return fallback value
                return user.totalHype || 0;
            }
        }
        
        // Calculate reputation score (0-100) - now uses Impact Score
        function calculateReputationScore(user, allUsers = [], performanceData = {}, participationData = {}) {
            let score = 0;
            
            // Get Impact Score
            const impactScore = getUserImpactScore(user, allUsers, performanceData, participationData);
            
            // Level contribution (0-40 points)
            const level = calculateLevel(impactScore);
            score += (level / 50) * 40;
            
            // Badge contribution (0-20 points)
            const badgeCount = (user.badges || []).length;
            score += Math.min((badgeCount / 10) * 20, 20);
            
            // Participation consistency (0-20 points)
            const participatedDrops = user.participatedDrops || [];
            const totalDrops = allUsers.length > 0 ? 
                Math.max(...allUsers.map(u => (u.participatedDrops || []).length)) : 1;
            const participationRate = participatedDrops.length / Math.max(totalDrops, 1);
            score += participationRate * 20;
            
            // Relative performance (0-20 points) - based on Impact Score
            if (allUsers.length > 0) {
                const allImpactScores = allUsers.map(u => 
                    getUserImpactScore(u, allUsers, performanceData, participationData)
                );
                const maxImpact = Math.max(...allImpactScores, 1);
                const relativeImpact = impactScore / maxImpact;
                score += relativeImpact * 20;
            }
            
            return Math.min(Math.round(score), 100);
        }
        // Award Impact Score (replaces awardXP)
        function awardImpactScore(user, points, allUsers = [], performanceData = {}, participationData = {}) {
            if (!user) return;
            
            const oldImpactScore = getUserImpactScore(user, allUsers, performanceData, participationData);
            const oldLevel = calculateLevel(oldImpactScore);
            
            // Update Impact Score
            user.impactScore = (user.impactScore || oldImpactScore) + points;
            user.totalHype = user.impactScore; // Maintain backward compatibility
            user.impactScoreLastCalculated = new Date().toISOString();
            
            const newLevel = calculateLevel(user.impactScore);
            
            // Check for level up
            if (newLevel > oldLevel) {
                return {
                    leveledUp: true,
                    oldLevel: oldLevel,
                    newLevel: newLevel,
                    impactScore: user.impactScore,
                    totalHype: user.impactScore // Backward compatibility
                };
            }
            
            return {
                leveledUp: false,
                level: newLevel,
                impactScore: user.impactScore,
                totalHype: user.impactScore // Backward compatibility
            };
        }

        // Initialize user level/reputation data (using Impact Score)
        function initializeUserReputation(user, allUsers = [], performanceData = {}, participationData = {}) {
            if (!user) return user;
            
            const impactScore = getUserImpactScore(user, allUsers, performanceData, participationData);
            const level = calculateLevel(impactScore);
            const xpProgress = calculateXPProgress(impactScore);
            const reputationTitle = calculateReputationTitle(level, impactScore, user.badges || []);
            
            // Add reputation data to user object
            user.level = level;
            user.xp = impactScore;
            user.xpProgress = xpProgress;
            user.reputationTitle = reputationTitle;
            user.impactScore = impactScore;
            
            // Maintain backward compatibility
            if (!user.totalHype) {
                user.totalHype = impactScore;
            }
            
            return user;
        }

        // --- PRIZE SYSTEM --- //
        
        // Prize definitions with rarity tiers
        const PRIZE_DEFINITIONS = {
            topPerformer: {
                id: 'top-performer',
                name: 'Top Performer',
                category: 'Top Performer',
                rarity: 'legendary',
                requirement: { type: 'rank', value: 1 },
                reward: '$500 Gift Card + Featured Recognition',
                icon: '🥇',
                description: 'Achieve #1 rank on the leaderboard'
            },
            runnerUp: {
                id: 'runner-up',
                name: 'Runner Up',
                category: 'Top Performer',
                rarity: 'epic',
                requirement: { type: 'rank', value: [2, 3] },
                reward: '$250 Gift Card',
                icon: '🥈',
                description: 'Achieve #2 or #3 rank on the leaderboard'
            },
            topTen: {
                id: 'top-ten',
                name: 'Top 10',
                category: 'Top Performer',
                rarity: 'rare',
                requirement: { type: 'rank', value: [4, 10] },
                reward: '$100 Gift Card',
                icon: '🥉',
                description: 'Achieve top 10 rank on the leaderboard'
            },
            participation: {
                id: 'participation',
                name: 'Participation Prize',
                category: 'Participation',
                rarity: 'common',
                requirement: { type: 'participation', value: true },
                reward: 'Exclusive Badge + Recognition',
                icon: '⭐',
                description: 'Participate in any campaign'
            },
            milestone1000: {
                id: 'milestone-1000',
                name: '1K Clicks',
                category: 'Milestone',
                rarity: 'epic',
                requirement: { type: 'clicks', value: 1000 },
                reward: 'Special Badge + $50 Gift Card',
                icon: '🎯',
                description: 'Generate 1000+ total clicks across all campaigns'
            },
            milestone500: {
                id: 'milestone-500',
                name: '500 Clicks',
                category: 'Milestone',
                rarity: 'rare',
                requirement: { type: 'clicks', value: 500 },
                reward: 'Special Badge + Recognition',
                icon: '🎯',
                description: 'Generate 500+ total clicks across all campaigns'
            },
            level25: {
                id: 'level-25',
                name: 'Level 25',
                category: 'Milestone',
                rarity: 'epic',
                requirement: { type: 'level', value: 25 },
                reward: 'Level 25 Badge + $100 Gift Card',
                icon: '⭐',
                description: 'Reach Level 25'
            },
            level50: {
                id: 'level-50',
                name: 'Level 50',
                category: 'Milestone',
                rarity: 'legendary',
                requirement: { type: 'level', value: 50 },
                reward: 'Level 50 Badge + $500 Gift Card',
                icon: '👑',
                description: 'Reach Level 50 (Max Level)'
            }
        };

        // --- PRIZE SHOP SYSTEM --- //
        // Shop items that can be purchased with points
        const PRIZE_SHOP_ITEMS = {
            wheelSpin1: {
                id: 'wheel-spin-1',
                name: 'Wheel Spin',
                category: 'Spins',
                cost: 500, // Points cost
                icon: '🎰',
                description: 'Spin the wheel for a chance to win prizes!',
                type: 'wheel-spin',
                quantity: 1
            },
            wheelSpin3: {
                id: 'wheel-spin-3',
                name: '3x Wheel Spins',
                category: 'Spins',
                cost: 1200, // Discounted bundle
                icon: '🎰',
                description: 'Get 3 wheel spins at a discount!',
                type: 'wheel-spin',
                quantity: 3
            },
            wheelSpin5: {
                id: 'wheel-spin-5',
                name: '5x Wheel Spins',
                category: 'Spins',
                cost: 1800, // Best value bundle
                icon: '🎰',
                description: 'Best value! Get 5 wheel spins.',
                type: 'wheel-spin',
                quantity: 5
            },
            bonusPoints100: {
                id: 'bonus-points-100',
                name: '100 Bonus Points',
                category: 'Boosters',
                cost: 800,
                icon: '⚡',
                description: 'Instant 100 bonus points added to your account',
                type: 'bonus-points',
                value: 100
            },
            bonusPoints250: {
                id: 'bonus-points-250',
                name: '250 Bonus Points',
                category: 'Boosters',
                cost: 1800,
                icon: '⚡',
                description: 'Instant 250 bonus points added to your account',
                type: 'bonus-points',
                value: 250
            },
            rareBadge: {
                id: 'rare-badge',
                name: 'Mystery Badge',
                category: 'Cosmetics',
                cost: 1000,
                icon: '🎖️',
                description: 'Unlock a random rare badge',
                type: 'badge',
                rarity: 'rare'
            },
            epicBadge: {
                id: 'epic-badge',
                name: 'Epic Mystery Badge',
                category: 'Cosmetics',
                cost: 2500,
                icon: '🏅',
                description: 'Unlock a random epic badge',
                type: 'badge',
                rarity: 'epic'
            }
        };

        // --- WHEEL SPIN SYSTEM --- //
        // Prize wheel with weighted chances
        const WHEEL_PRIZES = [
            // Common prizes (most likely)
            { id: 'common-1', name: '50 Points', value: 50, type: 'points', rarity: 'common', weight: 35, icon: '💰', color: '#6B7280' },
            { id: 'common-2', name: '100 Points', value: 100, type: 'points', rarity: 'common', weight: 30, icon: '💰', color: '#6B7280' },
            { id: 'common-3', name: '1 Extra Spin', value: 1, type: 'wheel-spin', rarity: 'common', weight: 20, icon: '🎰', color: '#6B7280' },
            
            // Rare prizes (less common)
            { id: 'rare-1', name: '250 Points', value: 250, type: 'points', rarity: 'rare', weight: 8, icon: '💎', color: '#3B82F6' },
            { id: 'rare-2', name: '2 Extra Spins', value: 2, type: 'wheel-spin', rarity: 'rare', weight: 5, icon: '🎰', color: '#3B82F6' },
            { id: 'rare-3', name: '£5 Coffee Voucher', value: 5, type: 'voucher', voucherType: 'coffee', rarity: 'rare', weight: 1.5, icon: '☕', color: '#3B82F6' },
            
            // Epic prizes (rare)
            { id: 'epic-1', name: '500 Points', value: 500, type: 'points', rarity: 'epic', weight: 0.3, icon: '💎', color: '#8B5CF6' },
            { id: 'epic-2', name: '£20 Deliveroo Voucher', value: 20, type: 'voucher', voucherType: 'deliveroo', rarity: 'epic', weight: 0.15, icon: '🍔', color: '#8B5CF6' },
            { id: 'epic-3', name: '£10 Coffee Voucher', value: 10, type: 'voucher', voucherType: 'coffee', rarity: 'epic', weight: 0.05, icon: '☕', color: '#8B5CF6' },
            
            // Legendary prizes (very rare)
            { id: 'legendary-1', name: '1000 Points', value: 1000, type: 'points', rarity: 'legendary', weight: 0.01, icon: '👑', color: '#F59E0B' },
            { id: 'legendary-2', name: '£50 Amazon Voucher', value: 50, type: 'voucher', voucherType: 'amazon', rarity: 'legendary', weight: 0.005, icon: '🎁', color: '#F59E0B' }
        ];

        // Calculate total weight for probability
        const WHEEL_TOTAL_WEIGHT = WHEEL_PRIZES.reduce((sum, prize) => sum + prize.weight, 0);

        // Spin the wheel and return a random prize based on weights
        function spinWheel() {
            const random = Math.random() * WHEEL_TOTAL_WEIGHT;
            let currentWeight = 0;
            
            for (const prize of WHEEL_PRIZES) {
                currentWeight += prize.weight;
                if (random <= currentWeight) {
                    return { ...prize };
                }
            }
            
            // Fallback to first prize (should never happen)
            return { ...WHEEL_PRIZES[0] };
        }

        // --- BATTLE PASS SYSTEM --- //
        // Milestone-based progression that unlocks wheel spins
        const BATTLE_PASS_MILESTONES = [
            { level: 1, reward: { type: 'wheel-spin', quantity: 1 }, pointsRequired: 0, name: 'Welcome Bonus' },
            { level: 2, reward: { type: 'wheel-spin', quantity: 1 }, pointsRequired: 500, name: 'First Steps' },
            { level: 3, reward: { type: 'wheel-spin', quantity: 2 }, pointsRequired: 1000, name: 'Getting Started' },
            { level: 4, reward: { type: 'points', quantity: 100 }, pointsRequired: 1500, name: 'Point Boost' },
            { level: 5, reward: { type: 'wheel-spin', quantity: 1 }, pointsRequired: 2000, name: 'Milestone 5' },
            { level: 6, reward: { type: 'badge', rarity: 'common' }, pointsRequired: 3000, name: 'Common Badge' },
            { level: 7, reward: { type: 'wheel-spin', quantity: 2 }, pointsRequired: 4000, name: 'Double Spin' },
            { level: 8, reward: { type: 'points', quantity: 250 }, pointsRequired: 5000, name: 'Point Boost' },
            { level: 9, reward: { type: 'wheel-spin', quantity: 1 }, pointsRequired: 6000, name: 'Milestone 9' },
            { level: 10, reward: { type: 'wheel-spin', quantity: 3 }, pointsRequired: 7000, name: 'Triple Spin' },
            { level: 11, reward: { type: 'badge', rarity: 'rare' }, pointsRequired: 8500, name: 'Rare Badge' },
            { level: 12, reward: { type: 'wheel-spin', quantity: 2 }, pointsRequired: 10000, name: 'Double Spin' },
            { level: 13, reward: { type: 'points', quantity: 500 }, pointsRequired: 12000, name: 'Point Boost' },
            { level: 14, reward: { type: 'wheel-spin', quantity: 1 }, pointsRequired: 14000, name: 'Milestone 14' },
            { level: 15, reward: { type: 'wheel-spin', quantity: 5 }, pointsRequired: 16000, name: 'Mega Spin' },
            { level: 16, reward: { type: 'badge', rarity: 'epic' }, pointsRequired: 20000, name: 'Epic Badge' },
            { level: 17, reward: { type: 'wheel-spin', quantity: 3 }, pointsRequired: 25000, name: 'Triple Spin' },
            { level: 18, reward: { type: 'points', quantity: 1000 }, pointsRequired: 30000, name: 'Point Boost' },
            { level: 19, reward: { type: 'wheel-spin', quantity: 2 }, pointsRequired: 35000, name: 'Double Spin' },
            { level: 20, reward: { type: 'wheel-spin', quantity: 10 }, pointsRequired: 40000, name: 'Ultimate Spin' }
        ];

        // Calculate battle pass progress
        function calculateBattlePassProgress(user, allUsers = [], performanceData = {}, participationData = {}) {
            if (!user) return { currentLevel: 0, progress: 0, nextMilestone: null, unlockedMilestones: [] };
            
            const impactScore = getUserImpactScore(user, allUsers, performanceData, participationData);
            let currentLevel = 0;
            let nextMilestone = null;
            const unlockedMilestones = [];
            
            for (const milestone of BATTLE_PASS_MILESTONES) {
                if (impactScore >= milestone.pointsRequired) {
                    currentLevel = milestone.level;
                    unlockedMilestones.push(milestone);
                } else if (!nextMilestone) {
                    nextMilestone = milestone;
                    break;
                }
            }
            
            if (!nextMilestone) {
                nextMilestone = BATTLE_PASS_MILESTONES[BATTLE_PASS_MILESTONES.length - 1];
            }
            
            const progress = nextMilestone 
                ? Math.min(((impactScore - (currentLevel > 0 ? BATTLE_PASS_MILESTONES[currentLevel - 1].pointsRequired : 0)) / 
                           (nextMilestone.pointsRequired - (currentLevel > 0 ? BATTLE_PASS_MILESTONES[currentLevel - 1].pointsRequired : 0))) * 100, 100)
                : 100;
            
            return {
                currentLevel,
                progress: Math.max(0, progress),
                nextMilestone,
                unlockedMilestones,
                totalMilestones: BATTLE_PASS_MILESTONES.length
            };
        }
        // Check if user has unclaimed battle pass rewards
        function getUnclaimedBattlePassRewards(user, battlePassProgress) {
            if (!user || !battlePassProgress) return [];
            
            const claimedRewards = user.claimedBattlePassRewards || [];
            const unclaimed = [];
            
            battlePassProgress.unlockedMilestones.forEach(milestone => {
                if (!claimedRewards.includes(milestone.level)) {
                    unclaimed.push(milestone);
                }
            });
            
            return unclaimed;
        }
        // Claim battle pass reward
        function claimBattlePassReward(user, milestoneLevel) {
            if (!user) return null;
            
            const milestone = BATTLE_PASS_MILESTONES.find(m => m.level === milestoneLevel);
            if (!milestone) return null;
            
            if (!user.claimedBattlePassRewards) {
                user.claimedBattlePassRewards = [];
            }
            
            if (user.claimedBattlePassRewards.includes(milestoneLevel)) {
                return { success: false, message: 'Reward already claimed' };
            }
            
            // Add reward to user
            const reward = milestone.reward;
            if (reward.type === 'wheel-spin') {
                if (!user.wheelSpins) user.wheelSpins = 0;
                user.wheelSpins += reward.quantity;
            } else if (reward.type === 'points') {
                if (!user.bonusPoints) user.bonusPoints = 0;
                user.bonusPoints += reward.quantity;
            } else if (reward.type === 'badge') {
                if (!user.badges) user.badges = [];
                const badgeId = `battle-pass-${milestone.level}-${reward.rarity}`;
                if (!user.badges.includes(badgeId)) {
                    user.badges.push(badgeId);
                }
            }
            
            user.claimedBattlePassRewards.push(milestoneLevel);
            
            return { success: true, reward: reward, milestone: milestone };
        }

        // --- REDEMPTION SYSTEM --- //
        // Purchase shop item with points
        function purchaseShopItem(user, itemId) {
            if (!user) return { success: false, message: 'User not found' };
            
            const item = PRIZE_SHOP_ITEMS[itemId];
            if (!item) return { success: false, message: 'Item not found' };
            
            // Get user's current points (impact score)
            const allUsers = [...appState.crew, user].filter((v, i, a) => 
                a.findIndex(t => t.email === v.email) === i && v
            );
            const currentPoints = getUserImpactScore(user, allUsers, appState.performanceData, appState.participationData);
            
            if (currentPoints < item.cost) {
                return { success: false, message: `Insufficient points. You need ${item.cost} points but only have ${currentPoints.toLocaleString()}` };
            }
            
            // Apply the purchase
            if (item.type === 'wheel-spin') {
                if (!user.wheelSpins) user.wheelSpins = 0;
                user.wheelSpins += item.quantity;
            } else if (item.type === 'bonus-points') {
                if (!user.bonusPoints) user.bonusPoints = 0;
                user.bonusPoints += item.value;
            } else if (item.type === 'badge') {
                if (!user.badges) user.badges = [];
                const badgeId = `shop-${item.rarity}-${Date.now()}`;
                if (!user.badges.includes(badgeId)) {
                    user.badges.push(badgeId);
                }
            }
            
            // Deduct points (this will be reflected in next impact score calculation)
            // For now, we'll track it separately
            if (!user.spentPoints) user.spentPoints = 0;
            user.spentPoints += item.cost;
            
            return { success: true, item: item, remainingPoints: currentPoints - item.cost };
        }

        // Use wheel spin
        function useWheelSpin(user) {
            if (!user) return { success: false, message: 'User not found' };
            
            if (!user.wheelSpins || user.wheelSpins <= 0) {
                return { success: false, message: 'No wheel spins available. Purchase more in the shop!' };
            }
            
            // Deduct one spin
            user.wheelSpins -= 1;
            
            // Spin the wheel
            const prize = spinWheel();
            
            // Apply prize
            const allUsers = [...appState.crew, user].filter((v, i, a) => 
                a.findIndex(t => t.email === v.email) === i && v
            );
            
            if (prize.type === 'points') {
                if (!user.bonusPoints) user.bonusPoints = 0;
                user.bonusPoints += prize.value;
            } else if (prize.type === 'wheel-spin') {
                // Add extra spins
                if (!user.wheelSpins) user.wheelSpins = 0;
                user.wheelSpins += prize.value;
            } else if (prize.type === 'voucher') {
                // Track vouchers
                if (!user.vouchers) user.vouchers = [];
                user.vouchers.push({
                    id: `voucher-${Date.now()}`,
                    type: prize.voucherType || 'generic',
                    value: prize.value,
                    name: prize.name,
                    wonAt: new Date().toISOString(),
                    code: null // Will be generated/assigned later
                });
            } else if (prize.type === 'badge') {
                if (!user.badges) user.badges = [];
                const badgeId = `wheel-${prize.rarity}-${Date.now()}`;
                if (!user.badges.includes(badgeId)) {
                    user.badges.push(badgeId);
                }
            }
            
            // Track spin history
            if (!user.wheelSpinHistory) user.wheelSpinHistory = [];
            user.wheelSpinHistory.push({
                prize: prize,
                timestamp: new Date().toISOString()
            });
            
            return { success: true, prize: prize, remainingSpins: user.wheelSpins };
        }

        // Calculate prize unlock progress
        function calculatePrizeProgress(prize, user, allUsers = []) {
            if (!user || !prize) return { unlocked: false, progress: 0, requirement: '' };
            
            const req = prize.requirement;
            let unlocked = false;
            let progress = 0;
            let requirement = '';
            
            if (req.type === 'rank') {
                const sortedCrew = [...allUsers, user].filter((v, i, a) => 
                    a.findIndex(t => t.email === v.email) === i && v
                ).sort((a, b) => (b.totalHype || 0) - (a.totalHype || 0));
                const rank = sortedCrew.findIndex(m => m.email === user.email) + 1;
                
                if (Array.isArray(req.value)) {
                    unlocked = rank >= req.value[0] && rank <= req.value[1];
                    progress = unlocked ? 100 : Math.min((req.value[1] - rank + 1) / (req.value[1] - req.value[0] + 1) * 100, 100);
                    requirement = `Rank #${req.value[0]}-${req.value[1]}`;
                } else {
                    unlocked = rank === req.value;
                    progress = unlocked ? 100 : Math.max(0, (req.value - rank) / req.value * 100);
                    requirement = `Rank #${req.value}`;
                }
            } else if (req.type === 'participation') {
                const participatedDrops = user.participatedDrops || [];
                unlocked = participatedDrops.length > 0;
                progress = unlocked ? 100 : 0;
                requirement = 'Participate in a campaign';
            } else if (req.type === 'clicks') {
                let totalClicks = 0;
                Object.values(appState.performanceData || {}).forEach(function(dropPerf) {
                    totalClicks += dropPerf[user.email.toLowerCase()] || 0;
                });
                unlocked = totalClicks >= req.value;
                progress = Math.min((totalClicks / req.value) * 100, 100);
                requirement = `${totalClicks.toLocaleString()} / ${req.value.toLocaleString()} clicks`;
            } else if (req.type === 'level') {
                const level = user.level || calculateLevel(user.totalHype || 0);
                unlocked = level >= req.value;
                progress = Math.min((level / req.value) * 100, 100);
                requirement = `Level ${level} / ${req.value}`;
            }
            
            return { unlocked, progress: Math.max(0, Math.min(100, progress)), requirement };
        }

        // Get rarity styling
        function getPrizeRarityClass(rarity) {
            const classes = {
                'common': 'prize-common',
                'rare': 'prize-rare',
                'epic': 'prize-epic',
                'legendary': 'prize-legendary'
            };
            return classes[rarity] || 'prize-common';
        }

        function getPrizeRarityColor(rarity) {
            const colors = {
                'common': '#6B7280',
                'rare': '#3B82F6',
                'epic': '#BE38F3',
                'legendary': '#FFD700'
            };
            return colors[rarity] || '#6B7280';
        }
        // --- ACHIEVEMENT SYSTEM --- //
        // Achievement definitions with categories and XP rewards
        const ACHIEVEMENT_DEFINITIONS = {
            // Participation Achievements
            'first-participation': {
                id: 'first-participation',
                name: 'First Steps',
                category: 'Participation',
                emoji: '🌱',
                description: 'Participate in your first campaign',
                xpReward: 50,
                requirement: { type: 'participation_count', value: 1 }
            },
            'five-participations': {
                id: 'five-participations',
                name: 'Team Player',
                category: 'Participation',
                emoji: '🤝',
                description: 'Participate in 5 campaigns',
                xpReward: 200,
                requirement: { type: 'participation_count', value: 5 }
            },
            'ten-participations': {
                id: 'ten-participations',
                name: 'Veteran',
                category: 'Participation',
                emoji: '🎖️',
                description: 'Participate in 10 campaigns',
                xpReward: 500,
                requirement: { type: 'participation_count', value: 10 }
            },
            
            // Performance Achievements
            'hundred-clicks': {
                id: 'hundred-clicks',
                name: 'Century Club',
                category: 'Performance',
                emoji: '💯',
                description: 'Generate 100 total clicks',
                xpReward: 150,
                requirement: { type: 'total_clicks', value: 100 }
            },
            'five-hundred-clicks': {
                id: 'five-hundred-clicks',
                name: 'Click Master',
                category: 'Performance',
                emoji: '🎯',
                description: 'Generate 500 total clicks',
                xpReward: 400,
                requirement: { type: 'total_clicks', value: 500 }
            },
            'thousand-clicks': {
                id: 'thousand-clicks',
                name: 'Click Legend',
                category: 'Performance',
                emoji: '👑',
                description: 'Generate 1000 total clicks',
                xpReward: 1000,
                requirement: { type: 'total_clicks', value: 1000 }
            },
            
            // Social Achievements
            'custom-copy': {
                id: 'custom-copy',
                name: 'Creative',
                category: 'Social',
                emoji: '🎨',
                description: 'Use customized copy in 3 campaigns',
                xpReward: 100,
                requirement: { type: 'custom_copy_count', value: 3 }
            },
            'original-copy': {
                id: 'original-copy',
                name: 'Storyteller',
                category: 'Social',
                emoji: '📝',
                description: 'Write original copy in 2 campaigns',
                xpReward: 150,
                requirement: { type: 'original_copy_count', value: 2 }
            },
            'cross-platform': {
                id: 'cross-platform',
                name: 'Multi-Platform',
                category: 'Social',
                emoji: '🌐',
                description: 'Share on 2+ platforms in one campaign',
                xpReward: 75,
                requirement: { type: 'cross_platform', value: true }
            },
            
            // Milestone Achievements
            'level-10': {
                id: 'level-10',
                name: 'Rising Star',
                category: 'Milestone',
                emoji: '⭐',
                description: 'Reach Level 10',
                xpReward: 300,
                requirement: { type: 'level', value: 10 }
            },
            'level-25': {
                id: 'level-25',
                name: 'Expert',
                category: 'Milestone',
                emoji: '🌟',
                description: 'Reach Level 25',
                xpReward: 750,
                requirement: { type: 'level', value: 25 }
            },
            'level-50': {
                id: 'level-50',
                name: 'Max Level',
                category: 'Milestone',
                emoji: '👑',
                description: 'Reach Level 50 (Maximum)',
                xpReward: 2000,
                requirement: { type: 'level', value: 50 }
            },
            
            // Special Achievements
            'first-responder': {
                id: 'first-responder',
                name: 'First Responder',
                category: 'Special',
                emoji: '⚡',
                description: 'Be the first to join a campaign',
                xpReward: 100,
                requirement: { type: 'first_participant', value: true }
            },
            'top-performer': {
                id: 'top-performer',
                name: 'Top Performer',
                category: 'Special',
                emoji: '🥇',
                description: 'Achieve #1 rank on leaderboard',
                xpReward: 500,
                requirement: { type: 'rank', value: 1 }
            }
        };

        // Check and award achievements
        function checkAchievements(user, allUsers = []) {
            if (!user) return [];
            
            const newlyUnlocked = [];
            const userBadges = user.badges || [];
            
            // Calculate user stats
            const participatedDrops = user.participatedDrops || [];
            let totalClicks = 0;
            let customCopyCount = 0;
            let originalCopyCount = 0;
            let hasCrossPlatform = false;
            let isFirstParticipant = false;
            
            Object.values(appState.performanceData || {}).forEach(function(dropPerf) {
                totalClicks += dropPerf[user.email.toLowerCase()] || 0;
            });
            
            Object.values(appState.participationData || {}).forEach(function(participation) {
                if (participation.email === user.email) {
                    if (participation.copyType === 'customized') customCopyCount++;
                    if (participation.copyType === 'original') originalCopyCount++;
                    if (participation.sharedOn && participation.sharedOn.length > 1) hasCrossPlatform = true;
                    if (participation.isFirstParticipant) isFirstParticipant = true;
                }
            });
            
            const userLevel = user.level || calculateLevel(user.totalHype || 0);
            const sortedCrew = [...allUsers, user].filter((v, i, a) => 
                a.findIndex(t => t.email === v.email) === i && v
            ).sort((a, b) => (b.totalHype || 0) - (a.totalHype || 0));
            const rank = sortedCrew.findIndex(m => m.email === user.email) + 1;
            
            // Check each achievement
            Object.values(ACHIEVEMENT_DEFINITIONS).forEach(function(achievement) {
                // Skip if already unlocked
                if (userBadges.includes(achievement.id)) return;
                
                const req = achievement.requirement;
                let unlocked = false;
                
                if (req.type === 'participation_count') {
                    unlocked = participatedDrops.length >= req.value;
                } else if (req.type === 'total_clicks') {
                    unlocked = totalClicks >= req.value;
                } else if (req.type === 'custom_copy_count') {
                    unlocked = customCopyCount >= req.value;
                } else if (req.type === 'original_copy_count') {
                    unlocked = originalCopyCount >= req.value;
                } else if (req.type === 'cross_platform') {
                    unlocked = hasCrossPlatform;
                } else if (req.type === 'level') {
                    unlocked = userLevel >= req.value;
                } else if (req.type === 'first_participant') {
                    unlocked = isFirstParticipant;
                } else if (req.type === 'rank') {
                    unlocked = rank === req.value;
                }
                
                if (unlocked) {
                    // Award achievement
                    if (!userBadges.includes(achievement.id)) {
                        userBadges.push(achievement.id);
                        user.badges = userBadges;
                        
                        // Award XP
                        const xpResult = awardXP(user, achievement.xpReward);
                        
                        newlyUnlocked.push({
                            achievement: achievement,
                            xpReward: achievement.xpReward,
                            leveledUp: xpResult ? xpResult.leveledUp : false,
                            newLevel: xpResult && xpResult.leveledUp ? xpResult.newLevel : null
                        });
                    }
                }
            });
            
            // Update user reputation after achievements
            if (newlyUnlocked.length > 0) {
                initializeUserReputation(user);
                user.reputationScore = calculateReputationScore(user, allUsers);
            }
            
            return newlyUnlocked;
        }

        // Show achievement unlock notification
        function showAchievementUnlock(achievementData) {
            const achievement = achievementData.achievement;
            const xpReward = achievementData.xpReward;
            const leveledUp = achievementData.leveledUp;
            const newLevel = achievementData.newLevel;
            
            let message = `🎉 Achievement Unlocked: ${achievement.emoji} ${achievement.name}! +${xpReward} XP`;
            if (leveledUp) {
                message += ` 🚀 Level Up! You're now Level ${newLevel}!`;
            }
            
            showToast(message, 'success', 5000);
            
            // Determine rarity based on XP reward
            let rarity = 'common';
            let rarityClass = '';
            if (xpReward >= 1000) {
                rarity = 'legendary';
                rarityClass = 'achievement-rarity-legendary';
            } else if (xpReward >= 500) {
                rarity = 'epic';
                rarityClass = 'achievement-rarity-epic';
            } else if (xpReward >= 200) {
                rarity = 'rare';
                rarityClass = 'achievement-rarity-rare';
            }
            
            // Create confetti particles
            function createConfetti() {
                const colors = ['#BE38F3', '#F43F5E', '#3B82F6', '#10B981', '#FFD700'];
                for (let i = 0; i < 50; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'confetti-particle';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                    particle.style.width = (Math.random() * 8 + 4) + 'px';
                    particle.style.height = particle.style.width;
                    particle.style.animationDuration = (Math.random() * 2 + 1) + 's';
                    particle.style.animationDelay = Math.random() * 0.5 + 's';
                    document.body.appendChild(particle);
                    setTimeout(() => particle.remove(), 3000);
                }
            }
            
            // Create overlay
            const overlay = document.createElement('div');
            overlay.className = 'achievement-unlock-overlay';
            
            // Create unlock animation card
            const unlockEl = document.createElement('div');
            unlockEl.className = 'achievement-unlock-animation';
            unlockEl.innerHTML = `
                <div class="achievement-unlock-content">
                    <div class="achievement-unlock-icon">${achievement.emoji}</div>
                    <div class="text-3xl font-extrabold-heading mb-3 gradient-text">Achievement Unlocked!</div>
                    <div class="text-2xl font-bold mb-4">${escapeHtml(achievement.name)}</div>
                    <div class="text-xl accent-text font-semibold mb-2">+${xpReward} XP</div>
                    ${leveledUp ? `<div class="text-xl text-green-400 font-bold mt-3">🚀 Level ${newLevel}!</div>` : ''}
                    ${rarity !== 'common' ? `<div class="mt-4"><span class="achievement-rarity-badge ${rarityClass}">${rarity.toUpperCase()}</span></div>` : ''}
                    <div class="mt-6 text-sm text-secondary">${escapeHtml(achievement.description)}</div>
                </div>
            `;
            
            overlay.appendChild(unlockEl);
            document.body.appendChild(overlay);
            
            // Create confetti
            createConfetti();
            
            // Auto-close after delay
            setTimeout(function() {
                overlay.classList.add('fade-out');
                unlockEl.classList.add('fade-out');
                setTimeout(function() {
                    overlay.remove();
                }, 500);
            }, 4000);
        }

        // --- RENDER FUNCTIONS --- //
        function renderAuthSection() {
            if (appState.currentUser) {
                const user = appState.currentUser;
                const isAdmin = user.email === 'admin@company.com' || user.email === 'demo@company.com'; // For prototype
                authSection.innerHTML = `
                    <div class="flex items-center gap-3 cursor-pointer hover:opacity-80 transition-opacity" onclick="if (window.appState && window.appState.currentUser && window.handleViewPlayer) { window.handleViewPlayer(window.appState.currentUser.email); }" title="View Profile">
                        ${getAvatarHTML(user.name, user.email, 'md', null, user)}
                        <div class="text-right">
                            <p class="text-md font-semibold">${escapeHtml(user.name)}</p>
                            <p class="text-xs text-secondary">${escapeHtml(user.email)}</p>
                            <div class="flex items-center gap-2 mt-1" onclick="event.stopPropagation();">
                                ${isAdmin ? `<button id="admin-button" class="text-xs text-accent-primary hover:underline">Admin</button>` : ''}
                                <button id="logout-button" class="text-xs text-red-500 hover:underline">Sign Out</button>
                            </div>
                        </div>
                    </div>`;
                document.getElementById('logout-button').addEventListener('click', handleLogout);
                if (isAdmin) {
                    document.getElementById('admin-button').addEventListener('click', () => switchView('admin'));
                }
            } else {
                authSection.innerHTML = ``;
            }
        }
        function renderSidebar() {
            try {
                logger.log('renderSidebar called');
                const sidebarEl = document.getElementById('sidebar-content');
                if (!sidebarEl) {
                    logger.error('sidebar-content element not found');
                    return;
                }
                
                // Show skeleton while loading
                sidebarEl.innerHTML = `
                    <div class="skeleton-card mb-6">
                        <div class="skeleton skeleton-title"></div>
                        <div class="skeleton skeleton-text"></div>
                        <div class="skeleton skeleton-text short"></div>
                    </div>
                    <div class="skeleton-card mb-6">
                        <div class="skeleton skeleton-title"></div>
                        <div class="skeleton skeleton-text"></div>
                    </div>
                `;
                
                // Small delay to show skeleton, then render content
                setTimeout(function() {
                    const user = appState.currentUser;
                    const persona = (user && user.playerPersona) ? user.playerPersona.toLowerCase() : 'achiever';
                const activeDrop = appState.drops.find(d => d.status === 'ACTIVE');
                const hasParticipated = user && appState.participationData[user.email] && 
                    appState.participationData[user.email].dropId === activeDrop?.id;
                
                let sidebarHTML = '';
            
            // Enhanced Persona Card
            if (user && user.playerPersona) {
                const personaEmojis = {
                    'achiever': '🏆',
                    'explorer': '🔍',
                    'socializer': '🤝',
                    'killer': '⚔️'
                };
                const personaNames = {
                    'achiever': 'Achiever',
                    'explorer': 'Explorer',
                    'socializer': 'Socializer',
                    'killer': 'Killer'
                };
                const personaDescriptions = {
                    'achiever': 'You\'re driven by mastery and achievement. The UI highlights your progress, badges, and milestones to keep you motivated.',
                    'explorer': 'You love discovering new features and content. The UI surfaces new campaigns, creative options, and exploration opportunities.',
                    'socializer': 'You thrive on connection and collaboration. The UI emphasizes team leaderboards, social features, and community engagement.',
                    'killer': 'You\'re competitive and love winning. The UI showcases rankings, competitive stats, and head-to-head comparisons.'
                };
                sidebarHTML += `
                    <section class="surface-card mb-6 p-4">
                        <div class="flex items-center gap-3 mb-3">
                            <span class="text-2xl">${personaEmojis[persona] || '🎮'}</span>
                            <div>
                                <div class="font-bold text-base">${personaNames[persona] || user.playerPersona}</div>
                                <div class="text-xs text-secondary">Your Player Persona</div>
                            </div>
                        </div>
                        <p class="text-sm text-secondary leading-relaxed">
                            ${personaDescriptions[persona] || 'Your experience is tailored to match your play style and preferences.'}
                        </p>
                    </section>
                `;
            }
            
            if (user && hasParticipated) {
                // Calculate Impact Score
                const allUsers = [...appState.crew, user].filter((v, i, a) => 
                    a.findIndex(t => t.email === v.email) === i && v
                );
                const impactScore = getUserImpactScore(user, allUsers, appState.performanceData, appState.participationData);
                
                // Persona-specific emphasis
                let scoreTitle = 'Impact Score';
                let scoreSubtitle = 'Total Impact Points';
                if (persona === 'achiever') {
                    scoreTitle = 'Achievement Score';
                    scoreSubtitle = 'Your Progress';
                } else if (persona === 'explorer') {
                    scoreTitle = 'Exploration Score';
                    scoreSubtitle = 'Discovery Points';
                } else if (persona === 'socializer') {
                    scoreTitle = 'Social Impact';
                    scoreSubtitle = 'Community Contribution';
                } else if (persona === 'killer') {
                    scoreTitle = 'Competitive Score';
                    scoreSubtitle = 'Your Ranking';
                }
                
                sidebarHTML += `
                    <!-- Impact Score Breakdown -->
                    <section id="impact-score-section" class="surface-card mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-extrabold-heading">${scoreTitle}</h3>
                            <button onclick="showImpactScoreBreakdown()" class="text-xs text-accent-primary hover:underline">View Details</button>
                        </div>
                        <div class="text-center mb-4">
                            <div class="text-4xl font-extrabold-heading gradient-text mb-1">${impactScore.toLocaleString()}</div>
                            <div class="text-xs text-secondary">${scoreSubtitle}</div>
                        </div>
                        <div class="space-y-2 text-xs">
                            <div class="flex justify-between">
                                <span class="text-secondary">Shares:</span>
                                <span class="text-text-primary font-semibold">${((user.participatedDrops || []).length * IMPACT_SCORE_WEIGHTS.SHARE_SUGGESTED).toLocaleString()}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-secondary">Clicks:</span>
                                <span class="text-text-primary font-semibold">${(() => {
                                    let totalClicks = 0;
                                    Object.values(appState.performanceData || {}).forEach(d => {
                                        totalClicks += d[user.email.toLowerCase()] || 0;
                                    });
                                    return (totalClicks * IMPACT_SCORE_WEIGHTS.CLICK_ON_LINK).toLocaleString();
                                })()}</span>
                            </div>
                            ${(user.originalPosts || 0) > 0 ? `
                            <div class="flex justify-between">
                                <span class="text-secondary">Original Posts:</span>
                                <span class="text-text-primary font-semibold accent-text">+${((user.originalPosts || 0) * IMPACT_SCORE_WEIGHTS.ORIGINAL_POST).toLocaleString()}</span>
                            </div>
                            ` : ''}
                            ${(user.commentsGenerated || 0) > 0 ? `
                            <div class="flex justify-between">
                                <span class="text-secondary">Comments:</span>
                                <span class="text-text-primary font-semibold accent-text">+${((user.commentsGenerated || 0) * IMPACT_SCORE_WEIGHTS.COMMENT_ON_POST).toLocaleString()}</span>
                            </div>
                            ` : ''}
                        </div>
                    </section>
                    
                    <!-- Mission Log -->
                    <section id="mission-log" class="surface-card mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-extrabold-heading flex items-center gap-2">
                                <span>📜</span>
                                <span>Missions</span>
                            </h3>
                            <button onclick="showMissionLog()" class="text-xs text-accent-primary hover:underline">View All</button>
                        </div>
                        ${(() => {
                            const missions = getMissionDefinitions();
                            const activeMissions = Object.keys(missions).slice(0, 2); // Show first 2 missions
                            if (activeMissions.length === 0) {
                                return `
                                    <div class="empty-state" style="padding: 2rem 1rem;">
                                        <div class="empty-state-icon" style="font-size: 3rem;">🎯</div>
                                        <h4 class="empty-state-title" style="font-size: 1rem;">No Active Missions</h4>
                                        <p class="empty-state-description" style="font-size: 0.875rem;">Complete campaigns to unlock new missions and earn rewards!</p>
                                    </div>
                                `;
                            }
                            return activeMissions.map(missionId => {
                                const mission = missions[missionId];
                                const progress = checkMissionProgress(missionId, user, appState);
                                if (!progress) return '';
                                return `
                                    <div class="mb-3 p-3 bg-bg-color rounded-lg border border-border-color">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="text-xl">${mission.emoji}</span>
                                            <div class="flex-1">
                                                <div class="font-semibold text-sm text-text-primary">${mission.name}</div>
                                                <div class="text-xs text-secondary">${mission.category}</div>
                                            </div>
                                        </div>
                                        <div class="mt-2">
                                            <div class="flex justify-between text-xs mb-1">
                                                <span class="text-secondary">Progress</span>
                                                <span class="text-text-primary font-semibold">${Math.round(progress.progress)}%</span>
                                            </div>
                                            <div class="prize-progress-bar" style="height: 6px;">
                                                <div class="prize-progress-fill" style="width: ${progress.progress}%"></div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('');
                        })()}
                    </section>
                    
                    <!-- Your Stats -->
                    <section id="user-stats" class="surface-card">
                        <h3 class="text-lg font-extrabold-heading mb-6">Your Stats</h3>
                        <div id="user-stats-content">
                            <!-- Stats rendered here -->
                        </div>
                    </section>
                    
                    <!-- Prize Shop & Wheel -->
                    <section class="surface-card mb-6">
                        <h3 class="text-lg font-extrabold-heading mb-4 flex items-center gap-2">
                            <span>🛒</span>
                            <span>Prize Shop</span>
                        </h3>
                        <div class="space-y-2">
                            <button onclick="showPrizeShop()" class="w-full btn-primary text-sm py-2 px-4 rounded-lg font-semibold">
                                🛒 Visit Shop
                            </button>
                            ${(user.wheelSpins || 0) > 0 ? `
                                <button onclick="showWheelSpin()" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white text-sm py-2 px-4 rounded-lg font-semibold hover:opacity-90 transition-all">
                                    🎰 Spin Wheel (${user.wheelSpins})
                                </button>
                            ` : `
                                <button onclick="showWheelSpin()" class="w-full btn-secondary text-sm py-2 px-4 rounded-lg font-semibold">
                                    🎰 Wheel Spin
                                </button>
                            `}
                        </div>
                    </section>
                    
                    <!-- Battle Pass -->
                    <section class="surface-card">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-extrabold-heading flex items-center gap-2">
                                <span>🎮</span>
                                <span>Battle Pass</span>
                            </h3>
                            ${(() => {
                                const allUsers = [...appState.crew, user].filter((v, i, a) => 
                                    a.findIndex(t => t.email === v.email) === i && v
                                );
                                const battlePassProgress = calculateBattlePassProgress(user, allUsers, appState.performanceData, appState.participationData);
                                const unclaimedRewards = getUnclaimedBattlePassRewards(user, battlePassProgress);
                                return unclaimedRewards.length > 0 ? `
                                    <span class="text-xs bg-accent-primary text-white px-2 py-1 rounded-full animate-pulse">${unclaimedRewards.length}</span>
                                ` : '';
                            })()}
                        </div>
                        ${(() => {
                            const allUsers = [...appState.crew, user].filter((v, i, a) => 
                                a.findIndex(t => t.email === v.email) === i && v
                            );
                            const battlePassProgress = calculateBattlePassProgress(user, allUsers, appState.performanceData, appState.participationData);
                            return `
                                <div class="mb-3">
                                    <div class="flex items-center justify-between text-xs mb-1">
                                        <span class="text-secondary">Level ${battlePassProgress.currentLevel}</span>
                                        <span class="text-secondary">${Math.round(battlePassProgress.progress)}%</span>
                                    </div>
                                    <div class="prize-progress-bar" style="height: 8px;">
                                        <div class="prize-progress-fill" style="width: ${battlePassProgress.progress}%"></div>
                                    </div>
                                </div>
                                <button onclick="showBattlePass()" class="w-full btn-secondary text-sm py-2 px-4 rounded-lg font-semibold">
                                    View Battle Pass
                                </button>
                            `;
                        })()}
                    </section>
                `;
            } else if (user) {
                sidebarHTML = `
                    <!-- Join Prompt -->
                    <section class="surface-card p-6 text-center mb-6">
                        <div class="text-3xl mb-3">🚀</div>
                        <h3 class="text-lg font-extrabold-heading mb-2">Join the Campaign</h3>
                        <p class="text-sm text-secondary mb-4">Start earning points and competing on the leaderboard!</p>
                        <button onclick="document.querySelector('.campaign-hero-card #participate-button')?.click()" class="bg-accent-primary text-white px-6 py-2 rounded-lg font-semibold hover:opacity-90 transition-all">
                            Get Started
                        </button>
                    </section>
                    
                    <!-- Prize Shop & Wheel -->
                    <section class="surface-card mb-6">
                        <h3 class="text-lg font-extrabold-heading mb-4 flex items-center gap-2">
                            <span>🛒</span>
                            <span>Prize Shop</span>
                        </h3>
                        <div class="space-y-2">
                            <button onclick="showPrizeShop()" class="w-full btn-primary text-sm py-2 px-4 rounded-lg font-semibold">
                                🛒 Visit Shop
                            </button>
                            ${(user.wheelSpins || 0) > 0 ? `
                                <button onclick="showWheelSpin()" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white text-sm py-2 px-4 rounded-lg font-semibold hover:opacity-90 transition-all">
                                    🎰 Spin Wheel (${user.wheelSpins})
                                </button>
                            ` : `
                                <button onclick="showWheelSpin()" class="w-full btn-secondary text-sm py-2 px-4 rounded-lg font-semibold">
                                    🎰 Wheel Spin
                                </button>
                            `}
                        </div>
                    </section>
                    
                    <!-- Battle Pass -->
                    <section class="surface-card mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-extrabold-heading flex items-center gap-2">
                                <span>🎮</span>
                                <span>Battle Pass</span>
                            </h3>
                            ${(() => {
                                const allUsers = [...appState.crew, user].filter((v, i, a) => 
                                    a.findIndex(t => t.email === v.email) === i && v
                                );
                                const battlePassProgress = calculateBattlePassProgress(user, allUsers, appState.performanceData, appState.participationData);
                                const unclaimedRewards = getUnclaimedBattlePassRewards(user, battlePassProgress);
                                return unclaimedRewards.length > 0 ? `
                                    <span class="text-xs bg-accent-primary text-white px-2 py-1 rounded-full animate-pulse">${unclaimedRewards.length}</span>
                                ` : '';
                            })()}
                        </div>
                        ${(() => {
                            const allUsers = [...appState.crew, user].filter((v, i, a) => 
                                a.findIndex(t => t.email === v.email) === i && v
                            );
                            const battlePassProgress = calculateBattlePassProgress(user, allUsers, appState.performanceData, appState.participationData);
                            return `
                                <div class="mb-3">
                                    <div class="flex items-center justify-between text-xs mb-1">
                                        <span class="text-secondary">Level ${battlePassProgress.currentLevel}</span>
                                        <span class="text-secondary">${Math.round(battlePassProgress.progress)}%</span>
                                    </div>
                                    <div class="prize-progress-bar" style="height: 8px;">
                                        <div class="prize-progress-fill" style="width: ${battlePassProgress.progress}%"></div>
                                    </div>
                                </div>
                                <button onclick="showBattlePass()" class="w-full btn-secondary text-sm py-2 px-4 rounded-lg font-semibold">
                                    View Battle Pass
                                </button>
                            `;
                        })()}
                    </section>
                `;
            }
            
            sidebarHTML += `
                    <!-- Prizes Display -->
                    <section class="surface-card">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-extrabold-heading flex items-center gap-2">
                                <span>🎁</span>
                                <span>Campaign Prizes</span>
                            </h3>
                            ${user ? `<button onclick="showPrizeShowcase()" class="text-xs text-accent-primary hover:underline">View All</button>` : ''}
                        </div>
                        <div class="space-y-3">
                            ${(() => {
                                if (!user) return '';
                                const allUsers = [...appState.crew, user].filter((v, i, a) => 
                                    a.findIndex(t => t.email === v.email) === i && v
                                );
                                // Show top 4 prizes (campaign-focused)
                                const campaignPrizes = [
                                    PRIZE_DEFINITIONS.topPerformer,
                                    PRIZE_DEFINITIONS.runnerUp,
                                    PRIZE_DEFINITIONS.topTen,
                                    PRIZE_DEFINITIONS.participation
                                ];
                                
                                return campaignPrizes.map(function(prize) {
                                    const progress = calculatePrizeProgress(prize, user, allUsers);
                                    const rarityClass = getPrizeRarityClass(prize.rarity);
                                    const rarityColor = getPrizeRarityColor(prize.rarity);
                                    const cardClass = progress.unlocked ? 'prize-unlocked' : 'prize-locked';
                                    
                                    return `
                                    <div class="prize-card ${rarityClass} ${cardClass}" onclick="showPrizeDetails('${prize.id}')" style="cursor: pointer;">
                                        ${progress.unlocked ? '<span class="prize-unlocked-badge">✓ Unlocked</span>' : ''}
                                        <div class="prize-tier">
                                            <div class="prize-icon">${prize.icon}</div>
                                            <div class="prize-details">
                                                <h4>
                                                    ${escapeHtml(prize.name)}
                                                    <span class="prize-rarity-badge" style="background: ${rarityColor}20; color: ${rarityColor};">${prize.rarity.toUpperCase()}</span>
                                                </h4>
                                                <p class="prize-requirement">${escapeHtml(prize.description)}</p>
                                                <p class="prize-reward">${escapeHtml(prize.reward)}</p>
                                                ${!progress.unlocked ? `
                                                    <div class="prize-progress">
                                                        <div class="prize-progress-label">
                                                            <span>Progress</span>
                                                            <span>${Math.round(progress.progress)}%</span>
                                                        </div>
                                                        <div class="prize-progress-bar">
                                                            <div class="prize-progress-fill" style="width: ${progress.progress}%"></div>
                                                        </div>
                                                        <div class="text-xs text-secondary mt-1">${escapeHtml(progress.requirement)}</div>
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    </div>
                                    `;
                                }).join('');
                            })()}
                        </div>
                        <p class="text-xs text-secondary mt-4 text-center">Prizes awarded at campaign end</p>
                    </section>

                    <!-- How Points Work -->
                    <section class="surface-card">
                        <button class="toggle-button w-full rounded-xl mb-3" data-target="points-explanation">
                            <span class="flex items-center gap-2">
                                <span class="text-lg">💎</span>
                                <span class="font-semibold">How Points Work</span>
                            </span>
                            <span class="icon text-sm">▼</span>
                        </button>
                        <div class="collapsible-section collapsed" id="points-explanation">
                            <div class="space-y-4 text-sm">
                                <div>
                                    <h4 class="font-bold text-base mb-2 flex items-center gap-2">
                                        <span>🎯</span>
                                        <span>Participation Points</span>
                                    </h4>
                                    <ul class="text-secondary space-y-1.5 ml-6 list-disc">
                                        <li><strong>Base:</strong> 100 points for joining</li>
                                        <li><strong>Custom Copy:</strong> +50 points</li>
                                        <li><strong>Original Copy:</strong> +100 points</li>
                                        <li><strong>Personal Story:</strong> +75 points</li>
                                        <li><strong>Call-to-Action:</strong> +25 points</li>
                                        <li><strong>Cross-Platform:</strong> +50 points (2+ platforms)</li>
                                    </ul>
                                </div>
                                <div class="pt-3 border-t border-border-color">
                                    <h4 class="font-bold text-base mb-2 flex items-center gap-2">
                                        <span>⚡</span>
                                        <span>Click Rewards</span>
                                    </h4>
                                    <ul class="text-secondary space-y-1.5 ml-6 list-disc">
                                        <li><strong>10-15 points</strong> per click (tiered)</li>
                                        <li>More clicks = higher tier rewards</li>
                                        <li>Points update in real-time</li>
                                    </ul>
                                </div>
                                <div class="pt-3 border-t border-border-color">
                                    <h4 class="font-bold text-base mb-2 flex items-center gap-2">
                                        <span>🏆</span>
                                        <span>What Points Mean</span>
                                    </h4>
                                    <p class="text-secondary">
                                        Points show your impact and effort. They help you compete on leaderboards, earn badges, and track your contribution to each campaign. Quality engagement (custom copy, stories) is rewarded just as much as reach!
                                    </p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Leaderboard -->
                    <section id="roster-section" class="surface-card ${user && user.playerPersona ? 'persona-' + user.playerPersona.toLowerCase() : ''}">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-lg font-extrabold-heading">${(() => {
                                if (!user || !user.playerPersona) return 'Leaderboard';
                                const titles = {
                                    'achiever': '🏆 Achievement Rankings',
                                    'explorer': '🔍 Discovery Leaderboard',
                                    'socializer': '🤝 Community Rankings',
                                    'killer': '⚔️ Competitive Leaderboard'
                                };
                                return titles[user.playerPersona.toLowerCase()] || 'Leaderboard';
                            })()}</h3>
                            <div class="flex gap-2">
                                <button onclick="showLeaderboardDashboard()" class="text-xs text-accent-primary hover:underline font-semibold">View Dashboard</button>
                                <select id="leaderboard-category" class="text-xs bg-bg-color border border-border-color rounded-lg px-3 py-1.5 text-text-primary" onchange="renderRoster()">
                                    <option value="overall">Overall</option>
                                    <option value="this-month">This Month</option>
                                    <option value="this-campaign">This Campaign</option>
                                    <option value="by-department">By Department</option>
                                </select>
                            </div>
                        </div>
                        <div id="roster" class="space-y-3">
                            <!-- Roster content rendered here -->
                        </div>
                    </section>
            `;
            
                    sidebarEl.innerHTML = sidebarHTML;
                    
                    // Add content-loaded animation
                    setTimeout(function() {
                        sidebarEl.classList.add('content-loaded');
                    }, 50);
                }, 150); // Small delay to show skeleton
            
            // Re-initialize toggle buttons for the new content
            document.querySelectorAll('.toggle-button').forEach(button => {
                button.addEventListener('click', function() {
                    const targetId = this.dataset.target;
                    const section = document.getElementById(targetId);
                    if (!section) return;
                    
                    const isCollapsed = section.classList.contains('collapsed');
                    const textSpan = this.querySelector('span:first-child span:last-child');
                    
                    if (isCollapsed) {
                        section.classList.remove('collapsed');
                        section.style.maxHeight = section.scrollHeight + 'px';
                        this.classList.add('expanded');
                        if (textSpan && textSpan.textContent.includes('Show')) {
                            textSpan.textContent = textSpan.textContent.replace('Show ', 'Hide ');
                        }
                    } else {
                        section.classList.add('collapsed');
                        section.style.maxHeight = '0';
                        this.classList.remove('expanded');
                        if (textSpan && textSpan.textContent.includes('Hide')) {
                            textSpan.textContent = textSpan.textContent.replace('Hide ', 'Show ');
                        }
                    }
                });
            });
            } catch(error) {
                logger.error('Error in renderSidebar:', error);
                logger.error('Stack:', error.stack);
                const sidebarEl = document.getElementById('sidebar-content');
                if (sidebarEl) {
                    sidebarEl.innerHTML = `<div class="surface-card p-6"><h3 class="text-lg font-bold mb-2">Error Loading Sidebar</h3><p class="text-secondary text-sm">Please refresh the page.</p></div>`;
                }
            }
        }

        function renderUserStats() {
            const statsEl = document.getElementById('user-stats-content');
            if (!appState.currentUser || !statsEl) return;
            
            const user = appState.currentUser;
            const participation = appState.participationData[user.email] || {};
            const activeDrop = appState.drops.find(d => d.status === 'ACTIVE');
            const dropPerf = activeDrop && appState.performanceData[activeDrop.id] 
                ? appState.performanceData[activeDrop.id][user.email.toLowerCase()] || 0 
                : 0;
            
            const clickPoints = calculateClickPoints(dropPerf);
            const participationPoints = participation.points || 0;
            
            // Calculate Impact Score
            const allCrew = [...appState.crew, user].filter((v, i, a) => 
                a.findIndex(t => t.email === v.email) === i
            );
            const impactScore = getUserImpactScore(user, allCrew, appState.performanceData, appState.participationData);
            const totalDrops = user.participatedDrops?.length || 0;
            
            // Calculate rank using Impact Score
            const sortedCrew = allCrew
                .map(m => {
                    const score = getUserImpactScore(m, allCrew, appState.performanceData, appState.participationData);
                    return { ...m, score: score };
                })
                .sort((a, b) => b.score - a.score);
            const userRank = sortedCrew.findIndex(m => m.email === user.email) + 1;
            
            statsEl.innerHTML = `
                <div class="text-center mb-6">
                    ${getAvatarHTML(user.name, user.email, 'xl', userRank <= 3 ? userRank : null, user)}
                    <div class="mt-4">
                        <!-- Level & Reputation Title -->
                        ${(() => {
                            const xpProgress = user.xpProgress || calculateXPProgress(impactScore);
                            const reputationTitle = user.reputationTitle || calculateReputationTitle(user.level || calculateLevel(impactScore), impactScore, user.badges || []);
                            const reputationScore = user.reputationScore || calculateReputationScore(user, allCrew, appState.performanceData, appState.participationData);
                            return `
                            <div class="mb-4">
                                <div class="flex items-center justify-center gap-2 mb-2">
                                    <span class="text-2xl">${reputationTitle.emoji}</span>
                                    <span class="text-lg font-bold" style="color: ${reputationTitle.color}">${reputationTitle.title}</span>
                                    <span class="text-lg font-bold accent-text">Level ${xpProgress.level}</span>
                                </div>
                                <!-- XP Progress Bar -->
                                <div class="xp-progress-bar mt-3 mb-2">
                                    <div class="xp-progress-fill" style="width: ${xpProgress.progress}%"></div>
                                </div>
                                <div class="text-xs text-secondary">
                                    ${xpProgress.currentXP.toLocaleString()} / ${xpProgress.xpNeeded.toLocaleString()} XP to Level ${xpProgress.level + 1}
                                </div>
                            </div>
                            
                            <!-- Reputation Score -->
                            <div class="mb-4 p-3 bg-bg-color rounded-lg">
                                <div class="text-xs text-secondary mb-2">Reputation Score</div>
                                <div class="reputation-meter mb-2">
                                    <div class="reputation-meter-fill" style="width: ${reputationScore}%"></div>
                                </div>
                                <div class="text-lg font-bold accent-text">${reputationScore}/100</div>
                            </div>
                            `;
                        })()}
                        
                            <div class="text-3xl md:text-4xl font-extrabold-heading gradient-text mb-2">${impactScore.toLocaleString()}</div>
                        <div class="text-sm text-secondary mb-4">Impact Score</div>
                        <div class="flex items-center justify-center gap-4 text-sm">
                            <div class="text-center">
                                <div class="font-bold text-lg">#${userRank}</div>
                                <div class="text-xs text-secondary">Rank</div>
                            </div>
                            <div class="w-px h-8 bg-border-color"></div>
                            <div class="text-center">
                                <div class="font-bold text-lg">${totalDrops}</div>
                                <div class="text-xs text-secondary">Campaigns</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                ${user.badges && user.badges.length > 0 ? `
                    <div class="pt-4 border-t border-border-color">
                        <div class="text-xs font-semibold mb-3 text-secondary uppercase tracking-wide text-center">Achievements</div>
                        <div class="flex flex-wrap gap-2 justify-center">
                            ${user.badges.slice(0, 4).map(badge => {
                                const badgeNames = {
                                    'creative': '🎨',
                                    'growth-hacker': '📈',
                                    'storyteller': '📝',
                                    'team-player': '🤝',
                                    'king-of-clicks': '👑',
                                    'first-responder': '⚡'
                                };
                                return `<span class="badge purple text-xs" title="${badge}">${badgeNames[badge] || badge}</span>`;
                            }).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Avatar generation function
        function getAvatarUrl(name, email, size = '80') {
            // Use DiceBear API with fun avatars style
            // Options: avataaars, bottts, identicon, initials, micah, openPeeps, personas
            const seed = email || name.toLowerCase().replace(/\s+/g, '');
            const style = 'avataaars'; // Fun, colorful style
            return `https://api.dicebear.com/7.x/${style}/svg?seed=${encodeURIComponent(seed)}&size=${size}&backgroundColor=b6e3f4,c0aede,d1d4f9,ffd5dc,ffdfbf`;
        }
        function getAvatarHTML(name, email, size = 'md', showRank = null, user = null) {
            const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
            const sizeClass = `avatar-${size}`;
            const avatarUrl = getAvatarUrl(name, email, size === 'sm' ? '40' : size === 'md' ? '56' : size === 'lg' ? '80' : size === 'xl' ? '120' : '160');
            
            // Initialize user reputation if not already done
            if (user && !user.level) {
                initializeUserReputation(user);
            }
            
            let badgeHTML = '';
            if (showRank !== null) {
                if (showRank === 1) badgeHTML = '<span class="avatar-badge rank-1"></span>';
                else if (showRank === 2) badgeHTML = '<span class="avatar-badge rank-2"></span>';
                else if (showRank === 3) badgeHTML = '<span class="avatar-badge rank-3"></span>';
            }
            
            // Level badge
            let levelBadgeHTML = '';
            if (user && user.level) {
                const level = user.level;
                const levelSize = size === 'sm' ? 'xs' : size === 'md' ? 'sm' : 'md';
                levelBadgeHTML = `<span class="level-badge level-badge-${levelSize}" title="Level ${level}">${level}</span>`;
            }
            
            return `
                <div class="avatar-container">
                    <img src="${avatarUrl}" alt="${escapeHtml(name)}" class="avatar ${sizeClass}" onerror="this.onerror=null; this.className='avatar-gradient ${sizeClass}'; this.textContent='${initials}'; this.style.display='flex';">
                    ${badgeHTML}
                    ${levelBadgeHTML}
                </div>
            `;
        }
        function renderDrop() {
            try {
                logger.log('renderDrop called');
                const activeDrop = appState.drops.find(d => d.status === 'ACTIVE');
                const terminal = document.getElementById('active-drop');
                
                if (!terminal) {
                    logger.error('active-drop element not found');
                    return;
                }
                
                // Show skeleton while loading
                terminal.innerHTML = `
                    <div class="skeleton-card">
                        <div class="skeleton skeleton-title"></div>
                        <div class="skeleton skeleton-text"></div>
                        <div class="skeleton skeleton-text short"></div>
                    </div>
                `;
                
                // Small delay to show skeleton, then render content
                setTimeout(function() {
                    if (!activeDrop) {
                    terminal.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">🎉</div>
                            <h3 class="empty-state-title">All Drops Complete!</h3>
                            <p class="empty-state-description">Great work! You've completed all active campaigns. Stand by for the next exciting drop.</p>
                            <div class="empty-state-action">
                                <button onclick="renderArchive()" class="btn-secondary">View Past Campaigns</button>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                logger.log('Rendering active drop:', activeDrop.name);
                logger.log('Terminal element:', terminal);

            const user = appState.currentUser;
            const persona = (user && user.playerPersona) ? user.playerPersona.toLowerCase() : 'achiever';
            logger.log('Current user:', user);
            const hasParticipated = user && appState.participationData[user.email] && 
                appState.participationData[user.email].dropId === activeDrop.id;
            const participation = hasParticipated ? appState.participationData[user.email] : null;
            const dropPerf = appState.performanceData[activeDrop.id] || {};
            const clicks = user ? (dropPerf[user.email.toLowerCase()] || 0) : 0;
            const shortLink = participation ? participation.shortLink : null;

            // Persona-specific messaging
            const personaMessages = {
                'achiever': { clicks: 'Achievement Progress', points: 'Total Achievement Points' },
                'explorer': { clicks: 'Discovery Clicks', points: 'Exploration Points' },
                'socializer': { clicks: 'Community Engagement', points: 'Social Impact Points' },
                'killer': { clicks: 'Competitive Clicks', points: 'Ranking Points' }
            };
            const messages = personaMessages[persona] || personaMessages['achiever'];

            let performanceHTML = '';
            if (hasParticipated) {
                const clickPoints = calculateClickPoints(clicks);
                const totalPoints = (participation.points || 0) + clickPoints;
                const engagementRate = user.followers ? ((clicks / user.followers) * 100).toFixed(1) : null;
                
                performanceHTML = `
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="stat-mini">
                            <div class="text-2xl md:text-3xl font-bold accent-text mb-1">${clicks}</div>
                            <div class="text-xs text-secondary uppercase tracking-wide">${messages.clicks}</div>
                        </div>
                        <div class="stat-mini">
                            <div class="text-2xl md:text-3xl font-bold accent-text mb-1">${totalPoints}</div>
                            <div class="text-xs text-secondary uppercase tracking-wide">${messages.points}</div>
                        </div>
                    </div>
                    
                    <div class="bg-bg-color p-5 rounded-xl border border-border-color">
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between items-center">
                                <span class="text-secondary">Participation:</span>
                                <span class="accent-text font-semibold">+${participation.points || 0} pts</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-secondary">Click Rewards:</span>
                                <span class="accent-text font-semibold">+${clickPoints} pts</span>
                            </div>
                            ${engagementRate ? `
                                <div class="flex justify-between items-center pt-3 border-t border-border-color">
                                    <span class="text-secondary">Engagement:</span>
                                    <span class="accent-text font-semibold">${engagementRate}%</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>`;
            }

            let participationFormHTML = '';
            if (!hasParticipated) {
                // Persona-specific join messages
                const joinMessages = {
                    'achiever': { emoji: '🏆', title: 'Earn Achievements', subtitle: 'Complete this campaign to unlock badges and level up!' },
                    'explorer': { emoji: '🔍', title: 'Explore & Create', subtitle: 'Discover new content and showcase your creativity!' },
                    'socializer': { emoji: '🤝', title: 'Join the Community', subtitle: 'Connect with your team and make an impact together!' },
                    'killer': { emoji: '⚔️', title: 'Compete & Win', subtitle: 'Climb the leaderboard and prove you\'re the best!' }
                };
                const joinMsg = joinMessages[persona] || joinMessages['achiever'];
                
                participationFormHTML = `
                    <div class="surface-card p-4 md:p-6 rounded-xl">
                        <h4 class="font-bold text-xl md:text-2xl mb-4 flex items-center gap-3">
                            <span class="text-xl md:text-2xl">${joinMsg.emoji}</span>
                            <span>${joinMsg.title}</span>
                        </h4>
                        <p class="text-sm text-secondary mb-6">${joinMsg.subtitle}</p>
                        
                        <div id="participation-form" class="space-y-6 max-h-[70vh] overflow-y-auto pr-2">
                            <!-- Choose Copy Style -->
                            <div>
                                <h5 class="font-bold text-lg mb-3">Choose Your Copy Style</h5>
                                <p class="text-sm text-secondary mb-4">Your choice affects how many points and spins you earn! 💎</p>
                                <div class="space-y-3">
                                    <label class="flex items-center gap-3 p-4 bg-bg-color rounded-lg cursor-pointer hover:bg-surface-color transition-all border border-border-color hover:border-accent-primary/50">
                                        <input type="radio" name="copyType" value="provided" checked onchange="handleCopyTypeChange('provided'); updatePointsPreview();">
                                        <div class="flex-1">
                                            <div class="font-semibold text-base mb-1">Use Provided Copy</div>
                                            <div class="text-sm text-secondary">0 bonus points - Quick & easy</div>
                                        </div>
                                    </label>
                                    <label class="flex items-center gap-3 p-4 bg-bg-color rounded-lg cursor-pointer hover:bg-surface-color transition-all border border-border-color hover:border-accent-primary/50">
                                        <input type="radio" name="copyType" value="customized" onchange="handleCopyTypeChange('customized'); updatePointsPreview();">
                                        <div class="flex-1">
                                            <div class="font-semibold text-base mb-1">Customize Copy</div>
                                            <div class="text-sm text-secondary">+50 points & <strong class="accent-text">+1 Spin</strong></div>
                                        </div>
                                    </label>
                                    <label class="flex items-center gap-3 p-4 bg-bg-color rounded-lg cursor-pointer hover:bg-surface-color transition-all border border-border-color hover:border-accent-primary/50">
                                        <input type="radio" name="copyType" value="original" onchange="handleCopyTypeChange('original'); updatePointsPreview();">
                                        <div class="flex-1">
                                            <div class="font-semibold text-base mb-1">Write Original Copy</div>
                                            <div class="text-sm text-secondary">+100 points & <strong class="accent-text">+2 Spins</strong></div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Customize Copy (if needed) -->
                            <div id="copy-editor-container" class="hidden">
                                <h5 class="font-bold text-lg mb-3">Write Your Copy</h5>
                                <p class="text-sm text-secondary mb-4">Make it personal and engaging to maximize your impact! ✨</p>
                                <label class="block text-sm font-semibold mb-2">
                                    Your Copy 
                                    <span class="tooltip">
                                        <span style="color: var(--accent-primary);">ℹ️</span>
                                        <span class="tooltip-text">Write your own post copy. Make it personal and engaging!</span>
                                    </span>
                                </label>
                                <textarea 
                                    id="custom-copy-editor" 
                                    class="copy-editor" 
                                    placeholder="Write your post copy here... Make it personal and engaging!"
                                    maxlength="500"
                                    oninput="updateCopyPreview(); updatePointsPreview();"
                                ></textarea>
                                <div class="character-count" id="char-count">0 / 500 characters</div>
                                
                                <div id="copy-preview-container" class="hidden mt-4">
                                    <label class="block text-sm font-semibold mb-2">Preview:</label>
                                    <div class="copy-preview" id="copy-preview"></div>
                                </div>
                            </div>
                            
                            <!-- Add Extras -->
                            <div>
                                <h5 class="font-bold text-lg mb-3">Add Extras (Optional)</h5>
                                <p class="text-sm text-secondary mb-4">Boost your points and spins with these bonus options! 🎁</p>
                                <div class="space-y-4">
                                    <div class="grid grid-cols-2 gap-4">
                                        <label class="flex items-center gap-3 p-4 bg-bg-color rounded-lg cursor-pointer hover:bg-surface-color transition-all border border-border-color hover:border-accent-primary/50">
                                            <input type="checkbox" id="hasStory" onchange="updatePointsPreview()">
                                            <div class="flex-1">
                                                <div class="font-semibold text-base mb-1">Add Personal Story</div>
                                                <div class="text-sm text-secondary">+75 points & <strong class="accent-text">+1&nbsp;Spin</strong></div>
                                            </div>
                                        </label>
                                        <label class="flex items-center gap-3 p-4 bg-bg-color rounded-lg cursor-pointer hover:bg-surface-color transition-all border border-border-color hover:border-accent-primary/50">
                                            <input type="checkbox" id="hasCTA" onchange="updatePointsPreview()">
                                            <div class="flex-1">
                                                <div class="font-semibold text-base mb-1">Include Call-to-Action</div>
                                                <div class="text-sm text-secondary">+25 points</div>
                                            </div>
                                        </label>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-base font-semibold mb-4">Share on Multiple Platforms:</label>
                                        <div class="grid grid-cols-2 gap-4">
                                            <label class="flex items-center gap-3 p-4 bg-bg-color rounded-lg cursor-pointer hover:bg-surface-color transition-all border border-border-color hover:border-accent-primary/50">
                                                <input type="checkbox" id="shareLinkedIn" checked onchange="updatePointsPreview()">
                                                <span class="font-semibold text-base">LinkedIn</span>
                                            </label>
                                            <label class="flex items-center gap-3 p-4 bg-bg-color rounded-lg cursor-pointer hover:bg-surface-color transition-all border border-border-color hover:border-accent-primary/50">
                                                <input type="checkbox" id="shareTwitter" onchange="updatePointsPreview()">
                                                <span class="font-semibold text-base">Twitter</span>
                                            </label>
                                        </div>
                                        <p class="text-sm text-secondary mt-3">Share on 2+ platforms for +50 bonus points & <strong class="accent-text">+1&nbsp;Spin</strong>!</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Review & Submit (Always Visible) -->
                        <div class="mt-6 pt-6 border-t border-border-color">
                            <div id="estimated-points" class="p-6 bg-gradient-to-r from-purple-900/20 to-pink-900/20 border-2 border-accent-primary rounded-xl mb-6">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="text-base font-semibold text-secondary">Estimated Rewards:</div>
                                    <div class="flex items-center gap-6">
                                        <div class="text-right">
                                            <div class="text-3xl font-extrabold-heading gradient-text" id="points-preview">100</div>
                                            <div class="text-base font-semibold text-secondary">Points</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-3xl font-extrabold-heading gradient-text" id="spins-preview">0</div>
                                            <div class="text-base font-semibold text-secondary">Spins</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-sm text-secondary space-y-2">
                                    <div class="flex items-center gap-2">
                                        <span>✓</span>
                                        <span>Base participation: 100</span>
                                    </div>
                                    <div id="points-breakdown-text"></div>
                                    <div class="mt-4 pt-4 border-t border-accent-primary/30">
                                        <div class="font-semibold mb-1">Plus click rewards:</div>
                                        <div class="text-xs">10-15 points per click (tiered system)</div>
                                    </div>
                                </div>
                            </div>
                            <button id="participate-button" class="campaign-join-button text-white font-bold py-3 px-6 text-base md:text-lg w-full rounded-xl">
                                Submit & Get My Link 🚀
                            </button>
                        </div>
                    </div>`;
            }

            let shortLinkHTML = '';
            if (shortLink) {
                const fullLink = `https://${shortLink}`;
                shortLinkHTML = `
                    <div class="mt-6">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-bold text-lg flex items-center gap-2">
                                <span class="text-xl">🔗</span>
                                <span>Your Tracking Link</span>
                            </h4>
                            <span class="badge purple text-xs">Active</span>
                        </div>
                        <div class="bg-bg-color p-5 rounded-xl border-2 border-accent-primary">
                            <div class="flex items-center gap-3 mb-4">
                                <code class="text-base md:text-lg font-mono accent-text flex-1 truncate font-bold">${shortLink}</code>
                                <button class="copy-link-button bg-gray-200 text-text-primary px-5 py-2.5 text-sm hover:bg-gray-300 rounded-lg font-semibold transition-all flex-shrink-0" data-text="${fullLink}">
                                    <span class="copy-link-text">Copy</span>
                                </button>
                            </div>
                            
                            <div class="bg-surface-color p-3 rounded-lg mb-3">
                                <p class="text-xs text-secondary mb-1">Full URL:</p>
                                <code class="text-sm text-text-primary break-all">${fullLink}</code>
                            </div>
                            
                            <div class="flex items-center gap-4 text-sm">
                                <div class="flex items-center gap-2 text-secondary">
                                    <span>📊</span>
                                    <span>Tracking active</span>
                                </div>
                                <div class="flex items-center gap-2 text-secondary">
                                    <span>⚡</span>
                                    <span>Real-time updates</span>
                                </div>
                            </div>
                            
                            <div class="mt-4 pt-4 border-t border-border-color">
                                <div class="bg-gradient-to-r from-purple-900/20 to-pink-900/20 p-5 rounded-xl mb-4 border-2 border-accent-primary/30">
                                    <div class="flex items-center gap-2 mb-3">
                                        <span class="text-2xl">🎯</span>
                                        <h5 class="font-bold text-base">Your Action Plan:</h5>
                                    </div>
                                    <div class="space-y-3">
                                        <div class="flex items-start gap-3 p-3 bg-bg-color/50 rounded-lg">
                                            <div class="flex-shrink-0 w-6 h-6 rounded-full bg-accent-primary/20 flex items-center justify-center text-xs font-bold accent-text">1</div>
                                            <div class="flex-1">
                                                <div class="font-semibold text-sm mb-1">Copy Your Link</div>
                                                <div class="text-xs text-secondary">Click the "Copy" button above to get your unique tracking link</div>
                                            </div>
                                        </div>
                                        <div class="flex items-start gap-3 p-3 bg-bg-color/50 rounded-lg">
                                            <div class="flex-shrink-0 w-6 h-6 rounded-full bg-accent-primary/20 flex items-center justify-center text-xs font-bold accent-text">2</div>
                                            <div class="flex-1">
                                                <div class="font-semibold text-sm mb-1">Create Your Post</div>
                                                <div class="text-xs text-secondary">Go to LinkedIn or Twitter and start a new post</div>
                                            </div>
                                        </div>
                                        <div class="flex items-start gap-3 p-3 bg-bg-color/50 rounded-lg">
                                            <div class="flex-shrink-0 w-6 h-6 rounded-full bg-accent-primary/20 flex items-center justify-center text-xs font-bold accent-text">3</div>
                                            <div class="flex-1">
                                                <div class="font-semibold text-sm mb-1">Paste & Share</div>
                                                <div class="text-xs text-secondary">Paste your link, add your copy, and post it!</div>
                                            </div>
                                        </div>
                                        <div class="flex items-start gap-3 p-3 bg-bg-color/50 rounded-lg">
                                            <div class="flex-shrink-0 w-6 h-6 rounded-full bg-accent-primary/20 flex items-center justify-center text-xs font-bold accent-text">4</div>
                                            <div class="flex-1">
                                                <div class="font-semibold text-sm mb-1">Watch Points Grow</div>
                                                <div class="text-xs text-secondary">Come back here to see your clicks and points update in real-time! 🚀</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-bg-color p-4 rounded-lg mb-3">
                                    <div class="flex items-start gap-2 mb-2">
                                        <span class="text-lg">💡</span>
                                        <div class="flex-1">
                                            <div class="font-semibold text-sm mb-1">Pro Tips:</div>
                                            <ul class="text-xs text-secondary space-y-1 list-disc list-inside">
                                                <li>Every click earns 10-15 points (tiered system)</li>
                                                <li>Share on multiple platforms for bonus points</li>
                                                <li>Check back regularly to see your progress</li>
                                                <li>Engage with comments to boost visibility</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <a href="https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(fullLink)}" target="_blank" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white text-center py-2.5 px-4 rounded-md text-sm font-semibold transition-all flex items-center justify-center gap-2">
                                        <span>💼</span>
                                        <span>Share on LinkedIn</span>
                                    </a>
                                    <a href="https://twitter.com/intent/tweet?url=${encodeURIComponent(fullLink)}" target="_blank" class="flex-1 bg-blue-400 hover:bg-blue-500 text-white text-center py-2.5 px-4 rounded-md text-sm font-semibold transition-all flex items-center justify-center gap-2">
                                        <span>🐦</span>
                                        <span>Share on Twitter</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>`;
            }

            // Get main hero image (first image) and additional assets
            const mainImage = activeDrop.visualAssets && activeDrop.visualAssets.length > 0 
                ? activeDrop.visualAssets[0] 
                : { url: 'https://placehold.co/1200x500/BE38F3/FFFFFF?text=AMPUP+DROP', filename: 'default-hero.png' };
            const additionalAssets = activeDrop.visualAssets && activeDrop.visualAssets.length > 1 
                ? activeDrop.visualAssets.slice(1) 
                : [];
            
            let heroImageHTML = `
                <img src="${escapeHtml(mainImage.url)}" alt="${escapeHtml(activeDrop.name)}" class="drop-hero-image">
            `;
            
            let visualAssetsHTML = '';
            if (additionalAssets.length > 0) {
                visualAssetsHTML = `
                    <div class="collapsible-section collapsed" id="assets-section">
                        <h4 class="font-bold text-xl mb-6 flex items-center gap-3">
                            <span class="text-2xl">🖼️</span>
                            <span>Additional Assets</span>
                        </h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                            ${additionalAssets.map(asset => `
                                <div class="border border-border-color p-3 bg-bg-color rounded-lg">
                                    <img src="${escapeHtml(asset.url)}" alt="${escapeHtml(asset.filename)}" class="asset-image w-full h-auto object-cover mb-3">
                                    <a href="${escapeHtml(asset.url)}" download="${escapeHtml(asset.filename)}" class="block text-center bg-gray-600 text-white px-3 py-2 text-sm hover:bg-gray-700 w-full rounded-md font-semibold">Download</a>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <button class="toggle-button mt-4" data-target="assets-section">
                        <span>Show Additional Assets</span>
                        <span class="icon">▼</span>
                    </button>
                `;
            }

            let contentOptionsHTML = `
                <div>
                    <button class="toggle-button mb-4" data-target="copy-options-section">
                        <span class="flex items-center gap-2">
                            <span class="text-xl">💬</span>
                            <span class="font-bold text-lg">Copy Options</span>
                        </span>
                        <span class="icon">▼</span>
                    </button>
                    <div class="collapsible-section collapsed" id="copy-options-section">
                        <div class="flex justify-between items-center mb-6">
                            <h4 class="font-bold text-xl flex items-center gap-3">
                                <span class="text-2xl">💬</span>
                                <span>Copy Options</span>
                            </h4>
                            <button id="suggest-copy-button" class="text-sm accent-text font-semibold hover:underline flex items-center gap-2 px-4 py-2 rounded-lg hover:bg-surface-color transition-all">
                                <span>✨</span>
                                <span>AI Suggestions</span>
                            </button>
                        </div>
                        <div class="space-y-4" id="content-options-container">
                            ${activeDrop.contentOptions.map((option, index) => `
                                <div class="bg-bg-color p-6 rounded-lg border border-border-color hover:border-accent-primary/50 transition-all">
                                    <div class="flex items-center justify-between mb-3">
                                        <p class="text-secondary text-sm font-semibold uppercase tracking-wide">Option ${index + 1}: ${escapeHtml(option.type)}</p>
                                        <button class="copy-text-button bg-gray-200 text-text-primary px-4 py-2 text-sm hover:bg-gray-300 flex-shrink-0 rounded-md font-semibold transition-all" data-text="${escapeHtml(option.text)}">
                                            Copy
                                        </button>
                                    </div>
                                    <p class="text-text-primary leading-relaxed text-base">${escapeHtml(option.text)}</p>
                                </div>
                            `).join('')}
                        </div>
                        <div id="copy-suggestions-loader" class="hidden text-center p-4 text-secondary">
                            <div class="spinner mx-auto mb-2"></div>
                            <p>Generating AI copy suggestions...</p>
                        </div>
                    </div>
                </div>`;

            const dropAge = Math.floor((new Date() - new Date(activeDrop.createdAt)) / (1000 * 60 * 60 * 24));
            const participantsCount = Object.keys(appState.performanceData[activeDrop.id] || {}).length;
            
            // Calculate drop stats
            const totalClicks = Object.values(dropPerf).reduce((sum, clicks) => sum + clicks, 0);
            const avgClicks = participantsCount > 0 ? Math.round(totalClicks / participantsCount) : 0;
            
            // Campaign Milestones
            const campaignMilestones = activeDrop.milestones || [
                { id: 'm1', name: 'First 10 Participants', target: 10, current: participantsCount, reward: 'Bonus 50 XP for all', type: 'participants' },
                { id: 'm2', name: '100 Total Clicks', target: 100, current: totalClicks, reward: 'Double XP Day', type: 'clicks' },
                { id: 'm3', name: '500 Total Clicks', target: 500, current: totalClicks, reward: 'Special Badge for Top 3', type: 'clicks' },
                { id: 'm4', name: '1000 Total Clicks', target: 1000, current: totalClicks, reward: 'Legendary Prize Unlock', type: 'clicks' }
            ];
            
            // Calculate milestone progress
            const milestoneProgress = campaignMilestones.map(function(milestone) {
                const progress = Math.min((milestone.current / milestone.target) * 100, 100);
                const unlocked = milestone.current >= milestone.target;
                return { ...milestone, progress, unlocked };
            });
            // Calculate potential points
            const basePoints = activeDrop.points || 100;
            const maxBonusPoints = 300; // Custom copy (100) + Story (75) + CTA (25) + Cross-platform (50) + First responder (50)
            const potentialPoints = basePoints + maxBonusPoints;
            
                    terminal.innerHTML = `
                        <!-- Epic Meaning Banner - Psychological Framing -->
                <div class="mb-6 p-6 rounded-2xl border-2 border-accent-primary/50 bg-gradient-to-br from-purple-900/20 via-pink-900/20 to-purple-900/20">
                    <div class="flex items-start gap-4">
                        <div class="text-4xl flex-shrink-0">🎯</div>
                        <div class="flex-1">
                            <h3 class="text-xl font-extrabold-heading mb-2 gradient-text">Your Mission: ${escapeHtml(activeDrop.name)}</h3>
                            <p class="text-secondary mb-3 leading-relaxed">${escapeHtml(activeDrop.objective)}</p>
                            <div class="flex flex-wrap gap-2 text-xs">
                                <span class="px-3 py-1 rounded-full bg-accent-primary/20 text-accent-primary border border-accent-primary/30">
                                    🎯 Epic Meaning & Calling
                                </span>
                                <span class="px-3 py-1 rounded-full bg-blue-500/20 text-blue-400 border border-blue-500/30">
                                    💪 Competence & Mastery
                                </span>
                                <span class="px-3 py-1 rounded-full bg-green-500/20 text-green-400 border border-green-500/30">
                                    🤝 Relatedness & Community
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Campaign Hero Card -->
                <div class="campaign-hero-card surface-card mb-6">
                    <!-- Hero Image -->
                    <div class="relative">
                        ${heroImageHTML.replace('drop-hero-image', 'drop-hero-image mb-0')}
                        <div class="absolute top-4 right-4 flex gap-2">
                            <span class="badge purple image-badge">${participantsCount} Joined</span>
                            ${dropAge > 0 ? `<span class="badge image-badge">Day ${dropAge}</span>` : ''}
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-surface-color via-surface-color/80 to-transparent h-24"></div>
                    </div>
                    
                    <!-- Campaign Info -->
                    <div class="p-4 md:p-6">
                        <div class="mb-6">
                            <h2 class="text-2xl md:text-3xl font-extrabold-heading gradient-text mb-3 leading-tight">${escapeHtml(activeDrop.name)}</h2>
                            <p class="text-lg md:text-xl text-secondary leading-relaxed max-w-3xl">${escapeHtml(activeDrop.objective)}</p>
                        </div>
                        
                        ${!hasParticipated ? `
                            <!-- Join Campaign -->
                            <div class="reward-card p-4 md:p-6 mb-6">
                                <div class="flex items-center gap-2 mb-4">
                                    <span class="text-2xl">🎁</span>
                                    <h3 class="text-xl font-extrabold-heading">Ready to Win?</h3>
                                </div>
                                <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-6 mb-6">
                                    <div>
                                        <div class="text-xs text-secondary uppercase tracking-wider mb-2">Earn up to</div>
                                        <div class="text-3xl md:text-4xl font-extrabold-heading gradient-text">${potentialPoints}</div>
                                        <div class="text-sm text-secondary mt-1">Points Available</div>
                                    </div>
                                    <div class="text-center md:text-right">
                                        <div class="text-xs text-secondary uppercase tracking-wider mb-2">Base Reward</div>
                                        <div class="text-2xl md:text-3xl font-bold accent-text">${basePoints}</div>
                                        <div class="text-sm text-secondary mt-1">+ ${maxBonusPoints} Bonus</div>
                                    </div>
                                </div>
                                <div class="bg-bg-color/50 p-4 rounded-lg mb-6">
                                    <div class="text-sm font-semibold mb-2 flex items-center gap-2">
                                        <span>💰</span>
                                        <span>Maximize Your Points:</span>
                                    </div>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs text-secondary">
                                        <div>✓ Custom copy: +100</div>
                                        <div>✓ Personal story: +75</div>
                                        <div>✓ Call-to-action: +25</div>
                                        <div>✓ Cross-platform: +50</div>
                                    </div>
                                </div>
                                <button id="participate-button" class="campaign-join-button text-white font-bold py-3 px-6 text-base md:text-lg w-full rounded-xl" onclick="
                                    const rewardCard = this.closest('.reward-card');
                                    const formContainer = document.getElementById('participation-form-container');
                                    if (rewardCard && formContainer) {
                                        rewardCard.classList.add('hidden');
                                        formContainer.classList.remove('hidden');
                                        formContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                                    }
                                ">
                                    Join Campaign & Get My Link 🚀
                                </button>
                                <p class="text-xs text-center text-secondary mt-4">⏱️ Takes less than 2 minutes • 🎯 Get your link instantly</p>
                            </div>
                            
                            <!-- Quick Stats -->
                            <div class="grid grid-cols-3 gap-4">
                                <div class="stat-mini">
                                    <div class="text-2xl md:text-3xl font-bold accent-text mb-1">${basePoints}+</div>
                                    <div class="text-xs text-secondary uppercase tracking-wide">Points</div>
                                </div>
                                <div class="stat-mini">
                                    <div class="text-2xl md:text-3xl font-bold accent-text mb-1">${participantsCount}</div>
                                    <div class="text-xs text-secondary uppercase tracking-wide">Players</div>
                                </div>
                                <div class="stat-mini">
                                    <div class="text-2xl md:text-3xl font-bold accent-text mb-1">${totalClicks}</div>
                                    <div class="text-xs text-secondary uppercase tracking-wide">Clicks</div>
                                </div>
                            </div>
                        ` : `
                            <!-- Already Participated -->
                            <div class="success-card p-4 md:p-6 mb-6">
                                <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-6 mb-6">
                                    <div>
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="text-xl">🎉</span>
                                            <span class="text-sm font-semibold text-green-400 uppercase tracking-wide">You're In!</span>
                                        </div>
                                        <div class="text-3xl md:text-4xl font-extrabold-heading accent-text mb-2">${clicks} Clicks</div>
                                        <div class="text-sm text-secondary">Keep sharing to earn more points</div>
                                    </div>
                                    <div class="text-center md:text-right">
                                        <div class="text-xs text-secondary uppercase tracking-wider mb-2">Your Points</div>
                                        <div class="text-3xl md:text-4xl font-extrabold-heading accent-text">${(participation.points || 0) + calculateClickPoints(clicks)}</div>
                                        <div class="text-sm text-secondary mt-1">Keep going! 🚀</div>
                                    </div>
                                </div>
                                ${shortLinkHTML ? shortLinkHTML.replace('mt-6', '') : ''}
                            </div>
                        `}
                    </div>
                </div>

                ${!hasParticipated ? `
                    <!-- Participation Form (Hidden by default, shown when Join clicked) -->
                    <div id="participation-form-container" class="hidden mb-6">
                        ${participationFormHTML.replace('mt-6 pt-6 border-t border-border-color', '')}
                    </div>
                ` : ''}

                ${hasParticipated ? `
                    <!-- Your Progress -->
                    <div class="surface-card p-4 md:p-6 mb-6 rounded-xl">
                        <h3 class="text-xl md:text-2xl font-extrabold-heading mb-6 flex items-center gap-2">
                            <span>📊</span>
                            <span>Your Progress</span>
                        </h3>
                        ${performanceHTML.replace('mt-6 pt-6 border-t border-dashed border-border-color', '')}
                    </div>
                ` : ''}

                <!-- Campaign Milestones -->
                ${milestoneProgress.length > 0 ? `
                    <div class="surface-card p-4 md:p-6 mb-6 rounded-xl">
                        <h3 class="text-xl md:text-2xl font-extrabold-heading mb-6 flex items-center gap-2">
                            <span>🎯</span>
                            <span>Campaign Milestones</span>
                        </h3>
                        <div class="space-y-4">
                            ${milestoneProgress.map(function(milestone) {
                                const milestoneClass = milestone.unlocked ? 'milestone-unlocked' : 'milestone-locked';
                                return `
                                    <div class="bg-bg-color p-4 rounded-lg border-2 ${milestone.unlocked ? 'border-green-400' : 'border-border-color'} ${milestoneClass}">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="flex items-center gap-2">
                                                <span class="text-xl">${milestone.unlocked ? '✅' : '🎯'}</span>
                                                <span class="font-semibold text-text-primary">${escapeHtml(milestone.name)}</span>
                                                ${milestone.unlocked ? '<span class="badge green text-xs">Unlocked!</span>' : ''}
                                            </div>
                                            <div class="text-right">
                                                <div class="text-sm font-bold ${milestone.unlocked ? 'text-green-400' : 'accent-text'}">
                                                    ${milestone.current.toLocaleString()} / ${milestone.target.toLocaleString()}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="xp-progress-bar mb-2">
                                            <div class="xp-progress-fill" style="width: ${milestone.progress}%"></div>
                                        </div>
                                        <div class="text-xs text-secondary">
                                            Reward: ${escapeHtml(milestone.reward)}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                ` : ''}

                <!-- Help & Resources (Collapsible) -->
                <div class="space-y-3">
                    <button class="toggle-button rounded-xl" data-target="help-section">
                        <span class="flex items-center gap-2">
                            <span class="text-lg">💡</span>
                            <span class="font-semibold">How it works & Resources</span>
                        </span>
                        <span class="icon text-sm">▼</span>
                    </button>
                    <div class="collapsible-section collapsed" id="help-section">
                        <div class="surface-card p-4 md:p-6 mt-3 rounded-xl">
                            <!-- Quick Instructions -->
                            <div class="mb-6">
                                <h4 class="font-bold text-lg mb-4">Quick Start</h4>
                                <div class="space-y-3">
                                    ${activeDrop.instructions.slice(0, 3).map((inst, idx) => `
                                        <div class="flex items-start gap-3">
                                            <span class="flex-shrink-0 w-6 h-6 rounded-full bg-accent-primary/20 flex items-center justify-center text-sm font-bold accent-text">${idx + 1}</span>
                                            <p class="text-text-primary">${escapeHtml(inst)}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            ${visualAssetsHTML ? `
                                <div class="mb-6">
                                    ${visualAssetsHTML.replace('collapsible-section collapsed', '')}
                                </div>
                            ` : ''}
                            
                            ${contentOptionsHTML ? `
                                <div class="mb-6">
                                    <h4 class="font-bold text-lg mb-4">Copy Options</h4>
                                    <div class="space-y-3" id="content-options-container">
                                        ${activeDrop.contentOptions.map((option, index) => `
                                            <div class="bg-bg-color p-4 rounded-lg border border-border-color hover:border-accent-primary/50 transition-all">
                                                <div class="flex items-center justify-between mb-2">
                                                    <p class="text-secondary text-xs font-semibold uppercase tracking-wide">Option ${index + 1}: ${escapeHtml(option.type)}</p>
                                                    <button class="copy-text-button bg-gray-200 text-text-primary px-3 py-1.5 text-sm hover:bg-gray-300 flex-shrink-0 rounded-md font-semibold transition-all" data-text="${escapeHtml(option.text)}">
                                                        Copy
                                                    </button>
                                                </div>
                                                <p class="text-text-primary leading-relaxed text-sm">${escapeHtml(option.text)}</p>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            // Event listeners
            document.querySelectorAll('.copy-text-button, .copy-link-button').forEach(button => {
                button.addEventListener('click', handleCopyText);
            });
            
            const suggestBtn = document.getElementById('suggest-copy-button');
            if (suggestBtn) suggestBtn.addEventListener('click', handleSuggestCopy);
            
            const participateBtn = document.getElementById('participate-button');
            if (participateBtn) {
                if (!hasParticipated) {
                    // Show form on first click (from hero card button)
                    const heroParticipateBtn = document.querySelector('.campaign-hero-card #participate-button');
                    if (heroParticipateBtn) {
                        heroParticipateBtn.addEventListener('click', function(e) {
                            const formContainer = document.getElementById('participation-form-container');
                            if (formContainer && formContainer.classList.contains('hidden')) {
                                formContainer.classList.remove('hidden');
                                formContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                                e.preventDefault();
                                return;
                            }
                        });
                    }
                    
                    // Submit button in simplified form
                    const formSubmitBtn = document.querySelector('#participation-form-container #participate-button');
                    if (formSubmitBtn) {
                        formSubmitBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            handleParticipation();
                        });
                    }
                    
                    // Update points preview
                    setTimeout(() => {
                        const form = document.getElementById('participation-form');
                        if (form) {
                            form.addEventListener('change', updatePointsPreview);
                            updatePointsPreview();
                        }
                    }, 100);
                } else {
                    participateBtn.addEventListener('click', handleParticipation);
                }
            }
            // Toggle button handlers
            document.querySelectorAll('.toggle-button').forEach(button => {
                button.addEventListener('click', function() {
                    const targetId = this.dataset.target;
                    const section = document.getElementById(targetId);
                    if (!section) return;
                    
                    const isCollapsed = section.classList.contains('collapsed');
                    const textSpan = this.querySelector('span:first-child span:last-child');
                    
                    if (isCollapsed) {
                        section.classList.remove('collapsed');
                        section.style.maxHeight = section.scrollHeight + 'px';
                        this.classList.add('expanded');
                        if (textSpan && textSpan.textContent.includes('Show')) {
                            textSpan.textContent = textSpan.textContent.replace('Show ', 'Hide ');
                        }
                    } else {
                        section.classList.add('collapsed');
                        section.style.maxHeight = '0';
                        this.classList.remove('expanded');
                        if (textSpan && textSpan.textContent.includes('Hide')) {
                            textSpan.textContent = textSpan.textContent.replace('Hide ', 'Show ');
                        }
                    }
                });
            });
            
                    // Add content-loaded animation
                    setTimeout(function() {
                        terminal.classList.add('content-loaded');
                    }, 50);
                }, 150); // Small delay to show skeleton
            } catch(error) {
                logger.error('Error in renderDrop:', error);
                logger.error('Stack:', error.stack);
                const terminal = document.getElementById('active-drop');
                if (terminal) {
                    terminal.innerHTML = `<div class="surface-card p-6"><h3 class="text-xl font-bold mb-2">Error Loading Campaign</h3><p class="text-secondary">Please refresh the page.</p><p class="text-xs text-secondary mt-2">Error: ${error.message}</p></div>`;
                }
            }
        }

        // Step navigation functions (kept for backward compatibility, but simplified form doesn't use steps)
        window.goToStep = function(targetStepNum) {
            // Simplified form doesn't use steps - this function is kept for compatibility
            // Scroll to top of form if needed
            const formContainer = document.getElementById('participation-form-container');
            if (formContainer) {
                formContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        };

        window.updateStepVisibility = function() {
            // Simplified form doesn't use steps - this function is kept for compatibility
            // No-op for simplified form
        };

        // Global function for copy type change
        window.handleCopyTypeChange = function(type) {
            const editorContainer = document.getElementById('copy-editor-container');
            const editor = document.getElementById('custom-copy-editor');
            
            if (type === 'provided') {
                if (editorContainer) editorContainer.classList.add('hidden');
                if (editor) editor.value = '';
            } else {
                if (editorContainer) editorContainer.classList.remove('hidden');
                if (editor && type === 'customized' && !editor.value) {
                    // Pre-fill with first provided copy option
                    const firstOption = document.querySelector('.copy-text-button');
                    if (firstOption) {
                        editor.value = firstOption.dataset.text || '';
                    }
                }
            }
            updateCopyPreview();
            updatePointsPreview();
        };

        function updateCopyPreview() {
            const editor = document.getElementById('custom-copy-editor');
            const preview = document.getElementById('copy-preview');
            const previewContainer = document.getElementById('copy-preview-container');
            const charCount = document.getElementById('char-count');
            
            if (!editor || !preview) return;
            
            const text = editor.value;
            const length = text.length;
            
            // Update character count
            if (charCount) {
                charCount.textContent = `${length} / 500 characters`;
                charCount.className = 'character-count';
                if (length > 450) charCount.classList.add('warning');
                if (length >= 500) charCount.classList.add('error');
            }
            
            // Update preview
            if (text.trim()) {
                preview.textContent = text;
                previewContainer.classList.remove('hidden');
            } else {
                previewContainer.classList.add('hidden');
            }
        }

        function updatePointsPreview() {
            const copyType = document.querySelector('input[name="copyType"]:checked')?.value || 'provided';
            const hasStory = document.getElementById('hasStory')?.checked || false;
            const hasCTA = document.getElementById('hasCTA')?.checked || false;
            const shareLinkedIn = document.getElementById('shareLinkedIn')?.checked || false;
            const shareTwitter = document.getElementById('shareTwitter')?.checked || false;
            
            const sharedOn = [];
            if (shareLinkedIn) sharedOn.push('linkedin');
            if (shareTwitter) sharedOn.push('twitter');
            
            const participation = {
                copyType,
                hasStory,
                hasCTA,
                sharedOn,
                colleaguesTagged: 0
            };
            
            // Calculate spins to award
            let spinsToAward = 0;
            if (copyType === 'original') {
                spinsToAward = 2;
            } else if (copyType === 'customized') {
                spinsToAward = 1;
            }
            if (hasStory) {
                spinsToAward += 1;
            }
            if (sharedOn.length > 1) {
                spinsToAward += 1;
            }
            
            const points = calculateParticipationPoints(participation);
            const previewEl = document.getElementById('points-preview');
            const spinsPreviewEl = document.getElementById('spins-preview');
            const breakdownEl = document.getElementById('points-breakdown-text');
            
            if (previewEl) {
                previewEl.textContent = points;
            }
            
            if (spinsPreviewEl) {
                spinsPreviewEl.textContent = spinsToAward;
            }
            
            if (breakdownEl) {
                const breakdown = [];
                if (copyType === 'customized') breakdown.push('Custom copy: +50 pts, +1 Spin');
                if (copyType === 'original') breakdown.push('Original copy: +100 pts, +2 Spins');
                if (hasStory) breakdown.push('Story: +75 pts, +1 Spin');
                if (hasCTA) breakdown.push('CTA: +25 pts');
                if (sharedOn.length > 1) breakdown.push('Cross-platform: +50 pts, +1 Spin');
                
                breakdownEl.innerHTML = breakdown.length > 0 
                    ? breakdown.join('<br>')
                    : '<span class="text-secondary">No bonuses selected</span>';
            }
        }
        function renderRoster() {
            const rosterEl = document.getElementById('roster');
            if (!rosterEl) return;
            
            // Show skeleton while loading
            rosterEl.innerHTML = `
                ${Array(5).fill(0).map(() => `
                    <div class="skeleton-list-item">
                        <div class="skeleton skeleton-avatar"></div>
                        <div class="flex-1">
                            <div class="skeleton skeleton-text"></div>
                            <div class="skeleton skeleton-text short"></div>
                        </div>
                    </div>
                `).join('')}
            `;
            
            // Small delay to show skeleton, then render content
            setTimeout(function() {
                const categorySelect = document.getElementById('leaderboard-category');
                const category = categorySelect ? categorySelect.value : 'overall';
                
                // Get persona for persona-aware rendering
                const user = appState.currentUser;
                const persona = (user && user.playerPersona) ? user.playerPersona.toLowerCase() : 'achiever';
                
                rosterEl.innerHTML = '';
            
            const allCrew = [...appState.crew];
            if (appState.currentUser) {
                const existingUser = allCrew.find(c => c.email === appState.currentUser.email);
                if (!existingUser) {
                    allCrew.push(appState.currentUser);
                }
            }
            
            // Calculate scores based on category
            let sortedCrew = [];
            const activeDrop = appState.drops.find(d => d.status === 'ACTIVE');
            
            if (category === 'this-campaign' && activeDrop) {
                // This Campaign: Score based on clicks in active campaign
                const dropPerf = appState.performanceData[activeDrop.id] || {};
                sortedCrew = allCrew
                    .map(member => {
                        const clicks = dropPerf[member.email.toLowerCase()] || 0;
                        const participation = appState.participationData[member.email];
                        const clickPoints = calculateClickPoints(clicks);
                        const participationPoints = participation && participation.dropId === activeDrop.id ? (participation.points || 0) : 0;
                        return { 
                            ...member, 
                            score: clickPoints + participationPoints,
                            clicks: clicks
                        };
                    })
                    .sort((a, b) => b.score - a.score);
            } else if (category === 'this-month') {
                // This Month: Score based on Impact Score (recent activity)
                sortedCrew = allCrew
                    .map(member => {
                        const impactScore = getUserImpactScore(member, allCrew, appState.performanceData, appState.participationData);
                        return { ...member, score: impactScore };
                    })
                    .sort((a, b) => b.score - a.score);
            } else if (category === 'by-department') {
                // By Department: Group by department, then sort by Impact Score
                const departments = {};
                allCrew.forEach(member => {
                    const dept = member.department || 'Unassigned';
                    if (!departments[dept]) {
                        departments[dept] = [];
                    }
                    const impactScore = getUserImpactScore(member, allCrew, appState.performanceData, appState.participationData);
                    departments[dept].push({ ...member, score: impactScore });
                });
                
                // Sort each department
                Object.keys(departments).forEach(dept => {
                    departments[dept].sort((a, b) => b.score - a.score);
                });
                
                // Flatten and sort by top performer in each department
                sortedCrew = Object.entries(departments)
                    .map(([dept, members]) => ({
                        ...members[0],
                        department: dept,
                        isDepartmentHeader: true,
                        departmentMembers: members,
                        score: members[0].score
                    }))
                    .sort((a, b) => b.score - a.score)
                    .flatMap(header => [header, ...header.departmentMembers.slice(1)]);
            } else {
                // Overall: Impact Score (replaces totalHype)
                sortedCrew = allCrew
                    .map(member => {
                        const impactScore = getUserImpactScore(member, allCrew, appState.performanceData, appState.participationData);
                        return { ...member, score: impactScore };
                    })
                    .sort((a, b) => b.score - a.score);
            }

            let rankOffset = 0;
            sortedCrew.forEach(function(member, index) {
                // Skip department headers in rendering (they're just for sorting)
                if (member.isDepartmentHeader && category === 'by-department') {
                    rosterEl.innerHTML += `
                        <div class="mt-6 mb-3 pt-4 border-t border-border-color">
                            <h4 class="text-sm font-bold text-secondary uppercase tracking-wide flex items-center gap-2">
                                <span>🏢</span>
                                <span>${escapeHtml(member.department)}</span>
                            </h4>
                        </div>
                    `;
                    rankOffset = index;
                    return;
                }
                
                const actualRank = category === 'by-department' ? (index - rankOffset) : (index + 1);
                const isCurrentUser = appState.currentUser && member.email === appState.currentUser.email;
                // Persona-specific styling for leaderboard
                let topCrewClass = '';
                if (persona === 'killer' && actualRank <= 5) {
                    topCrewClass = 'bg-red-900/20 border-red-500/30';
                } else if (persona === 'achiever' && actualRank <= 3) {
                    topCrewClass = 'bg-yellow-900/20 border-yellow-500/30';
                } else if (actualRank <= 3) {
                    topCrewClass = 'bg-purple-900/20';
                }
                const currentUserClass = isCurrentUser ? 'ring-2 ring-accent-primary' : '';
                const rankEmoji = actualRank === 1 ? '🥇' : (actualRank === 2 ? '🥈' : (actualRank === 3 ? '🥉' : ''));

                const badgeDisplay = member.badges && member.badges.length > 0 
                    ? member.badges.slice(0, 2).map(function(badge) {
                        const badgeNames = {
                            'creative': '🎨',
                            'growth-hacker': '📈',
                            'storyteller': '📝',
                            'team-player': '🤝',
                            'king-of-clicks': '👑',
                            'first-responder': '⚡'
                        };
                        return `<span class="badge purple text-xs" title="${badge}">${badgeNames[badge] || badge}</span>`;
                    }).join('')
                    : '';
                
                rosterEl.innerHTML += `
                    <div class="flex items-center justify-between p-4 rounded-xl ${topCrewClass} ${currentUserClass} transition-all hover:bg-surface-color/50 cursor-pointer view-player border border-transparent hover:border-accent-primary/30" data-email="${escapeHtml(member.email)}">
                        <div class="flex items-center gap-4 flex-1 min-w-0">
                            <div class="flex items-center gap-2 w-12 flex-shrink-0">
                                <span class="font-bold text-lg text-secondary text-center">${actualRank}</span>
                            </div>
                            ${getAvatarHTML(member.name, member.email, 'md', actualRank <= 3 ? actualRank : null, member)}
                            <div class="flex-1 min-w-0">
                                <div class="font-semibold text-text-primary text-base mb-0.5 truncate flex items-center gap-2">
                                    ${rankEmoji}
                                    <span>${escapeHtml(member.name)}</span>
                                    ${member.level ? `<span class="text-xs accent-text font-bold">Lv.${member.level}</span>` : ''}
                                </div>
                                ${member.department ? `<div class="text-xs text-secondary truncate">${escapeHtml(member.department)}</div>` : ''}
                                ${badgeDisplay ? `<div class="flex gap-1.5 mt-1.5 flex-wrap">${badgeDisplay}</div>` : ''}
                            </div>
                        </div>
                        <div class="text-right flex-shrink-0 ml-4">
                            <div class="font-bold text-lg accent-text">${member.score.toLocaleString()}</div>
                            <div class="text-xs text-secondary">${category === 'this-campaign' && member.clicks !== undefined ? `${member.clicks} clicks` : 'Impact'}</div>
                        </div>
                    </div>`;
            });
            
                // Add click handlers for player profiles
                document.querySelectorAll('.view-player').forEach(el => {
                    el.addEventListener('click', (e) => {
                        const email = e.currentTarget.dataset.email;
                        handleViewPlayer(email);
                    });
                });
                
                // Add stagger animation to roster items
                setTimeout(function() {
                    document.querySelectorAll('#roster > div').forEach(function(item, index) {
                        item.classList.add('stagger-item');
                        item.style.animationDelay = (index * 0.05) + 's';
                    });
                }, 50);
                
                // Add content-loaded animation
                setTimeout(function() {
                    rosterEl.classList.add('content-loaded');
                }, 50);
            }, 150); // Small delay to show skeleton
        }

        function renderArchive() {
            const archiveLog = document.getElementById('archive-log');
            if (!archiveLog) return;
            
            archiveLog.innerHTML = '';
            const completedDrops = appState.drops.filter(d => d.status === 'COMPLETE');

            if(completedDrops.length === 0) {
                archiveLog.innerHTML = `<p class="text-secondary text-center">No past drops.</p>`;
                return;
            }

            completedDrops.slice(0, 3).forEach(drop => {
                const dropPerf = appState.performanceData[drop.id] || {};
                const totalClicks = Object.values(dropPerf).reduce((sum, clicks) => sum + clicks, 0);
                const participants = Object.keys(dropPerf).length;
                const dropImage = drop.visualAssets && drop.visualAssets.length > 0 
                    ? drop.visualAssets[0].url 
                    : 'https://placehold.co/400x200/BE38F3/FFFFFF?text=CAMPAIGN';
                
                archiveLog.innerHTML += `
                    <div class="surface-card overflow-hidden rounded-xl hover:border-accent-primary transition-all cursor-pointer border border-border-color group" onclick="document.querySelector('[data-drop-id=\\'${escapeHtml(drop.id)}\\']').click()">
                        <div class="relative overflow-hidden">
                            <img src="${escapeHtml(dropImage)}" alt="${escapeHtml(drop.name)}" class="asset-image w-full h-36 object-cover transition-transform duration-300 group-hover:scale-105" style="border-radius: 12px 12px 0 0;">
                            <div class="absolute inset-0 bg-gradient-to-t from-surface-color via-transparent to-transparent"></div>
                        </div>
                        <div class="p-5">
                            <p class="font-semibold text-lg mb-2">${escapeHtml(drop.name)}</p>
                            <div class="flex items-center gap-4 text-xs text-secondary mb-4">
                                <span class="flex items-center gap-1">👥 ${participants}</span>
                                <span class="flex items-center gap-1">📈 ${totalClicks}</span>
                            </div>
                            <button class="view-recap-button text-sm accent-text hover:underline font-semibold flex items-center gap-1 group-hover:gap-2 transition-all" data-drop-id="${escapeHtml(drop.id)}">
                                View Results <span>→</span>
                            </button>
                        </div>
                    </div>`;
            });
            
            document.querySelectorAll('.view-recap-button').forEach(button => {
                button.addEventListener('click', handleViewRecap);
            });
        }

        // --- EVENT HANDLERS --- //
        function handleLogin() {
            // Make sure this function is accessible globally
            if (!window.handleLogin) {
                window.handleLogin = handleLogin;
            }
            logger.log('handleLogin called');
            const emailInput = document.getElementById('advocate-email-input');
            const loginBtn = document.getElementById('login-button');
            
            if (!emailInput) {
                logger.error('Email input not found');
                showToast('Email input not found. Please refresh the page.', 'error');
                return;
            }
            
            const email = emailInput.value.trim();
            logger.log('Email entered:', email);
            
            if (!email || !email.includes('@')) { 
                showToast('Please enter a valid email address.', 'error');
                emailInput.focus();
                return; 
            }
            
            if (loginBtn) {
                setLoading(loginBtn, true, 'Signing in...');
            }
            
            // Always create a new user or use existing one
            const emailLower = email.toLowerCase();
            let user = appState.crew.find(a => a.email.toLowerCase() === emailLower);
            
            // If user doesn't exist, create a new one
            if (!user) {
                logger.log('Creating new user for:', emailLower);
                const nameParts = email.split('@')[0].replace(/[._]/g, ' ').split(' ');
                const firstName = nameParts[0] ? nameParts[0].charAt(0).toUpperCase() + nameParts[0].slice(1) : 'User';
                const lastName = nameParts[1] ? nameParts[1].charAt(0).toUpperCase() + nameParts[1].slice(1) : '';
                const fullName = lastName ? `${firstName} ${lastName}` : firstName;
                
                user = { 
                    name: fullName,
                    email: emailLower,
                    department: 'Unassigned', 
                    participatedDrops: [],
                    totalHype: 0,
                    badges: [],
                    followers: 0
                };
                
                // Add to crew list
                appState.crew.push(user);
                logger.log('New user created:', user);
            } else {
                logger.log('Existing user found:', user);
            }
            
            appState.currentUser = user;
            logger.log('Current user set:', appState.currentUser);
            
            // Simulate login delay
            setTimeout(() => {
                logger.log('Login timeout fired');
                const loginBtn = document.getElementById('login-button');
                if (loginBtn) {
                    setLoading(loginBtn, false);
                }
                logger.log('Switching to main view');
                switchView('main');
                logger.log('Rendering all');
                renderAll();
                showToast(`Welcome back, ${user.name}! 🎉`, 'success');
                
                // Show helpful tip for first-time users
                const activeDrop = appState.drops.find(d => d.status === 'ACTIVE');
                const hasParticipated = appState.participationData[user.email] && 
                    appState.participationData[user.email].dropId === activeDrop?.id;
                
                if (!hasParticipated && activeDrop) {
                    setTimeout(() => {
                        showToast('💡 Tip: Click "Join Campaign" to get started and earn your first points!', 'info', 5000);
                    }, 2000);
                }
            }, 800);
        }
        
        function handleLogout() {
            if (appState.currentUser) {
                const userIndex = appState.crew.findIndex(a => a.email === appState.currentUser.email);
                if (userIndex > -1) {
                    appState.crew[userIndex] = appState.currentUser;
                } else {
                    appState.crew.push(appState.currentUser);
                }
            }
            appState.currentUser = null;
            const emailInput = document.getElementById('advocate-email-input');
            if (emailInput) {
                emailInput.value = '';
            }
            switchView('login');
            renderAuthSection();
        }

        function handleParticipation() {
            const activeDrop = appState.drops.find(d => d.status === 'ACTIVE');
            if (!activeDrop || !appState.currentUser) return;
            
            const participateBtn = document.getElementById('participate-button');
            
            // Optimistic UI update - immediately show loading and disable button
            setLoading(participateBtn, true, 'Generating your link...');
            
            // Optimistically update UI - show success state immediately
            const originalText = participateBtn.textContent;
            participateBtn.disabled = true;
            
            // Optimistic feedback - show immediate visual response
            setTimeout(function() {
                participateBtn.classList.add('animate-spring');
            }, 100);
            
            const copyType = document.querySelector('input[name="copyType"]:checked')?.value || 'provided';
            const hasStory = document.getElementById('hasStory')?.checked || false;
            const hasCTA = document.getElementById('hasCTA')?.checked || false;
            const shareLinkedIn = document.getElementById('shareLinkedIn')?.checked || false;
            const shareTwitter = document.getElementById('shareTwitter')?.checked || false;
            const customCopy = document.getElementById('custom-copy-editor')?.value || '';
            
            const sharedOn = [];
            if (shareLinkedIn) sharedOn.push('linkedin');
            if (shareTwitter) sharedOn.push('twitter');
            
            const participation = {
                dropId: activeDrop.id,
                copyType,
                hasStory,
                hasCTA,
                sharedOn,
                colleaguesTagged: 0,
                customCopy: customCopy || null,
                isFirstParticipant: !appState.crew.some(c => c.participatedDrops.includes(activeDrop.id))
            };
            
            // --- New Spin Calculation Logic ---
            let spinsToAward = 0;
            if (copyType === 'original') {
                spinsToAward += 2;
            } else if (copyType === 'customized') {
                spinsToAward += 1;
            }
            if (hasStory) {
                spinsToAward += 1;
            }
            if (sharedOn.length > 1) {
                spinsToAward += 1; // Cross-platform bonus
            }
            
            if (spinsToAward > 0) {
                appState.currentUser.wheelSpins = (appState.currentUser.wheelSpins || 0) + spinsToAward;
            }
            // --- End New Logic ---
            
            const points = calculateParticipationPoints(participation);
            participation.points = points;
            
            // Generate short link
            const shortCode = Math.random().toString(36).substring(2, 8);
            participation.shortLink = `amp.yourdomain.com/${shortCode}`;
            
            // Store participation
            appState.participationData[appState.currentUser.email] = participation;
            
            // Update user
            if (!appState.currentUser.participatedDrops.includes(activeDrop.id)) {
                appState.currentUser.participatedDrops.push(activeDrop.id);
            }
            appState.currentUser.totalHype = (appState.currentUser.totalHype || 0) + points;
            
            // Simulate some clicks
            if (!appState.performanceData[activeDrop.id]) {
                appState.performanceData[activeDrop.id] = {};
            }
            appState.performanceData[activeDrop.id][appState.currentUser.email] = Math.floor(Math.random() * 20) + 5;
            
            // Optimistic UI update - immediately update stats before server response
            const user = appState.currentUser;
            if (user) {
                // Optimistically update user stats
                user.totalHype = (user.totalHype || 0) + points;
                if (!user.participatedDrops) user.participatedDrops = [];
                if (!user.participatedDrops.includes(activeDrop.id)) {
                    user.participatedDrops.push(activeDrop.id);
                }
                
                // Immediately update sidebar stats for instant feedback
                setTimeout(function() {
                    renderSidebar();
                    renderUserStats();
                }, 100);
            }
            
            // Animated success with optimistic updates
            setTimeout(() => {
                setLoading(participateBtn, false);
                participateBtn.classList.remove('animate-spring');
                participateBtn.classList.add('animate-bounce');
                
                // Check achievements after participation is saved
                if (appState.currentUser) {
                    const allUsers = [...appState.crew, appState.currentUser].filter((v, i, a) => 
                        a.findIndex(t => t.email === v.email) === i && v
                    );
                    const newlyUnlocked = checkAchievements(appState.currentUser, allUsers);
                    newlyUnlocked.forEach(function(achievementData) {
                        showAchievementUnlock(achievementData);
                    });
                }
                
                renderAll();
                let toastMessage = `You're in! ${points} points earned! 🎉`;
                if (spinsToAward > 0) {
                    toastMessage = `You're in! ${points} points & ${spinsToAward} Spin${spinsToAward > 1 ? 's' : ''} earned! 🎉`;
                }
                showToast(toastMessage, 'success');
                
                // Show success message with next steps
                setTimeout(() => {
                    showToast('📋 Your tracking link is ready! Scroll down to copy it and start sharing.', 'info', 6000);
                }, 2000);
                
                // Scroll to short link with smooth animation
                setTimeout(() => {
                    const shortLinkEl = document.querySelector('.copy-link-button') || document.querySelector('#participation-form-container');
                    if (shortLinkEl) {
                        shortLinkEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 500);
            }, 1500);
        }

        function handleCopyText(event) {
            const textToCopy = event.target.dataset.text;
            const button = event.target;
            const originalText = button.textContent;
            const originalBg = button.style.background;
            
            // Optimistic UI - immediately show success state
            button.textContent = 'Copied!';
            button.style.background = '#10b981';
            button.classList.add('animate-spring');
            
            navigator.clipboard.writeText(textToCopy).then(() => {
                showToast('Copied to clipboard!', 'success', 2000);
                setTimeout(() => { 
                    button.textContent = originalText;
                    button.style.background = originalBg;
                    button.classList.remove('animate-spring');
                }, 2000);
            }).catch(err => {
                logger.error('Failed to copy: ', err);
                button.textContent = originalText;
                button.style.background = originalBg;
                button.classList.remove('animate-spring');
                button.classList.add('animate-shake');
                showToast('Failed to copy. Please try again.', 'error');
                setTimeout(() => button.classList.remove('animate-shake'), 500);
            });
        }
        function handleViewRecap(event) {
            const dropId = event.target.dataset.dropId;
            const drop = appState.drops.find(d => d.id === dropId);
            if (!drop) return;
            
            switchView('recap');
            
            const performance = appState.performanceData[dropId] || {};
            const participants = Object.keys(performance);
            const totalClicks = Object.values(performance).reduce((sum, clicks) => sum + clicks, 0);
            const avgClicks = participants.length > 0 ? Math.round(totalClicks / participants.length) : 0;
            
            // Calculate participation data
            const participationDetails = participants.map(email => {
                const member = appState.crew.find(m => m.email === email);
                const clicks = performance[email] || 0;
                const participation = appState.participationData[email];
                const clickPoints = calculateClickPoints(clicks);
                const participationPoints = participation?.points || 0;
                const totalPoints = clickPoints + participationPoints;
                const engagementRate = member?.followers ? ((clicks / member.followers) * 100).toFixed(1) : null;
                
                return {
                    name: member?.name || email.split('@')[0],
                    email,
                    department: member?.department || 'Unassigned',
                    clicks,
                    clickPoints,
                    participationPoints,
                    totalPoints,
                    engagementRate,
                    badges: member?.badges || []
                };
            });
            
            // Team breakdown
            const teamClicks = {};
            const teamParticipants = {};
            participationDetails.forEach(p => {
                teamClicks[p.department] = (teamClicks[p.department] || 0) + p.clicks;
                teamParticipants[p.department] = (teamParticipants[p.department] || 0) + 1;
            });
            
            const sortedTeams = Object.entries(teamClicks)
                .map(([team, clicks]) => ({
                    team,
                    clicks,
                    participants: teamParticipants[team],
                    avgClicks: Math.round(clicks / teamParticipants[team])
                }))
                .sort((a, b) => b.clicks - a.clicks);
            
            const maxTeamClicks = sortedTeams.length > 0 ? sortedTeams[0].clicks : 0;
            
            // Top performers (with email for avatar generation)
            const sortedCrew = [...participationDetails]
                .map(p => ({
                    ...p,
                    email: p.email || appState.crew.find(m => m.name === p.name)?.email || p.name.toLowerCase()
                }))
                .sort((a, b) => b.clicks - a.clicks)
                .slice(0, 10);
            
            // Top point earners (with email for avatar generation)
            const topPointEarners = [...participationDetails]
                .map(p => ({
                    ...p,
                    email: p.email || appState.crew.find(m => m.name === p.name)?.email || p.name.toLowerCase()
                }))
                .sort((a, b) => b.totalPoints - a.totalPoints)
                .slice(0, 5);
            
            // Calculate insights
            const topPerformer = sortedCrew[0];
            const totalPoints = participationDetails.reduce((sum, p) => sum + p.totalPoints, 0);
            const avgPoints = Math.round(totalPoints / participants.length);
            const estimatedReach = Math.round(totalClicks * 125);
            const conversionRate = participants.length > 0 ? ((participants.length / appState.crew.length) * 100).toFixed(1) : 0;
            
            // Date formatting
            const dropDate = drop.createdAt ? new Date(drop.createdAt).toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            }) : 'N/A';
            
            recapScreen.innerHTML = `
                <div class="max-w-6xl mx-auto fade-in pb-12">
                    <!-- Header -->
                    <div class="flex items-center justify-between mb-6">
                        <button id="back-to-main" class="accent-text hover:underline text-lg font-semibold flex items-center gap-2 transition-all hover:gap-3">
                            <span>←</span> Back to Dashboard
                        </button>
                        <div class="text-right">
                            <div class="text-sm text-secondary">Drop Date</div>
                            <div class="font-semibold">${dropDate}</div>
                        </div>
                    </div>
                    
                    <!-- Hero Section -->
                    <div class="text-center mb-6 pb-4 md:pb-6 border-b border-border-color">
                        <div class="inline-block px-4 py-2 bg-purple-900/20 border border-accent-primary rounded-full mb-4">
                            <span class="text-sm font-semibold accent-text">DROP RECAP</span>
                        </div>
                        <h2 class="text-3xl md:text-4xl font-extrabold-heading mb-3 gradient-text">${escapeHtml(drop.name)}</h2>
                        <p class="text-xl text-secondary max-w-2xl mx-auto">${escapeHtml(drop.objective)}</p>
                    </div>

                    <!-- Key Metrics -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="stat-card">
                            <div class="stat-value count-up" data-target="${totalClicks}">0</div>
                            <div class="stat-label">Total Clicks</div>
                            <div class="text-xs text-secondary mt-1">Avg: ${avgClicks} per person</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value count-up" data-target="${participants.length}">0</div>
                            <div class="stat-label">Participants</div>
                            <div class="text-xs text-secondary mt-1">${conversionRate}% of crew</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value count-up" data-target="${estimatedReach}">0</div>
                            <div class="stat-label">Estimated Reach</div>
                            <div class="text-xs text-secondary mt-1">Social impressions</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value count-up" data-target="${totalPoints}">0</div>
                            <div class="stat-label">Total Points</div>
                            <div class="text-xs text-secondary mt-1">Avg: ${avgPoints} per person</div>
                        </div>
                    </div>

                    <!-- Main Content Grid -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6 mb-6">
                        <!-- Team Performance -->
                        <div class="lg:col-span-2 surface-card p-6">
                            <h3 class="text-xl font-extrabold-heading mb-6 flex items-center gap-2">
                                <span>🤝</span>
                                <span>Team Performance</span>
                            </h3>
                            <div class="space-y-4">
                                ${sortedTeams.map(({team, clicks, participants: teamCount, avgClicks}) => `
                                    <div class="bg-bg-color p-4 rounded-lg border border-border-color">
                                        <div class="flex justify-between items-start mb-3">
                                            <div>
                                                <div class="font-semibold text-lg text-text-primary mb-1">${escapeHtml(team)}</div>
                                                <div class="text-xs text-secondary">${teamCount} participant${teamCount !== 1 ? 's' : ''}</div>
                                            </div>
                                            <div class="text-right">
                                                <div class="text-2xl font-bold accent-text">${clicks}</div>
                                                <div class="text-xs text-secondary">clicks</div>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-3 text-xs text-secondary mb-2">
                                            <span>Avg: ${avgClicks} clicks/person</span>
                                            <span>•</span>
                                            <span>${maxTeamClicks > 0 ? Math.round((clicks / maxTeamClicks) * 100) : 0}% of top team</span>
                                        </div>
                                        <div class="progress-bar-container">
                                            <div class="progress-bar-fill" style="width: 0%;" data-width="${maxTeamClicks > 0 ? (clicks / maxTeamClicks) * 100 : 0}%"></div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Top Performers -->
                        <div class="surface-card p-4 md:p-5">
                            <h3 class="text-xl font-extrabold-heading mb-6 flex items-center gap-2">
                                <span>⭐</span>
                                <span>Top Performers</span>
                            </h3>
                            <div class="space-y-3">
                                ${sortedCrew.slice(0, 5).map(({name, clicks, engagementRate, email}, index) => {
                                    const member = appState.crew.find(m => m.email === email) || (appState.currentUser && appState.currentUser.email === email ? appState.currentUser : null);
                                    return `
                                    <div class="bg-bg-color p-3 rounded-lg flex items-center justify-between ${index === 0 ? 'ring-2 ring-accent-primary' : ''}">
                                        <div class="flex items-center gap-3">
                                            ${getAvatarHTML(name, email || name.toLowerCase(), 'sm', index < 3 ? index + 1 : null, member)}
                                            <div>
                                                <div class="font-semibold text-text-primary text-sm flex items-center gap-2">
                                                    <span>${index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : '🏅'}</span>
                                                    <span>${escapeHtml(name)}</span>
                                                </div>
                                                ${engagementRate ? `<div class="text-xs text-secondary">${engagementRate}% engagement</div>` : ''}
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="accent-text font-bold">${clicks}</div>
                                            <div class="text-xs text-secondary">clicks</div>
                                        </div>
                                    </div>
                                `;
                                }).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Stats Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-6">
                        <!-- Point Leaders -->
                        <div class="surface-card p-4 md:p-5">
                            <h3 class="text-xl font-extrabold-heading mb-6 flex items-center gap-2">
                                <span>🏆</span>
                                <span>Point Leaders</span>
                            </h3>
                            <div class="space-y-3">
                                ${topPointEarners.map(({name, totalPoints, clicks, participationPoints, email}, index) => {
                                    const member = appState.crew.find(m => m.email === email) || (appState.currentUser && appState.currentUser.email === email ? appState.currentUser : null);
                                    return `
                                    <div class="bg-bg-color p-4 rounded-lg">
                                        <div class="flex justify-between items-center mb-2">
                                            <div class="flex items-center gap-3">
                                                ${getAvatarHTML(name, email || name.toLowerCase(), 'sm', index < 3 ? index + 1 : null, member)}
                                                <div>
                                                    <div class="font-semibold text-text-primary flex items-center gap-2">
                                                        <span>${index === 0 ? '👑' : index === 1 ? '🥈' : index === 2 ? '🥉' : '⭐'}</span>
                                                        <span>${escapeHtml(name)}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <div class="text-xl font-bold accent-text">${totalPoints}</div>
                                                <div class="text-xs text-secondary">total points</div>
                                            </div>
                                        </div>
                                        <div class="flex gap-4 text-xs text-secondary mt-2 pt-2 border-t border-border-color">
                                            <span>Participation: +${participationPoints}</span>
                                            <span>•</span>
                                            <span>Clicks: +${clicks} (${calculateClickPoints(clicks)} pts)</span>
                                        </div>
                                    </div>
                                `;
                                }).join('')}
                            </div>
                        </div>

                        <!-- Participation Breakdown -->
                        <div class="surface-card p-4 md:p-5">
                            <h3 class="text-xl font-extrabold-heading mb-6 flex items-center gap-2">
                                <span>📊</span>
                                <span>Participation Stats</span>
                            </h3>
                            <div class="space-y-4">
                                <div class="bg-bg-color p-4 rounded-lg">
                                    <div class="flex justify-between items-center mb-3">
                                        <span class="text-secondary">Participation Rate</span>
                                        <span class="text-2xl font-bold accent-text">${conversionRate}%</span>
                                    </div>
                                    <div class="progress-bar-container">
                                        <div class="progress-bar-fill" style="width: 0%;" data-width="${conversionRate}%"></div>
                                    </div>
                                    <div class="text-xs text-secondary mt-2">${participants.length} of ${appState.crew.length} crew members</div>
                                </div>
                                
                                <div class="bg-bg-color p-4 rounded-lg">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-secondary">Average Clicks</span>
                                        <span class="text-xl font-bold accent-text">${avgClicks}</span>
                                    </div>
                                    <div class="text-xs text-secondary">per participant</div>
                                </div>
                                
                                <div class="bg-bg-color p-4 rounded-lg">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-secondary">Top Performer</span>
                                        <span class="font-semibold text-text-primary">${topPerformer ? escapeHtml(topPerformer.name) : 'N/A'}</span>
                                    </div>
                                    <div class="text-xs text-secondary">${topPerformer ? `${topPerformer.clicks} clicks • ${topPerformer.engagementRate ? topPerformer.engagementRate + '% engagement' : ''}` : ''}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Social Boost Impact Charts -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-6">
                        <div class="surface-card p-4 md:p-5">
                            <h3 class="text-xl font-extrabold-heading mb-4">Clicks Distribution</h3>
                            <div style="height: 250px;">
                                <canvas id="recap-clicks-chart"></canvas>
                            </div>
                        </div>
                        <div class="surface-card p-4 md:p-5">
                            <h3 class="text-xl font-extrabold-heading mb-4">Social Boost Impact</h3>
                            <div style="height: 250px;">
                                <canvas id="recap-boost-chart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Full Participant List -->
                    <div class="surface-card p-6">
                        <h3 class="text-xl font-extrabold-heading mb-6 flex items-center gap-2">
                            <span>👥</span>
                            <span>All Participants</span>
                        </h3>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b border-border-color">
                                        <th class="text-left py-3 px-4 text-sm font-semibold text-secondary">Rank</th>
                                        <th class="text-left py-3 px-4 text-sm font-semibold text-secondary">Name</th>
                                        <th class="text-left py-3 px-4 text-sm font-semibold text-secondary">Department</th>
                                        <th class="text-right py-3 px-4 text-sm font-semibold text-secondary">Clicks</th>
                                        <th class="text-right py-3 px-4 text-sm font-semibold text-secondary">Points</th>
                                        ${participationDetails.some(function(p) { return p.engagementRate; }) ? '<th class="text-right py-3 px-4 text-sm font-semibold text-secondary">Engagement</th>' : ''}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${participationDetails.sort(function(a, b) { return b.clicks - a.clicks; }).map(function(p, index) {
                                        const member = appState.crew.find(function(m) { return m.email === p.email; }) || (appState.currentUser && appState.currentUser.email === p.email ? appState.currentUser : null);
                                        return `
                                        <tr class="border-b border-border-color/50">
                                            <td class="py-3 px-4">
                                                <span class="text-lg">${index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : '#' + (index + 1)}</span>
                                            </td>
                                            <td class="py-3 px-4">
                                                <div class="flex items-center gap-3">
                                                    ${getAvatarHTML(p.name, p.email || p.name.toLowerCase(), 'sm', null, member || p)}
                                                    <div>
                                                        <div class="font-semibold text-text-primary">${escapeHtml(p.name)}</div>
                                                        ${p.badges && p.badges.length > 0 ? `
                                                            <div class="flex gap-1 mt-1">
                                                                ${p.badges.slice(0, 2).map(function(b) { return '<span class="badge purple text-xs">' + escapeHtml(b) + '</span>'; }).join('')}
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="py-3 px-4 text-secondary text-sm">${escapeHtml(p.department)}</td>
                                            <td class="py-3 px-4 text-right">
                                                <span class="font-bold accent-text">${p.clicks}</span>
                                            </td>
                                            <td class="py-3 px-4 text-right">
                                                <span class="font-semibold">${p.totalPoints}</span>
                                                <div class="text-xs text-secondary">${p.participationPoints} + ${p.clickPoints}</div>
                                            </td>
                                            ${p.engagementRate ? `
                                                <td class="py-3 px-4 text-right text-sm text-secondary">${p.engagementRate}%</td>
                                            ` : ''}
                                        </tr>
                                    `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            const backBtn = document.getElementById('back-to-main');
            if (backBtn) {
                backBtn.addEventListener('click', function() { switchView('main'); });
            }
            
            // Animate numbers and progress bars
            setTimeout(function() {
                document.querySelectorAll('.count-up').forEach(function(el) { animateCountUp(el); });
                document.querySelectorAll('.progress-bar-fill').forEach(function(el) {
                    el.style.width = el.dataset.width;
                });
            }, 100);
            
            // Render charts after content is added
            setTimeout(function() {
                logger.log('Attempting to render recap charts...');
                logger.log('Chart.js available:', typeof Chart !== 'undefined');
                if (typeof Chart !== 'undefined') {
                    logger.log('Rendering recap charts now');
                    renderRecapCharts(dropId, participationDetails, totalClicks, estimatedReach);
                } else {
                    logger.error('Chart.js not loaded, retrying...');
                    // Retry after a delay
                    setTimeout(function() {
                        logger.log('Retry: Chart.js available:', typeof Chart !== 'undefined');
                        if (typeof Chart !== 'undefined') {
                            logger.log('Rendering recap charts on retry');
                            renderRecapCharts(dropId, participationDetails, totalClicks, estimatedReach);
                        } else {
                            logger.error('Chart.js still not loaded after retry');
                        }
                    }, 1000);
                }
            }, 500);
        }
        
        function renderRecapCharts(dropId, participationDetails, totalClicks, estimatedReach) {
            logger.log('renderRecapCharts called');
            if (typeof Chart === 'undefined') {
                logger.error('Chart.js library not loaded');
                return;
            }
            logger.log('Chart.js is available, proceeding...');
            
            // Destroy existing charts if any
            if (window.recapCharts) {
                Object.values(window.recapCharts).forEach(function(chart) {
                    if (chart && typeof chart.destroy === 'function') {
                        chart.destroy();
                    }
                });
            }
            window.recapCharts = {};
            
            // Clicks Distribution Chart
            const clicksCtx = document.getElementById('recap-clicks-chart');
            logger.log('Recap clicks chart canvas:', clicksCtx);
            if (clicksCtx) {
                const topPerformers = [...participationDetails]
                    .sort(function(a, b) { return b.clicks - a.clicks; })
                    .slice(0, 10);
                
                logger.log('Creating recap clicks chart...');
                try {
                    window.recapCharts.clicks = new Chart(clicksCtx, {
                        type: 'bar',
                        data: {
                            labels: topPerformers.map(function(p) { 
                            return p.name.length > 15 ? p.name.substring(0, 15) + '...' : p.name; 
                        }),
                        datasets: [{
                            label: 'Clicks',
                            data: topPerformers.map(function(p) { return p.clicks; }),
                            backgroundColor: 'rgba(190, 56, 243, 0.9)',
                            borderColor: 'rgba(190, 56, 243, 1)',
                            borderWidth: 2,
                            borderRadius: 8,
                            borderSkipped: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 1500,
                            easing: 'easeOutQuart',
                            delay: function(context) {
                                return context.dataIndex * 50;
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(21, 21, 21, 0.95)',
                                titleColor: '#FFFFFF',
                                bodyColor: '#FFFFFF',
                                borderColor: '#BE38F3',
                                borderWidth: 2,
                                padding: 12,
                                cornerRadius: 8,
                                callbacks: {
                                    label: function(context) {
                                        return 'Clicks: ' + context.parsed.y;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { 
                                    color: '#B0B0B0',
                                    font: { size: 11 },
                                    padding: 8,
                                    stepSize: 1
                                },
                                grid: { 
                                    color: 'rgba(42, 42, 42, 0.5)',
                                    lineWidth: 1
                                }
                            },
                            x: {
                                ticks: { 
                                    color: '#B0B0B0',
                                    font: { size: 11 },
                                    padding: 8,
                                    maxRotation: window.innerWidth < 640 ? 90 : 45,
                                    minRotation: window.innerWidth < 640 ? 90 : 45
                                },
                                grid: { 
                                    color: 'rgba(42, 42, 42, 0.5)',
                                    lineWidth: 1
                                }
                            }
                        },
                        onResize: function(chart, size) {
                            if (size.width < 640) {
                                chart.options.scales.x.ticks.maxRotation = 90;
                                chart.options.scales.x.ticks.minRotation = 90;
                            } else {
                                chart.options.scales.x.ticks.maxRotation = 45;
                                chart.options.scales.x.ticks.minRotation = 45;
                            }
                            chart.update('none');
                        }
                    }
                    });
                    logger.log('Recap clicks chart created successfully');
                } catch (error) {
                    logger.error('Error creating recap clicks chart:', error);
                }
            } else {
                logger.warn('Recap clicks chart canvas not found');
            }
            
            // Social Boost Impact Chart
            const boostCtx = document.getElementById('recap-boost-chart');
            logger.log('Recap boost chart canvas:', boostCtx);
            if (boostCtx) {
                const organicClicks = totalClicks;
                const socialReach = estimatedReach;
                const estimatedImpressions = Math.round(estimatedReach * 2.5);
                const boostMultiplier = organicClicks > 0 ? (socialReach / organicClicks).toFixed(1) : '0';
                
                logger.log('Creating recap boost chart...');
                try {
                    window.recapCharts.boost = new Chart(boostCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Direct Clicks', 'Social Reach', 'Impressions'],
                        datasets: [{
                            data: [organicClicks, Math.max(0, socialReach - organicClicks), Math.max(0, estimatedImpressions - socialReach)],
                            backgroundColor: [
                                'rgba(190, 56, 243, 0.9)',
                                'rgba(236, 72, 153, 0.9)',
                                'rgba(251, 146, 60, 0.9)'
                            ],
                            borderColor: '#151515',
                            borderWidth: 3,
                            hoverBorderWidth: 4,
                            hoverBorderColor: '#BE38F3'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'right',
                                labels: {
                                    color: '#FFFFFF',
                                    font: { size: 12, weight: '500' },
                                    padding: 15,
                                    usePointStyle: true,
                                    pointStyle: 'circle'
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(21, 21, 21, 0.95)',
                                titleColor: '#FFFFFF',
                                bodyColor: '#FFFFFF',
                                borderColor: '#BE38F3',
                                borderWidth: 2,
                                padding: 12,
                                cornerRadius: 8,
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed;
                                        if (label === 'Direct Clicks') {
                                            return label + ': ' + value.toLocaleString() + ' clicks';
                                        } else if (label === 'Social Reach') {
                                            return label + ': ' + value.toLocaleString() + ' people reached';
                                        } else {
                                            return label + ': ' + value.toLocaleString();
                                        }
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: boostMultiplier + 'x Social Boost',
                                color: '#BE38F3',
                                font: { size: 16, weight: 'bold', family: 'Sora, sans-serif' },
                                padding: { bottom: 15 }
                            }
                        }
                    }
                    });
                    logger.log('Recap boost chart created successfully');
                } catch (error) {
                    logger.error('Error creating recap boost chart:', error);
                }
            } else {
                logger.warn('Recap boost chart canvas not found');
            }
            
            logger.log('All recap charts rendering complete');
        }
        
        function animateCountUp(el) {
            const target = parseInt(el.dataset.target, 10);
            let current = 0;
            const duration = 1500;
            const increment = target / (duration / 16);

            function updateCount() {
                current += increment;
                if (current < target) {
                    el.textContent = Math.ceil(current).toLocaleString();
                    requestAnimationFrame(updateCount);
                } else {
                    el.textContent = target.toLocaleString();
                }
            }
            requestAnimationFrame(updateCount);
        }
        function handleSuggestCopy() {
            const button = document.getElementById('suggest-copy-button');
            const container = document.getElementById('content-options-container');
            const loader = document.getElementById('copy-suggestions-loader');
            const activeDrop = appState.drops.find(d => d.status === 'ACTIVE');
            
            if (!button || !container || !activeDrop) return;
            
            button.disabled = true;
            if (loader) loader.classList.remove('hidden');
            
            // Simulate AI generation
            setTimeout(() => {
                if (loader) loader.classList.add('hidden');
                const suggestions = [
                    { type: 'AI Generated', text: "Just launched something I'm really proud of. This is going to make a real difference for our team. Would love your thoughts!" },
                    { type: 'AI Generated', text: "The future of work just got a major upgrade. Excited to see how this transforms our workflow. Check it out!" },
                    { type: 'AI Generated', text: "After months of development, we're finally ready to share this. It's going to change everything. What do you think?" }
                ];
                
            suggestions.forEach((suggestion, index) => {
                const newOption = document.createElement('div');
                newOption.className = 'bg-bg-color p-4 rounded-lg border-2 border-dashed border-accent-primary fade-in';
                newOption.style.animationDelay = `${index * 0.1}s`;
                newOption.innerHTML = `
                    <p class="text-secondary text-sm mb-2 font-semibold">[✨ AI Suggestion ${index + 1}: ${escapeHtml(suggestion.type)}]</p>
                    <div class="flex justify-between items-start gap-4">
                        <p class="text-text-primary">${escapeHtml(suggestion.text)}</p>
                        <button class="copy-text-button bg-gray-200 text-text-primary px-3 py-1 text-sm hover:bg-gray-300 flex-shrink-0 rounded-md font-semibold" data-text="${escapeHtml(suggestion.text)}">Copy</button>
                    </div>
                `;
                container.appendChild(newOption);
            });
                
                document.querySelectorAll('.copy-text-button').forEach(btn => {
                    btn.addEventListener('click', handleCopyText);
                });
                
                button.disabled = false;
                button.innerHTML = '<span>✨</span> <span>More Suggestions</span>';
                showToast('3 new AI copy suggestions generated!', 'success');
            }, 2000);
        }
        window.handleViewPlayer = function(email) {
            if (!email) {
                logger.error('handleViewPlayer: No email provided');
                return;
            }
            
            const emailLower = email.toLowerCase();
            const member = appState.crew.find(m => m.email && m.email.toLowerCase() === emailLower) || 
                          (appState.currentUser && appState.currentUser.email && appState.currentUser.email.toLowerCase() === emailLower ? appState.currentUser : null);
            
            if (!member) {
                logger.error('handleViewPlayer: Member not found for email:', email);
                showToast('Player profile not found', 'error');
                return;
            }
            
            switchView('player', { playerName: member.name, playerEmail: email });
            
            // Ensure we scroll to top when viewing player profile
            setTimeout(function() {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }, 200);
            
            // Calculate player stats
            const allDrops = appState.drops.filter(d => d.status === 'COMPLETE' || d.status === 'ACTIVE');
            const participatedDrops = allDrops.filter(d => member.participatedDrops && member.participatedDrops.includes(d.id));
            
            // Calculate total clicks across all drops
            let totalClicks = 0;
            let totalPoints = member.totalHype || 0;
            const dropPerformance = [];
            
            participatedDrops.forEach(drop => {
                const perf = appState.performanceData[drop.id] || {};
                const clicks = perf[email.toLowerCase()] || 0;
                totalClicks += clicks;
                const participation = appState.participationData[email];
                const clickPoints = calculateClickPoints(clicks);
                const participationPoints = participation?.points || 0;
                
                dropPerformance.push({
                    drop,
                    clicks,
                    clickPoints,
                    participationPoints,
                    totalPoints: clickPoints + participationPoints
                });
            });
            
            // Calculate rank
            const allCrew = [...appState.crew, appState.currentUser].filter((v, i, a) => 
                a.findIndex(t => t.email === v.email) === i && v
            );
            const sortedCrew = allCrew
                .map(m => ({ ...m, score: m.totalHype || 0 }))
                .sort((a, b) => b.score - a.score);
            const emailLowerForRank = email.toLowerCase();
            const rank = sortedCrew.findIndex(m => m.email && m.email.toLowerCase() === emailLowerForRank) + 1;
            
            // Badge details
            const badgeDetails = {
                'creative': { name: 'Creative', emoji: '🎨', desc: 'Customized copy in multiple drops' },
                'growth-hacker': { name: 'Growth Hacker', emoji: '📈', desc: 'Generated 100+ clicks total' },
                'storyteller': { name: 'Storyteller', emoji: '📝', desc: 'Added personal stories to posts' },
                'team-player': { name: 'Team Player', emoji: '🤝', desc: 'Participated in 5+ drops' },
                'king-of-clicks': { name: 'King of Clicks', emoji: '👑', desc: 'Top click generator' },
                'first-responder': { name: 'First Responder', emoji: '⚡', desc: 'First to join a drop' }
            };
            
            if (!playerScreen) {
                logger.error('Player screen element not found');
                return;
            }
            
            playerScreen.innerHTML = `
                <div class="max-w-5xl mx-auto fade-in pb-12">
                    <!-- Header -->
                    <div class="flex items-center justify-between mb-6">
                        <button id="back-from-player" class="accent-text hover:underline text-lg font-semibold flex items-center gap-2 transition-all hover:gap-3">
                            <span>←</span> Back to Dashboard
                        </button>
                        ${appState.currentUser && appState.currentUser.email !== email ? `
                            <button onclick="showPlayerComparison('${escapeHtml(email)}')" class="bg-accent-primary text-white px-3 py-1.5 rounded-lg text-sm font-semibold hover:opacity-90 transition-all flex items-center gap-2">
                                <span>⚖️</span>
                                <span>Compare</span>
                            </button>
                        ` : ''}
                    </div>
                    
                    <!-- Player Hero -->
                    <div class="text-center mb-6 pb-4 md:pb-6 border-b border-border-color">
                        <div class="inline-block mb-4">
                            ${getAvatarHTML(member.name, member.email, '2xl', rank <= 3 ? rank : null, member)}
                        </div>
                        <h2 class="text-2xl md:text-3xl font-extrabold-heading mb-2 gradient-text">${escapeHtml(member.name)}</h2>
                        <p class="text-lg text-secondary mb-2">${escapeHtml(member.department || 'Crew Member')}</p>
                        
                        <!-- Level & Reputation Title -->
                        ${(() => {
                            const memberXPProgress = member.xpProgress || calculateXPProgress(totalPoints);
                            const memberReputationTitle = member.reputationTitle || calculateReputationTitle(member.level || calculateLevel(totalPoints), totalPoints, member.badges || []);
                            const memberReputationScore = member.reputationScore || calculateReputationScore(member, allCrew);
                            return `
                            <div class="mb-6">
                                <div class="flex items-center justify-center gap-3 mb-3">
                                    <span class="text-3xl">${memberReputationTitle.emoji}</span>
                                    <span class="text-xl font-bold" style="color: ${memberReputationTitle.color}">${memberReputationTitle.title}</span>
                                    <span class="text-xl font-bold accent-text">Level ${memberXPProgress.level}</span>
                                </div>
                                <!-- XP Progress Bar -->
                                <div class="xp-progress-bar mt-3 mb-2 max-w-md mx-auto">
                                    <div class="xp-progress-fill" style="width: ${memberXPProgress.progress}%"></div>
                                </div>
                                <div class="text-xs text-secondary text-center">
                                    ${memberXPProgress.currentXP.toLocaleString()} / ${memberXPProgress.xpNeeded.toLocaleString()} XP to Level ${memberXPProgress.level + 1}
                                </div>
                                
                                <!-- Reputation Score -->
                                <div class="mt-4 p-4 bg-bg-color rounded-lg max-w-md mx-auto">
                                    <div class="text-xs text-secondary mb-2 text-center">Reputation Score</div>
                                    <div class="reputation-meter mb-2">
                                        <div class="reputation-meter-fill" style="width: ${memberReputationScore}%"></div>
                                    </div>
                                    <div class="text-xl font-bold accent-text text-center">${memberReputationScore}/100</div>
                                </div>
                            </div>
                            `;
                        })()}
                        <div class="flex items-center justify-center gap-6">
                            <div>
                                <div class="text-2xl font-bold accent-text">#${rank}</div>
                                <div class="text-xs text-secondary uppercase">Rank</div>
                            </div>
                            <div class="w-px h-8 bg-border-color"></div>
                            <div>
                                <div class="text-2xl font-bold accent-text">${totalPoints.toLocaleString()}</div>
                                <div class="text-xs text-secondary uppercase">Total Hype</div>
                            </div>
                            <div class="w-px h-8 bg-border-color"></div>
                            <div>
                                <div class="text-2xl font-bold accent-text">${participatedDrops.length}</div>
                                <div class="text-xs text-secondary uppercase">Drops</div>
                            </div>
                        </div>
                    </div>

                    <!-- Achievement Gallery -->
                    <div class="surface-card p-4 md:p-6 mb-6">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-extrabold-heading flex items-center gap-2">
                                <span>🏆</span>
                                <span>Achievement Gallery</span>
                            </h3>
                            <div class="text-sm text-secondary">
                                ${member.badges ? member.badges.length : 0} / ${Object.keys(badgeDetails).length} Unlocked
                            </div>
                        </div>
                        ${member.badges && member.badges.length > 0 ? `
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                                ${member.badges.map(function(badge) {
                                    const achievement = ACHIEVEMENT_DEFINITIONS[badge];
                                    const detail = achievement || badgeDetails[badge] || { name: badge, emoji: '⭐', desc: 'Achievement unlocked', category: 'Special', xpReward: 0 };
                                    const categoryClass = 'category-' + (detail.category || 'special').toLowerCase();
                                    const rarity = detail.xpReward >= 1000 ? 'legendary' : (detail.xpReward >= 500 ? 'epic' : (detail.xpReward >= 200 ? 'rare' : 'common'));
                                    const rarityClass = 'achievement-rarity-' + rarity;
                                    return `
                                        <div class="achievement-card unlocked ${categoryClass} relative">
                                            <span class="achievement-rarity-badge ${rarityClass}">${rarity.toUpperCase()}</span>
                                            <div class="absolute top-2 right-2 text-green-400 text-xl z-10">✓</div>
                                            <div class="flex items-center gap-3 mb-3">
                                                <span class="text-4xl filter drop-shadow-lg">${detail.emoji}</span>
                                                <div class="flex-1">
                                                    <div class="font-bold text-lg text-text-primary">${detail.name}</div>
                                                    <div class="text-xs text-secondary uppercase mt-1">${detail.category || 'Special'}</div>
                                            </div>
                                            </div>
                                            <p class="text-sm text-secondary mb-2">${detail.desc}</p>
                                            ${detail.xpReward ? `<div class="text-xs accent-text font-semibold">+${detail.xpReward} XP</div>` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        ` : '<p class="text-secondary text-center py-8">No achievements unlocked yet. Start participating to earn badges!</p>'}
                        
                        <!-- All Available Achievements - Organized by Category -->
                        <div class="pt-6 border-t border-border-color">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-sm font-semibold text-secondary uppercase tracking-wide">All Achievements</h4>
                                <div class="text-xs text-secondary">
                                    ${member.badges ? member.badges.length : 0} / ${Object.keys(ACHIEVEMENT_DEFINITIONS).length} Unlocked
                                </div>
                            </div>
                            ${(() => {
                                // Group achievements by category
                                const byCategory = {};
                                Object.keys(ACHIEVEMENT_DEFINITIONS).forEach(function(key) {
                                    const achievement = ACHIEVEMENT_DEFINITIONS[key];
                                    const category = achievement.category || 'Special';
                                    if (!byCategory[category]) {
                                        byCategory[category] = [];
                                    }
                                    byCategory[category].push({ key, achievement });
                                });
                                
                                return Object.keys(byCategory).map(function(category) {
                                    const achievements = byCategory[category];
                                    const categoryLower = category.toLowerCase();
                                    const categoryClass = 'category-' + categoryLower;
                                    const categoryColor = categoryLower === 'participation' ? 'bg-green-500' : (categoryLower === 'performance' ? 'bg-blue-500' : (categoryLower === 'social' ? 'bg-yellow-500' : (categoryLower === 'milestone' ? 'bg-purple-500' : 'bg-yellow-400')));
                                    var categoryHtml = '<div class="mb-6">';
                                    categoryHtml += '<h5 class="text-sm font-bold mb-3 text-text-primary flex items-center gap-2">';
                                    categoryHtml += '<span class="w-1 h-6 rounded-full ' + categoryColor + '"></span>';
                                    categoryHtml += category;
                                    categoryHtml += '</h5>';
                                    categoryHtml += '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">';
                                    categoryHtml += achievements.map(function(entry) {
                                        const key = entry.key;
                                        const achievement = entry.achievement;
                                                    const isUnlocked = member.badges && member.badges.includes(key);
                                                    const rarity = achievement.xpReward >= 1000 ? 'legendary' : (achievement.xpReward >= 500 ? 'epic' : (achievement.xpReward >= 200 ? 'rare' : 'common'));
                                                    const rarityClass = 'achievement-rarity-' + rarity;
                                        var cardHtml = '<div class="achievement-card ' + (isUnlocked ? 'unlocked' : 'locked') + ' ' + categoryClass + ' relative">';
                                        if (!isUnlocked) {
                                            cardHtml += '<span class="achievement-rarity-badge ' + rarityClass + '">' + rarity.toUpperCase() + '</span>';
                                        }
                                        cardHtml += '<div class="flex items-center gap-3 mb-2">';
                                        cardHtml += '<span class="text-3xl ' + (isUnlocked ? '' : 'opacity-50') + '">' + achievement.emoji + '</span>';
                                        cardHtml += '<div class="flex-1">';
                                        cardHtml += '<div class="font-semibold text-text-primary text-sm">' + achievement.name + '</div>';
                                        cardHtml += isUnlocked ? '<span class="text-green-400 text-xs">✓ Unlocked</span>' : '<span class="text-secondary text-xs">🔒 Locked</span>';
                                        cardHtml += '</div></div>';
                                        cardHtml += '<p class="text-xs text-secondary mb-1">' + achievement.description + '</p>';
                                        if (achievement.xpReward) {
                                            cardHtml += '<div class="text-xs accent-text font-semibold">+' + achievement.xpReward + ' XP</div>';
                                        }
                                        cardHtml += '</div>';
                                        return cardHtml;
                                    }).join('');
                                    categoryHtml += '</div>';
                                    categoryHtml += '</div>';
                                    return categoryHtml;
                                }).join('')
                            })()}
                        </div>
                    </div>

                    <!-- Stats Grid -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="stat-card">
                            <div class="stat-value">${totalClicks}</div>
                            <div class="stat-label">Total Clicks</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${participatedDrops.length}</div>
                            <div class="stat-label">Drops Joined</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${participatedDrops.length > 0 ? Math.round(totalClicks / participatedDrops.length) : 0}</div>
                            <div class="stat-label">Avg Clicks</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${member.followers ? member.followers.toLocaleString() : 'N/A'}</div>
                            <div class="stat-label">Followers</div>
                        </div>
                    </div>

                    <!-- Performance History & Stats -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6 mb-6">
                        <!-- Drop Performance History -->
                        ${dropPerformance.length > 0 ? `
                            <div class="surface-card p-4 md:p-5">
                                <h3 class="text-xl font-extrabold-heading mb-6 flex items-center gap-2">
                                    <span>📊</span>
                                    <span>Performance History</span>
                                </h3>
                                <div class="space-y-4">
                                    ${dropPerformance.sort(function(a, b) { return b.clicks - a.clicks; }).map(function({drop, clicks, totalPoints: dropPoints, clickPoints, participationPoints}) {
                                        const engagementRate = member.followers ? ((clicks / member.followers) * 100).toFixed(1) : null;
                                        return `
                                            <div class="bg-bg-color p-4 rounded-lg border border-border-color hover:border-accent-primary/50 transition-all">
                                                <div class="flex justify-between items-start mb-3">
                                                    <div class="flex-1">
                                                        <div class="font-semibold text-text-primary mb-1">${escapeHtml(drop.name)}</div>
                                                        <div class="text-xs text-secondary line-clamp-2">${escapeHtml(drop.objective)}</div>
                                                    </div>
                                                    <div class="text-right ml-4">
                                                        <div class="text-2xl font-bold accent-text">${clicks}</div>
                                                        <div class="text-xs text-secondary">clicks</div>
                                                    </div>
                                                </div>
                                                <div class="grid grid-cols-2 gap-3 text-xs pt-3 border-t border-border-color">
                                                    <div>
                                                        <span class="text-secondary">Points:</span>
                                                        <span class="accent-text font-semibold ml-1">${dropPoints}</span>
                                                    </div>
                                                    ${engagementRate ? `
                                                        <div>
                                                            <span class="text-secondary">Engagement:</span>
                                                            <span class="accent-text font-semibold ml-1">${engagementRate}%</span>
                                                        </div>
                                                    ` : ''}
                                                    <div>
                                                        <span class="text-secondary">Participation:</span>
                                                        <span class="text-text-primary font-semibold ml-1">+${participationPoints}</span>
                                                    </div>
                                                    <div>
                                                        <span class="text-secondary">Click Rewards:</span>
                                                        <span class="text-text-primary font-semibold ml-1">+${clickPoints}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : `
                            <div class="surface-card p-6 text-center">
                                <p class="text-secondary">No drop participation yet. Join your first drop to get started! 🚀</p>
                            </div>
                        `}
                        
                        <!-- Reputation Dashboard -->
                        <div class="surface-card p-4 md:p-5">
                            <h3 class="text-xl font-extrabold-heading mb-6 flex items-center gap-2">
                                <span>⭐</span>
                                <span>Reputation Dashboard</span>
                            </h3>
                            ${(() => {
                                const memberXPProgress = member.xpProgress || calculateXPProgress(totalPoints);
                                const memberReputationScore = member.reputationScore || calculateReputationScore(member, allCrew);
                                
                                // Calculate consistency score
                                const avgClicksPerDrop = participatedDrops.length > 0 ? totalClicks / participatedDrops.length : 0;
                                const consistencyScore = participatedDrops.length >= 3 ? Math.min(100, (avgClicksPerDrop / 50) * 100) : 0;
                                
                                // Calculate engagement rate
                                const avgEngagement = member.followers && participatedDrops.length > 0 ? 
                                    (dropPerformance.reduce(function(sum, dp) {
                                        return sum + (dp.clicks / member.followers * 100);
                                    }, 0) / dropPerformance.length) : 0;
                                
                                return `
                                <div class="space-y-6">
                                    <!-- Reputation Breakdown -->
                                    <div class="bg-bg-color p-4 rounded-lg">
                                        <div class="flex items-center justify-between mb-3">
                                            <span class="text-sm font-semibold">Overall Reputation</span>
                                            <span class="text-lg font-bold accent-text">${memberReputationScore}/100</span>
                                        </div>
                                        <div class="reputation-meter mb-2">
                                            <div class="reputation-meter-fill" style="width: ${memberReputationScore}%"></div>
                                        </div>
                                        <div class="text-xs text-secondary">
                                            Based on level, badges, participation, and performance
                                        </div>
                                    </div>
                                    
                                    <!-- Level Progress -->
                                    <div class="bg-bg-color p-4 rounded-lg">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="text-sm font-semibold">Level Progress</span>
                                            <span class="text-lg font-bold accent-text">${memberXPProgress.level}/50</span>
                                        </div>
                                        <div class="xp-progress-bar mb-2">
                                            <div class="xp-progress-fill" style="width: ${memberXPProgress.progress}%"></div>
                                        </div>
                                        <div class="text-xs text-secondary">
                                            ${memberXPProgress.currentXP.toLocaleString()} / ${memberXPProgress.xpNeeded.toLocaleString()} XP to next level
                                        </div>
                                    </div>
                                    
                                    <!-- Performance Metrics -->
                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="bg-bg-color p-4 rounded-lg text-center">
                                            <div class="text-2xl font-bold accent-text mb-1">${avgClicksPerDrop.toFixed(1)}</div>
                                            <div class="text-xs text-secondary">Avg Clicks/Drop</div>
                                        </div>
                                        <div class="bg-bg-color p-4 rounded-lg text-center">
                                            <div class="text-2xl font-bold accent-text mb-1">${avgEngagement.toFixed(1)}%</div>
                                            <div class="text-xs text-secondary">Avg Engagement</div>
                                        </div>
                                        <div class="bg-bg-color p-4 rounded-lg text-center">
                                            <div class="text-2xl font-bold accent-text mb-1">${consistencyScore.toFixed(0)}</div>
                                            <div class="text-xs text-secondary">Consistency</div>
                                        </div>
                                        <div class="bg-bg-color p-4 rounded-lg text-center">
                                            <div class="text-2xl font-bold accent-text mb-1">${member.badges ? member.badges.length : 0}</div>
                                            <div class="text-xs text-secondary">Badges</div>
                                        </div>
                                    </div>
                                </div>
                                `;
                            })()}
                        </div>
                    </div>
                </div>
            `;
            
            // Add back button handler
            const backBtn = document.getElementById('back-from-player');
            if (backBtn) {
                backBtn.addEventListener('click', () => switchView('main'));
            }
        }

        function renderAll() {
            logger.log('renderAll called');
            try {
                // Apply persona class to main app element
                const mainApp = document.getElementById('main-app');
                if (mainApp && appState.currentUser && appState.currentUser.playerPersona) {
                    const persona = appState.currentUser.playerPersona.toLowerCase();
                    mainApp.className = mainApp.className.replace(/persona-\w+/g, '');
                    mainApp.classList.add('persona-' + persona);
                    mainApp.setAttribute('data-persona', persona);
                    logger.log('Applied persona class:', 'persona-' + persona);
                }
                
                logger.log('Rendering navigation...');
                renderNavigation();
                logger.log('Rendering auth section...');
                renderAuthSection();
                logger.log('Rendering drop...');
                renderDrop();
                logger.log('Rendering sidebar...');
                renderSidebar();
                logger.log('Rendering roster...');
                renderRoster();
                logger.log('Rendering archive...');
                renderArchive();
                logger.log('Rendering user stats...');
                renderUserStats();
                logger.log('All components rendered');
            } catch(error) {
                logger.error('Error in renderAll:', error);
                logger.error('Stack:', error.stack);
            }
        }
        
        // Make renderAll available globally for setTimeout callbacks
        window.renderAll = renderAll;

        // --- ADMIN FUNCTIONS --- //
        function renderAdminDashboard() {
            const adminScreen = document.getElementById('admin-screen');
            if (!adminScreen) return;
            
            const activeTab = appState.adminTab || 'campaigns';
            
            adminScreen.innerHTML = `
                <div class="max-w-7xl mx-auto p-6 pb-12">
                    <!-- Header -->
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h1 class="text-3xl font-extrabold-heading gradient-text mb-2">Admin Dashboard</h1>
                            <p class="text-secondary">Manage campaigns, users, and view analytics</p>
                        </div>
                        <button onclick="window.switchView('main')" class="accent-text hover:underline text-lg font-semibold flex items-center gap-2">
                            <span>←</span> Back to Dashboard
                        </button>
                    </div>

                    <!-- Tabs -->
                    <div class="flex gap-2 mb-8 border-b border-border-color">
                        <button class="admin-tab ${activeTab === 'campaigns' ? 'active' : ''}" data-tab="campaigns" onclick="switchAdminTab('campaigns')">
                            📋 Campaigns
                        </button>
                        <button class="admin-tab ${activeTab === 'users' ? 'active' : ''}" data-tab="users" onclick="switchAdminTab('users')">
                            👥 Users
                        </button>
                        <button class="admin-tab ${activeTab === 'analytics' ? 'active' : ''}" data-tab="analytics" onclick="switchAdminTab('analytics')">
                            📊 Analytics
                        </button>
                        <button class="admin-tab ${activeTab === 'settings' ? 'active' : ''}" data-tab="settings" onclick="switchAdminTab('settings')">
                            ⚙️ Settings
                        </button>
                    </div>

                    <!-- Tab Content -->
                    <div id="admin-content">
                        ${renderAdminTabContent(activeTab)}
                    </div>
                </div>
            `;
        }

        function renderAdminTabContent(tab) {
            let content = '';
            switch(tab) {
                case 'campaigns':
                    content = renderAdminCampaigns();
                    break;
                case 'users':
                    content = renderAdminUsers();
                    break;
                case 'analytics':
                    content = renderAdminAnalytics();
                    break;
                case 'settings':
                    content = renderAdminSettings();
                    break;
                default:
                    content = '';
            }
            
            return content;
        }
        function renderAdminCampaigns() {
            const activeDrop = appState.drops.find(function(d) { return d.status === 'ACTIVE'; });
            const completedDrops = appState.drops.filter(function(d) { return d.status === 'COMPLETE'; });
            
            // Calculate KPIs
            const totalCampaigns = appState.drops.length;
            const allUsers = [...appState.crew];
            if (appState.currentUser && !allUsers.find(function(u) { return u.email === appState.currentUser.email; })) {
                allUsers.push(appState.currentUser);
            }
            const activeParticipants = allUsers.filter(function(user) {
                return (user.participatedDrops || []).length > 0;
            }).length;
            
            const totalClicks = Object.values(appState.performanceData).reduce(function(sum, dropPerf) {
                return sum + Object.values(dropPerf).reduce(function(a, b) { return a + b; }, 0);
            }, 0);
            
            // Calculate average engagement rate (participations / total users)
            const totalParticipations = Object.keys(appState.participationData).length;
            const avgEngagementRate = allUsers.length > 0 ? Math.round((totalParticipations / allUsers.length) * 100) : 0;
            
            return `
                <div class="space-y-6">
                    <!-- KPI Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="surface-card p-4 md:p-5 rounded-xl border-2 border-accent-primary/20">
                            <div class="flex items-center justify-between mb-3">
                                <div class="text-xl md:text-2xl">📊</div>
                                <div class="text-xs text-secondary font-semibold uppercase tracking-wide">Total Campaigns</div>
                            </div>
                            <div class="text-2xl md:text-3xl font-extrabold-heading gradient-text mb-1">${totalCampaigns}</div>
                            <div class="text-xs text-secondary">${activeDrop ? '1 active' : '0 active'}</div>
                        </div>
                        
                        <div class="surface-card p-4 md:p-5 rounded-xl border-2 border-accent-primary/20">
                            <div class="flex items-center justify-between mb-3">
                                <div class="text-xl md:text-2xl">👥</div>
                                <div class="text-xs text-secondary font-semibold uppercase tracking-wide">Active Participants</div>
                            </div>
                            <div class="text-2xl md:text-3xl font-extrabold-heading gradient-text mb-1">${activeParticipants}</div>
                            <div class="text-xs text-secondary">of ${allUsers.length} total users</div>
                        </div>
                        
                        <div class="surface-card p-4 md:p-5 rounded-xl border-2 border-accent-primary/20">
                            <div class="flex items-center justify-between mb-3">
                                <div class="text-xl md:text-2xl">📈</div>
                                <div class="text-xs text-secondary font-semibold uppercase tracking-wide">Total Clicks</div>
                            </div>
                            <div class="text-2xl md:text-3xl font-extrabold-heading gradient-text mb-1">${totalClicks.toLocaleString()}</div>
                            <div class="text-xs text-secondary">All time</div>
                        </div>
                        
                        <div class="surface-card p-4 md:p-5 rounded-xl border-2 border-accent-primary/20">
                            <div class="flex items-center justify-between mb-3">
                                <div class="text-xl md:text-2xl">⚡</div>
                                <div class="text-xs text-secondary font-semibold uppercase tracking-wide">Engagement Rate</div>
                            </div>
                            <div class="text-2xl md:text-3xl font-extrabold-heading gradient-text mb-1">${avgEngagementRate}%</div>
                            <div class="text-xs text-secondary">Average participation</div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions Panel -->
                    <div class="surface-card p-4 md:p-5 rounded-xl">
                        <h3 class="text-lg font-extrabold-heading mb-3">Quick Actions</h3>
                        <div class="flex flex-wrap gap-3">
                            <button onclick="showCreateCampaignModal()" class="btn-primary px-4 py-2 font-bold text-sm">
                                + Create Campaign
                            </button>
                            <button onclick="switchAdminTab('users')" class="btn-secondary px-4 py-2 font-semibold text-sm">
                                + Import Users
                            </button>
                            <button onclick="switchAdminTab('analytics')" class="btn-secondary px-4 py-2 font-semibold text-sm">
                                📊 View Reports
                            </button>
                        </div>
                    </div>
                    
                    <!-- Active Campaign -->
                    ${activeDrop ? `
                        <div class="surface-card p-4 md:p-5">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-2xl font-extrabold-heading">Active Campaign</h3>
                                <div class="flex items-center gap-2">
                                    <button onclick="showEditCampaignModal('${activeDrop.id}')" class="bg-accent-primary text-white px-3 py-1.5 rounded-lg text-sm font-semibold hover:opacity-90">
                                        Edit
                                    </button>
                                    <button onclick="handleEndCampaign('${activeDrop.id}')" class="bg-red-600 text-white px-3 py-1.5 rounded-lg text-sm font-semibold hover:opacity-90">
                                        End Campaign
                                    </button>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h4 class="font-bold text-lg mb-2">${escapeHtml(activeDrop.name)}</h4>
                                    <p class="text-secondary mb-4">${escapeHtml(activeDrop.objective)}</p>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between">
                                            <span class="text-secondary">Status:</span>
                                            <span class="badge purple">ACTIVE</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-secondary">Created:</span>
                                            <span>${activeDrop.createdAt ? new Date(activeDrop.createdAt).toLocaleDateString() : 'N/A'}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-secondary">Participants:</span>
                                            <span>${Object.keys(appState.performanceData[activeDrop.id] || {}).length}</span>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h4 class="font-bold text-lg mb-2">Quick Stats</h4>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="stat-mini">
                                            <div class="text-3xl font-bold accent-text mb-1">
                                                ${Object.values(appState.performanceData[activeDrop.id] || {}).reduce(function(a, b) { return a + b; }, 0)}
                                            </div>
                                            <div class="text-xs text-secondary">Total Clicks</div>
                                        </div>
                                        <div class="stat-mini">
                                            <div class="text-3xl font-bold accent-text mb-1">
                                                ${Object.keys(appState.participationData).filter(function(email) {
                                                    const part = appState.participationData[email];
                                                    return part && part.dropId === activeDrop.id;
                                                }).length}
                                            </div>
                                            <div class="text-xs text-secondary">Joined</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div class="surface-card p-6 text-center">
                            <p class="text-secondary mb-4">No active campaign</p>
                            <button onclick="showCreateCampaignModal()" class="gradient-bg text-white px-5 py-2.5 rounded-xl text-sm font-bold hover:opacity-90">
                                Create New Campaign
                            </button>
                        </div>
                    `}

                    <!-- Create Campaign Button -->
                    <div class="flex justify-end">
                        <button onclick="showCreateCampaignModal()" class="gradient-bg text-white px-6 py-3 rounded-xl font-bold hover:opacity-90">
                            + Create New Campaign
                        </button>
                    </div>

                    <!-- Past Campaigns -->
                    ${completedDrops.length > 0 ? `
                        <div class="surface-card p-4 md:p-5">
                            <h3 class="text-2xl font-extrabold-heading mb-4">Past Campaigns</h3>
                            <div class="space-y-4">
                                ${completedDrops.map(function(drop) {
                                    const dropPerf = appState.performanceData[drop.id] || {};
                                    const totalClicks = Object.values(dropPerf).reduce(function(a, b) { return a + b; }, 0);
                                    const participants = Object.keys(dropPerf).length;
                                    return `
                                        <div class="bg-bg-color p-4 rounded-lg border border-border-color">
                                            <div class="flex items-center justify-between">
                                                <div class="flex-1">
                                                    <h4 class="font-bold text-lg">${escapeHtml(drop.name)}</h4>
                                                    <p class="text-sm text-secondary mt-1">${escapeHtml(drop.objective)}</p>
                                                    <div class="flex gap-4 mt-2 text-xs text-secondary">
                                                        <span>👥 ${participants} participants</span>
                                                        <span>📈 ${totalClicks} clicks</span>
                                                    </div>
                                                </div>
                                                <div class="flex items-center gap-2">
                                                    <button onclick="showEditCampaignModal('${drop.id}')" class="text-accent-primary hover:underline text-sm font-semibold">
                                                        Edit
                                                    </button>
                                                    <button onclick="handleViewCampaignDetails('${drop.id}')" class="text-accent-primary hover:underline text-sm font-semibold">
                                                        View Details →
                                                    </button>
                                                    <button onclick="handleDeleteCampaign('${drop.id}')" class="text-red-500 hover:underline text-sm font-semibold">
                                                        Delete
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderAdminUsers() {
            const allUsers = [...appState.crew];
            if (appState.currentUser && !allUsers.find(function(u) { return u.email === appState.currentUser.email; })) {
                allUsers.push(appState.currentUser);
            }
            
            return `
                <div class="space-y-6">
                    <div class="flex items-center justify-between">
                        <h3 class="text-2xl font-extrabold-heading">All Users (${allUsers.length})</h3>
                        <button onclick="showAddUserModal()" class="gradient-bg text-white px-5 py-2.5 rounded-xl text-sm font-bold hover:opacity-90">
                            + Add User
                        </button>
                    </div>
                    
                    <div class="surface-card p-6">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b border-border-color">
                                        <th class="text-left py-3 px-4 text-sm font-semibold text-secondary">Name</th>
                                        <th class="text-left py-3 px-4 text-sm font-semibold text-secondary">Email</th>
                                        <th class="text-left py-3 px-4 text-sm font-semibold text-secondary">Department</th>
                                        <th class="text-right py-3 px-4 text-sm font-semibold text-secondary">Total Points</th>
                                        <th class="text-right py-3 px-4 text-sm font-semibold text-secondary">Campaigns</th>
                                        <th class="text-right py-3 px-4 text-sm font-semibold text-secondary">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${allUsers.sort(function(a, b) { return (b.totalHype || 0) - (a.totalHype || 0); }).map(function(user) {
                                        return `
                                        <tr class="border-b border-border-color/50">
                                            <td class="py-3 px-4">
                                                <div class="flex items-center gap-3">
                                                    ${getAvatarHTML(user.name, user.email, 'sm', null, user)}
                                                    <span class="font-semibold">${escapeHtml(user.name)}</span>
                                                </div>
                                            </td>
                                            <td class="py-3 px-4 text-secondary text-sm">${escapeHtml(user.email)}</td>
                                            <td class="py-3 px-4 text-secondary text-sm">${escapeHtml(user.department || 'Unassigned')}</td>
                                            <td class="py-3 px-4 text-right font-bold accent-text">${(user.totalHype || 0).toLocaleString()}</td>
                                            <td class="py-3 px-4 text-right text-secondary">${(user.participatedDrops || []).length}</td>
                                            <td class="py-3 px-4 text-right">
                                                <div class="flex items-center justify-end gap-3">
                                                    <button onclick="handleEditUser('${escapeHtml(user.email)}')" class="text-accent-primary hover:underline text-sm">
                                                        Edit
                                                    </button>
                                                    ${user.email !== appState.currentUser.email ? `
                                                        <button onclick="handleDeleteUser('${escapeHtml(user.email)}')" class="text-red-500 hover:underline text-sm">
                                                            Delete
                                                        </button>
                                                    ` : ''}
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }
        function renderAdminAnalytics() {
            const allDrops = appState.drops;
            const totalClicks = Object.values(appState.performanceData).reduce(function(sum, dropPerf) {
                return sum + Object.values(dropPerf).reduce(function(a, b) { return a + b; }, 0);
            }, 0);
            const totalUsers = appState.crew.length;
            const totalParticipations = Object.keys(appState.participationData).length;
            
            // Calculate total points awarded
            let totalPointsAwarded = 0;
            Object.keys(appState.participationData).forEach(function(email) {
                const part = appState.participationData[email];
                if (part && part.points) {
                    totalPointsAwarded += part.points.total || part.points || 0;
                }
            });
            Object.values(appState.performanceData).forEach(function(dropPerf) {
                Object.values(dropPerf).forEach(function(clicks) {
                    totalPointsAwarded += calculateClickPoints(clicks);
                });
            });
            
            // Top performers
            const allUsersWithStats = appState.crew.map(function(user) {
                return {
                    ...user,
                    totalClicks: Object.values(appState.performanceData).reduce(function(sum, dropPerf) {
                        return sum + (dropPerf[user.email] || 0);
                    }, 0),
                    campaignsJoined: (user.participatedDrops || []).length
                };
            }).sort(function(a, b) {
                return (b.totalHype || 0) - (a.totalHype || 0);
            });
            
            // Engagement rate calculation
            const usersWithEngagement = allUsersWithStats.filter(function(u) {
                return u.followers > 0;
            });
            const avgEngagement = usersWithEngagement.length > 0 ? 
                usersWithEngagement.reduce(function(sum, u) {
                    const userClicks = Object.values(appState.performanceData).reduce(function(s, dp) {
                        return s + (dp[u.email] || 0);
                    }, 0);
                    return sum + (userClicks / u.followers * 100);
                }, 0) / usersWithEngagement.length : 0;
            
            return `
                <div class="space-y-6">
                    <!-- Overview Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="stat-card">
                            <div class="stat-value">${allDrops.length}</div>
                            <div class="stat-label">Total Campaigns</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${totalClicks.toLocaleString()}</div>
                            <div class="stat-label">Total Clicks</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${totalUsers}</div>
                            <div class="stat-label">Total Users</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${totalParticipations}</div>
                            <div class="stat-label">Total Participations</div>
                        </div>
                    </div>

                    <!-- Additional Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="stat-card">
                            <div class="stat-value">${Math.round(totalPointsAwarded).toLocaleString()}</div>
                            <div class="stat-label">Total Points Awarded</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${avgEngagement > 0 ? avgEngagement.toFixed(1) + '%' : 'N/A'}</div>
                            <div class="stat-label">Avg Engagement Rate</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${totalUsers > 0 ? Math.round(totalParticipations / totalUsers * 100) : 0}%</div>
                            <div class="stat-label">Participation Rate</div>
                        </div>
                    </div>

                    <!-- Campaign Performance Chart -->
                    <div class="surface-card p-6">
                        <h3 class="text-2xl font-extrabold-heading mb-4">Campaign Performance Over Time</h3>
                        <div class="mb-6" style="height: 300px;">
                            <canvas id="campaign-performance-chart"></canvas>
                        </div>
                    </div>

                    <!-- Social Boost Impact -->
                    <div class="surface-card p-6">
                        <h3 class="text-2xl font-extrabold-heading mb-4">Social Boost Impact</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div style="height: 250px;">
                                <canvas id="clicks-distribution-chart"></canvas>
                            </div>
                            <div style="height: 250px;">
                                <canvas id="engagement-chart"></canvas>
                            </div>
                        </div>
                        <div style="height: 300px;">
                            <canvas id="social-boost-impact-chart"></canvas>
                        </div>
                    </div>

                    <!-- Top Performers -->
                    <div class="surface-card p-6">
                        <h3 class="text-2xl font-extrabold-heading mb-4">Top Performers</h3>
                        <div class="space-y-3">
                            ${allUsersWithStats.slice(0, 10).map(function(user, index) {
                                return `
                                    <div class="bg-bg-color p-4 rounded-lg flex items-center justify-between">
                                        <div class="flex items-center gap-4">
                                            <span class="font-bold text-lg text-secondary w-8">#${index + 1}</span>
                                            ${getAvatarHTML(user.name, user.email, 'sm', index < 3 ? index + 1 : null, user)}
                                            <div>
                                                <div class="font-semibold text-text-primary">${escapeHtml(user.name)}</div>
                                                <div class="text-xs text-secondary">${escapeHtml(user.department || 'Unassigned')}</div>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-6 text-sm">
                                            <div class="text-center">
                                                <div class="font-bold accent-text">${(user.totalHype || 0).toLocaleString()}</div>
                                                <div class="text-xs text-secondary">Points</div>
                                            </div>
                                            <div class="text-center">
                                                <div class="font-bold">${user.totalClicks}</div>
                                                <div class="text-xs text-secondary">Clicks</div>
                                            </div>
                                            <div class="text-center">
                                                <div class="font-bold">${user.campaignsJoined}</div>
                                                <div class="text-xs text-secondary">Campaigns</div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <!-- Campaign Performance -->
                    <div class="surface-card p-6">
                        <h3 class="text-2xl font-extrabold-heading mb-4">Campaign Performance</h3>
                        <div class="space-y-4">
                            ${allDrops.map(function(drop) {
                                const dropPerf = appState.performanceData[drop.id] || {};
                                const clicks = Object.values(dropPerf).reduce(function(a, b) { return a + b; }, 0);
                                const participants = Object.keys(dropPerf).length;
                                const avgClicks = participants > 0 ? Math.round(clicks / participants) : 0;
                                
                                // Calculate points for this campaign
                                let campaignPoints = 0;
                                Object.keys(appState.participationData).forEach(function(email) {
                                    const part = appState.participationData[email];
                                    if (part && part.dropId === drop.id) {
                                        campaignPoints += part.points ? (part.points.total || part.points) : 0;
                                    }
                                });
                                Object.values(dropPerf).forEach(function(c) {
                                    campaignPoints += calculateClickPoints(c);
                                });
                                
                                return `
                                    <div class="bg-bg-color p-4 rounded-lg">
                                        <div class="flex items-center justify-between mb-3">
                                            <h4 class="font-bold text-lg">${escapeHtml(drop.name)}</h4>
                                            <span class="badge ${drop.status === 'ACTIVE' ? 'purple' : 'gray'}">${drop.status}</span>
                                        </div>
                                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                            <div>
                                                <span class="text-secondary">Clicks:</span>
                                                <span class="font-bold accent-text ml-2">${clicks}</span>
                                            </div>
                                            <div>
                                                <span class="text-secondary">Participants:</span>
                                                <span class="font-bold ml-2">${participants}</span>
                                            </div>
                                            <div>
                                                <span class="text-secondary">Avg Clicks:</span>
                                                <span class="font-bold ml-2">${avgClicks}</span>
                                            </div>
                                            <div>
                                                <span class="text-secondary">Points Awarded:</span>
                                                <span class="font-bold accent-text ml-2">${Math.round(campaignPoints).toLocaleString()}</span>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            // Render charts after content is added
            setTimeout(function() {
                logger.log('Attempting to render admin charts...');
                logger.log('Chart.js available:', typeof Chart !== 'undefined');
                if (typeof Chart !== 'undefined') {
                    logger.log('Rendering admin charts now');
                    renderAdminCharts();
                } else {
                    logger.error('Chart.js not loaded, retrying...');
                    // Retry after a delay
                    setTimeout(function() {
                        logger.log('Retry: Chart.js available:', typeof Chart !== 'undefined');
                        if (typeof Chart !== 'undefined') {
                            logger.log('Rendering admin charts on retry');
                            renderAdminCharts();
                        } else {
                            logger.error('Chart.js still not loaded after retry');
                        }
                    }, 1000);
                }
            }, 500);
        }
        function renderAdminCharts() {
            logger.log('renderAdminCharts called');
            if (typeof Chart === 'undefined') {
                logger.error('Chart.js library not loaded');
                return;
            }
            logger.log('Chart.js is available, proceeding...');
            
            // Destroy existing charts if any
            if (window.adminCharts) {
                Object.values(window.adminCharts).forEach(function(chart) {
                    if (chart && typeof chart.destroy === 'function') {
                        chart.destroy();
                    }
                });
            }
            window.adminCharts = {};
            
            // Campaign Performance Chart
            const campaignCtx = document.getElementById('campaign-performance-chart');
            logger.log('Campaign performance chart canvas:', campaignCtx);
            if (campaignCtx) {
                const allDrops = appState.drops;
                const chartData = {
                    labels: allDrops.map(function(d) { return d.name; }),
                    datasets: [{
                        label: 'Total Clicks',
                        data: allDrops.map(function(d) {
                            const dropPerf = appState.performanceData[d.id] || {};
                            return Object.values(dropPerf).reduce(function(a, b) { return a + b; }, 0);
                        }),
                        backgroundColor: 'rgba(190, 56, 243, 0.2)',
                        borderColor: 'rgba(190, 56, 243, 1)',
                        borderWidth: 2,
                        tension: 0.4
                    }, {
                        label: 'Participants',
                        data: allDrops.map(function(d) {
                            const dropPerf = appState.performanceData[d.id] || {};
                            return Object.keys(dropPerf).length;
                        }),
                        backgroundColor: 'rgba(236, 72, 153, 0.2)',
                        borderColor: 'rgba(236, 72, 153, 1)',
                        borderWidth: 2,
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                };
                
                logger.log('Creating campaign performance chart...');
                try {
                    // Enhanced Chart.js options with animations
                    const chartOptions = {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 2000,
                            easing: 'easeOutQuart'
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            tooltip: {
                                enabled: true,
                                backgroundColor: 'rgba(10, 10, 10, 0.9)',
                                padding: 12,
                                titleFont: { size: 14, weight: 'bold' },
                                bodyFont: { size: 13 },
                                borderColor: 'rgba(190, 56, 243, 0.5)',
                                borderWidth: 1,
                                cornerRadius: 8
                            },
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    padding: 15,
                                    font: { size: 12 }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    font: { size: 11 }
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                beginAtZero: true,
                                ticks: {
                                    font: { size: 11 }
                                },
                                grid: {
                                    drawOnChartArea: false
                                }
                            },
                            x: {
                                ticks: {
                                    font: { size: 11 },
                                    maxRotation: 45,
                                    minRotation: 45
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            }
                        },
                        // Mobile optimizations
                        onResize: function(chart, size) {
                            if (size.width < 640) {
                                chart.options.plugins.legend.position = 'bottom';
                                chart.options.scales.x.ticks.maxRotation = 90;
                                chart.options.scales.x.ticks.minRotation = 90;
                            } else {
                                chart.options.plugins.legend.position = 'top';
                                chart.options.scales.x.ticks.maxRotation = 45;
                                chart.options.scales.x.ticks.minRotation = 45;
                            }
                            chart.update('none');
                        }
                    };
                    window.adminCharts.campaignPerformance = new Chart(campaignCtx, {
                        type: 'line',
                        data: chartData,
                        options: chartOptions
                    });
                    logger.log('Campaign performance chart created successfully');
                } catch (error) {
                    logger.error('Error creating campaign performance chart:', error);
                }
            } else {
                logger.warn('Campaign performance chart canvas not found');
            }
            
            // Clicks Distribution Chart
            const clicksCtx = document.getElementById('clicks-distribution-chart');
            logger.log('Clicks distribution chart canvas:', clicksCtx);
            if (clicksCtx) {
                const allDrops = appState.drops;
                const clicksData = allDrops.map(function(d) {
                    const dropPerf = appState.performanceData[d.id] || {};
                    return Object.values(dropPerf).reduce(function(a, b) { return a + b; }, 0);
                });
                
                logger.log('Creating clicks distribution chart...');
                try {
                    window.adminCharts.clicksDistribution = new Chart(clicksCtx, {
                        type: 'bar',
                        data: {
                            labels: allDrops.map(function(d) { return d.name.length > 20 ? d.name.substring(0, 20) + '...' : d.name; }),
                        datasets: [{
                            label: 'Total Clicks',
                            data: clicksData,
                            backgroundColor: allDrops.map(function(d) {
                                return d.status === 'ACTIVE' 
                                    ? 'rgba(190, 56, 243, 0.9)' 
                                    : 'rgba(190, 56, 243, 0.5)';
                            }),
                            borderColor: allDrops.map(function(d) {
                                return d.status === 'ACTIVE' 
                                    ? 'rgba(190, 56, 243, 1)' 
                                    : 'rgba(190, 56, 243, 0.7)';
                            }),
                            borderWidth: 2,
                            borderRadius: 8,
                            borderSkipped: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(21, 21, 21, 0.95)',
                                titleColor: '#FFFFFF',
                                bodyColor: '#FFFFFF',
                                borderColor: '#BE38F3',
                                borderWidth: 2,
                                padding: 12,
                                cornerRadius: 8,
                                callbacks: {
                                    label: function(context) {
                                        return 'Clicks: ' + context.parsed.y.toLocaleString();
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { 
                                    color: '#B0B0B0',
                                    font: { size: 11 },
                                    padding: 8,
                                    callback: function(value) { return value.toLocaleString(); }
                                },
                                grid: { 
                                    color: 'rgba(42, 42, 42, 0.5)',
                                    lineWidth: 1
                                }
                            },
                            x: {
                                ticks: { 
                                    color: '#B0B0B0',
                                    font: { size: 11 },
                                    padding: 8,
                                    maxRotation: 45,
                                    minRotation: 45
                                },
                                grid: { 
                                    color: 'rgba(42, 42, 42, 0.5)',
                                    lineWidth: 1
                                }
                            }
                        }
                    }
                    });
                    logger.log('Clicks distribution chart created successfully');
                } catch (error) {
                    logger.error('Error creating clicks distribution chart:', error);
                }
            } else {
                logger.warn('Clicks distribution chart canvas not found');
            }
            
            // Engagement Chart
            const engagementCtx = document.getElementById('engagement-chart');
            logger.log('Engagement chart canvas:', engagementCtx);
            if (engagementCtx) {
                const allUsersWithEngagement = appState.crew.filter(function(u) {
                    return u.followers > 0;
                }).map(function(user) {
                    const userClicks = Object.values(appState.performanceData).reduce(function(sum, dropPerf) {
                        return sum + (dropPerf[user.email] || 0);
                    }, 0);
                    return {
                        name: user.name,
                        engagement: user.followers > 0 ? (userClicks / user.followers * 100) : 0
                    };
                }).sort(function(a, b) {
                    return b.engagement - a.engagement;
                }).slice(0, 10);
                
                logger.log('Creating engagement chart...');
                try {
                    window.adminCharts.engagement = new Chart(engagementCtx, {
                        type: 'doughnut',
                    data: {
                        labels: allUsersWithEngagement.map(function(u) { 
                            return u.name.length > 15 ? u.name.substring(0, 15) + '...' : u.name; 
                        }),
                        datasets: [{
                            data: allUsersWithEngagement.map(function(u) { return u.engagement; }),
                            backgroundColor: [
                                'rgba(190, 56, 243, 0.9)',
                                'rgba(236, 72, 153, 0.9)',
                                'rgba(251, 146, 60, 0.9)',
                                'rgba(34, 197, 94, 0.9)',
                                'rgba(59, 130, 246, 0.9)',
                                'rgba(168, 85, 247, 0.9)',
                                'rgba(239, 68, 68, 0.9)',
                                'rgba(245, 158, 11, 0.9)',
                                'rgba(14, 165, 233, 0.9)',
                                'rgba(139, 92, 246, 0.9)'
                            ],
                            borderColor: '#151515',
                            borderWidth: 3,
                            hoverBorderWidth: 4,
                            hoverBorderColor: '#BE38F3'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'right',
                                labels: {
                                    color: '#FFFFFF',
                                    font: { size: 12, weight: '500' },
                                    padding: 15,
                                    usePointStyle: true,
                                    pointStyle: 'circle'
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(21, 21, 21, 0.95)',
                                titleColor: '#FFFFFF',
                                bodyColor: '#FFFFFF',
                                borderColor: '#BE38F3',
                                borderWidth: 2,
                                padding: 12,
                                cornerRadius: 8,
                                callbacks: {
                                    label: function(context) {
                                        return context.label + ': ' + context.parsed.toFixed(1) + '% engagement';
                                    }
                                }
                            }
                        }
                    }
                    });
                    logger.log('Engagement chart created successfully');
                } catch (error) {
                    logger.error('Error creating engagement chart:', error);
                }
            } else {
                logger.warn('Engagement chart canvas not found');
            }
            
            // Social Boost Impact Chart
            const boostCtx = document.getElementById('social-boost-impact-chart');
            logger.log('Social boost impact chart canvas:', boostCtx);
            if (boostCtx) {
                const allDrops = appState.drops;
                const boostData = allDrops.map(function(drop) {
                    const dropPerf = appState.performanceData[drop.id] || {};
                    const clicks = Object.values(dropPerf).reduce(function(a, b) { return a + b; }, 0);
                    const participants = Object.keys(dropPerf).length;
                    
                    // Calculate social boost metrics
                    const estimatedReach = Math.round(clicks * 125); // Average social multiplier
                    const estimatedImpressions = Math.round(estimatedReach * 2.5);
                    const boostMultiplier = clicks > 0 ? (estimatedReach / clicks).toFixed(1) : 0;
                    
                    return {
                        name: drop.name,
                        clicks: clicks,
                        participants: participants,
                        estimatedReach: estimatedReach,
                        estimatedImpressions: estimatedImpressions,
                        boostMultiplier: boostMultiplier
                    };
                });
                
                logger.log('Creating social boost impact chart...');
                try {
                    window.adminCharts.socialBoost = new Chart(boostCtx, {
                        type: 'bar',
                        data: {
                            labels: boostData.map(function(d) { 
                            return d.name.length > 15 ? d.name.substring(0, 15) + '...' : d.name; 
                        }),
                        datasets: [{
                            label: 'Direct Clicks',
                            data: boostData.map(function(d) { return d.clicks; }),
                            backgroundColor: 'rgba(190, 56, 243, 0.8)',
                            borderColor: 'rgba(190, 56, 243, 1)',
                            borderWidth: 2,
                            borderRadius: 6,
                            borderSkipped: false
                        }, {
                            label: 'Estimated Reach',
                            data: boostData.map(function(d) { return d.estimatedReach; }),
                            backgroundColor: 'rgba(236, 72, 153, 0.8)',
                            borderColor: 'rgba(236, 72, 153, 1)',
                            borderWidth: 2,
                            borderRadius: 6,
                            borderSkipped: false
                        }, {
                            label: 'Estimated Impressions',
                            data: boostData.map(function(d) { return d.estimatedImpressions; }),
                            backgroundColor: 'rgba(251, 146, 60, 0.8)',
                            borderColor: 'rgba(251, 146, 60, 1)',
                            borderWidth: 2,
                            borderRadius: 6,
                            borderSkipped: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    color: '#FFFFFF',
                                    font: { size: 13, weight: '600' },
                                    padding: 15,
                                    usePointStyle: true,
                                    pointStyle: 'circle'
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(21, 21, 21, 0.95)',
                                titleColor: '#FFFFFF',
                                bodyColor: '#FFFFFF',
                                borderColor: '#BE38F3',
                                borderWidth: 2,
                                padding: 12,
                                cornerRadius: 8,
                                callbacks: {
                                    label: function(context) {
                                        const label = context.dataset.label || '';
                                        const value = context.parsed.y;
                                        const dropIndex = context.dataIndex;
                                        const drop = boostData[dropIndex];
                                        
                                        if (label === 'Direct Clicks') {
                                            return label + ': ' + value.toLocaleString() + ' clicks';
                                        } else if (label === 'Estimated Reach') {
                                            return label + ': ' + value.toLocaleString() + ' people (≈' + drop.boostMultiplier + 'x multiplier)';
                                        } else {
                                            return label + ': ' + value.toLocaleString();
                                        }
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { 
                                    color: '#B0B0B0',
                                    font: { size: 11 },
                                    padding: 8,
                                    callback: function(value) { return value.toLocaleString(); }
                                },
                                grid: { 
                                    color: 'rgba(42, 42, 42, 0.5)',
                                    lineWidth: 1
                                }
                            },
                            x: {
                                ticks: { 
                                    color: '#B0B0B0',
                                    font: { size: 11 },
                                    padding: 8,
                                    maxRotation: 45,
                                    minRotation: 45
                                },
                                grid: { 
                                    color: 'rgba(42, 42, 42, 0.5)',
                                    lineWidth: 1
                                }
                            }
                        }
                    }
                    });
                    logger.log('Social boost impact chart created successfully');
                } catch (error) {
                    logger.error('Error creating social boost impact chart:', error);
                }
            } else {
                logger.warn('Social boost impact chart canvas not found');
            }
            
            logger.log('All admin charts rendering complete');
        }

        function renderAdminSettings() {
            const settings = appState.settings || {
                platformName: 'AmpUp',
                defaultPoints: 100,
                urlShortenerDomain: 'amp.yourdomain.com',
                clickPointsTier1: 15,
                clickPointsTier2: 10,
                clickPointsTier3: 8
            };
            
            return `
                <div class="space-y-6">
                    <div class="surface-card p-6">
                        <h3 class="text-2xl font-extrabold-heading mb-4">Platform Settings</h3>
                        <form onsubmit="handleSaveSettings(event)">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Platform Name</label>
                                    <input type="text" id="setting-platform-name" value="${escapeHtml(settings.platformName)}" class="p-3 w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Default Points for Participation</label>
                                    <input type="number" id="setting-default-points" value="${settings.defaultPoints}" min="0" class="p-3 w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">URL Shortener Domain</label>
                                    <input type="text" id="setting-url-domain" value="${escapeHtml(settings.urlShortenerDomain)}" class="p-3 w-full" placeholder="amp.yourdomain.com">
                                </div>
                                <div class="pt-4 border-t border-border-color">
                                    <h4 class="font-bold text-lg mb-4">Click Points Configuration</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-semibold mb-2">Tier 1 (1-10 clicks)</label>
                                            <input type="number" id="setting-tier1-points" value="${settings.clickPointsTier1}" min="0" class="p-3 w-full">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold mb-2">Tier 2 (11-50 clicks)</label>
                                            <input type="number" id="setting-tier2-points" value="${settings.clickPointsTier2}" min="0" class="p-3 w-full">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold mb-2">Tier 3 (51+ clicks)</label>
                                            <input type="number" id="setting-tier3-points" value="${settings.clickPointsTier3}" min="0" class="p-3 w-full">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end mt-6">
                                <button type="submit" class="gradient-bg text-white px-5 py-2.5 rounded-xl text-sm font-bold hover:opacity-90">
                                    Save Settings
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="surface-card p-6">
                        <h3 class="text-2xl font-extrabold-heading mb-4">Bonus Points Configuration</h3>
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between items-center p-3 bg-bg-color rounded-lg">
                                <span class="text-secondary">Customize Copy</span>
                                <span class="font-bold accent-text">+${POINTS.CUSTOMIZE_COPY} points</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-bg-color rounded-lg">
                                <span class="text-secondary">Original Copy</span>
                                <span class="font-bold accent-text">+${POINTS.ORIGINAL_COPY} points</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-bg-color rounded-lg">
                                <span class="text-secondary">Add Personal Story</span>
                                <span class="font-bold accent-text">+${POINTS.ADD_STORY} points</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-bg-color rounded-lg">
                                <span class="text-secondary">Include Call-to-Action</span>
                                <span class="font-bold accent-text">+${POINTS.ADD_CTA} points</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-bg-color rounded-lg">
                                <span class="text-secondary">Cross-Platform Sharing</span>
                                <span class="font-bold accent-text">+${POINTS.CROSS_PLATFORM} points</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-bg-color rounded-lg">
                                <span class="text-secondary">First Participant Bonus</span>
                                <span class="font-bold accent-text">+${POINTS.FIRST_PARTICIPANT} points</span>
                            </div>
                        </div>
                        <p class="text-xs text-secondary mt-4">Bonus points are configured in code and will be editable in the full version</p>
                    </div>
                </div>
            `;
        }

        window.handleSaveSettings = function(event) {
            event.preventDefault();
            
            if (!appState.settings) {
                appState.settings = {};
            }
            
            appState.settings.platformName = document.getElementById('setting-platform-name').value.trim();
            appState.settings.defaultPoints = parseInt(document.getElementById('setting-default-points').value) || 100;
            appState.settings.urlShortenerDomain = document.getElementById('setting-url-domain').value.trim();
            appState.settings.clickPointsTier1 = parseInt(document.getElementById('setting-tier1-points').value) || 15;
            appState.settings.clickPointsTier2 = parseInt(document.getElementById('setting-tier2-points').value) || 10;
            appState.settings.clickPointsTier3 = parseInt(document.getElementById('setting-tier3-points').value) || 8;
            
            // Update CLICK_POINTS if needed
            CLICK_POINTS.TIER_1.points = appState.settings.clickPointsTier1;
            CLICK_POINTS.TIER_2.points = appState.settings.clickPointsTier2;
            CLICK_POINTS.TIER_3.points = appState.settings.clickPointsTier3;
            
            showToast('Settings saved successfully', 'success');
            renderAdminDashboard();
        };
        // Admin Tab Switching
        window.switchAdminTab = function(tab) {
            logger.log('Switching to admin tab:', tab);
            appState.adminTab = tab;
            const content = document.getElementById('admin-content');
            if (content) {
                content.innerHTML = renderAdminTabContent(tab);
            }
            // Update tab buttons
            document.querySelectorAll('.admin-tab').forEach(function(btn) {
                btn.classList.remove('active');
                if (btn.dataset.tab === tab) {
                    btn.classList.add('active');
                }
            });
            
            // If switching to analytics, render charts after DOM update
            if (tab === 'analytics') {
                setTimeout(function() {
                    logger.log('Analytics tab active, checking Chart.js and rendering charts...');
                    logger.log('Chart.js available:', typeof Chart !== 'undefined');
                    if (typeof Chart !== 'undefined') {
                        logger.log('Rendering admin charts...');
                        renderAdminCharts();
                    } else {
                        logger.error('Chart.js not available, retrying in 500ms...');
                        // Retry after delay
                        setTimeout(function() {
                            logger.log('Retry: Chart.js available:', typeof Chart !== 'undefined');
                            if (typeof Chart !== 'undefined') {
                                logger.log('Rendering admin charts on retry...');
                                renderAdminCharts();
                            } else {
                                logger.error('Chart.js still not available after retry');
                            }
                        }, 500);
                    }
                }, 300);
            }
        };
        // Admin Actions
        window.showCreateCampaignModal = function() {
            appState.editingCampaignId = null;
            const modal = document.getElementById('campaign-modal');
            const title = document.getElementById('campaign-modal-title');
            const form = document.getElementById('campaign-form');
            
            if (title) title.textContent = 'Create New Campaign';
            if (form) form.reset();
            
            // Clear form fields
            document.getElementById('campaign-source-url').value = '';
            document.getElementById('campaign-name').value = '';
            document.getElementById('campaign-objective').value = '';
            document.getElementById('campaign-post-link').value = '';
            document.getElementById('campaign-hero-image').value = '';
            document.getElementById('campaign-points').value = '100';
            document.getElementById('campaign-instructions').value = '';
            document.getElementById('campaign-content-options').value = '';
            
            // Clear fetch status
            const statusEl = document.getElementById('fetch-url-status');
            if (statusEl) {
                statusEl.classList.add('hidden');
                statusEl.textContent = '';
                statusEl.className = 'mt-2 text-sm hidden';
            }
            
            // Reset to step 1 and hide steps 2-4
            goToCampaignStep(1);
            
            // Hide steps 2, 3, and 4 by default
            setTimeout(function() {
                const step2 = document.getElementById('campaign-step-2');
                const step3 = document.getElementById('campaign-step-3');
                const step4 = document.getElementById('campaign-step-4');
                if (step2) step2.style.display = 'none';
                if (step3) step3.style.display = 'none';
                if (step4) step4.style.display = 'none';
            }, 100);
            
            if (modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        };
        // Fetch webpage metadata and pre-populate form
        window.fetchWebpageMetadata = async function() {
            const urlInput = document.getElementById('campaign-source-url');
            const fetchBtn = document.getElementById('fetch-url-btn');
            const fetchBtnText = document.getElementById('fetch-url-btn-text');
            const statusEl = document.getElementById('fetch-url-status');
            
            if (!urlInput || !urlInput.value.trim()) {
                showToast('Please enter a URL', 'warning');
                return;
            }
            
            const url = urlInput.value.trim();
            
            // Validate URL
            try {
                new URL(url);
            } catch(e) {
                showToast('Please enter a valid URL', 'error');
                return;
            }
            
            // Show loading state
            if (fetchBtn) {
                fetchBtn.disabled = true;
                if (fetchBtnText) fetchBtnText.innerHTML = '<span class="spinner" style="display: inline-block; width: 16px; height: 16px; margin-right: 4px;"></span> Fetching...';
            }
            
            if (statusEl) {
                statusEl.classList.remove('hidden');
                statusEl.textContent = 'Fetching webpage metadata...';
                statusEl.className = 'mt-2 text-sm text-info';
            }
            
            try {
                // Use a CORS proxy for fetching (for prototype - in production, use server-side)
                // Using a public CORS proxy service
                const proxyUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent(url);
                
                const response = await fetch(proxyUrl);
                if (!response.ok) {
                    throw new Error('Failed to fetch webpage: ' + response.status);
                }
                
                const data = await response.json();
                
                // Check if the proxy returned an error
                if (data.status && data.status.http_code !== 200) {
                    throw new Error('Proxy returned error: ' + (data.status.message || 'Unknown error'));
                }
                
                const htmlContent = data.contents;
                
                if (!htmlContent) {
                    throw new Error('No content received from webpage');
                }
                
                // Parse HTML to extract metadata
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlContent, 'text/html');
                
                // Check for parsing errors
                const parserError = doc.querySelector('parsererror');
                if (parserError) {
                    console.warn('HTML parsing warning, but continuing...');
                }
                
                // Extract title
                const title = doc.querySelector('title')?.textContent || 
                            doc.querySelector('meta[property="og:title"]')?.getAttribute('content') ||
                            doc.querySelector('h1')?.textContent ||
                            '';
                
                // Extract description
                const description = doc.querySelector('meta[property="og:description"]')?.getAttribute('content') ||
                                  doc.querySelector('meta[name="description"]')?.getAttribute('content') ||
                                  doc.querySelector('meta[name="twitter:description"]')?.getAttribute('content') ||
                                  '';
                
                // Extract main image
                let imageUrl = doc.querySelector('meta[property="og:image"]')?.getAttribute('content') ||
                             doc.querySelector('meta[name="twitter:image"]')?.getAttribute('content') ||
                             doc.querySelector('meta[name="twitter:image:src"]')?.getAttribute('content') ||
                             '';
                
                // If no OG image, try to find the first large image
                if (!imageUrl) {
                    const images = doc.querySelectorAll('img');
                    for (let img of images) {
                        const src = img.getAttribute('src') || img.getAttribute('data-src');
                        if (src) {
                            // Check if it's a reasonable size (not an icon)
                            const width = parseInt(img.getAttribute('width')) || 0;
                            const height = parseInt(img.getAttribute('height')) || 0;
                            if (width > 200 || height > 200 || (!width && !height)) {
                                // Make absolute URL if relative
                                imageUrl = src.startsWith('http') ? src : new URL(src, url).href;
                                break;
                            }
                        }
                    }
                }
                
                // Make image URL absolute if relative
                if (imageUrl && !imageUrl.startsWith('http')) {
                    imageUrl = new URL(imageUrl, url).href;
                }
                
                // Extract first paragraph for content options
                const firstParagraph = doc.querySelector('article p, .content p, main p, [role="main"] p')?.textContent?.trim() ||
                                     doc.querySelector('p')?.textContent?.trim() ||
                                     '';
                
                // Track what we found
                let foundItems = [];
                let populatedFields = false;
                
                try {
                    // Pre-populate form fields
                    const nameField = document.getElementById('campaign-name');
                    const objectiveField = document.getElementById('campaign-objective');
                    const postLinkField = document.getElementById('campaign-post-link');
                    const heroImageField = document.getElementById('campaign-hero-image');
                    const contentOptionsField = document.getElementById('campaign-content-options');
                    
                    if (title && nameField) {
                        nameField.value = title;
                        foundItems.push('title');
                        populatedFields = true;
                    }
                    
                    if (description && objectiveField) {
                        objectiveField.value = description;
                        foundItems.push('description');
                        populatedFields = true;
                    } else if (firstParagraph && objectiveField) {
                        // Use first paragraph if no description
                        objectiveField.value = firstParagraph.substring(0, 300);
                        foundItems.push('paragraph');
                        populatedFields = true;
                    }
                    
                    if (postLinkField) {
                        postLinkField.value = url;
                        foundItems.push('URL');
                        populatedFields = true;
                    }
                    
                    if (imageUrl && heroImageField) {
                        heroImageField.value = imageUrl;
                        foundItems.push('image');
                        populatedFields = true;
                    }
                    
                    // Generate content options from description/paragraph
                    if ((description || firstParagraph) && contentOptionsField) {
                        const contentText = description || firstParagraph;
                        const contentOptions = [
                            contentText.substring(0, 200),
                            'Check out this: ' + contentText.substring(0, 150),
                            'Excited to share: ' + contentText.substring(0, 150)
                        ].filter(opt => opt.trim());
                        
                        if (contentOptions.length > 0) {
                            contentOptionsField.value = contentOptions.join('\n');
                            foundItems.push('content options');
                            populatedFields = true;
                        }
                    }
                } catch(fieldError) {
                    console.warn('Error populating fields, but continuing:', fieldError);
                }
                
                // Show success if we populated at least one field
                if (populatedFields) {
                    const foundText = foundItems.length > 0 ? 'Found: ' + foundItems.join(', ') : 'Metadata extracted';
                    if (statusEl) {
                        statusEl.textContent = '✓ Successfully imported metadata from webpage. ' + foundText;
                        statusEl.className = 'mt-2 text-sm text-success';
                    }
                    
                    // Use setTimeout to avoid DOM manipulation conflicts
                    setTimeout(function() {
                        try {
                            showToast('Webpage metadata imported successfully! ' + foundText, 'success');
                        } catch(toastError) {
                            console.warn('Toast error (non-critical):', toastError);
                        }
                    }, 100);
                    
                    // Generate AI assistance and auto-advance to step 2
                    if (description || firstParagraph) {
                        await generateAIAssistance(title, description || firstParagraph, firstParagraph);
                    } else {
                        // If no description, still advance to step 2
                        setTimeout(function() {
                            goToCampaignStep(2);
                        }, 500);
                    }
                } else {
                    // No fields were populated, but fetch succeeded
                    if (statusEl) {
                        statusEl.textContent = '⚠ Fetched webpage but no metadata found. Please fill the form manually.';
                        statusEl.className = 'mt-2 text-sm text-warning';
                    }
                    
                    setTimeout(function() {
                        try {
                            showToast('Webpage fetched but no metadata found. Please fill the form manually.', 'warning');
                        } catch(toastError) {
                            console.warn('Toast error (non-critical):', toastError);
                        }
                    }, 100);
                }
                
            } catch(error) {
                console.error('Error fetching webpage:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    url: url
                });
                
                const errorMessage = error.message || 'Unknown error occurred';
                
                if (statusEl) {
                    statusEl.textContent = '✗ Failed to fetch webpage: ' + errorMessage + '. You can still fill the form manually.';
                    statusEl.className = 'mt-2 text-sm text-error';
                }
                
                // Use setTimeout to avoid DOM manipulation conflicts
                setTimeout(function() {
                    try {
                        showToast('Failed to fetch webpage: ' + errorMessage + '. Please fill the form manually or try a different URL.', 'error');
                    } catch(toastError) {
                        console.warn('Toast error (non-critical):', toastError);
                    }
                }, 100);
            } finally {
                // Reset button state
                if (fetchBtn) {
                    fetchBtn.disabled = false;
                    if (fetchBtnText) fetchBtnText.textContent = '🔍 Fetch';
                }
            }
        };

        // Generate AI assistance for campaign creation
        async function generateAIAssistance(title, description, firstParagraph) {
            try {
                const instructionsField = document.getElementById('campaign-instructions');
                const contentOptionsField = document.getElementById('campaign-content-options');
                
                if (!instructionsField || !contentOptionsField) {
                    logger.warn('Campaign form fields not found for AI assistance');
                    return;
                }
                
                // Show loading state
                const statusEl = document.getElementById('fetch-url-status');
                if (statusEl) {
                    statusEl.textContent = '🤖 Generating AI campaign suggestions...';
                    statusEl.className = 'mt-2 text-sm text-info';
                }
                
                // Use Gemini API to generate campaign instructions and content options
                // For now, we'll use a simplified approach that generates based on the description
                // In production, this would call the Gemini API
                
                // Generate campaign instructions
                const instructions = [
                    "1. Review this AI-drafted post and add your personal touch",
                    "2. Choose one of the content options below or write your own",
                    "3. Download the visual asset and add it to your post",
                    "4. Get your unique tracking link and share on LinkedIn or Twitter",
                    "5. Watch your points and spins grow as clicks come in!"
                ];
                
                // Generate content options from description
                const contentText = description || firstParagraph || '';
                const contentOptions = [];
                
                if (contentText) {
                    // Create variations of the content
                    const truncated = contentText.substring(0, 150);
                    contentOptions.push(
                        `Just launched: ${truncated}... Check it out!`,
                        `Excited to share: ${truncated}... What do you think?`,
                        `This is a game-changer: ${truncated}... Can't wait to see the impact!`
                    );
                } else {
                    // Fallback options
                    contentOptions.push(
                        "Just launched something I'm really proud of. This is going to make a real difference for our team. Would love your thoughts!",
                        "The future of work just got a major upgrade. Excited to see how this transforms our workflow. Check it out!",
                        "After months of development, we're finally ready to share this. It's going to change everything. What do you think?"
                    );
                }
                
                // Pre-populate form fields
                instructionsField.value = instructions.join('\n');
                contentOptionsField.value = contentOptions.join('\n');
                
                // Update status
                if (statusEl) {
                    statusEl.textContent = '✓ AI campaign suggestions generated!';
                    statusEl.className = 'mt-2 text-sm text-success';
                }
                
                showToast('AI campaign suggestions generated!', 'success');
                
                // Auto-advance to step 2 (Review & Edit)
                setTimeout(function() {
                    goToCampaignStep(2);
                }, 500);
                
            } catch (error) {
                logger.error('Error generating AI assistance:', error);
                showToast('AI generation failed, but you can still fill the form manually', 'warning');
                // Still advance to step 2
                setTimeout(function() {
                    goToCampaignStep(2);
                }, 500);
            }
        }

        window.showEditCampaignModal = function(dropId) {
            const drop = appState.drops.find(function(d) { return d.id === dropId; });
            if (!drop) return;
            
            appState.editingCampaignId = dropId;
            const modal = document.getElementById('campaign-modal');
            const title = document.getElementById('campaign-modal-title');
            
            if (title) title.textContent = 'Edit Campaign';
            
            // Populate form
            document.getElementById('campaign-name').value = drop.name || '';
            document.getElementById('campaign-objective').value = drop.objective || '';
            document.getElementById('campaign-post-link').value = drop.postLink || '';
            document.getElementById('campaign-hero-image').value = (drop.visualAssets && drop.visualAssets[0]) ? drop.visualAssets[0].url : '';
            document.getElementById('campaign-points').value = drop.points || 100;
            document.getElementById('campaign-instructions').value = (drop.instructions || []).join('\n');
            document.getElementById('campaign-content-options').value = (drop.contentOptions || []).map(function(opt) {
                return opt.text || opt;
            }).join('\n');
            
            if (modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        };

        window.closeCampaignModal = function() {
            const modal = document.getElementById('campaign-modal');
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }
            // Reset to step 1
            goToCampaignStep(1);
        };

        // Campaign Wizard Navigation
        window.goToCampaignStep = function(stepNum) {
            // Hide all steps
            for (let i = 1; i <= 4; i++) {
                const stepEl = document.getElementById('campaign-step-' + i);
                const wizardStepEl = document.querySelector('[data-wizard-step="' + i + '"]');
                
                if (stepEl) {
                    stepEl.classList.remove('active');
                    // Show step if it's the current one or a previous one
                    if (i <= stepNum) {
                        stepEl.style.display = '';
                    } else {
                        stepEl.style.display = 'none';
                    }
                }
                if (wizardStepEl) {
                    wizardStepEl.classList.remove('active', 'completed');
                }
            }
            
            // Show current step
            const currentStepEl = document.getElementById('campaign-step-' + stepNum);
            const currentWizardStepEl = document.querySelector('[data-wizard-step="' + stepNum + '"]');
            
            if (currentStepEl) {
                currentStepEl.classList.add('active');
                currentStepEl.style.display = '';
            }
            if (currentWizardStepEl) currentWizardStepEl.classList.add('active');
            
            // Mark previous steps as completed
            for (let i = 1; i < stepNum; i++) {
                const prevWizardStepEl = document.querySelector('[data-wizard-step="' + i + '"]');
                if (prevWizardStepEl) prevWizardStepEl.classList.add('completed');
            }
            
            // If step 4, render preview
            if (stepNum === 4) {
                renderCampaignPreview();
            }
            
            // If step 2, setup image preview
            if (stepNum === 2) {
                setupImagePreview();
            }
        };

        // Setup image preview for hero image
        function setupImagePreview() {
            const heroImageInput = document.getElementById('campaign-hero-image');
            const previewContainer = document.getElementById('campaign-image-preview');
            const previewImage = document.getElementById('preview-hero-image');
            
            if (heroImageInput && previewContainer && previewImage) {
                heroImageInput.addEventListener('input', function() {
                    const url = heroImageInput.value.trim();
                    if (url) {
                        previewImage.src = url;
                        previewImage.onload = function() {
                            previewContainer.classList.remove('hidden');
                        };
                        previewImage.onerror = function() {
                            previewContainer.classList.add('hidden');
                        };
                    } else {
                        previewContainer.classList.add('hidden');
                    }
                });
                
                // Check if there's already a value
                if (heroImageInput.value.trim()) {
                    previewImage.src = heroImageInput.value.trim();
                    previewContainer.classList.remove('hidden');
                }
            }
        }

        // Render campaign preview in step 4
        function renderCampaignPreview() {
            const previewEl = document.getElementById('campaign-preview');
            if (!previewEl) return;
            
            const name = document.getElementById('campaign-name').value.trim() || 'Untitled Campaign';
            const objective = document.getElementById('campaign-objective').value.trim() || 'No objective set';
            const postLink = document.getElementById('campaign-post-link').value.trim() || '#';
            const heroImage = document.getElementById('campaign-hero-image').value.trim();
            const points = parseInt(document.getElementById('campaign-points').value) || 100;
            const instructionsText = document.getElementById('campaign-instructions').value.trim();
            const contentOptionsText = document.getElementById('campaign-content-options').value.trim();
            
            const instructions = instructionsText ? instructionsText.split('\n').filter(function(line) {
                return line.trim();
            }) : [];
            
            const contentOptions = contentOptionsText ? contentOptionsText.split('\n').filter(function(line) {
                return line.trim();
            }) : [];
            
            let previewHTML = `
                <div class="space-y-4">
                    <div>
                        <h4 class="font-bold text-lg mb-2">Campaign Name</h4>
                        <p class="text-text-primary">${escapeHtml(name)}</p>
                    </div>
                    
                    <div>
                        <h4 class="font-bold text-lg mb-2">Objective</h4>
                        <p class="text-secondary">${escapeHtml(objective)}</p>
                    </div>
                    
                    ${heroImage ? `
                    <div>
                        <h4 class="font-bold text-lg mb-2">Hero Image</h4>
                        <img src="${escapeHtml(heroImage)}" alt="Preview" class="max-w-full h-auto rounded-lg border border-border-color" style="max-height: 200px;">
                    </div>
                    ` : ''}
                    
                    <div>
                        <h4 class="font-bold text-lg mb-2">Post Link</h4>
                        <a href="${escapeHtml(postLink)}" target="_blank" class="text-accent-primary hover:underline">${escapeHtml(postLink)}</a>
                    </div>
                    
                    <div>
                        <h4 class="font-bold text-lg mb-2">Base Points</h4>
                        <p class="text-text-primary">${points} points</p>
                    </div>
                    
                    ${instructions.length > 0 ? `
                    <div>
                        <h4 class="font-bold text-lg mb-2">Instructions</h4>
                        <ol class="list-decimal list-inside space-y-1 text-secondary">
                            ${instructions.map(function(inst) {
                                return '<li>' + escapeHtml(inst) + '</li>';
                            }).join('')}
                        </ol>
                    </div>
                    ` : ''}
                    
                    ${contentOptions.length > 0 ? `
                    <div>
                        <h4 class="font-bold text-lg mb-2">Content Options (${contentOptions.length})</h4>
                        <div class="space-y-2">
                            ${contentOptions.map(function(opt, idx) {
                                return '<div class="p-3 bg-bg-color rounded-lg text-sm text-secondary">Option ' + (idx + 1) + ': ' + escapeHtml(opt) + '</div>';
                            }).join('')}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
            
            previewEl.innerHTML = previewHTML;
        }

        window.handleSaveCampaign = function(event) {
            event.preventDefault();
            
            const name = document.getElementById('campaign-name').value.trim();
            const objective = document.getElementById('campaign-objective').value.trim();
            const postLink = document.getElementById('campaign-post-link').value.trim();
            const heroImage = document.getElementById('campaign-hero-image').value.trim();
            const points = parseInt(document.getElementById('campaign-points').value) || 100;
            const instructionsText = document.getElementById('campaign-instructions').value.trim();
            const contentOptionsText = document.getElementById('campaign-content-options').value.trim();
            
            const instructions = instructionsText ? instructionsText.split('\n').filter(function(line) {
                return line.trim();
            }) : [];
            
            const contentOptions = contentOptionsText ? contentOptionsText.split('\n').filter(function(line) {
                return line.trim();
            }).map(function(text) {
                return { type: 'Statement', text: text.trim() };
            }) : [];
            
            if (appState.editingCampaignId) {
                // Edit existing campaign
                const drop = appState.drops.find(function(d) { return d.id === appState.editingCampaignId; });
                if (drop) {
                    drop.name = name;
                    drop.objective = objective;
                    drop.postLink = postLink;
                    drop.points = points;
                    drop.instructions = instructions;
                    drop.contentOptions = contentOptions;
                    if (heroImage) {
                        drop.visualAssets = [{ type: 'image', url: heroImage, filename: 'hero.png' }];
                    }
                    showToast('Campaign updated successfully', 'success');
                }
            } else {
                // Create new campaign
                const newId = 'd' + String(Date.now()).slice(-6);
                const newDrop = {
                    id: newId,
                    name: name,
                    objective: objective,
                    status: 'ACTIVE',
                    postLink: postLink,
                    points: points,
                    instructions: instructions,
                    contentOptions: contentOptions,
                    visualAssets: heroImage ? [{ type: 'image', url: heroImage, filename: 'hero.png' }] : [],
                    createdAt: new Date()
                };
                
                // End any existing active campaign
                appState.drops.forEach(function(d) {
                    if (d.status === 'ACTIVE') {
                        d.status = 'COMPLETE';
                    }
                });
                
                appState.drops.unshift(newDrop);
                showToast('Campaign created successfully', 'success');
            }
            
            closeCampaignModal();
            renderAdminDashboard();
            if (appState.currentView === 'main') {
                renderAll();
            }
        };

        window.handleEndCampaign = function(dropId) {
            if (confirm('Are you sure you want to end this campaign?')) {
                const drop = appState.drops.find(function(d) { return d.id === dropId; });
                if (drop) {
                    drop.status = 'COMPLETE';
                    renderAdminDashboard();
                    if (appState.currentView === 'main') {
                        renderAll();
                    }
                    showToast('Campaign ended successfully', 'success');
                }
            }
        };

        window.handleDeleteCampaign = function(dropId) {
            if (confirm('Are you sure you want to delete this campaign? This action cannot be undone.')) {
                const index = appState.drops.findIndex(function(d) { return d.id === dropId; });
                if (index > -1) {
                    appState.drops.splice(index, 1);
                    delete appState.performanceData[dropId];
                    renderAdminDashboard();
                    if (appState.currentView === 'main') {
                        renderAll();
                    }
                    showToast('Campaign deleted successfully', 'success');
                }
            }
        };

        window.handleViewCampaignDetails = function(dropId) {
            const drop = appState.drops.find(function(d) { return d.id === dropId; });
            if (drop) {
                switchView('recap');
                setTimeout(function() {
                    const event = { target: { dataset: { dropId: dropId } } };
                    handleViewRecap(event);
                }, 100);
            }
        };

        window.showAddUserModal = function() {
            appState.editingUserEmail = null;
            const modal = document.getElementById('user-modal');
            const title = document.getElementById('user-modal-title');
            const form = document.getElementById('user-form');
            
            if (title) title.textContent = 'Add New User';
            if (form) form.reset();
            
            document.getElementById('user-name').value = '';
            document.getElementById('user-email').value = '';
            document.getElementById('user-department').value = '';
            document.getElementById('user-followers').value = '0';
            document.getElementById('user-is-admin').checked = false;
            
            if (modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        };

        window.handleEditUser = function(email) {
            const user = appState.crew.find(function(u) { return u.email === email; }) || 
                        (appState.currentUser && appState.currentUser.email === email ? appState.currentUser : null);
            if (!user) return;
            
            appState.editingUserEmail = email;
            const modal = document.getElementById('user-modal');
            const title = document.getElementById('user-modal-title');
            
            if (title) title.textContent = 'Edit User';
            
            document.getElementById('user-name').value = user.name || '';
            document.getElementById('user-email').value = user.email || '';
            document.getElementById('user-department').value = user.department || '';
            document.getElementById('user-followers').value = user.followers || 0;
            document.getElementById('user-is-admin').checked = user.isAdmin || false;
            
            if (modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        };

        window.closeUserModal = function() {
            const modal = document.getElementById('user-modal');
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }
        };
        window.handleSaveUser = function(event) {
            event.preventDefault();
            
            const name = document.getElementById('user-name').value.trim();
            const email = document.getElementById('user-email').value.trim().toLowerCase();
            const department = document.getElementById('user-department').value.trim();
            const followers = parseInt(document.getElementById('user-followers').value) || 0;
            const isAdmin = document.getElementById('user-is-admin').checked;
            
            if (appState.editingUserEmail) {
                // Edit existing user
                const user = appState.crew.find(function(u) { return u.email === appState.editingUserEmail; }) ||
                           (appState.currentUser && appState.currentUser.email === appState.editingUserEmail ? appState.currentUser : null);
                if (user) {
                    user.name = name;
                    user.email = email;
                    user.department = department;
                    user.followers = followers;
                    user.isAdmin = isAdmin;
                    
                    // Update current user if editing self
                    if (appState.currentUser && appState.currentUser.email === email) {
                        appState.currentUser = user;
                        renderAuthSection();
                    }
                    
                    showToast('User updated successfully', 'success');
                }
            } else {
                // Create new user
                const existingUser = appState.crew.find(function(u) { return u.email === email; });
                if (existingUser) {
                    showToast('User with this email already exists', 'error');
                    return;
                }
                
                const newUser = {
                    name: name,
                    email: email,
                    department: department || 'Unassigned',
                    participatedDrops: [],
                    totalHype: 0,
                    badges: [],
                    followers: followers,
                    isAdmin: isAdmin
                };
                
                appState.crew.push(newUser);
                showToast('User created successfully', 'success');
            }
            
            closeUserModal();
            renderAdminDashboard();
        };
        window.handleDeleteUser = function(email) {
            if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                const index = appState.crew.findIndex(function(u) { return u.email === email; });
                if (index > -1) {
                    appState.crew.splice(index, 1);
                    delete appState.participationData[email];
                    // Remove from performance data
                    Object.keys(appState.performanceData).forEach(function(dropId) {
                        delete appState.performanceData[dropId][email];
                    });
                    renderAdminDashboard();
                    showToast('User deleted successfully', 'success');
                }
            }
        };

        // Modal Functions
        window.showOnboardingModal = function() {
            const modal = document.getElementById('onboarding-modal');
            if (modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        };

        window.closeOnboardingModal = function() {
            const modal = document.getElementById('onboarding-modal');
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = '';
                // Mark as seen in localStorage
                localStorage.setItem('ampup-onboarding-seen', 'true');
            }
        };

        // Close modal on overlay click
        document.addEventListener('click', function(e) {
            const onboardingModal = document.getElementById('onboarding-modal');
            const campaignModal = document.getElementById('campaign-modal');
            const userModal = document.getElementById('user-modal');
            const prizeShowcaseModal = document.getElementById('prize-showcase-modal');
            const prizeDetailModal = document.getElementById('prize-detail-modal');
            
            if (e.target === onboardingModal) {
                closeOnboardingModal();
            }
            if (e.target === campaignModal) {
                closeCampaignModal();
            }
            if (e.target === userModal) {
                closeUserModal();
            }
            if (e.target === prizeShowcaseModal || e.target === prizeDetailModal) {
                closePrizeModal();
            }
            const comparisonModal = document.getElementById('player-comparison-modal');
            if (e.target === comparisonModal) {
                closePlayerComparison();
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeOnboardingModal();
                closeCampaignModal();
                closeUserModal();
                closePrizeModal();
                closePlayerComparison();
            }
        });
        // --- PRIZE SHOWCASE & DETAILS --- //
        window.showPrizeShowcase = function() {
            const user = appState.currentUser;
            if (!user) return;
            
            const allUsers = [...appState.crew, user].filter((v, i, a) => 
                a.findIndex(t => t.email === v.email) === i && v
            );
            
            // Group prizes by category and rarity
            const prizesByCategory = {};
            const allPrizes = Object.values(PRIZE_DEFINITIONS);
            const unlockedPrizes = allPrizes.filter(p => {
                const progress = calculatePrizeProgress(p, user, allUsers);
                return progress.unlocked;
            });
            const featuredPrize = unlockedPrizes.length > 0 ? unlockedPrizes[0] : allPrizes.find(p => p.rarity === 'legendary') || allPrizes[0];
            
            Object.values(PRIZE_DEFINITIONS).forEach(function(prize) {
                if (!prizesByCategory[prize.category]) {
                    prizesByCategory[prize.category] = [];
                }
                prizesByCategory[prize.category].push(prize);
            });
            
            let modalHTML = `
                <div id="prize-showcase-modal" class="modal active">
                    <div class="modal-content max-w-6xl">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-3xl font-extrabold-heading gradient-text">Prize Showcase</h2>
                            <button onclick="closePrizeModal()" class="text-2xl text-secondary hover:text-text-primary transition-colors">&times;</button>
                        </div>
                        
                        <!-- Filter Tabs -->
                        <div class="flex flex-wrap gap-2 mb-6 pb-4 border-b border-border-color">
                            <button onclick="filterPrizes('all')" class="prize-filter-btn active px-4 py-2 rounded-lg font-semibold text-sm transition-all" data-filter="all">All</button>
                            <button onclick="filterPrizes('common')" class="prize-filter-btn px-4 py-2 rounded-lg font-semibold text-sm transition-all" data-filter="common">Common</button>
                            <button onclick="filterPrizes('rare')" class="prize-filter-btn px-4 py-2 rounded-lg font-semibold text-sm transition-all" data-filter="rare">Rare</button>
                            <button onclick="filterPrizes('epic')" class="prize-filter-btn px-4 py-2 rounded-lg font-semibold text-sm transition-all" data-filter="epic">Epic</button>
                            <button onclick="filterPrizes('legendary')" class="prize-filter-btn px-4 py-2 rounded-lg font-semibold text-sm transition-all" data-filter="legendary">Legendary</button>
                            <button onclick="filterPrizes('unlocked')" class="prize-filter-btn px-4 py-2 rounded-lg font-semibold text-sm transition-all" data-filter="unlocked">Unlocked</button>
                        </div>
                        
                        ${featuredPrize ? `
                            <!-- Featured Prize Hero Section -->
                            <div class="mb-8 p-6 rounded-2xl border-2 border-accent-primary/50 bg-gradient-to-br from-purple-900/20 to-pink-900/20">
                                <div class="flex items-center gap-2 mb-3">
                                    <span class="text-xs font-bold text-accent-primary uppercase tracking-wide">Featured Prize</span>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-center">
                                    <div class="text-center md:text-left">
                                        <div class="text-6xl mb-3 filter drop-shadow-2xl">${featuredPrize.icon}</div>
                                        <div class="prize-rarity-badge inline-block mb-2" style="background: ${getPrizeRarityColor(featuredPrize.rarity)}20; color: ${getPrizeRarityColor(featuredPrize.rarity)};">
                                            ${featuredPrize.rarity.toUpperCase()}
                                        </div>
                                    </div>
                                    <div class="md:col-span-2">
                                        <h3 class="text-2xl font-extrabold-heading mb-2">${escapeHtml(featuredPrize.name)}</h3>
                                        <p class="text-secondary mb-3">${escapeHtml(featuredPrize.description)}</p>
                                        <p class="text-lg font-bold accent-text mb-4">${escapeHtml(featuredPrize.reward)}</p>
                                        <button onclick="showPrizeDetails('${featuredPrize.id}')" class="btn-primary">View Details</button>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="space-y-8 max-h-[60vh] overflow-y-auto prize-showcase-content">
            `;
            
            Object.keys(prizesByCategory).forEach(function(category) {
                modalHTML += `
                    <div class="prize-category-section" data-category="${category.toLowerCase()}">
                        <h3 class="text-xl font-bold mb-4 text-text-primary flex items-center gap-2">
                            <span class="w-1 h-6 rounded-full bg-accent-primary"></span>
                            ${escapeHtml(category)}
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                `;
                
                prizesByCategory[category].forEach(function(prize) {
                    const progress = calculatePrizeProgress(prize, user, allUsers);
                    const rarityClass = getPrizeRarityClass(prize.rarity);
                    const rarityColor = getPrizeRarityColor(prize.rarity);
                    const cardClass = progress.unlocked ? 'prize-unlocked' : 'prize-locked';
                    
                    modalHTML += `
                        <div class="prize-card ${rarityClass} ${cardClass} prize-item" 
                             onclick="showPrizeDetails('${prize.id}')" 
                             style="cursor: pointer;"
                             data-rarity="${prize.rarity}"
                             data-unlocked="${progress.unlocked}">
                            ${progress.unlocked ? '<span class="prize-unlocked-badge">✓ Unlocked</span>' : ''}
                            <div class="prize-tier">
                                <div class="prize-icon">${prize.icon}</div>
                                <div class="prize-details">
                                    <h4>
                                        ${escapeHtml(prize.name)}
                                        <span class="prize-rarity-badge" style="background: ${rarityColor}20; color: ${rarityColor};">${prize.rarity.toUpperCase()}</span>
                                    </h4>
                                    <p class="prize-requirement">${escapeHtml(prize.description)}</p>
                                    <p class="prize-reward">${escapeHtml(prize.reward)}</p>
                                    ${!progress.unlocked ? `
                                        <div class="prize-progress">
                                            <div class="prize-progress-label">
                                                <span>Progress</span>
                                                <span>${Math.round(progress.progress)}%</span>
                                            </div>
                                            <div class="prize-progress-bar">
                                                <div class="prize-progress-fill" style="width: ${progress.progress}%"></div>
                                            </div>
                                            <div class="text-xs text-secondary mt-1">${escapeHtml(progress.requirement)}</div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                modalHTML += `
                        </div>
                    </div>
                `;
            });
            
            modalHTML += `
                        </div>
                    </div>
                </div>
            `;
            
            // Create or update modal
            let modal = document.getElementById('prize-showcase-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'prize-showcase-modal';
                modal.className = 'modal';
                document.body.appendChild(modal);
            }
            modal.innerHTML = modalHTML;
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Add filter functionality
            window.filterPrizes = function(filter) {
                const buttons = document.querySelectorAll('.prize-filter-btn');
                buttons.forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
                
                const items = document.querySelectorAll('.prize-item');
                items.forEach(item => {
                    if (filter === 'all') {
                        item.style.display = '';
                    } else if (filter === 'unlocked') {
                        item.style.display = item.dataset.unlocked === 'true' ? '' : 'none';
                    } else {
                        item.style.display = item.dataset.rarity === filter ? '' : 'none';
                    }
                });
            };
        };

        window.showPrizeDetails = function(prizeId) {
            const prize = Object.values(PRIZE_DEFINITIONS).find(function(p) { return p.id === prizeId; });
            if (!prize) return;
            
            const user = appState.currentUser;
            if (!user) return;
            
            const allUsers = [...appState.crew, user].filter((v, i, a) => 
                a.findIndex(t => t.email === v.email) === i && v
            );
            const progress = calculatePrizeProgress(prize, user, allUsers);
            const rarityColor = getPrizeRarityColor(prize.rarity);
            const rarityClass = getPrizeRarityClass(prize.rarity);
            
            // Calculate estimated time to unlock (mock calculation)
            const estimatedTime = progress.progress > 0 && !progress.unlocked 
                ? Math.ceil((100 - progress.progress) / 10) + ' days' 
                : 'N/A';
            
            let modalHTML = `
                <div id="prize-detail-modal" class="modal active">
                    <div class="modal-content max-w-3xl">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-3xl font-extrabold-heading gradient-text">${escapeHtml(prize.name)}</h2>
                            <button onclick="closePrizeModal()" class="text-2xl text-secondary hover:text-text-primary transition-colors">&times;</button>
                        </div>
                        <div class="space-y-6">
                            <!-- Hero Section -->
                            <div class="text-center p-8 rounded-2xl border-2 ${progress.unlocked ? 'border-green-500/50 bg-green-900/10' : 'border-' + rarityClass.replace('prize-', '') + '/50 bg-gradient-to-br from-purple-900/20 to-pink-900/20'}">
                                <div class="text-8xl mb-4 filter drop-shadow-2xl">${prize.icon}</div>
                                <div class="prize-rarity-badge inline-block mb-4 text-base px-4 py-2" style="background: ${rarityColor}20; color: ${rarityColor}; border: 2px solid ${rarityColor};">
                                    ${prize.rarity.toUpperCase()}
                                </div>
                                ${progress.unlocked ? '<div class="text-green-400 font-bold text-2xl mb-2 animate-pulse">✓ UNLOCKED</div>' : ''}
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="surface-card p-5">
                                    <h3 class="font-bold text-lg mb-3 flex items-center gap-2">
                                        <span>📝</span>
                                        <span>Description</span>
                                    </h3>
                                    <p class="text-secondary leading-relaxed">${escapeHtml(prize.description)}</p>
                            </div>
                            
                                <div class="surface-card p-5">
                                    <h3 class="font-bold text-lg mb-3 flex items-center gap-2">
                                        <span>🎁</span>
                                        <span>Reward</span>
                                    </h3>
                                    <p class="text-text-primary font-bold text-xl accent-text">${escapeHtml(prize.reward)}</p>
                                </div>
                            </div>
                            
                            ${!progress.unlocked ? `
                                <div class="surface-card p-5">
                                    <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                                        <span>📊</span>
                                        <span>Progress to Unlock</span>
                                    </h3>
                                    <div class="space-y-4">
                                    <div class="prize-progress-label mb-2">
                                            <span class="font-semibold">${escapeHtml(progress.requirement)}</span>
                                            <span class="accent-text font-bold text-lg">${Math.round(progress.progress)}%</span>
                                    </div>
                                        <div class="prize-progress-bar" style="height: 14px;">
                                        <div class="prize-progress-fill" style="width: ${progress.progress}%"></div>
                                    </div>
                                        <div class="flex justify-between items-center text-sm">
                                            <span class="text-secondary">Estimated time: <span class="text-text-primary font-semibold">${estimatedTime}</span></span>
                                            <span class="text-secondary">${Math.round(progress.progress)}% complete</span>
                                </div>
                                    </div>
                                </div>
                                
                                <div class="surface-card p-5">
                                    <h3 class="font-bold text-lg mb-3 flex items-center gap-2">
                                        <span>🎯</span>
                                        <span>How to Unlock</span>
                                    </h3>
                                    <div class="space-y-2 text-secondary">
                                        ${prize.requirement.type === 'rank' ? `
                                            <p>• Achieve rank #${prize.requirement.value} on the leaderboard</p>
                                            <p>• Keep participating in campaigns to earn Hype points</p>
                                            <p>• Generate clicks through your social posts</p>
                                        ` : prize.requirement.type === 'participation' ? `
                                            <p>• Join and participate in at least one campaign</p>
                                            <p>• Complete the participation form</p>
                                            <p>• Share your unique tracking link</p>
                                        ` : prize.requirement.type === 'clicks' ? `
                                            <p>• Generate ${prize.requirement.value.toLocaleString()} total clicks across all campaigns</p>
                                            <p>• Share your posts on social media</p>
                                            <p>• Encourage engagement with your content</p>
                                        ` : prize.requirement.type === 'level' ? `
                                            <p>• Reach Level ${prize.requirement.value} by earning Hype points</p>
                                            <p>• Participate in campaigns regularly</p>
                                            <p>• Unlock achievements to gain bonus XP</p>
                                        ` : '<p>• Check the requirements above</p>'}
                                    </div>
                                </div>
                            ` : `
                                <div class="surface-card p-5 bg-green-900/10 border-green-500/50">
                                    <h3 class="font-bold text-lg mb-3 flex items-center gap-2 text-green-400">
                                        <span>✅</span>
                                        <span>Unlocked!</span>
                                    </h3>
                                    <p class="text-secondary">Congratulations! You've unlocked this prize. ${escapeHtml(prize.reward)}</p>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
            
            // Create or update modal
            let modal = document.getElementById('prize-detail-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'prize-detail-modal';
                modal.className = 'modal';
                document.body.appendChild(modal);
            }
            modal.innerHTML = modalHTML;
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Animate progress bar
            setTimeout(() => {
                const progressFill = modal.querySelector('.prize-progress-fill');
                if (progressFill) {
                    progressFill.style.transition = 'width 1s cubic-bezier(0.4, 0, 0.2, 1)';
                }
            }, 100);
        };

        // Reusable modal helper functions
        function createModal(modalId, modalHTML, options) {
            options = options || {};
            const cleanupOnClose = options.cleanupOnClose !== false;
            
            let modalOverlay = document.getElementById(modalId);
            if (!modalOverlay) {
                modalOverlay = document.createElement('div');
                modalOverlay.id = modalId;
                modalOverlay.className = 'modal-overlay';
                document.body.appendChild(modalOverlay);
            }
            
            modalOverlay.innerHTML = modalHTML;
            modalOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
            document.body.classList.add('modal-open');
            
            // Add click-outside-to-close
            modalOverlay.addEventListener('click', function(e) {
                if (e.target === modalOverlay) {
                    closeModal(modalId, cleanupOnClose);
                }
            });
            
            // Store previous focus for restoration
            const previousFocus = document.activeElement;
            modalOverlay.setAttribute('data-previous-focus', previousFocus ? (previousFocus.id || previousFocus.className || '') : '');
            
            // Focus first focusable element in modal
            setTimeout(function() {
                const firstFocusable = modalOverlay.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                if (firstFocusable) {
                    firstFocusable.focus();
                }
            }, 100);
            
            return modalOverlay;
        }
        
        function closeModal(modalId, cleanupOnClose) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
                
                // Clean up after animation
                if (cleanupOnClose) {
                    setTimeout(function() {
                        if (modal && !modal.classList.contains('active')) {
                            modal.innerHTML = '';
                        }
                    }, 300);
                }
                
                // Restore focus
                const previousFocusId = modal.getAttribute('data-previous-focus');
                if (previousFocusId) {
                    const previousElement = document.getElementById(previousFocusId) || 
                                          document.querySelector('.' + previousFocusId);
                    if (previousElement && typeof previousElement.focus === 'function') {
                        setTimeout(function() {
                            previousElement.focus();
                        }, 100);
                    }
                }
            }
        }
        
        window.closePrizeModal = function() {
            const modalIds = [
                'prize-showcase-modal',
                'prize-detail-modal',
                'prize-shop-modal',
                'wheel-spin-modal',
                'battle-pass-modal',
                'rewards-menu-modal',
                'impact-score-breakdown-modal'
            ];
            
            // Close all modals
            modalIds.forEach(function(modalId) {
                closeModal(modalId, modalId === 'rewards-menu-modal');
            });
            
            // Always restore scrolling
            document.body.style.overflow = '';
            document.body.classList.remove('modal-open');
        };
        
        // --- PRIZE SHOP MODAL --- //
        window.showPrizeShop = function() {
            const user = appState.currentUser;
            if (!user) return;
            
            const allUsers = [...appState.crew, user].filter((v, i, a) => 
                a.findIndex(t => t.email === v.email) === i && v
            );
            const currentPoints = getUserImpactScore(user, allUsers, appState.performanceData, appState.participationData);
            
            // Group items by category
            const itemsByCategory = {};
            Object.values(PRIZE_SHOP_ITEMS).forEach(item => {
                if (!itemsByCategory[item.category]) {
                    itemsByCategory[item.category] = [];
                }
                itemsByCategory[item.category].push(item);
            });
            
            let modalHTML = `
                <div class="modal" style="max-width: 900px;">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h2 class="text-3xl font-extrabold-heading gradient-text">Prize Shop</h2>
                                <p class="text-secondary mt-1">Redeem your points for spins and rewards!</p>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold accent-text">${currentPoints.toLocaleString()}</div>
                                <div class="text-sm text-secondary">Available Points</div>
                            </div>
                            <button onclick="closePrizeModal()" class="text-2xl text-secondary hover:text-text-primary transition-colors">&times;</button>
                        </div>
                        
                        <div class="space-y-8 max-h-[70vh] overflow-y-auto">
            `;
            
            Object.keys(itemsByCategory).forEach(category => {
                modalHTML += `
                    <div>
                        <h3 class="text-xl font-bold mb-4 text-text-primary flex items-center gap-2">
                            <span class="w-1 h-6 rounded-full bg-accent-primary"></span>
                            ${escapeHtml(category)}
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                `;
                
                itemsByCategory[category].forEach(item => {
                    const affordable = currentPoints >= item.cost;
                    const cardClass = affordable ? 'shop-item-card affordable' : 'shop-item-card unaffordable';
                    
                    modalHTML += `
                        <div class="${cardClass}" onclick="${affordable ? `purchaseShopItem('${item.id}')` : ''}">
                            <div class="text-center mb-3">
                                <div class="text-5xl mb-2">${item.icon}</div>
                                <h4 class="font-bold text-lg mb-1">${escapeHtml(item.name)}</h4>
                                <p class="text-sm text-secondary mb-3">${escapeHtml(item.description)}</p>
                            </div>
                            <div class="flex items-center justify-between pt-3 border-t border-border-color">
                                <span class="text-lg font-bold accent-text">${item.cost.toLocaleString()} pts</span>
                                ${affordable ? 
                                    '<button class="btn-primary text-sm px-4 py-2">Purchase</button>' :
                                    '<span class="text-xs text-secondary">Insufficient points</span>'
                                }
                            </div>
                        </div>
                    `;
                });
                
                modalHTML += `
                        </div>
                    </div>
                `;
            });
            
            modalHTML += `
                        </div>
                    </div>
                </div>
            `;
            
            createModal('prize-shop-modal', modalHTML);
        };
        
        // Purchase shop item handler
        window.purchaseShopItem = function(itemId) {
            const user = appState.currentUser;
            if (!user) {
                showToast('Please log in to make a purchase', 'error');
                return;
            }
            
            const result = purchaseShopItem(user, itemId);
            if (result.success) {
                showToast(`Successfully purchased ${result.item.name}!`, 'success');
                renderAll(); // Refresh UI
                showPrizeShop(); // Refresh shop modal
            } else {
                showToast(result.message, 'error');
            }
        };
        // --- WHEEL SPIN MODAL --- //
        window.showWheelSpin = function() {
            const user = appState.currentUser;
            if (!user) return;
            
            const availableSpins = user.wheelSpins || 0;
            
            // Build wheel segments with refined design
            const segmentAngle = 360 / WHEEL_PRIZES.length;
            let wheelSegmentsHTML = '';
            WHEEL_PRIZES.forEach((prize, index) => {
                const rotation = index * segmentAngle;
                const rarityClass = `wheel-segment-${prize.rarity}`;
                const centerRotation = segmentAngle / 2;
                
                // Format prize name for display
                let displayName = prize.name;
                if (prize.type === 'points') {
                    displayName = `${prize.value} Pts`;
                } else if (prize.type === 'wheel-spin') {
                    displayName = `${prize.value} Spin${prize.value > 1 ? 's' : ''}`;
                } else if (prize.type === 'voucher') {
                    displayName = `£${prize.value}`;
                }
                
                wheelSegmentsHTML += `
                    <div class="wheel-segment ${rarityClass}" style="
                        transform: rotate(${rotation}deg);
                        clip-path: polygon(0 0, 100% 0, 100% 100%);
                    ">
                        <div class="wheel-segment-content" style="transform: rotate(${centerRotation}deg);">
                            <div class="wheel-segment-icon">${prize.icon}</div>
                            <div class="wheel-segment-name">${escapeHtml(displayName)}</div>
                            ${prize.type === 'voucher' ? `<div class="wheel-segment-value">${escapeHtml(prize.voucherType || 'Voucher')}</div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            let modalHTML = `
                <div class="modal" style="max-width: 700px;">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h2 class="text-3xl font-extrabold-heading gradient-text">🎰 Prize Wheel</h2>
                                <p class="text-secondary mt-1">Spin for a chance to win amazing prizes!</p>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold accent-text">${availableSpins}</div>
                                <div class="text-sm text-secondary">Available Spins</div>
                            </div>
                            <button onclick="closePrizeModal()" class="text-2xl text-secondary hover:text-text-primary transition-colors">&times;</button>
                        </div>
                        
                        <div class="wheel-container">
                            <div class="wheel-pointer"></div>
                            <div class="wheel" id="prize-wheel">
                                ${wheelSegmentsHTML}
                            </div>
                            <button class="spin-button" id="spin-btn" ${availableSpins <= 0 ? 'disabled' : ''} onclick="performWheelSpin()">
                                <span class="spin-button-text">${availableSpins > 0 ? 'SPIN' : 'NO SPINS'}</span>
                                ${availableSpins > 0 ? `<span class="spin-button-subtext">${availableSpins} left</span>` : ''}
                            </button>
                        </div>
                        
                        ${availableSpins <= 0 ? `
                            <div class="text-center mt-4">
                                <p class="text-secondary mb-3">No spins available. Purchase more in the shop!</p>
                                <button onclick="closePrizeModal(); showPrizeShop();" class="btn-primary">Visit Shop</button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            createModal('wheel-spin-modal', modalHTML);
        };
        // Perform wheel spin
        window.performWheelSpin = function() {
            const user = appState.currentUser;
            if (!user) return;
            
            const spinBtn = document.getElementById('spin-btn');
            const wheel = document.getElementById('prize-wheel');
            
            if (!spinBtn || !wheel || spinBtn.disabled) return;
            
            // Disable button during spin
            spinBtn.disabled = true;
            const spinBtnText = spinBtn.querySelector('.spin-button-text');
            if (spinBtnText) {
                spinBtnText.textContent = 'SPINNING...';
            } else {
                spinBtn.textContent = 'SPINNING...';
            }
            
            // Spin the wheel
            const result = useWheelSpin(user);
            
            if (!result.success) {
                showToast(result.message, 'error');
                spinBtn.disabled = false;
                const spinBtnText = spinBtn.querySelector('.spin-button-text');
                if (spinBtnText) {
                    spinBtnText.textContent = 'SPIN';
                } else {
                    spinBtn.textContent = 'SPIN!';
                }
                return;
            }
            
            // Calculate spin rotation (multiple full rotations + prize position)
            const prizeIndex = WHEEL_PRIZES.findIndex(p => p.id === result.prize.id);
            const segmentAngle = 360 / WHEEL_PRIZES.length;
            const targetAngle = prizeIndex * segmentAngle + (segmentAngle / 2);
            const fullRotations = 8; // 8 full spins for dramatic effect
            const finalRotation = fullRotations * 360 + (360 - targetAngle);
            
            // Reset wheel position first
            wheel.style.transform = 'rotate(0deg)';
            wheel.offsetHeight; // Force reflow
            
            // Apply spin animation
            wheel.style.transform = `rotate(${finalRotation}deg)`;
            wheel.classList.add('wheel-spinning');
            
            // Show result after animation
            setTimeout(() => {
                wheel.classList.remove('wheel-spinning');
                const rarityColor = getPrizeRarityColor(result.prize.rarity);
                
                // Highlight winning segment
                const segments = wheel.querySelectorAll('.wheel-segment');
                if (segments[prizeIndex]) {
                    segments[prizeIndex].style.animation = 'winningPulse 1s ease-in-out 3';
                    segments[prizeIndex].style.zIndex = '5';
                }
                
                showToast(`🎉 You won: ${result.prize.name}!`, 'success', 5000);
                
                // Format prize description
                let prizeDescription = '';
                if (result.prize.type === 'points') {
                    prizeDescription = `+${result.prize.value} Points`;
                } else if (result.prize.type === 'wheel-spin') {
                    prizeDescription = `${result.prize.value} Extra Spin${result.prize.value > 1 ? 's' : ''}`;
                } else if (result.prize.type === 'voucher') {
                    prizeDescription = `£${result.prize.value} ${result.prize.voucherType ? result.prize.voucherType.charAt(0).toUpperCase() + result.prize.voucherType.slice(1) : ''} Voucher`;
                } else {
                    prizeDescription = 'Badge Unlocked!';
                }
                
                // Show prize modal
                let prizeModalHTML = `
                    <div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50" onclick="this.remove()">
                        <div class="bg-surface-color border-2 border-accent-primary rounded-2xl p-8 text-center max-w-md mx-4" style="border-color: ${rarityColor};">
                            <div class="text-6xl mb-4">${result.prize.icon}</div>
                            <h3 class="text-2xl font-bold mb-2" style="color: ${rarityColor};">${result.prize.name}</h3>
                            <p class="text-secondary mb-4">${prizeDescription}</p>
                            ${result.prize.type === 'voucher' ? '<p class="text-xs text-secondary mb-2">Voucher code will be sent to your email</p>' : ''}
                            <p class="text-sm text-secondary mb-6">Remaining spins: ${result.remainingSpins}</p>
                            <button onclick="this.closest('.fixed').remove(); renderAll(); showWheelSpin();" class="btn-primary">Continue</button>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', prizeModalHTML);
                
                renderAll(); // Refresh UI
            }, 5000);
        };
        
        // --- BATTLE PASS MODAL --- //
        window.showBattlePass = function() {
            const user = appState.currentUser;
            if (!user) return;
            
            const allUsers = [...appState.crew, user].filter((v, i, a) => 
                a.findIndex(t => t.email === v.email) === i && v
            );
            const battlePassProgress = calculateBattlePassProgress(user, allUsers, appState.performanceData, appState.participationData);
            const unclaimedRewards = getUnclaimedBattlePassRewards(user, battlePassProgress);
            
            let modalHTML = `
                <div class="modal" style="max-width: 800px;">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h2 class="text-3xl font-extrabold-heading gradient-text">🎮 Battle Pass</h2>
                                <p class="text-secondary mt-1">Level up and unlock rewards!</p>
                            </div>
                            ${unclaimedRewards.length > 0 ? `
                                <div class="text-right">
                                    <div class="text-2xl font-bold accent-text animate-pulse">${unclaimedRewards.length}</div>
                                    <div class="text-sm text-secondary">Unclaimed Rewards</div>
                                </div>
                            ` : ''}
                            <button onclick="closePrizeModal()" class="text-2xl text-secondary hover:text-text-primary transition-colors">&times;</button>
                        </div>
                        
                        <!-- Progress Bar -->
                        <div class="battle-pass-track mb-6">
                            <div class="flex items-center justify-between mb-2">
                                <span class="font-bold">Level ${battlePassProgress.currentLevel} / ${battlePassProgress.totalMilestones}</span>
                                <span class="text-secondary">${Math.round(battlePassProgress.progress)}% to next milestone</span>
                            </div>
                            <div class="prize-progress-bar" style="height: 12px;">
                                <div class="prize-progress-fill" style="width: ${battlePassProgress.progress}%"></div>
                            </div>
                            ${battlePassProgress.nextMilestone ? `
                                <p class="text-sm text-secondary mt-2">Next: ${battlePassProgress.nextMilestone.name} at ${battlePassProgress.nextMilestone.pointsRequired.toLocaleString()} points</p>
                            ` : ''}
                        </div>
                        
                        <!-- Milestones -->
                        <div class="space-y-3 max-h-[60vh] overflow-y-auto">
            `;
            
            BATTLE_PASS_MILESTONES.forEach(milestone => {
                const isUnlocked = battlePassProgress.unlockedMilestones.some(m => m.level === milestone.level);
                const isClaimed = (user.claimedBattlePassRewards || []).includes(milestone.level);
                const isClaimable = isUnlocked && !isClaimed;
                
                let milestoneClass = 'battle-pass-milestone';
                if (isClaimed) milestoneClass += ' claimed';
                else if (isClaimable) milestoneClass += ' claimable unlocked';
                else if (isUnlocked) milestoneClass += ' unlocked';
                
                const rewardIcon = milestone.reward.type === 'wheel-spin' ? '🎰' :
                                  milestone.reward.type === 'points' ? '⚡' :
                                  milestone.reward.type === 'badge' ? '🎖️' : '🎁';
                
                modalHTML += `
                    <div class="${milestoneClass}" ${isClaimable ? `onclick="claimBattlePassReward(${milestone.level})"` : ''}>
                        <div class="text-3xl">${rewardIcon}</div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-1">
                                <span class="font-bold">Level ${milestone.level}: ${milestone.name}</span>
                                <span class="text-sm text-secondary">${milestone.pointsRequired.toLocaleString()} pts</span>
                            </div>
                            <div class="text-sm text-secondary">
                                ${milestone.reward.type === 'wheel-spin' ? `${milestone.reward.quantity} Wheel Spin${milestone.reward.quantity > 1 ? 's' : ''}` :
                                  milestone.reward.type === 'points' ? `${milestone.reward.quantity} Bonus Points` :
                                  milestone.reward.type === 'badge' ? `${milestone.reward.rarity.charAt(0).toUpperCase() + milestone.reward.rarity.slice(1)} Badge` : 'Reward'}
                            </div>
                        </div>
                        ${isClaimed ? '<span class="text-green-400">✓ Claimed</span>' :
                          isClaimable ? '<button class="btn-primary text-sm px-4 py-2">Claim</button>' :
                          '<span class="text-secondary text-sm">Locked</span>'}
                    </div>
                `;
            });
            
            modalHTML += `
                        </div>
                    </div>
                </div>
            `;
            
            createModal('battle-pass-modal', modalHTML);
        };
        
        // Claim battle pass reward handler
        window.claimBattlePassReward = function(milestoneLevel) {
            const user = appState.currentUser;
            if (!user) {
                showToast('Please log in to claim rewards', 'error');
                return;
            }
            
            const result = claimBattlePassReward(user, milestoneLevel);
            if (result && result.success) {
                const rewardText = result.reward.type === 'wheel-spin' ? `${result.reward.quantity} wheel spin${result.reward.quantity > 1 ? 's' : ''}` :
                                 result.reward.type === 'points' ? `${result.reward.quantity} bonus points` :
                                 result.reward.type === 'badge' ? 'badge' : 'reward';
                showToast(`Claimed ${rewardText}!`, 'success');
                renderAll(); // Refresh UI
                showBattlePass(); // Refresh battle pass modal
            } else if (result) {
                showToast(result.message, 'error');
            }
        };
        // --- REWARDS MENU --- //
        // Combined menu for Shop, Wheel, and Battle Pass
        window.showRewardsMenu = function() {
            logger.log('showRewardsMenu called');
            const user = appState.currentUser;
            if (!user) {
                logger.log('No user found');
                return;
            }
            
            const allUsers = [...appState.crew, user].filter((v, i, a) => 
                a.findIndex(t => t.email === v.email) === i && v
            );
            const currentPoints = getUserImpactScore(user, allUsers, appState.performanceData, appState.participationData);
            const availableSpins = user.wheelSpins || 0;
            const battlePassProgress = calculateBattlePassProgress(user, allUsers, appState.performanceData, appState.participationData);
            const unclaimedRewards = getUnclaimedBattlePassRewards(user, battlePassProgress);
            
            logger.log('Creating rewards menu modal');
            let modalHTML = `
                <div class="modal" style="max-width: 800px;">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-3xl font-extrabold-heading gradient-text">🎁 Rewards</h2>
                            <div class="flex items-center gap-4">
                                <div class="text-right">
                                    <div class="text-xl font-bold accent-text">${currentPoints.toLocaleString()}</div>
                                    <div class="text-xs text-secondary">Points</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-xl font-bold accent-text">${availableSpins}</div>
                                    <div class="text-xs text-secondary">Spins</div>
                                </div>
                                <button onclick="if (window.closePrizeModal) window.closePrizeModal();" class="text-2xl text-secondary hover:text-text-primary transition-colors">&times;</button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- Prize Shop -->
                            <div class="surface-card p-6 text-center cursor-pointer hover:border-accent-primary transition-all" data-action="prize-shop">
                                <div class="text-5xl mb-3">🛒</div>
                                <h3 class="text-xl font-bold mb-2">Prize Shop</h3>
                                <p class="text-sm text-secondary mb-4">Redeem points for spins and rewards</p>
                                <button class="btn-primary w-full" data-action="prize-shop">Visit Shop</button>
                            </div>
                            
                            <!-- Wheel Spin -->
                            <div class="surface-card p-6 text-center cursor-pointer hover:border-accent-primary transition-all" data-action="wheel-spin">
                                <div class="text-5xl mb-3">🎰</div>
                                <h3 class="text-xl font-bold mb-2">Prize Wheel</h3>
                                <p class="text-sm text-secondary mb-4">${availableSpins > 0 ? `You have ${availableSpins} spin${availableSpins > 1 ? 's' : ''} available!` : 'Purchase spins in the shop'}</p>
                                <button class="${availableSpins > 0 ? 'bg-gradient-to-r from-purple-600 to-pink-600' : 'btn-secondary'} text-white w-full py-2 px-4 rounded-lg font-semibold" data-action="wheel-spin">
                                    ${availableSpins > 0 ? 'Spin Now' : 'Get Spins'}
                                </button>
                            </div>
                            
                            <!-- Battle Pass -->
                            <div class="surface-card p-6 text-center cursor-pointer hover:border-accent-primary transition-all" data-action="battle-pass">
                                <div class="text-5xl mb-3">🎮</div>
                                <h3 class="text-xl font-bold mb-2">Battle Pass</h3>
                                <p class="text-sm text-secondary mb-4">Level ${battlePassProgress.currentLevel} / ${battlePassProgress.totalMilestones}</p>
                                ${unclaimedRewards.length > 0 ? `
                                    <div class="mb-2">
                                        <span class="bg-accent-primary text-white px-3 py-1 rounded-full text-xs font-bold animate-pulse">${unclaimedRewards.length} Unclaimed</span>
                                    </div>
                                ` : ''}
                                <button class="btn-secondary w-full" data-action="battle-pass">View Progress</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            logger.log('Modal HTML created, length:', modalHTML.length);
            let modalOverlay = document.getElementById('rewards-menu-modal');
            if (!modalOverlay) {
                logger.log('Creating new rewards menu modal element');
                modalOverlay = document.createElement('div');
                modalOverlay.id = 'rewards-menu-modal';
                modalOverlay.className = 'modal-overlay';
                document.body.appendChild(modalOverlay);
            }
            modalOverlay.innerHTML = modalHTML;
            modalOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
            document.body.classList.add('modal-open');
            
            // Add click-outside-to-close (but not on the modal content itself)
            modalOverlay.addEventListener('click', function(e) {
                if (e.target === modalOverlay) {
                    window.closePrizeModal();
                }
            });
            
            // Store previous focus for restoration
            const previousFocus = document.activeElement;
            modalOverlay.setAttribute('data-previous-focus', previousFocus ? previousFocus.id || '' : '');
            
            // Focus first focusable element in modal
            setTimeout(function() {
                const firstFocusable = modalOverlay.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                if (firstFocusable) {
                    firstFocusable.focus();
                }
            }, 100);
            
            // Attach event listeners programmatically - use event delegation on the modal overlay
            modalOverlay.addEventListener('click', function(e) {
                const target = e.target;
                const button = target.closest('button[data-action]');
                const card = target.closest('[data-action]');
                
                if (button) {
                    e.stopPropagation();
                    e.preventDefault();
                    const action = button.getAttribute('data-action');
                    logger.log('Button clicked:', action);
                    
                    // Close the rewards menu first
                    if (window.closePrizeModal) {
                        window.closePrizeModal();
                    }
                    
                    // Then open the appropriate modal
                    setTimeout(function() {
                        logger.log('Timeout executing, action:', action);
                        if (action === 'prize-shop') {
                            if (window.showPrizeShop) {
                                logger.log('Calling showPrizeShop');
                                window.showPrizeShop();
                            } else {
                                logger.error('showPrizeShop not available');
                            }
                        } else if (action === 'wheel-spin') {
                            if (window.showWheelSpin) {
                                logger.log('Calling showWheelSpin');
                                window.showWheelSpin();
                            } else {
                                logger.error('showWheelSpin not available');
                            }
                        } else if (action === 'battle-pass') {
                            if (window.showBattlePass) {
                                logger.log('Calling showBattlePass');
                                window.showBattlePass();
                            } else {
                                logger.error('showBattlePass not available');
                            }
                        }
                    }, 200);
                } else if (card && !button) {
                    // Clicked on card but not button
                    const action = card.getAttribute('data-action');
                    if (action) {
                        e.stopPropagation();
                        logger.log('Card clicked:', action);
                        if (window.closePrizeModal) window.closePrizeModal();
                        
                        setTimeout(function() {
                            if (action === 'prize-shop' && window.showPrizeShop) {
                                window.showPrizeShop();
                            } else if (action === 'wheel-spin' && window.showWheelSpin) {
                                window.showWheelSpin();
                            } else if (action === 'battle-pass' && window.showBattlePass) {
                                window.showBattlePass();
                            }
                        }, 200);
                    }
                }
            });
        };
        
        // --- IMPACT SCORE BREAKDOWN MODAL --- //
        window.showImpactScoreBreakdown = function() {
            const user = appState.currentUser;
            if (!user) return;
            
            const allUsers = [...appState.crew, user].filter((v, i, a) => 
                a.findIndex(t => t.email === v.email) === i && v
            );
            const impactScore = getUserImpactScore(user, allUsers, appState.performanceData, appState.participationData);
            
            // Calculate breakdown
            const shares = (user.participatedDrops || []).length;
            const sharePoints = shares * IMPACT_SCORE_WEIGHTS.SHARE_SUGGESTED;
            
            let totalClicks = 0;
            Object.values(appState.performanceData || {}).forEach(d => {
                totalClicks += d[user.email.toLowerCase()] || 0;
            });
            const clickPoints = totalClicks * IMPACT_SCORE_WEIGHTS.CLICK_ON_LINK;
            
            const commentPoints = (user.commentsGenerated || 0) * IMPACT_SCORE_WEIGHTS.COMMENT_ON_POST;
            const originalPostPoints = (user.originalPosts || 0) * IMPACT_SCORE_WEIGHTS.ORIGINAL_POST;
            const peerBadgePoints = (user.peerBadgesReceived || 0) * IMPACT_SCORE_WEIGHTS.PEER_BADGE_RECEIVED;
            const conversionPoints = ((user.conversions || []).length) * IMPACT_SCORE_WEIGHTS.CONVERSION_LEAD;
            
            let modalHTML = `
                <div id="impact-score-modal" class="modal active">
                    <div class="modal-content max-w-3xl">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-3xl font-extrabold-heading gradient-text">Impact Score Breakdown</h2>
                            <button onclick="closeImpactScoreModal()" class="text-2xl text-secondary hover:text-text-primary transition-colors">&times;</button>
                        </div>
                        <div class="space-y-6">
                            <div class="text-center p-6 rounded-2xl border-2 border-accent-primary/50 bg-gradient-to-br from-purple-900/20 to-pink-900/20">
                                <div class="text-5xl font-extrabold-heading gradient-text mb-2">${impactScore.toLocaleString()}</div>
                                <div class="text-lg text-secondary">Total Impact Points</div>
                                <div class="text-sm text-secondary mt-2">Quality over quantity - authentic effort matters most</div>
                            </div>
                            
                            <div class="space-y-4">
                                <h3 class="text-xl font-bold mb-4">Score Components</h3>
                                
                                ${sharePoints > 0 ? `
                                <div class="surface-card p-4">
                                    <div class="flex justify-between items-center mb-2">
                                        <div class="flex items-center gap-3">
                                            <span class="text-2xl">📤</span>
                                            <div>
                                                <div class="font-semibold">Shares (${shares})</div>
                                                <div class="text-xs text-secondary">Base brand awareness</div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-bold text-lg">${sharePoints.toLocaleString()}</div>
                                            <div class="text-xs text-secondary">${IMPACT_SCORE_WEIGHTS.SHARE_SUGGESTED}x weight</div>
                                        </div>
                                    </div>
                                </div>
                                ` : ''}
                                
                                ${clickPoints > 0 ? `
                                <div class="surface-card p-4 border-l-4 border-blue-500">
                                    <div class="flex justify-between items-center mb-2">
                                        <div class="flex items-center gap-3">
                                            <span class="text-2xl">👆</span>
                                            <div>
                                                <div class="font-semibold">Clicks Generated (${totalClicks})</div>
                                                <div class="text-xs text-secondary">Content relevance & engagement</div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-bold text-lg accent-text">${clickPoints.toLocaleString()}</div>
                                            <div class="text-xs text-secondary">${IMPACT_SCORE_WEIGHTS.CLICK_ON_LINK}x weight</div>
                                        </div>
                                    </div>
                                </div>
                                ` : ''}
                                
                                ${commentPoints > 0 ? `
                                <div class="surface-card p-4 border-l-4 border-green-500">
                                    <div class="flex justify-between items-center mb-2">
                                        <div class="flex items-center gap-3">
                                            <span class="text-2xl">💬</span>
                                            <div>
                                                <div class="font-semibold">Comments Generated (${user.commentsGenerated || 0})</div>
                                                <div class="text-xs text-secondary">Meaningful engagement & conversation</div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-bold text-lg accent-text">${commentPoints.toLocaleString()}</div>
                                            <div class="text-xs text-secondary">${IMPACT_SCORE_WEIGHTS.COMMENT_ON_POST}x weight</div>
                                        </div>
                                    </div>
                                </div>
                                ` : ''}
                                
                                ${originalPostPoints > 0 ? `
                                <div class="surface-card p-4 border-l-4 border-purple-500">
                                    <div class="flex justify-between items-center mb-2">
                                        <div class="flex items-center gap-3">
                                            <span class="text-2xl">✍️</span>
                                            <div>
                                                <div class="font-semibold">Original Posts (${user.originalPosts || 0})</div>
                                                <div class="text-xs text-secondary">Authentic effort & creativity</div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-bold text-lg accent-text">${originalPostPoints.toLocaleString()}</div>
                                            <div class="text-xs text-secondary">${IMPACT_SCORE_WEIGHTS.ORIGINAL_POST}x weight</div>
                                        </div>
                                    </div>
                                </div>
                                ` : ''}
                                
                                ${peerBadgePoints > 0 ? `
                                <div class="surface-card p-4 border-l-4 border-yellow-500">
                                    <div class="flex justify-between items-center mb-2">
                                        <div class="flex items-center gap-3">
                                            <span class="text-2xl">🏅</span>
                                            <div>
                                                <div class="font-semibold">Peer Recognition (${user.peerBadgesReceived || 0})</div>
                                                <div class="text-xs text-secondary">Social recognition from colleagues</div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-bold text-lg accent-text">${peerBadgePoints.toLocaleString()}</div>
                                            <div class="text-xs text-secondary">${IMPACT_SCORE_WEIGHTS.PEER_BADGE_RECEIVED}x weight</div>
                                        </div>
                                    </div>
                                </div>
                                ` : ''}
                                
                                ${conversionPoints > 0 ? `
                                <div class="surface-card p-4 border-l-4 border-gold-500">
                                    <div class="flex justify-between items-center mb-2">
                                        <div class="flex items-center gap-3">
                                            <span class="text-2xl">🎯</span>
                                            <div>
                                                <div class="font-semibold">Conversions (${(user.conversions || []).length})</div>
                                                <div class="text-xs text-secondary">Direct business impact</div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-bold text-lg accent-text">${conversionPoints.toLocaleString()}</div>
                                            <div class="text-xs text-secondary">${IMPACT_SCORE_WEIGHTS.CONVERSION_LEAD}x weight</div>
                                        </div>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                            
                            <div class="surface-card p-4 bg-blue-900/20 border-blue-500/50">
                                <h4 class="font-bold mb-2 flex items-center gap-2">
                                    <span>💡</span>
                                    <span>Why Impact Score?</span>
                                </h4>
                                <p class="text-sm text-secondary leading-relaxed">
                                    Impact Score rewards <strong>authentic effort</strong> and <strong>real business value</strong>, not just quantity. 
                                    A high-quality original post that generates engagement is worth more than dozens of simple shares. 
                                    This system ensures everyone can compete, regardless of network size.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            let modal = document.getElementById('impact-score-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'impact-score-modal';
                modal.className = 'modal';
                document.body.appendChild(modal);
            }
            modal.innerHTML = modalHTML;
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        };
        
        window.closeImpactScoreModal = function() {
            const modal = document.getElementById('impact-score-modal');
            if (modal) {
                modal.classList.remove('active');
            }
            document.body.style.overflow = '';
        };
        // --- MISSION LOG MODAL --- //
        window.showMissionLog = function() {
            const user = appState.currentUser;
            if (!user) return;
            
            const missions = getMissionDefinitions();
            const allUsers = [...appState.crew, user].filter((v, i, a) => 
                a.findIndex(t => t.email === v.email) === i && v
            );
            
            let modalHTML = `
                <div id="mission-log-modal" class="modal active">
                    <div class="modal-content max-w-4xl">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-3xl font-extrabold-heading gradient-text">Mission Log</h2>
                            <button onclick="closeMissionLogModal()" class="text-2xl text-secondary hover:text-text-primary transition-colors">&times;</button>
                        </div>
                        <div class="space-y-6 max-h-[70vh] overflow-y-auto">
            `;
            
            Object.keys(missions).forEach(function(missionId) {
                const mission = missions[missionId];
                const progress = checkMissionProgress(missionId, user, appState);
                if (!progress) return;
                
                modalHTML += `
                    <div class="surface-card p-5 border-l-4 ${progress.isComplete ? 'border-green-500' : 'border-accent-primary'}">
                        <div class="flex items-start gap-4 mb-4">
                            <span class="text-4xl">${mission.emoji}</span>
                            <div class="flex-1">
                                <h3 class="text-xl font-extrabold-heading mb-2">${mission.name}</h3>
                                <p class="text-secondary mb-3 leading-relaxed">${mission.narrative}</p>
                                <div class="flex flex-wrap gap-2 mb-4">
                                    ${mission.targetPlayerTypes.map(type => `
                                        <span class="px-2 py-1 rounded text-xs bg-bg-color border border-border-color text-secondary">${type}</span>
                                    `).join('')}
                                </div>
                                <div class="mb-4">
                                    <div class="flex justify-between text-sm mb-2">
                                        <span class="text-secondary">Progress</span>
                                        <span class="font-bold ${progress.isComplete ? 'text-green-400' : 'accent-text'}">${Math.round(progress.progress)}%</span>
                                    </div>
                                    <div class="prize-progress-bar" style="height: 8px;">
                                        <div class="prize-progress-fill" style="width: ${progress.progress}%"></div>
                                    </div>
                                </div>
                                <div class="space-y-3">
                                    ${mission.tasks.map(task => {
                                        const isComplete = progress.completedTasks.includes(task.id);
                                        return `
                                            <div class="p-3 bg-bg-color rounded-lg ${isComplete ? 'border border-green-500/50' : 'border border-border-color'}">
                                                <div class="flex items-center gap-3">
                                                    ${isComplete ? '<span class="text-green-400 text-xl">✓</span>' : '<span class="text-secondary text-xl">○</span>'}
                                                    <div class="flex-1">
                                                        <div class="font-semibold ${isComplete ? 'text-green-400' : 'text-text-primary'}">${task.name}</div>
                                                        <div class="text-xs text-secondary mt-1">${task.description}</div>
                                                        <div class="text-xs accent-text mt-1">Reward: +${task.reward.impactScore} Impact Score</div>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                                ${progress.isComplete ? `
                                    <div class="mt-4 p-3 bg-green-900/20 border border-green-500/50 rounded-lg">
                                        <div class="font-bold text-green-400 mb-1">✓ Mission Complete!</div>
                                        <div class="text-sm text-secondary">Reward: +${mission.completionReward.impactScore} Impact Score, ${mission.completionReward.badge} badge</div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            modalHTML += `
                        </div>
                    </div>
                </div>
            `;
            
            let modal = document.getElementById('mission-log-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'mission-log-modal';
                modal.className = 'modal';
                document.body.appendChild(modal);
            }
            modal.innerHTML = modalHTML;
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        };
        
        window.closeMissionLogModal = function() {
            const modal = document.getElementById('mission-log-modal');
            if (modal) {
                modal.classList.remove('active');
            }
            document.body.style.overflow = '';
        };
        
        // --- MULTI-FACETED LEADERBOARD DASHBOARD --- //
        window.showLeaderboardDashboard = function() {
            const user = appState.currentUser;
            if (!user) return;
            
            const allUsers = [...appState.crew, user].filter((v, i, a) => 
                a.findIndex(t => t.email === v.email) === i && v
            );
            
            // Calculate Impact Scores for all users
            const impactScores = {};
            allUsers.forEach(u => {
                impactScores[u.email] = getUserImpactScore(u, allUsers, appState.performanceData, appState.participationData);
            });
            
            // Generate different leaderboard types
            const personalLeague = generatePersonalMicroLeague(user, allUsers, impactScores);
            const teamLeaderboard = generateTeamLeaderboard(user, allUsers, impactScores);
            const creativeLeaderboard = generateRotatingMetricLeaderboard(allUsers, 'most-creative', impactScores);
            
            let modalHTML = `
                <div id="leaderboard-dashboard-modal" class="modal active">
                    <div class="modal-content max-w-6xl">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-3xl font-extrabold-heading gradient-text">Leaderboard Dashboard</h2>
                            <button onclick="closeLeaderboardDashboard()" class="text-2xl text-secondary hover:text-text-primary transition-colors">&times;</button>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 max-h-[75vh] overflow-y-auto">
                            <!-- Personal Micro-League (5-Up / 5-Down) -->
                            <div class="surface-card p-5">
                                <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                                    <span>🎯</span>
                                    <span>Your Competitive Zone</span>
                                </h3>
                                ${personalLeague ? `
                                    <div class="mb-4 p-3 bg-bg-color rounded-lg text-center">
                                        <div class="text-2xl font-bold accent-text">#${personalLeague.userPosition}</div>
                                        <div class="text-sm text-secondary">Top ${personalLeague.percentile}%</div>
                                    </div>
                                    <div class="space-y-2">
                                        ${personalLeague.users.map((u, idx) => {
                                            const isUser = u.email === user.email;
                                            const position = personalLeague.users.findIndex(us => us.email === u.email) + personalLeague.userPosition - 5;
                                            return `
                                                <div class="p-3 bg-bg-color rounded-lg ${isUser ? 'ring-2 ring-accent-primary' : ''}">
                                                    <div class="flex items-center justify-between">
                                                        <div class="flex items-center gap-3">
                                                            <span class="font-bold text-secondary w-8">#${position}</span>
                                                            <span class="font-semibold ${isUser ? 'accent-text' : 'text-text-primary'}">${escapeHtml(u.name)}</span>
                                                        </div>
                                                        <span class="font-bold accent-text">${(impactScores[u.email] || 0).toLocaleString()}</span>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                ` : '<p class="text-secondary text-center py-4">Not enough data</p>'}
                            </div>
                            
                            <!-- Team Leaderboard -->
                            <div class="surface-card p-5">
                                <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                                    <span>🤝</span>
                                    <span>Team Competition</span>
                                </h3>
                                ${teamLeaderboard ? `
                                    <div class="space-y-3">
                                        ${teamLeaderboard.teams.slice(0, 5).map((team, idx) => {
                                            const isUserTeam = team.name === (user.department || 'Unassigned');
                                            return `
                                                <div class="p-3 bg-bg-color rounded-lg ${isUserTeam ? 'ring-2 ring-accent-primary' : ''}">
                                                    <div class="flex items-center justify-between mb-2">
                                                        <div class="flex items-center gap-3">
                                                            <span class="font-bold text-lg">#${idx + 1}</span>
                                                            <span class="font-semibold ${isUserTeam ? 'accent-text' : 'text-text-primary'}">${escapeHtml(team.name)}</span>
                                                        </div>
                                                        <span class="font-bold accent-text">${team.totalImpact.toLocaleString()}</span>
                                                    </div>
                                                    <div class="text-xs text-secondary">${team.members.length} members • Avg: ${Math.round(team.avgImpact).toLocaleString()}</div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                ` : '<p class="text-secondary text-center py-4">No team data</p>'}
                            </div>
                            
                            <!-- Rotating Metric: Most Creative -->
                            <div class="surface-card p-5">
                                <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                                    <span>✨</span>
                                    <span>Weekly Challenge: Most Creative</span>
                                </h3>
                                ${creativeLeaderboard ? `
                                    <div class="space-y-2">
                                        ${creativeLeaderboard.users.map((u, idx) => `
                                            <div class="p-3 bg-bg-color rounded-lg">
                                                <div class="flex items-center justify-between">
                                                    <div class="flex items-center gap-3">
                                                        <span class="font-bold text-lg">#${idx + 1}</span>
                                                        <span class="font-semibold text-text-primary">${escapeHtml(u.name)}</span>
                                                    </div>
                                                    <span class="font-bold accent-text">${u.score.toLocaleString()}</span>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : '<p class="text-secondary text-center py-4">No data</p>'}
                            </div>
                            
                            <!-- Prestige Status -->
                            <div class="surface-card p-5">
                                <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                                    <span>👑</span>
                                    <span>Prestige Status</span>
                                </h3>
                                ${(() => {
                                    const impactScore = getUserImpactScore(user, allUsers, appState.performanceData, appState.participationData);
                                    const prestigeStatus = checkPrestigeEligibility(user, impactScore);
                                    if (prestigeStatus.eligible) {
                                        if (prestigeStatus.hasChosenPath) {
                                            const path = PRESTIGE_PATHS[user.prestigePath.toUpperCase()];
                                            return `
                                                <div class="p-4 bg-gradient-to-br from-purple-900/20 to-pink-900/20 rounded-lg border-2 border-accent-primary/50">
                                                    <div class="text-3xl mb-2">${path.emoji}</div>
                                                    <div class="font-bold text-lg mb-2">${path.name}</div>
                                                    <div class="text-sm text-secondary mb-3">${path.description}</div>
                                                    <div class="text-xs text-secondary">
                                                        <div class="font-semibold mb-1">Unlocks:</div>
                                                        ${path.unlocks.map(u => `<div>• ${u}</div>`).join('')}
                                                    </div>
                                                </div>
                                            `;
                                        } else {
                                            return `
                                                <div class="p-4 bg-gradient-to-br from-yellow-900/20 to-orange-900/20 rounded-lg border-2 border-yellow-500/50">
                                                    <div class="text-3xl mb-2">🎉</div>
                                                    <div class="font-bold text-lg mb-2">Prestige Unlocked!</div>
                                                    <div class="text-sm text-secondary mb-4">Choose your path to continue your journey</div>
                                                    <button onclick="showPrestigePathSelection()" class="btn-primary w-full">Choose Prestige Path</button>
                                                </div>
                                            `;
                                        }
                                    } else {
                                        return `
                                            <div class="p-4 bg-bg-color rounded-lg">
                                                <div class="text-sm text-secondary mb-2">Level ${prestigeStatus.currentLevel} / ${prestigeStatus.requiredLevel}</div>
                                                <div class="prize-progress-bar mb-2" style="height: 8px;">
                                                    <div class="prize-progress-fill" style="width: ${prestigeStatus.progress}%"></div>
                                                </div>
                                                <div class="text-xs text-secondary">Reach Level 50 to unlock Prestige</div>
                                            </div>
                                        `;
                                    }
                                })()}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            let modal = document.getElementById('leaderboard-dashboard-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'leaderboard-dashboard-modal';
                modal.className = 'modal';
                document.body.appendChild(modal);
            }
            modal.innerHTML = modalHTML;
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        };
        
        window.closeLeaderboardDashboard = function() {
            const modal = document.getElementById('leaderboard-dashboard-modal');
            if (modal) {
                modal.classList.remove('active');
            }
            document.body.style.overflow = '';
        };
        
        // --- PRESTIGE PATH SELECTION MODAL --- //
        window.showPrestigePathSelection = function() {
            const user = appState.currentUser;
            if (!user) return;
            
            const allUsers = [...appState.crew, user].filter((v, i, a) => 
                a.findIndex(t => t.email === v.email) === i && v
            );
            const impactScore = getUserImpactScore(user, allUsers, appState.performanceData, appState.participationData);
            const prestigeStatus = checkPrestigeEligibility(user, impactScore);
            
            if (!prestigeStatus.eligible) {
                showToast('You must reach Level 50 to unlock Prestige', 'warning', 3000);
                return;
            }
            
            let modalHTML = `
                <div id="prestige-path-modal" class="modal active">
                    <div class="modal-content max-w-4xl">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-3xl font-extrabold-heading gradient-text">Choose Your Prestige Path</h2>
                            <button onclick="closePrestigePathModal()" class="text-2xl text-secondary hover:text-text-primary transition-colors">&times;</button>
                        </div>
                        <div class="mb-6 p-4 bg-blue-900/20 border border-blue-500/50 rounded-lg">
                            <p class="text-sm text-secondary leading-relaxed">
                                Congratulations on reaching Level 50! Prestige transforms you from a player into a co-creator. 
                                Choose the path that aligns with your strengths and interests.
                            </p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            `;
            
            Object.values(PRESTIGE_PATHS).forEach(path => {
                modalHTML += `
                    <div class="surface-card p-5 border-2 border-border-color hover:border-accent-primary transition-all cursor-pointer" onclick="selectPrestigePath('${path.id}')">
                        <div class="text-4xl mb-3 text-center">${path.emoji}</div>
                        <h3 class="text-xl font-extrabold-heading mb-2 text-center">${path.name}</h3>
                        <p class="text-sm text-secondary mb-4 text-center leading-relaxed">${path.description}</p>
                        <div class="space-y-2 mb-4">
                            <div class="text-xs font-semibold text-secondary uppercase mb-2">Unlocks:</div>
                            ${path.unlocks.map(unlock => `
                                <div class="text-xs text-secondary flex items-start gap-2">
                                    <span class="text-green-400 mt-0.5">✓</span>
                                    <span>${unlock}</span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="text-xs text-secondary mt-4 pt-4 border-t border-border-color">
                            <div class="font-semibold mb-1">Best for:</div>
                            <div class="flex flex-wrap gap-1">
                                ${path.targetPlayerTypes.map(type => `
                                    <span class="px-2 py-1 rounded bg-bg-color border border-border-color">${type}</span>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            modalHTML += `
                        </div>
                    </div>
                </div>
            `;
            
            let modal = document.getElementById('prestige-path-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'prestige-path-modal';
                modal.className = 'modal';
                document.body.appendChild(modal);
            }
            modal.innerHTML = modalHTML;
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        };
        
        window.selectPrestigePath = function(pathId) {
            const user = appState.currentUser;
            if (!user) return;
            
            if (unlockPrestigePath(user, pathId)) {
                showToast('Prestige path unlocked! Your journey continues...', 'success', 5000);
                closePrestigePathModal();
                // Refresh views
                renderSidebar();
                if (typeof renderAll === 'function') renderAll();
            } else {
                showToast('Error selecting prestige path', 'error', 3000);
            }
        };
        
        window.closePrestigePathModal = function() {
            const modal = document.getElementById('prestige-path-modal');
            if (modal) {
                modal.classList.remove('active');
            }
            document.body.style.overflow = '';
        };
        // --- SOCIAL FEATURES --- //
        // Player Comparison
        window.showPlayerComparison = function(otherPlayerEmail) {
            const currentUser = appState.currentUser;
            if (!currentUser) return;
            
            const otherPlayer = appState.crew.find(function(u) { return u.email === otherPlayerEmail; }) || 
                              (currentUser.email === otherPlayerEmail ? currentUser : null);
            if (!otherPlayer) return;
            
            // Calculate stats for both players
            const allUsers = [...appState.crew, currentUser].filter((v, i, a) => 
                a.findIndex(t => t.email === v.email) === i && v
            );
            
            const currentUserStats = {
                name: currentUser.name,
                level: currentUser.level || calculateLevel(currentUser.totalHype || 0),
                totalHype: currentUser.totalHype || 0,
                reputationScore: currentUser.reputationScore || calculateReputationScore(currentUser, allUsers),
                badges: currentUser.badges || [],
                participatedDrops: currentUser.participatedDrops || [],
                followers: currentUser.followers || 0
            };
            
            let currentUserClicks = 0;
            Object.values(appState.performanceData || {}).forEach(function(dropPerf) {
                currentUserClicks += dropPerf[currentUser.email.toLowerCase()] || 0;
            });
            currentUserStats.totalClicks = currentUserClicks;
            
            const otherPlayerStats = {
                name: otherPlayer.name,
                level: otherPlayer.level || calculateLevel(otherPlayer.totalHype || 0),
                totalHype: otherPlayer.totalHype || 0,
                reputationScore: otherPlayer.reputationScore || calculateReputationScore(otherPlayer, allUsers),
                badges: otherPlayer.badges || [],
                participatedDrops: otherPlayer.participatedDrops || [],
                followers: otherPlayer.followers || 0
            };
            
            let otherPlayerClicks = 0;
            Object.values(appState.performanceData || {}).forEach(function(dropPerf) {
                otherPlayerClicks += dropPerf[otherPlayer.email.toLowerCase()] || 0;
            });
            otherPlayerStats.totalClicks = otherPlayerClicks;
            
            const modalHTML = `
                <div id="player-comparison-modal" class="modal active">
                    <div class="modal-content max-w-4xl">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-extrabold-heading">Player Comparison</h2>
                            <button onclick="closePlayerComparison()" class="text-2xl text-secondary hover:text-text-primary">&times;</button>
                        </div>
                        <div class="grid grid-cols-2 gap-6 mb-6">
                            <!-- Current User -->
                            <div class="text-center">
                                ${getAvatarHTML(currentUserStats.name, currentUser.email, 'xl', null, currentUser)}
                                <h3 class="text-xl font-bold mt-4">${escapeHtml(currentUserStats.name)}</h3>
                                <p class="text-sm text-secondary">You</p>
                            </div>
                            <!-- Other Player -->
                            <div class="text-center">
                                ${getAvatarHTML(otherPlayerStats.name, otherPlayer.email, 'xl', null, otherPlayer)}
                                <h3 class="text-xl font-bold mt-4">${escapeHtml(otherPlayerStats.name)}</h3>
                                <p class="text-sm text-secondary">${escapeHtml(otherPlayer.department || 'Crew Member')}</p>
                            </div>
                        </div>
                        <div class="space-y-4">
                            ${[
                                { label: 'Level', current: currentUserStats.level, other: otherPlayerStats.level, higher: 'better' },
                                { label: 'Total Hype', current: currentUserStats.totalHype, other: otherPlayerStats.totalHype, higher: 'better' },
                                { label: 'Reputation Score', current: currentUserStats.reputationScore, other: otherPlayerStats.reputationScore, higher: 'better' },
                                { label: 'Total Clicks', current: currentUserStats.totalClicks, other: otherPlayerStats.totalClicks, higher: 'better' },
                                { label: 'Campaigns Joined', current: currentUserStats.participatedDrops.length, other: otherPlayerStats.participatedDrops.length, higher: 'better' },
                                { label: 'Badges', current: currentUserStats.badges.length, other: otherPlayerStats.badges.length, higher: 'better' },
                                { label: 'Followers', current: currentUserStats.followers, other: otherPlayerStats.followers, higher: 'better' }
                            ].map(function(stat) {
                                const currentWins = stat.higher === 'better' ? stat.current > stat.other : stat.current < stat.other;
                                const otherWins = stat.higher === 'better' ? stat.other > stat.current : stat.other < stat.current;
                                return `
                                    <div class="bg-bg-color p-4 rounded-lg">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="text-sm font-semibold text-secondary">${stat.label}</span>
                                        </div>
                                        <div class="grid grid-cols-2 gap-4">
                                            <div class="text-center ${currentWins ? 'ring-2 ring-green-400 rounded-lg p-2' : ''}">
                                                <div class="text-2xl font-bold ${currentWins ? 'text-green-400' : 'accent-text'}">${stat.current.toLocaleString()}</div>
                                                ${currentWins ? '<div class="text-xs text-green-400 mt-1">Winner!</div>' : ''}
                                            </div>
                                            <div class="text-center ${otherWins ? 'ring-2 ring-green-400 rounded-lg p-2' : ''}">
                                                <div class="text-2xl font-bold ${otherWins ? 'text-green-400' : 'accent-text'}">${stat.other.toLocaleString()}</div>
                                                ${otherWins ? '<div class="text-xs text-green-400 mt-1">Winner!</div>' : ''}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            let modal = document.getElementById('player-comparison-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'player-comparison-modal';
                modal.className = 'modal';
                document.body.appendChild(modal);
            }
            modal.innerHTML = modalHTML;
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        };

        window.closePlayerComparison = function() {
            const modal = document.getElementById('player-comparison-modal');
            if (modal) {
                modal.classList.remove('active');
            }
            document.body.style.overflow = '';
        };
        
            } catch(error) {
                logger.error('Error in initializeApp:', error);
                logger.error('Stack:', error.stack);
            }
        }

        // Activity Feed (simplified for prototype)
        function generateActivityFeed() {
            const activities = [];
            const allUsers = [...appState.crew, appState.currentUser].filter((v, i, a) => 
                a.findIndex(t => t.email === v.email) === i && v
            );
            
            // Generate activities from recent achievements, level ups, etc.
            allUsers.forEach(function(user) {
                if (user.badges && user.badges.length > 0) {
                    user.badges.forEach(function(badge) {
                        const achievement = ACHIEVEMENT_DEFINITIONS[badge];
                        if (achievement) {
                            activities.push({
                                type: 'achievement',
                                user: user.name,
                                message: `unlocked ${achievement.emoji} ${achievement.name}`,
                                timestamp: new Date()
                            });
                        }
                    });
                }
            });
            
            return activities.slice(0, 10).sort(function(a, b) { return b.timestamp - a.timestamp; });
        }
        
        // Call initializeApp to execute initialization
        initializeApp();
        
        // Call renderAll after initialization completes (with a small delay to ensure all functions are defined)
        setTimeout(function() {
            if (typeof renderAll === 'function') {
                renderAll();
            } else if (typeof window.renderAll === 'function') {
                window.renderAll();
            }
        }, 50);

        // Make handleLogin available globally for inline onclick
        window.handleLoginClick = function(e) {
            if (e) {
                e.preventDefault();
                e.stopPropagation();
            }
            logger.log('Login button clicked (inline)!');
            try {
                // Call handleLogin - it should be defined by now
                if (typeof handleLogin === 'function') {
                    handleLogin();
                } else {
                    logger.error('handleLogin function not found');
                    showToast('Login function not ready. Please try again.', 'error');
                }
            } catch (error) {
                logger.error('Error in handleLogin:', error);
                showToast('An error occurred. Please try again.', 'error');
            }
        };

        // Initialize - ensure elements exist
        logger.log('Initializing login...');
        
        // Use setTimeout to ensure DOM is fully ready
        setTimeout(() => {
            const loginBtn = document.getElementById('login-button');
            const emailInput = document.getElementById('advocate-email-input');
            
            logger.log('Login button:', loginBtn);
            logger.log('Email input:', emailInput);
            
            if (loginBtn) {
                // Also attach event listener as backup
                loginBtn.addEventListener('click', window.handleLoginClick);
                logger.log('Login button event listener attached');
            } else {
                logger.error('Login button not found');
            }
            
            if (emailInput) {
                emailInput.addEventListener('keyup', (e) => { 
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        e.stopPropagation();
                        try {
                            handleLogin(); 
                        } catch (error) {
                            logger.error('Error in handleLogin:', error);
                            showToast('An error occurred. Please try again.', 'error');
                        }
                    }
                });
            }
        }, 100);

        // Show onboarding modal on first visit
        if (!localStorage.getItem('ampup-onboarding-seen')) {
            setTimeout(() => {
                showOnboardingModal();
            }, 500);
        }

        // For prototype: Always show dashboard
        logger.log('Initializing dashboard...');
        logger.log('Current user:', appState.currentUser);
        logger.log('Active drops:', appState.drops.filter(d => d.status === 'ACTIVE'));
        
        switchView('main');
        
        // Wait a bit for DOM to be fully ready
        setTimeout(function() {
            logger.log('Rendering all components...');
            try {
                // Check if renderAll is defined before calling (try both local and global)
                var renderFn = typeof renderAll === 'function' ? renderAll : (typeof window.renderAll === 'function' ? window.renderAll : null);
                if (renderFn) {
                    renderFn();
                    logger.log('Dashboard rendered successfully');
                } else {
                    logger.warn('renderAll not yet defined, will retry...');
                    // Retry after a short delay
                    setTimeout(function() {
                        var renderFnRetry = typeof renderAll === 'function' ? renderAll : (typeof window.renderAll === 'function' ? window.renderAll : null);
                        if (renderFnRetry) {
                            renderFnRetry();
                            logger.log('Dashboard rendered successfully (retry)');
                        } else {
                            logger.error('renderAll function not found after retry');
                            // Try to manually call the render functions as fallback
                            try {
                                if (typeof renderNavigation === 'function') renderNavigation();
                                if (typeof renderAuthSection === 'function') renderAuthSection();
                                if (typeof renderDrop === 'function') renderDrop();
                                if (typeof renderSidebar === 'function') renderSidebar();
                                if (typeof renderRoster === 'function') renderRoster();
                                if (typeof renderUserStats === 'function') renderUserStats();
                                logger.log('Dashboard rendered using fallback method');
                            } catch (fallbackError) {
                                logger.error('Fallback rendering also failed:', fallbackError);
                            }
                        }
                    }, 500);
                }
                
                // Check achievements for all users (after all definitions are loaded)
                if (typeof checkAchievements === 'function' && typeof ACHIEVEMENT_DEFINITIONS !== 'undefined') {
                    appState.crew.forEach(function(user) {
                        const allUsers = [...appState.crew, appState.currentUser].filter(u => u);
                        const newlyUnlocked = checkAchievements(user, allUsers);
                        newlyUnlocked.forEach(function(achievementData) {
                            // Only show notifications for current user
                            if (appState.currentUser && user.email === appState.currentUser.email) {
                                showAchievementUnlock(achievementData);
                            }
                        });
                    });
                    
                    // Check achievements for current user
                    if (appState.currentUser) {
                        const allUsers = [...appState.crew, appState.currentUser].filter(u => u);
                        const newlyUnlocked = checkAchievements(appState.currentUser, allUsers);
                        newlyUnlocked.forEach(function(achievementData) {
                            showAchievementUnlock(achievementData);
                        });
                    }
                }
            } catch(error) {
                logger.error('Error rendering dashboard:', error);
                logger.error('Stack:', error.stack);
            }
        }, 100);
    })();
    
    } catch(error) {
        // Catch any errors in the outer try block
        console.error('[AmpUp] Fatal error during initialization:', error);
        console.error('[AmpUp] Stack:', error.stack);
    }
</script>
</body>
</html>